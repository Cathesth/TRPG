import json
import logging
from typing import List, Dict, Optional

# 필요한 모듈 임포트
try:
    from core.vector_db import get_vector_db_client
    from llm_factory import LLMFactory
except ImportError:
    pass

logger = logging.getLogger(__name__)


class ChatbotService:
    @staticmethod
    async def generate_response(user_query: str, chat_history: List[Dict] = None) -> dict:
        """
        사용자의 질문을 받아 답변을 생성합니다.
        """
        # [학습 내용] AI에게 주입할 프로젝트 지식 정보
        context_text = """
        [TRPG Studio 서비스 정보]
        1. 서비스 개요: 여울(YEOUL)은 멀티 에이전트 AI 기반의 인터랙티브 TRPG 플랫폼입니다.
        2. 시나리오 제작 (Builder Mode): 노드 기반 편집기, AI 보조 도구(NPC/지문 생성), 로직 검수 제공.
        3. 요금제: Free(3개 생성), Pro(9,900원/무제한/GPT-4), Biz(29,900원/파인튜닝).
        4. 플레이: 메인 화면 리스트 선택 -> 1:1 AI GM과 플레이.
        """

        try:
            # LLM 호출 시도
            if 'LLMFactory' in globals() and hasattr(LLMFactory, 'create_llm'):
                try:
                    # 대화 히스토리 포맷팅
                    history_text = ""
                    if chat_history:
                        recent_history = chat_history[-3:]
                        for msg in recent_history:
                            role = "User" if msg.get('role') == 'user' else "AI"
                            history_text += f"{role}: {msg.get('content')}\n"

                    system_prompt = f"""
                    당신은 TRPG Studio의 친절하고 재치 있는 AI 가이드 '여울'입니다.
                    사용자는 TRPG 게임을 만들거나 플레이하는 유저입니다.

                    [지침]
                    1. 제공된 'Context' 정보를 기반으로 정확하게 답변하세요.
                    2. 정보가 없다면 솔직히 모르겠다고 하고, 메뉴 이용을 권장하세요.
                    3. 말투는 친절하고 격려하는 톤("~해요", "~해보세요!")을 사용하세요.
                    4. 답변 끝에는 항상 사용자가 이어서 할 법한 질문 2~3개를 'choices'에 담아 주세요.

                    [이전 대화 참고]
                    {history_text}

                    반드시 아래 JSON 형식을 지켜서 응답하세요. (마크다운 없이 순수 JSON만)
                    {{
                        "answer": "답변 내용... (줄바꿈은 \\n 사용)",
                        "choices": ["선택지1", "선택지2"]
                    }}
                    """

                    llm = LLMFactory.create_llm("gpt-4o")
                    response_text = await llm.chat_completion(
                        system_prompt=system_prompt,
                        user_input=f"Context: {context_text}\n\nQuestion: {user_query}"
                    )
                    cleaned_text = response_text.replace("```json", "").replace("```", "").strip()
                    return json.loads(cleaned_text)
                except Exception as e:
                    logger.warning(f"LLM 호출 실패 (Fallback 전환): {e}")
                    return ChatbotService.get_keyword_response(user_query)
            else:
                return ChatbotService.get_keyword_response(user_query)

        except Exception as e:
            logger.error(f"Chatbot Critical Error: {e}")
            return ChatbotService.get_keyword_response(user_query)

    # ▼▼▼ [최종 수정] 키워드 분석 로직 (모든 질문 대응) ▼▼▼
    @staticmethod
    def get_keyword_response(query: str) -> dict:
        """
        AI 모델 연결 불가 시, 키워드 점수(Score) 기반으로 가장 적합한 답변을 찾습니다.
        """
        query = query.lower().strip()

        # 답변 템플릿 리스트
        responses = [
            # -----------------------------------------------------------
            # 1. 시나리오/프리셋 관리 (로드/저장/보기 분리)
            # -----------------------------------------------------------

            # [시나리오 로드] - (빌더 기능 설명으로 수정됨)
            {
                "keywords": ['시나리오', 'scenario', '로드', 'load', '불러오기', '열기', '가져오기'],
                "required": ['로드', 'load', '불러오기', '열기', '가져오기'],
                "answer": "📂 **시나리오 로드 (Load Scenario)**\n\n작성하던 시나리오를 편집기로 불러오고 싶으신가요?\n\n1. 빌더 모드 상단의 **'Load Scenario'** 버튼을 클릭하세요.\n2. 서버에 저장된 나의 시나리오 목록이 나타납니다.\n3. 원하는 항목을 선택하면 에디터에 내용이 로드됩니다.",
                "choices": ["프리셋 로드란?", "내 시나리오 보기", "빌더 모드 이동"]
            },

            # [내 시나리오 보기] - (마이페이지 설명으로 분리됨)
            {
                "keywords": ['내', 'my', '작품', '목록', '리스트', '확인', '보기', 'list'],
                "required": ['목록', '리스트', '확인', '보기', '내'],
                "answer": "📖 **내 시나리오 목록 보기**\n\n내가 만든 작품들을 확인하고 싶으신가요?\n\n1. 우측 상단 프로필을 클릭하여 **'마이페이지'**로 이동하세요.\n2. **'내 시나리오'** 탭에서 작성 중이거나 완성된 시나리오 목록을 확인할 수 있습니다.\n3. 목록을 클릭하면 상세 정보를 보거나 편집할 수 있습니다.",
                "choices": ["마이페이지로 이동", "시나리오 로드란?", "새 시나리오 만들기"]
            },

            # [프리셋 저장]
            {
                "keywords": ['프리셋', 'preset', '저장', 'save', '다운로드', '백업'],
                "required": ['프리셋', 'preset'],
                "answer": "💾 **프리셋(Preset) 저장**\n\n현재 캔버스에 그려진 **노드와 연결 구조**를 내 컴퓨터에 **JSON 파일**로 다운로드하는 기능입니다.\n\n작업 중인 배치를 백업하거나, 다른 사람에게 시나리오 구조를 공유할 때 유용합니다.",
                "choices": ["프리셋 로드가 뭔가요?", "시나리오 저장과 차이점", "빌더 모드 이동"]
            },

            # [프리셋 로드]
            {
                "keywords": ['프리셋', 'preset', '로드', 'load', '불러오기', '열기'],
                "required": ['프리셋', 'preset'],
                "answer": "📂 **프리셋(Preset) 로드**\n\n컴퓨터에 가지고 있는 **프리셋 파일(.json)**을 캔버스에 적용하는 기능입니다.\n\n⚠️ **주의:** 프리셋을 로드하면 현재 캔버스의 내용은 사라지고 프리셋의 구조로 덮어씌워집니다.",
                "choices": ["프리셋 저장이 뭔가요?", "시나리오 로드란?", "빌더 모드 이동"]
            },

            # [프리셋 vs 시나리오 차이]
            {
                "keywords": ['프리셋', '시나리오', '차이', 'vs', '비교', '다른'],
                "required": ['프리셋', '시나리오'],
                "answer": "⚖️ **프리셋 로드 vs 시나리오 로드 차이점**\n\n두 기능은 **'어디서'** 데이터를 가져오느냐가 다릅니다.\n\n• **프리셋 로드**: 내 컴퓨터에 저장된 **JSON 파일(구조)**을 캔버스로 불러옵니다. (로컬 파일)\n• **시나리오 로드**: 서버에 저장된 **내 프로젝트**를 편집기로 불러옵니다. (클라우드 DB)\n\n즉, 프리셋은 '단순 도면 백업', 시나리오는 '진행 중인 프로젝트 전체'라고 이해하시면 됩니다!",
                "choices": ["프리셋 저장이 뭔가요?", "시나리오 제작 방법", "빌더 모드 이동"]
            },

            # -----------------------------------------------------------
            # 2. 빌더(제작) 상세 기능
            # -----------------------------------------------------------

            # [NPC 생성 가이드]
            {
                "keywords": ['npc', '등장인물', '캐릭터', '인물', '만들', '생성', '추가', '방법'],
                "required": ['npc'],
                "answer": "👥 **NPC 생성 가이드**\n\nNPC 생성 탭에서 다음 정보를 입력하여 모험을 돕거나 방해하는 인물을 만듭니다.\n\n• **필수**: 이름, 역할/직업, 성격/특징, 대표 대사\n• **상세**: 외모 묘사, 배경 설정, 숨겨진 비밀\n• **설정**: 나이대, 협력도(우호/중립/비협조)\n\n생성된 NPC는 시나리오에 생동감을 더하고 플레이어와 상호작용합니다.",
                "choices": ["적(Enemy) 생성 방법", "아이템 생성 방법", "AI 자동 생성 팁"]
            },

            # [적(Enemy) 생성 가이드]
            {
                "keywords": ['적', 'enemy', '몬스터', 'monster', '몹', '만들', '생성', '추가', '방법'],
                "required": ['적', 'enemy', '몬스터', 'monster'],
                "answer": "⚔️ **적(Enemy) 생성 가이드**\n\n전투 탭에서 플레이어를 위협하는 적을 생성합니다.\n\n• **기본**: 이름, 종족/유형, 난이도(하~보스)\n• **스탯**: 체력(HP), 공격력(ATK)\n• **상세**: 특징/공격 패턴, 약점, 드랍 아이템\n\n생성된 적은 전투 이벤트 발생 시 등장하여 긴장감을 줍니다.",
                "choices": ["NPC 생성 방법", "아이템 생성 방법", "전투 시스템 안내"]
            },

            # [아이템(Item) 생성 가이드]
            {
                "keywords": ['아이템', 'item', '물건', '보상', '만들', '생성', '추가', '제작', '방법'],
                "required": ['아이템'],
                "answer": "💎 **아이템(Item) 생성 가이드**\n\n아이템 탭에서 보상이나 중요 물품을 생성합니다.\n\n• **정보**: 이름, 유형(무기/방어구/소모품 등)\n• **상세**: 효과/능력치, 설명/외형\n\n적 처치 보상이나 이벤트 획득 아이템으로 활용됩니다.",
                "choices": ["NPC 생성 방법", "적 생성 방법", "아이템 사용 방법"]
            },

            # [씬 추가 방법]
            {
                "keywords": ['씬', 'scene', '추가', '생성', '만들', '방법', 'how', '어떻게'],
                "required": ['씬', 'scene'],
                "answer": "🎬 **Scene(장면) 추가 방법**\n\n새로운 장면을 추가하고 싶으신가요?\n\n1. 캔버스 화면의 빈 공간을 **우클릭** 하세요.\n2. 나타나는 메뉴에서 **'Add Scene'**을 선택하세요.\n3. 또는 상단 툴바의 **'+' 버튼**을 클릭해도 됩니다.",
                "choices": ["씬 배경 설정", "내용 AI 작성", "엔딩 추가 방법"]
            },

            # [씬 배경 설정]
            {
                "keywords": ['배경', 'background', 'bg', '설정', '변경', '바꾸', '이미지', '넣기'],
                "required": ['배경', 'background'],
                "answer": "🖼️ **씬 배경 설정 방법**\n\n장면에 어울리는 배경을 넣어보세요!\n\n1. 편집하려는 **씬 노드를 클릭**하여 에디터를 엽니다.\n2. **'Image / Background'** 섹션을 찾습니다.\n3. 이미지 URL을 직접 입력하거나, **'AI 생성'** 버튼으로 즉석에서 그림을 그릴 수 있습니다.",
                "choices": ["이미지 생성 방법", "내용 AI 작성", "빌더 모드 이동"]
            },

            # [내용 AI 작성]
            {
                "keywords": ['내용', '지문', 'text', '본문', '작성', 'magic', 'write', '자동', '써줘'],
                "required": ['내용', '지문', 'text', '작성'],
                "answer": "✨ **내용 AI 작성 (Magic Write)**\n\n글쓰기가 막막할 때 사용하세요!\n\n1. 씬 에디터의 텍스트 입력창 우측에 있는 **마법봉 아이콘(🪄)**을 클릭합니다.\n2. '어두운 숲, 긴장감' 같은 **키워드**나 **상황**을 짧게 입력합니다.\n3. AI가 그에 맞는 멋진 묘사를 자동으로 작성해 줍니다.",
                "choices": ["이미지 생성 방법", "AI 도구 소개", "빌더 모드 이동"]
            },

            # [이미지 생성 방법]
            {
                "keywords": ['이미지', '그림', '삽화', 'image', 'picture', '생성', '만들', 'gen', '그려', '방법', '엑박', '깨짐', '안나와'],
                "required": ['이미지', '그림', '삽화'],
                "answer": "🎨 **AI 이미지 생성 및 문제 해결**\n\n1. **생성 방법**: 씬 에디터 하단의 **'Generate Image'** 버튼을 클릭하세요.\n2. **엑박(깨짐) 현상**: 이미지가 로딩되지 않는다면, **브라우저 새로고침**을 하거나 잠시 후 다시 시도해 주세요. 네트워크 문제일 수 있습니다.",
                "choices": ["씬 배경 설정", "내용 AI 작성", "요금제 안내"]
            },

            # [엔딩 추가]
            {
                "keywords": ['엔딩', 'ending', '결말', '끝', 'finish', '만들', '추가', '방법'],
                "required": ['엔딩', '결말', '끝'],
                "answer": "🏁 **Ending(엔딩) 만드는 법**\n\n이야기의 끝을 만드는 방법은 간단합니다.\n\n1. 새로운 씬을 추가하여 결말 내용을 작성하세요.\n2. 해당 씬에서 **다른 씬으로 연결되는 선택지(Choice)를 만들지 않으면**, 게임 시스템이 이를 자동으로 **엔딩(Ending)**으로 인식합니다.",
                "choices": ["씬 추가 방법", "내용 AI 작성", "빌더 모드 이동"]
            },

            # [AI 도구 소개]
            {
                "keywords": ['ai', '도구', 'tool', '인공지능', '기능', '뭐야', '뭔가요', '소개', '종류'],
                "required": ['ai', '도구'],
                "answer": "🤖 **AI 보조 도구 소개**\n\nTRPG Studio는 창작자를 위한 강력한 AI 도구 3가지를 제공합니다.\n\n1. **NPC 제네레이터**: 성격/배경/대사를 자동 생성\n2. **Magic Write**: 지문/내용 자동 작성\n3. **로직 검수기**: 연결 오류 자동 분석\n\n빌더 모드에서 이 기능들을 활용해 보세요!",
                "choices": ["내용 AI 작성", "이미지 생성 방법", "처음으로"]
            },

            # [시나리오 공개 설정]
            {
                "keywords": ['공개', '공유', 'publish', '배포', '다른', '사람'],
                "required": ['공개', '공유', '배포'],
                "answer": "🌍 **시나리오 공개 (Publish)**\n\n완성된 시나리오를 다른 사람들과 공유할 수 있습니다.\n\n1. 빌더 모드 상단의 **'Publish'** 버튼을 클릭하세요.\n2. 공개 설정이 완료되면, 메인 화면의 리스트에 내 시나리오가 등록되어 누구나 플레이할 수 있게 됩니다.",
                "choices": ["시나리오 제작 방법", "빌더 모드 이동", "처음으로"]
            },

            # [부적절한 내용 (욕설/선정성)]
            {
                "keywords": ['부적절', '욕', '욕설', '야한', '선정', '19금', '입력', '필터'],
                "required": ['부적절', '욕', '욕설', '선정', '입력'],
                "answer": "🚫 **부적절한 내용 감지 및 제재 안내**\n\nAI는 욕설, 혐오 표현, 선정적인 내용 등 부적절한 입력을 자동으로 필터링합니다.\n\n이러한 내용이 반복적으로 입력될 경우, **AI 응답이 거부되거나 계정 이용이 제한**될 수 있으니 건전한 플레이를 부탁드립니다.",
                "choices": ["게임 플레이 방법", "문의하기", "처음으로"]
            },

            # [AI 엉뚱한 대답 / 재시도]
            {
                "keywords": ['엉뚱', '이상', '말', '못', '알아', '대답', '답변', '바보'],
                "required": ['엉뚱', '이상', '못', '알아', '답변'],
                "answer": "🤔 **AI가 엉뚱한 대답을 하나요?**\n\n그럴 땐 이렇게 해보세요!\n\n1. **질문을 구체적으로** 다시 입력해 보세요. (예: \"공격해\" -> \"검으로 적을 공격한다\")\n2. **새로고침** 후 다시 시도해 보세요.\n3. 여전히 문제가 있다면 **문의하기**를 통해 제보해 주세요.",
                "choices": ["게임 플레이 방법", "문의하기", "처음으로"]
            },

            # [이미지 생성 제한]
            {
                "keywords": ['이미지', '생성', '무제한', '제한', '횟수', '개수'],
                "required": ['이미지', '무제한', '제한', '횟수'],
                "answer": "🎨 **AI 이미지 생성 제한 안내**\n\nAI 이미지 생성은 서버 비용 문제로 인해 **횟수 제한**이 있습니다.\n\n• **Free**: 월 10장\n• **Pro/Biz**: 월 50장 이상 (요금제별 상이)\n\n토큰을 모두 소진하면 다음 달 1일에 초기화됩니다.",
                "choices": ["요금제 안내", "이미지 생성 방법", "처음으로"]
            },

            # [만들다 만 시나리오 / 임시 보관함]
            {
                "keywords": ['만들다', '중단', '어디', '임시', '보관', '다시', '이어서'],
                "required": ['만들다', '중단', '어디', '임시', '다시'],
                "answer": "📂 **작성 중인 시나리오 찾기**\n\n만들다 만 시나리오는 **마이페이지 > 내 시나리오** 탭에 저장되어 있습니다.\n\n'작성 중(Draft)' 상태인 시나리오를 클릭하면 마지막 작업 내용을 불러와 이어서 제작할 수 있습니다.",
                "choices": ["마이페이지로 이동", "시나리오 제작 방법", "처음으로"]
            },

            # [자동 저장]
            {
                "keywords": ['자동', '저장', '작성', '중', '날아', '백업'],
                "required": ['자동', '저장', '작성'],
                "answer": "💾 **자동 저장 (Draft Service)**\n\n안심하세요! 작성 중인 시나리오는 시스템에 의해 주기적으로 **자동 임시 저장**됩니다.\n\n혹시 브라우저가 꺼지더라도, 다시 접속하여 **'내 시나리오'**에서 이어서 작성할 수 있습니다.",
                "choices": ["만들다 만 시나리오 찾기", "시나리오 제작 방법", "처음으로"]
            },

            # [PC 이미지 업로드]
            {
                "keywords": ['pc', '이미지', '업로드', '사진', '내', '컴퓨터', '파일'],
                "required": ['이미지', '업로드', '사진', '파일'],
                "answer": "📤 **이미지 업로드 안내**\n\n현재 버전에서는 **AI 생성 이미지**와 **외부 이미지 URL** 입력만 지원합니다.\n\nPC에 있는 이미지를 직접 업로드하는 기능은 추후 업데이트될 예정입니다. 불편을 드려 죄송합니다.",
                "choices": ["이미지 생성 방법", "씬 배경 설정", "처음으로"]
            },

            # [다른 사람 시나리오 복사/수정]
            {
                "keywords": ['다른', '사람', '시나리오', '복사', '수정', '리믹스', '가져'],
                "required": ['다른', '사람', '복사', '수정'],
                "answer": "📑 **타인 시나리오 수정 (리믹스) 안내**\n\n다른 사람의 공개 시나리오는 **플레이만 가능**하며, 내용을 직접 수정하거나 복사해오는 기능(리믹스)은 아직 지원하지 않습니다.\n\n단, 제작자가 공유한 **프리셋(JSON) 파일**이 있다면 '프리셋 로드'를 통해 내 캔버스로 불러올 수 있습니다.",
                "choices": ["프리셋 로드가 뭔가요?", "시나리오 제작 방법", "처음으로"]
            },

            # [토큰 시스템]
            {
                "keywords": ['토큰', 'token', '다', '쓰면', '부족', '사용량'],
                "required": ['토큰', 'token', '쓰면', '부족'],
                "answer": "🪙 **토큰(Token) 시스템 안내**\n\nAI와의 대화 및 이미지 생성에는 '토큰'이 소모됩니다.\n\n• **Free**: 매일 일정량 무료 제공\n• **Pro/Biz**: 대용량 토큰 제공\n\n토큰이 다 떨어지면 AI 응답이 멈출 수 있으며, 다음 날 충전되거나 상위 요금제로 업그레이드해야 합니다.",
                "choices": ["요금제 안내", "마이페이지 확인", "처음으로"]
            },

            # [플레이 로그 다운로드]
            {
                "keywords": ['로그', '기록', '다운', '다운로드', '텍스트', '파일', '저장'],
                "required": ['로그', '기록', '다운', '파일'],
                "answer": "📜 **플레이 로그 다운로드**\n\n현재 플레이 로그를 텍스트 파일(.txt)로 다운로드하는 기능은 개발 중에 있습니다.\n\n지금은 화면을 스크롤하여 지난 대화를 확인하거나, 내용을 직접 복사하여 저장해 주세요.",
                "choices": ["이전 대화 보기", "게임 저장 방법", "처음으로"]
            },

            # [동시 게임 진행 / 세션]
            {
                "keywords": ['동시', '여러', '개', '게임', '진행', '세션', '멀티'],
                "required": ['동시', '여러', '게임', '세션'],
                "answer": "🎮 **동시 게임 진행 안내**\n\n현재 하나의 계정으로는 **한 번에 하나의 게임**만 진행할 수 있습니다.\n\n다른 시나리오를 플레이하려면 현재 진행 중인 게임을 종료하거나 저장해야 합니다.",
                "choices": ["게임 저장 방법", "게임 플레이 방법", "처음으로"]
            },

            # -----------------------------------------------------------
            # 3. 요금제, 계정, 문의
            # -----------------------------------------------------------

            # [회원 가입/시작]
            {
                "keywords": ['가입', 'register', 'sign', '시작', '처음', 'start'],
                "required": ['가입', '시작', '처음'],
                "answer": "👋 **TRPG Studio 시작하기**\n\n환영합니다! 우측 상단의 **'LOGIN'** 버튼을 눌러보세요.\n\n구글, 카카오, 네이버 계정으로 **간편하게 회원가입 및 로그인**하여 바로 모험을 시작할 수 있습니다.",
                "choices": ["게임 플레이 방법", "시나리오 제작 방법", "요금제 안내"]
            },

            # [비밀번호 변경/찾기]
            {
                "keywords": ['비번', '비밀번호', 'password', '변경', '찾기', '분실', '까먹'],
                "required": ['비번', '비밀번호', 'password'],
                "answer": "🔐 **비밀번호 관리**\n\n소셜 로그인(구글/카카오/네이버)을 이용하시는 경우, 해당 소셜 서비스에서 비밀번호를 관리해야 합니다.\n\n이메일로 가입하신 경우, **마이페이지 > 프로필 수정**에서 비밀번호를 변경하실 수 있습니다.",
                "choices": ["마이페이지로 이동", "로그인 방법", "처음으로"]
            },

            # [회원 탈퇴]
            {
                "keywords": ['탈퇴', '삭제', 'delete', 'withdraw', '그만'],
                "required": ['탈퇴', '삭제', '그만'],
                "answer": "😢 **회원 탈퇴 안내**\n\n떠나신다니 아쉽습니다.\n\n회원 탈퇴는 **마이페이지 > 프로필 수정** 메뉴 하단의 **'회원 탈퇴'** 버튼을 통해 진행하실 수 있습니다.\n탈퇴 시 모든 시나리오와 데이터가 삭제되니 신중하게 결정해 주세요.",
                "choices": ["마이페이지로 이동", "문의하기", "처음으로"]
            },

            # [무료 기능/회원]
            {
                "keywords": ['무료', 'free', '기능', 'adventurer', '공짜', '몇개', '제한'],
                "required": ['무료', 'free', '공짜'],
                "answer": "🎒 **Adventurer (Free) 플랜 안내**\n\n무료 회원도 충분히 즐길 수 있습니다!\n\n✅ **제공 기능**\n• 시나리오 생성: 최대 **3개**\n• 기본 AI 모델(GPT-3.5) 무제한 사용\n• 다른 유저의 공개 시나리오 **무제한 플레이**\n• 커뮤니티 기능 이용 가능\n\n부담 없이 모험을 시작해 보세요!",
                "choices": ["요금제 안내", "시나리오 제작 방법", "처음으로"]
            },

            # [요금제 안내]
            {
                "keywords": ['요금', '가격', '비용', '결제', 'plan', '구독', '얼마', '유료', '안내'],
                "required": ['요금', '가격', '비용', '결제', 'plan', '구독', '얼마', '유료'],
                "answer": "💳 **요금제 안내**\n\n모험가님의 스타일에 맞는 플랜을 선택하세요!\n\n🔹 **Adventurer (Free)**: 무료, 시나리오 3개\n🔹 **Dungeon Master (9,900원/월)**: 무제한 생성, GPT-4, 이미지 50회\n🔹 **World Creator (29,900원/월)**: 모든 기능 + 전용 파인튜닝 모델\n\n자세한 내용은 **마이페이지**에서 확인 가능합니다.",
                "choices": ["무료 기능 더 보기", "마이페이지로 이동", "처음으로"]
            },

            # [문의하기/버그 신고]
            {
                "keywords": ['문의', 'contact', 'support', '질문', 'help', '버그', '신고', '오류', '개발자'],
                "required": ['문의', 'contact', '버그', '신고', '오류', '개발자'],
                "answer": "📬 **문의하기 및 버그 신고**\n\n서비스 이용 중 불편한 점이나 버그를 발견하셨나요?\n\n현재는 베타 테스트 기간으로, **커뮤니티(디스코드/게시판)**를 통해 개발자에게 직접 문의하실 수 있습니다.\n빠른 시일 내에 1:1 문의 기능을 제공해 드리겠습니다!",
                "choices": ["플레이 방법", "시나리오 제작 방법", "처음으로"]
            },

            # -----------------------------------------------------------
            # 4. 플레이 / 인게임 (힌트 등)
            # -----------------------------------------------------------

            # [게임 플레이 방법]
            {
                "keywords": ['게임', '플레이', '시작', '방법', 'play', 'game', 'how'],
                "required": ['게임', '플레이'],
                "answer": "🎮 **게임 플레이 방법**\n\nTRPG Studio에서는 AI 게임마스터와 함께 자유로운 모험을 즐길 수 있습니다.\n\n1. 메인 화면에서 원하는 **시나리오를 선택**하세요.\n2. **'PLAY'** 버튼을 눌러 게임을 시작합니다.\n3. 상황에 맞는 **행동이나 대사**를 입력하면 스토리가 진행됩니다.",
                "choices": ["전투는 어떻게 해요?", "아이템 사용법", "힌트가 필요해요"]
            },

            # [모바일 플레이]
            {
                "keywords": ['모바일', '폰', '스마트폰', 'mobile', 'phone'],
                "required": ['모바일', '폰'],
                "answer": "📱 **모바일 플레이 지원**\n\n네! TRPG Studio는 모바일 웹 브라우저에서도 플레이할 수 있습니다.\n\n다만, **시나리오 제작(빌더 모드)**은 화면이 넓은 PC 환경에서 하시는 것을 권장합니다.",
                "choices": ["