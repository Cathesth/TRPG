import json
import logging
from typing import List, Dict, Optional

# í•„ìš”í•œ ëª¨ë“ˆ ì„í¬íŠ¸
try:
    from core.vector_db import get_vector_db_client
    from llm_factory import LLMFactory
except ImportError:
    pass

logger = logging.getLogger(__name__)


class ChatbotService:
    @staticmethod
    async def generate_response(user_query: str, chat_history: List[Dict] = None) -> dict:
        """
        ì‚¬ìš©ìì˜ ì§ˆë¬¸ì„ ë°›ì•„ ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤.
        """
        # [í•™ìŠµ ë‚´ìš©] AIì—ê²Œ ì£¼ì…í•  í”„ë¡œì íŠ¸ ì§€ì‹ ì •ë³´
        context_text = """
        [TRPG Studio ì„œë¹„ìŠ¤ ì •ë³´]
        1. ì„œë¹„ìŠ¤ ê°œìš”: ì—¬ìš¸(YEOUL)ì€ ë©€í‹° ì—ì´ì „íŠ¸ AI ê¸°ë°˜ì˜ ì¸í„°ë™í‹°ë¸Œ TRPG í”Œë«í¼ì…ë‹ˆë‹¤.
        2. ì‹œë‚˜ë¦¬ì˜¤ ì œì‘ (Builder Mode): ë…¸ë“œ ê¸°ë°˜ í¸ì§‘ê¸°, AI ë³´ì¡° ë„êµ¬(NPC/ì§€ë¬¸ ìƒì„±), ë¡œì§ ê²€ìˆ˜ ì œê³µ.
        3. ìš”ê¸ˆì œ: Free(3ê°œ ìƒì„±), Pro(9,900ì›/ë¬´ì œí•œ/GPT-4), Biz(29,900ì›/íŒŒì¸íŠœë‹).
        4. í”Œë ˆì´: ë©”ì¸ í™”ë©´ ë¦¬ìŠ¤íŠ¸ ì„ íƒ -> 1:1 AI GMê³¼ í”Œë ˆì´.
        """

        try:
            # LLM í˜¸ì¶œ ì‹œë„
            if 'LLMFactory' in globals() and hasattr(LLMFactory, 'create_llm'):
                try:
                    # ëŒ€í™” íˆìŠ¤í† ë¦¬ í¬ë§·íŒ…
                    history_text = ""
                    if chat_history:
                        recent_history = chat_history[-3:]
                        for msg in recent_history:
                            role = "User" if msg.get('role') == 'user' else "AI"
                            history_text += f"{role}: {msg.get('content')}\n"

                    system_prompt = f"""
                    ë‹¹ì‹ ì€ TRPG Studioì˜ ì¹œì ˆí•˜ê³  ì¬ì¹˜ ìˆëŠ” AI ê°€ì´ë“œ 'ì—¬ìš¸'ì…ë‹ˆë‹¤.
                    ì‚¬ìš©ìëŠ” TRPG ê²Œì„ì„ ë§Œë“¤ê±°ë‚˜ í”Œë ˆì´í•˜ëŠ” ìœ ì €ì…ë‹ˆë‹¤.

                    [ì§€ì¹¨]
                    1. ì œê³µëœ 'Context' ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì •í™•í•˜ê²Œ ë‹µë³€í•˜ì„¸ìš”.
                    2. ì •ë³´ê°€ ì—†ë‹¤ë©´ ì†”ì§íˆ ëª¨ë¥´ê² ë‹¤ê³  í•˜ê³ , ë©”ë‰´ ì´ìš©ì„ ê¶Œì¥í•˜ì„¸ìš”.
                    3. ë§íˆ¬ëŠ” ì¹œì ˆí•˜ê³  ê²©ë ¤í•˜ëŠ” í†¤("~í•´ìš”", "~í•´ë³´ì„¸ìš”!")ì„ ì‚¬ìš©í•˜ì„¸ìš”.
                    4. ë‹µë³€ ëì—ëŠ” í•­ìƒ ì‚¬ìš©ìê°€ ì´ì–´ì„œ í•  ë²•í•œ ì§ˆë¬¸ 2~3ê°œë¥¼ 'choices'ì— ë‹´ì•„ ì£¼ì„¸ìš”.

                    [ì´ì „ ëŒ€í™” ì°¸ê³ ]
                    {history_text}

                    ë°˜ë“œì‹œ ì•„ë˜ JSON í˜•ì‹ì„ ì§€ì¼œì„œ ì‘ë‹µí•˜ì„¸ìš”. (ë§ˆí¬ë‹¤ìš´ ì—†ì´ ìˆœìˆ˜ JSONë§Œ)
                    {{
                        "answer": "ë‹µë³€ ë‚´ìš©... (ì¤„ë°”ê¿ˆì€ \\n ì‚¬ìš©)",
                        "choices": ["ì„ íƒì§€1", "ì„ íƒì§€2"]
                    }}
                    """

                    llm = LLMFactory.create_llm("gpt-4o")
                    response_text = await llm.chat_completion(
                        system_prompt=system_prompt,
                        user_input=f"Context: {context_text}\n\nQuestion: {user_query}"
                    )
                    cleaned_text = response_text.replace("```json", "").replace("```", "").strip()
                    return json.loads(cleaned_text)
                except Exception as e:
                    logger.warning(f"LLM í˜¸ì¶œ ì‹¤íŒ¨ (Fallback ì „í™˜): {e}")
                    return ChatbotService.get_keyword_response(user_query)
            else:
                return ChatbotService.get_keyword_response(user_query)

        except Exception as e:
            logger.error(f"Chatbot Critical Error: {e}")
            return ChatbotService.get_keyword_response(user_query)

    # â–¼â–¼â–¼ [ìˆ˜ì •ë¨] í‚¤ì›Œë“œ ë¶„ì„ ë¡œì§ (ìš°ì„ ìˆœìœ„ ë° ì ìˆ˜ ë¡œì§ ê°œì„ ) â–¼â–¼â–¼
    @staticmethod
    def get_keyword_response(query: str) -> dict:
        """
        AI ëª¨ë¸ ì—°ê²° ë¶ˆê°€ ì‹œ, í‚¤ì›Œë“œ ì ìˆ˜(Score) ê¸°ë°˜ìœ¼ë¡œ ê°€ì¥ ì í•©í•œ ë‹µë³€ì„ ì°¾ìŠµë‹ˆë‹¤.
        """
        query = query.lower().strip()

        # ë‹µë³€ í…œí”Œë¦¿ ë¦¬ìŠ¤íŠ¸
        # íŒ: êµ¬ì²´ì ì¸ ì§ˆë¬¸ì¼ìˆ˜ë¡ ë¦¬ìŠ¤íŠ¸ ìƒë‹¨ì— ë°°ì¹˜í•˜ê³ , í‚¤ì›Œë“œë¥¼ í’ë¶€í•˜ê²Œ ë„£ì–´ ì ìˆ˜ë¥¼ ë†’ì…ë‹ˆë‹¤.
        responses = [
            # -----------------------------------------------------------
            # 1. êµ¬ì²´ì ì¸ ê¸°ëŠ¥ ê°€ì´ë“œ (ì ìˆ˜ ë¶€ìŠ¤íŒ…: ë°©ë²•, ì–´ë–»ê²Œ, ë“± í¬í•¨)
            # -----------------------------------------------------------

            # [ì´ë¯¸ì§€ ìƒì„±]
            {
                "keywords": ['ì´ë¯¸ì§€', 'ê·¸ë¦¼', 'ì‚½í™”', 'image', 'picture', 'ìƒì„±', 'ë§Œë“¤', 'gen', 'ê·¸ë ¤', 'ë°©ë²•', 'ì–´ë–»ê²Œ'],
                "required": ['ì´ë¯¸ì§€', 'ê·¸ë¦¼', 'ì‚½í™”'],  # í•„ìˆ˜ ë‹¨ì–´
                "answer": "ğŸ¨ **AI ì´ë¯¸ì§€ ìƒì„± ë°©ë²•**\n\ní…ìŠ¤íŠ¸ë§Œìœ¼ë¡œëŠ” ë¶€ì¡±í•˜ë‹¤ë©´ ì´ë¯¸ì§€ë¥¼ ìƒì„±í•´ ë³´ì„¸ìš”.\n\n1. **ë¹Œë” ëª¨ë“œ**ì˜ ì”¬ ì—ë””í„°ë¡œ ì§„ì…í•©ë‹ˆë‹¤.\n2. í•˜ë‹¨ì˜ **'ì´ë¯¸ì§€ ìƒì„±'** ë²„íŠ¼ì„ ëˆ„ë¦…ë‹ˆë‹¤.\n3. í˜„ì¬ ì‘ì„±ëœ **ìƒí™© ë¬˜ì‚¬ì™€ ë¶„ìœ„ê¸°**ë¥¼ AIê°€ ë¶„ì„í•˜ì—¬ ì–´ìš¸ë¦¬ëŠ” ì¼ëŸ¬ìŠ¤íŠ¸ë¥¼ ì¦‰ì„ì—ì„œ ê·¸ë ¤ì¤ë‹ˆë‹¤!",
                "choices": ["ì”¬ ë°°ê²½ ì„¤ì •", "ë‚´ìš© AI ì‘ì„±", "ë¹Œë” ëª¨ë“œ ì´ë™"]
            },

            # [ì—”ë”© ì¶”ê°€]
            {
                "keywords": ['ì—”ë”©', 'ending', 'ê²°ë§', 'ë', 'finish', 'ë§Œë“¤', 'ì¶”ê°€', 'ë°©ë²•', 'ì–´ë–»ê²Œ'],
                "required": ['ì—”ë”©', 'ê²°ë§', 'ë'],
                "answer": "ğŸ **Ending(ì—”ë”©) ë§Œë“œëŠ” ë²•**\n\nì´ì•¼ê¸°ì˜ ëì„ ë§Œë“œëŠ” ë°©ë²•ì€ ê°„ë‹¨í•©ë‹ˆë‹¤.\n\n1. ìƒˆë¡œìš´ ì”¬ì„ ì¶”ê°€í•˜ì—¬ ê²°ë§ ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”.\n2. í•´ë‹¹ ì”¬ì—ì„œ **ë‹¤ë¥¸ ì”¬ìœ¼ë¡œ ì—°ê²°ë˜ëŠ” ì„ íƒì§€(Choice)ë¥¼ ë§Œë“¤ì§€ ì•Šìœ¼ë©´**, ê²Œì„ì´ ì¢…ë£Œë˜ëŠ” ì—”ë”© ì”¬ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.",
                "choices": ["ì”¬ ì¶”ê°€ ë°©ë²•", "ë‚´ìš© AI ì‘ì„±", "ë¹Œë” ëª¨ë“œ ì´ë™"]
            },

            # [AI ë„êµ¬ ì†Œê°œ]
            {
                "keywords": ['ai', 'ë„êµ¬', 'tool', 'ì¸ê³µì§€ëŠ¥', 'ê¸°ëŠ¥', 'ë­ì•¼', 'ë­”ê°€ìš”', 'ì„¤ëª…', 'ì¢…ë¥˜', 'ì–´ë–¤'],
                "required": ['ai', 'ë„êµ¬'],
                "answer": "ğŸ¤– **AI ë³´ì¡° ë„êµ¬ ì†Œê°œ**\n\nTRPG StudioëŠ” ì°½ì‘ìë¥¼ ìœ„í•œ ê°•ë ¥í•œ AI ë„êµ¬ 3ê°€ì§€ë¥¼ ì œê³µí•©ë‹ˆë‹¤.\n\n1. **NPC ì œë„¤ë ˆì´í„°**: ì„±ê²©/ë°°ê²½/ëŒ€ì‚¬ë¥¼ ìë™ ìƒì„±\n2. **Magic Write (ì§€ë¬¸ ì‘ì„±)**: í‚¤ì›Œë“œë§Œìœ¼ë¡œ ì†Œì„¤ ê°™ì€ ë¬˜ì‚¬ ì‘ì„±\n3. **ë¡œì§ ê²€ìˆ˜ê¸°**: ì—°ê²°ì´ ëŠê¸´ ë…¸ë“œë‚˜ ì˜¤ë¥˜ ìë™ ë¶„ì„\n\në¹Œë” ëª¨ë“œì—ì„œ ë§ˆë²•ë´‰ ì•„ì´ì½˜ë“¤ì„ ì°¾ì•„ë³´ì„¸ìš”!",
                "choices": ["ë¹Œë” ëª¨ë“œ ì´ë™", "ì´ë¯¸ì§€ ìƒì„± ë°©ë²•", "ì²˜ìŒìœ¼ë¡œ"]
            },

            # [ìš”ê¸ˆì œ ì•ˆë‚´]
            {
                "keywords": ['ìš”ê¸ˆ', 'ê°€ê²©', 'ë¹„ìš©', 'ê²°ì œ', 'plan', 'êµ¬ë…', 'ì–¼ë§ˆ', 'ìœ ë£Œ', 'ë¬´ë£Œ', 'ì•ˆë‚´'],
                "required": ['ìš”ê¸ˆ', 'ê°€ê²©', 'ë¹„ìš©', 'ê²°ì œ', 'plan', 'êµ¬ë…', 'ì–¼ë§ˆ', 'ìœ ë£Œ', 'ë¬´ë£Œ'],  # í•˜ë‚˜ë¼ë„ ë§¤ì¹­ë˜ë©´ OK
                "answer": "ğŸ’³ **ìš”ê¸ˆì œ ì•ˆë‚´**\n\nëª¨í—˜ê°€ë‹˜ì˜ ìŠ¤íƒ€ì¼ì— ë§ëŠ” í”Œëœì„ ì„ íƒí•˜ì„¸ìš”!\n\nğŸ”¹ **Adventurer (Free)**: ë¬´ë£Œ, ì‹œë‚˜ë¦¬ì˜¤ 3ê°œ ìƒì„± ê°€ëŠ¥\nğŸ”¹ **Dungeon Master (9,900ì›/ì›”)**: ë¬´ì œí•œ ìƒì„±, GPT-4, ì´ë¯¸ì§€ 50íšŒ\nğŸ”¹ **World Creator (29,900ì›/ì›”)**: ëª¨ë“  ê¸°ëŠ¥ + ì „ìš© íŒŒì¸íŠœë‹ ëª¨ë¸\n\nìì„¸í•œ ë‚´ìš©ì€ ë§ˆì´í˜ì´ì§€ì—ì„œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.",
                "choices": ["ë§ˆì´í˜ì´ì§€ë¡œ ì´ë™", "ë¬´ë£Œ ê¸°ëŠ¥ ë”ë³´ê¸°", "ì²˜ìŒìœ¼ë¡œ"]
            },

            # -----------------------------------------------------------
            # 2. í”Œë ˆì´ / ì¸ê²Œì„ ê°€ì´ë“œ
            # -----------------------------------------------------------

            # [ì „íˆ¬/ê³µê²©]
            {
                "keywords": ['ì „íˆ¬', 'ê³µê²©', 'ì‹¸ì›€', 'attack', 'fight', 'ì£½ì´', 'ë°©ë²•', 'ì–´ë–»ê²Œ', 'í•˜ë‚˜ìš”'],
                "required": ['ì „íˆ¬', 'ê³µê²©', 'ì‹¸ì›€'],
                "answer": "âš”ï¸ **ì „íˆ¬ ë° ê³µê²© ë°©ë²•**\n\nì ì„ ë§Œë‚¬ë‹¤ë©´ ê³µê²© ë°©ì‹ì„ **í–‰ë™ìœ¼ë¡œ ë¬˜ì‚¬**í•˜ì„¸ìš”.\n\nì˜ˆì‹œ:\nâ€¢ \"ë“¤ê³  ìˆëŠ” ê²€ì„ íœ˜ë‘˜ëŸ¬ ì ì„ ê³µê²©í•œë‹¤.\"\nâ€¢ \"í™”ì—¼êµ¬ ì£¼ë¬¸ì„ ì™¸ì›Œ ì ì—ê²Œ ë‚ ë¦°ë‹¤.\"\n\ní”Œë ˆì´ì–´ì˜ í–‰ë™ -> AIì˜ íŒì •(ëª…ì¤‘ ì—¬ë¶€) -> ì ì˜ ë°˜ê²© ìˆœì„œë¡œ í„´ì´ ì§„í–‰ë©ë‹ˆë‹¤.",
                "choices": ["ë„ë§ì¹  ìˆ˜ ìˆë‚˜ìš”?", "ì£¼ì‚¬ìœ„ êµ´ë¦¬ëŠ” ë²•", "ì•„ì´í…œ ì‚¬ìš©ë²•"]
            },

            # [ë„ë§/íšŒí”¼]
            {
                "keywords": ['ë„ë§', 'run', 'escape', 'í”¼í•˜', 'íšŒí”¼', 'ì‚´ë ¤', 'ë°©ë²•'],
                "required": ['ë„ë§', 'í”¼í•˜', 'íšŒí”¼'],
                "answer": "ğŸƒ **ë„ë§ì¹˜ê¸°**\n\nìœ„í—˜í•œ ìƒí™©ì¸ê°€ìš”?\n\n**\"ë’¤ë„ ëŒì•„ë³´ì§€ ì•Šê³  ì „ë ¥ ì§ˆì£¼í•´ ë„ë§ì¹œë‹¤\"** ë˜ëŠ” **\"ì—°ë§‰íƒ„ì„ ë¿Œë¦¬ê³  ìˆ¨ëŠ”ë‹¤\"** ì²˜ëŸ¼ êµ¬ì²´ì ìœ¼ë¡œ ì…ë ¥í•´ ë³´ì„¸ìš”.\nAIê°€ ìƒí™©ê³¼ ë¯¼ì²©ì„±ì„ ê³ ë ¤í•´ ì„±ê³µ ì—¬ë¶€ë¥¼ íŒì •í•´ ì¤„ ê²ƒì…ë‹ˆë‹¤.",
                "choices": ["ì „íˆ¬ëŠ” ì–´ë–»ê²Œ í•´ìš”?", "ì•„ì´í…œ ì‚¬ìš©ë²•"]
            },

            # [ì£¼ì‚¬ìœ„/íŒì •]
            {
                "keywords": ['ì£¼ì‚¬ìœ„', 'ë‹¤ì´ìŠ¤', 'dice', 'êµ´ë¦¬', 'íŒì •', 'rule', 'ë£°', 'ì„±ê³µ', 'ë°©ë²•'],
                "required": ['ì£¼ì‚¬ìœ„', 'ë‹¤ì´ìŠ¤', 'íŒì •'],
                "answer": "ğŸ² **í–‰ë™ íŒì • ì•ˆë‚´**\n\nTRPG StudioëŠ” **ìë™ íŒì • ì‹œìŠ¤í…œ**ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.\n\në”°ë¡œ ì£¼ì‚¬ìœ„ ë²„íŠ¼ì„ ëˆ„ë¥¼ í•„ìš” ì—†ì´, **\"ë¬¸ì„ ë°œë¡œ ì°¹ë‹ˆë‹¤\"** ë˜ëŠ” **\"ê³ ë¸”ë¦°ì„ ê²€ìœ¼ë¡œ ì°Œë¥¸ë‹¤\"** ê°™ì´ í–‰ë™ì„ ê¸€ë¡œ ì ìœ¼ì„¸ìš”.\nAI GMì´ ìƒí™©ì— ë§ì¶° ìë™ìœ¼ë¡œ ì£¼ì‚¬ìœ„ë¥¼ êµ´ë¦¬ê³  ê²°ê³¼ë¥¼ ì•Œë ¤ì¤ë‹ˆë‹¤!",
                "choices": ["ì „íˆ¬ëŠ” ì–´ë–»ê²Œ í•´ìš”?", "ì•„ì´í…œ ì‚¬ìš©ë²•", "íŒíŠ¸ê°€ í•„ìš”í•´ìš”"]
            },

            # [ë””ë²„ê·¸ ë„êµ¬]
            {
                "keywords": ['ë””ë²„ê·¸', 'debug', 'ë²„ê·¸', 'ì‹œê°í™”', 'viz', 'ê·¸ë˜í”„', 'ë…¸ë“œ', 'ì˜¤ë¥˜', 'ì•ˆ', 'error', 'ë³´ì—¬'],
                "required": ['ë””ë²„ê·¸', 'debug', 'ì‹œê°í™”', 'ë²„ê·¸'],
                "answer": "ğŸ› ï¸ **ë””ë²„ê·¸(Debug) ë„êµ¬ ì•ˆë‚´**\n\ní”Œë ˆì´ í™”ë©´ ìš°ì¸¡ í•˜ë‹¨ì˜ **ë²Œë ˆ(Bug) ì•„ì´ì½˜**ì„ í´ë¦­í•´ ë³´ì„¸ìš”.\ní˜„ì¬ ì”¬ì˜ ìƒíƒœ, ë³€ìˆ˜ ê°’, ì§„í–‰ ê²½ë¡œë¥¼ ì‹œê°ì ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\n(ê·¸ë˜í”„ê°€ ì•ˆ ë³´ì¸ë‹¤ë©´ PC í™˜ê²½ì—ì„œ ìƒˆë¡œê³ ì¹¨ì„ ì‹œë„í•´ ì£¼ì„¸ìš”!)",
                "choices": ["í”Œë ˆì´ ë°©ë²•", "ë¬¸ì˜í•˜ê¸°"]
            },

            # [í”„ë¦¬ì…‹ vs ì‹œë‚˜ë¦¬ì˜¤]
            {
                "keywords": ['í”„ë¦¬ì…‹', 'ì‹œë‚˜ë¦¬ì˜¤', 'ì°¨ì´', 'vs', 'ë¹„êµ', 'ë‹¤ë¥¸'],
                "required": ['í”„ë¦¬ì…‹'],
                "answer": "âš–ï¸ **í”„ë¦¬ì…‹ ë¡œë“œ vs ì‹œë‚˜ë¦¬ì˜¤ ë¡œë“œ ì°¨ì´ì **\n\në‘ ê¸°ëŠ¥ì€ **'ì–´ë””ì„œ'** ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠëƒê°€ ë‹¤ë¦…ë‹ˆë‹¤.\n\nâ€¢ **í”„ë¦¬ì…‹ ë¡œë“œ**: ë‚´ ì»´í“¨í„°ì— ì €ì¥ëœ **JSON íŒŒì¼(êµ¬ì¡°)**ì„ ìº”ë²„ìŠ¤ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤. (ë¡œì»¬ íŒŒì¼)\nâ€¢ **ì‹œë‚˜ë¦¬ì˜¤ ë¡œë“œ**: ì„œë²„ì— ì €ì¥ëœ **ë‚´ í”„ë¡œì íŠ¸**ë¥¼ í¸ì§‘ê¸°ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤. (í´ë¼ìš°ë“œ DB)\n\nì¦‰, í”„ë¦¬ì…‹ì€ 'ë‹¨ìˆœ ë„ë©´ ë°±ì—…', ì‹œë‚˜ë¦¬ì˜¤ëŠ” 'ì§„í–‰ ì¤‘ì¸ í”„ë¡œì íŠ¸ ì „ì²´'ë¼ê³  ì´í•´í•˜ì‹œë©´ ë©ë‹ˆë‹¤!",
                "choices": ["í”„ë¦¬ì…‹ ì €ì¥ì´ ë­”ê°€ìš”?", "ì‹œë‚˜ë¦¬ì˜¤ ì œì‘ ë°©ë²•", "ë¹Œë” ëª¨ë“œ ì´ë™"]
            },

            # -----------------------------------------------------------
            # 3. ì¼ë°˜ì ì¸ ê°€ì´ë“œ (ìš°ì„ ìˆœìœ„ ë‚®ìŒ)
            # -----------------------------------------------------------

            # [ì‹œë‚˜ë¦¬ì˜¤ ì œì‘ (ì¼ë°˜)] - ì¤‘ìš”: 'ìƒì„±', 'ë§Œë“¤' ê°™ì€ ë‹¨ì–´ëŠ” 'ì‹œë‚˜ë¦¬ì˜¤'ì™€ ê°™ì´ ìˆì–´ì•¼ë§Œ ë°œë™ë˜ê²Œ ìˆ˜ì •
            {
                "keywords": ['ì‹œë‚˜ë¦¬ì˜¤', 'ì œì‘', 'ë§Œë“¤', 'ìƒì„±', 'ë¹Œë”', 'create', 'ë…¸ë“œ', 'ë°©ë²•'],
                "required": ['ì‹œë‚˜ë¦¬ì˜¤', 'ë¹Œë”', 'ë…¸ë“œ'],  # 'ìƒì„±' ë‹¨ë…ìœ¼ë¡œëŠ” ë°œë™ ì•ˆ í•¨ (ì´ë¯¸ì§€ ìƒì„± ë“±ê³¼ì˜ ì¶©ëŒ ë°©ì§€)
                "answer": "ğŸ› ï¸ **ì‹œë‚˜ë¦¬ì˜¤ ì œì‘ (Builder Mode)**\n\nTRPG StudioëŠ” **ë…¸ë“œ(Node) ê¸°ë°˜ í¸ì§‘ê¸°**ë¥¼ ì œê³µí•©ë‹ˆë‹¤.\nì½”ë”© ì—†ì´ ì´ì•¼ê¸°ì˜ íë¦„ì„ ì‹œê°ì ìœ¼ë¡œ ì—°ê²°í•˜ì—¬ ë‚˜ë§Œì˜ ëª¨í—˜ì„ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\nìƒë‹¨ì˜ **'Start Creation'** ë²„íŠ¼ì„ ëˆŒëŸ¬ ìº”ë²„ìŠ¤ë¥¼ ì—´ì–´ë³´ì„¸ìš”!",
                "choices": ["ë¹Œë” ëª¨ë“œ ì´ë™", "ì”¬ ì¶”ê°€ ë°©ë²•", "AI ë„êµ¬ê°€ ë­”ê°€ìš”?"]
            },

            # [ì—¬ìš¸ ì„œë¹„ìŠ¤ ì†Œê°œ]
            {
                "keywords": ['ì—¬ìš¸', 'ì„œë¹„ìŠ¤', 'ì†Œê°œ', 'yeoul', 'ì›Œí„°', 'í”Œë«í¼', 'í™ˆí˜ì´ì§€', 'ì‚¬ì´íŠ¸', 'ë­ì•¼', 'ë¬´ìŠ¨', 'ëˆ„êµ¬'],
                "required": ['ì—¬ìš¸'],
                "answer": "ğŸŒŠ **ì—¬ìš¸(YEOUL) ì„œë¹„ìŠ¤ ì†Œê°œ**\n\nì—¬ìš¸ì€ **AI ê¸°ë°˜ ì¸í„°ë™í‹°ë¸Œ TRPG í”Œë«í¼**ì…ë‹ˆë‹¤.\n\nëˆ„êµ¬ë‚˜ ìƒìƒ ì†ì˜ ëª¨í—˜ì„ **ì‹œë‚˜ë¦¬ì˜¤ë¡œ ì œì‘**í•˜ê³ ,\n**AI ê²Œì„ë§ˆìŠ¤í„°**ì™€ í•¨ê»˜ 1:1ë¡œ ììœ ë¡­ê²Œ í”Œë ˆì´í•  ìˆ˜ ìˆëŠ” ê³µê°„ì…ë‹ˆë‹¤.\n\nì—¬ëŸ¬ë¶„ì˜ ìƒìƒë ¥ì„ ë§ˆìŒê» í¼ì³ë³´ì„¸ìš”!",
                "choices": ["ì‹œë‚˜ë¦¬ì˜¤ ì œì‘ ë°©ë²•", "ê²Œì„ í”Œë ˆì´ ë°©ë²•", "ìš”ê¸ˆì œ ì•ˆë‚´"]
            },

            # [ì¸ì‚¬/ì´ˆê¸°í™”]
            {
                "keywords": ['ì²˜ìŒ', 'ì‹œì‘', 'start', 'home', 'ë©”ì¸', 'reset', 'ë¦¬ì…‹', 'ì•ˆë…•', 'ë°˜ê°€', 'hi'],
                "required": [],
                "answer": "ì•ˆë…•í•˜ì„¸ìš”! ëª¨í—˜ê°€ë‹˜. ğŸ‘‹\nì €ëŠ” TRPG Studioì˜ ì•ˆë‚´ë¥¼ ë•ëŠ” AI ê°€ì´ë“œ 'ì—¬ìš¸'ì…ë‹ˆë‹¤.\në¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?",
                "choices": ["ì‹œë‚˜ë¦¬ì˜¤ ì œì‘ ë°©ë²•", "ìš”ê¸ˆì œ ì•ˆë‚´", "ê²Œì„ í”Œë ˆì´ ë°©ë²•"]
            }
        ]

        # [ë§¤ì¹­ ë¡œì§]
        best_match = None
        max_score = 0

        for item in responses:
            score = 0
            # í•„ìˆ˜ ë‹¨ì–´ ì²´í¬ (ìˆë‹¤ë©´)
            if item.get("required") and not any(r in query for r in item["required"]):
                continue

            # í‚¤ì›Œë“œ ì ìˆ˜ ê³„ì‚°
            for k in item.get("keywords", []):
                if k in query:
                    score += 1

            # ì ìˆ˜ê°€ ë” ë†’ìœ¼ë©´ ê°±ì‹  (ê°™ì€ ì ìˆ˜ë©´ ë¦¬ìŠ¤íŠ¸ ìœ„ìª½ ìš°ì„ )
            if score > max_score:
                max_score = score
                best_match = item

        if best_match:
            # [DB ì—°ë™ ë£° ì²˜ë¦¬] (ì¸ê¸° ì‹œë‚˜ë¦¬ì˜¤ ë“±)
            if best_match.get("type") == "db_popular":
                # ... (DB ë¡œì§ ìœ ì§€) ...
                pass

            return {
                "answer": best_match["answer"],
                "choices": best_match["choices"]
            }

        # ê¸°ë³¸ ì‘ë‹µ
        return {
            "answer": f"ì£„ì†¡í•©ë‹ˆë‹¤. ë§ì”€í•˜ì‹  '{query}'ì— ëŒ€í•œ ì •í™•í•œ ì •ë³´ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\ní•˜ì§€ë§Œ ì•„ë˜ ë©”ë‰´ë¥¼ í†µí•´ ë„ì›€ì„ ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.",
            "choices": ["ì‹œë‚˜ë¦¬ì˜¤ ì œì‘ ë°©ë²•", "ìš”ê¸ˆì œ ì•ˆë‚´", "ë¬¸ì˜í•˜ê¸°"]
        }