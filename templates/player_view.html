<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRPG Player Mode</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        rpg: {
                            900: '#020617',
                            800: '#0f172a',
                            700: '#1e293b',
                            accent: '#38bdf8',
                            hover: '#0ea5e9',
                            danger: '#ef4444',
                        }
                    },
                    fontFamily: {
                        title: ['Cinzel', 'serif'],
                        body: ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #020617 !important;
            color: #e2e8f0 !important;
            font-family: 'Inter', 'Noto Sans KR', sans-serif;
        }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }

        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .streaming-cursor { animation: blink 1s step-end infinite; color: #818cf8; }
        @keyframes blink { 50% { opacity: 0; } }

        .serif-font { font-family: 'Noto Sans KR', 'Inter', sans-serif; }

        /* íŒíŠ¸ í‚¤ì›Œë“œ í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ */
        mark {
            background: linear-gradient(120deg, rgba(251, 191, 36, 0.15) 0%, rgba(251, 191, 36, 0.2) 100%);
            color: #fbbf24;
            padding: 0.1em 0.3em;
            border-radius: 3px;
            font-weight: 500;
        }

        /* NPC ëŒ€í™”ì™€ ë‚˜ë ˆì´í„° êµ¬ë¶„ ìŠ¤íƒ€ì¼ */
        .npc-dialogue {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.15) 0%, rgba(202, 138, 4, 0.1) 100%);
            border-left: 4px solid #eab308;
        }

        .narrator-text {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(79, 70, 229, 0.05) 100%);
            border-left: 3px solid #6366f1;
        }

        /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
        input:disabled, button:disabled { cursor: not-allowed !important; opacity: 0.5; }
        input:disabled { background-color: #1f2937 !important; border-color: #374151 !important; color: #6b7280 !important; }
        button:disabled { background-color: #374151 !important; border-color: #4b5563 !important; }
        input:read-only:not(:disabled) { background-color: #1f2937; border-color: #fbbf24; cursor: wait; opacity: 0.7; }
        input:not(:disabled):not(:read-only):focus { border-color: #6366f1; box-shadow: 0 0 0 1px #6366f1; }

        .version-badge {
            position: fixed; bottom: 16px; right: 16px; font-size: 10px; color: #9ca3af;
            font-family: 'Courier New', monospace; z-index: 1000; pointer-events: none; user-select: none;
        }

        /* íƒ€ì´í•‘ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes typing-dot {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }
        .typing-dot:nth-child(1) { animation: typing-dot 1.4s infinite; }
        .typing-dot:nth-child(2) { animation: typing-dot 1.4s infinite 0.2s; }
        .typing-dot:nth-child(3) { animation: typing-dot 1.4s infinite 0.4s; }

        /* ìŠ¤í¬ë¡¤ë°” ì™„ì „ ì œê±° */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="min-h-screen flex flex-col selection:bg-rpg-accent selection:text-black">

<!-- ìƒë‹¨ í—¤ë” (index.html ìŠ¤íƒ€ì¼) -->
<header class="fixed top-0 left-0 w-full h-20 bg-rpg-900/90 backdrop-blur-md border-b border-rpg-700 z-50 px-8 flex items-center justify-between">
    <!-- ì™¼ìª½: ë¡œê³  -->
    <div class="flex items-center gap-3 cursor-pointer" onclick="location.href='/'">
        <div class="w-10 h-10 bg-rpg-accent rounded flex items-center justify-center shadow-[0_0_15px_#38bdf8]">
            <i data-lucide="sword" class="text-black w-6 h-6 fill-current"></i>
        </div>
        <span class="font-title text-2xl font-black text-white tracking-widest hover:text-rpg-accent transition-colors">TRPG.OS</span>
    </div>

    <!-- ì˜¤ë¥¸ìª½: AI ëª¨ë¸ ì„ íƒ & í”„ë¡œí•„ -->
    <div class="flex items-center gap-5">
        <!-- AI ëª¨ë¸ ì„ íƒ -->
        <div class="flex items-center gap-2">
            <label class="text-xs text-gray-400 font-medium">AI:</label>
            <select id="provider-select" onchange="updateModelVersions()"
                class="bg-rpg-800 border border-rpg-700 text-gray-200 text-xs rounded px-3 py-1.5 focus:outline-none focus:ring-1 focus:ring-rpg-accent hover:bg-rpg-800/80 transition-colors">
                <option value="google">ğŸ”· Google</option>
                <option value="anthropic">ğŸŸ£ Anthropic</option>
                <option value="openai">ğŸŸ¢ OpenAI</option>
                <option value="deepseek" selected>ğŸ”´ DeepSeek</option>
                <option value="meta">ğŸ”µ Meta</option>
                <option value="xai">âš« xAI</option>
                <option value="mistral">ğŸŸ  Mistral</option>
                <option value="xiaomi">ğŸŸ¡ Xiaomi</option>
            </select>

            <select id="model-version-select"
                class="bg-rpg-800 border border-rpg-700 text-gray-200 text-xs rounded px-3 py-1.5 focus:outline-none focus:ring-1 focus:ring-rpg-accent hover:bg-rpg-800/80 transition-colors min-w-[180px]">
                <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
            </select>
        </div>

        <div class="h-6 w-px bg-rpg-700"></div>

        <!-- ì‹œë‚˜ë¦¬ì˜¤ ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ -->
        <button id="load-btn" onclick="openLoadModal()"
                class="bg-rpg-accent hover:bg-rpg-hover text-black px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-bold transition-all hover:scale-105 shadow-[0_0_10px_rgba(56,189,248,0.3)]">
            <i data-lucide="folder-open" class="w-4 h-4"></i>
            <span class="hidden sm:inline">ì‹œë‚˜ë¦¬ì˜¤ ë¶ˆëŸ¬ì˜¤ê¸°</span>
        </button>

        <!-- ìœ ì € í”„ë¡œí•„ (index.htmlê³¼ ë™ì¼) -->
        <div hx-get="/api/views/header-profile"
             hx-trigger="load from:body"
             hx-swap="innerHTML">
             <div class="w-10 h-10 rounded-full bg-rpg-800 animate-pulse"></div>
        </div>
    </div>
</header>

<!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ (ì „ì²´ ë„ˆë¹„) -->
<div class="flex-1 flex pt-20 h-screen overflow-hidden">
    <div class="flex flex-1 overflow-hidden">
        <!-- ì±„íŒ… ì˜ì—­ -->
        <div class="flex-1 flex flex-col relative bg-rpg-900 overflow-hidden">

            <!-- ì‹œë‚˜ë¦¬ì˜¤ ë¡œë“œ ëª¨ë‹¬ -->
            <div id="load-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-gray-950/90 backdrop-blur-sm">
                <div class="bg-rpg-800 border border-rpg-700 rounded-xl w-full max-w-4xl h-[80vh] flex flex-col shadow-2xl overflow-hidden m-4">
                    <div class="p-4 border-b border-rpg-700 flex justify-between items-center bg-rpg-800">
                        <h3 class="text-xl font-bold text-white flex items-center gap-2">
                            <i data-lucide="folder-open" class="text-yellow-500"></i> ì €ì¥ëœ ì‹œë‚˜ë¦¬ì˜¤ ëª©ë¡
                        </h3>
                        <div class="flex items-center gap-3">
                            <select id="scenario-sort" onchange="reloadScenarioList()"
                                    class="bg-rpg-900 border border-rpg-700 text-gray-200 text-sm rounded px-3 py-1.5 focus:outline-none focus:ring-1 focus:ring-rpg-accent">
                                <option value="newest">ìµœì‹ ìˆœ</option>
                                <option value="oldest">ì˜¤ë˜ëœìˆœ</option>
                                <option value="name_asc">ì´ë¦„ ì˜¤ë¦„ì°¨ìˆœ</option>
                            </select>
                            <button onclick="closeLoadModal()" class="text-gray-400 hover:text-white p-2"><i data-lucide="x" class="w-6 h-6"></i></button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-6 bg-rpg-900">
                        <div id="scenario-list-container"
                             hx-get="/api/scenarios?sort=newest&filter=all"
                             hx-trigger="revealed"
                             class="grid gap-4 grid-cols-1 md:grid-cols-2">
                            <div class="col-span-1 md:col-span-2 text-center text-gray-500 py-12">
                                <i data-lucide="loader" class="w-8 h-8 mx-auto mb-2 animate-spin text-rpg-accent"></i>
                                <p>ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì±„íŒ… ë¡œê·¸ ì˜ì—­ (ë…ë¦½ ìŠ¤í¬ë¡¤) -->
            <div id="chat-log" class="flex-1 overflow-y-auto p-6 space-y-6 scroll-smooth">
                <!-- ì•Œë¦¼ ë©”ì‹œì§€ ì˜ì—­ -->
                <div id="init-result" class="mb-4"></div>

                <!-- ì´ˆê¸° ì•ˆë‚´ -->
                <div id="intro-message" class="flex gap-4 fade-in mb-4">
                    <div class="w-8 h-8 rounded-lg bg-indigo-900 flex items-center justify-center shrink-0">
                        <i data-lucide="bot" class="text-white w-4 h-4"></i>
                    </div>
                    <div class="flex-1">
                        <div class="text-indigo-400 text-xs font-bold mb-1">GM</div>
                        <div class="bg-rpg-800 border-rpg-700 p-3 rounded-lg border text-gray-300 text-sm leading-relaxed">
                            ì‹œìŠ¤í…œì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤. ìš°ì¸¡ ìƒë‹¨ì˜ <span class="text-rpg-accent font-bold">[ì‹œë‚˜ë¦¬ì˜¤ ë¶ˆëŸ¬ì˜¤ê¸°]</span> ë²„íŠ¼ì„ ëˆŒëŸ¬ ê²Œì„ì„ ë¡œë“œí•˜ì„¸ìš”.
                        </div>
                    </div>
                </div>

                <!-- AI ë¡œë”© ì¸ë””ì¼€ì´í„° -->
                <div id="ai-loading" class="hidden flex gap-4 fade-in">
                    <div class="w-8 h-8 rounded-lg bg-indigo-900 flex items-center justify-center shrink-0">
                        <i data-lucide="bot" class="text-white w-4 h-4"></i>
                    </div>
                    <div class="flex-1">
                        <div class="text-indigo-400 text-xs font-bold mb-1">GM</div>
                        <div id="loading-message" class="bg-rpg-800/50 border border-rpg-700/50 p-3 rounded-lg text-gray-400 text-sm flex flex-col gap-1">
                            <div class="flex items-center gap-2">
                                <div class="flex gap-1">
                                    <div class="w-1.5 h-1.5 bg-indigo-500 rounded-full typing-dot"></div>
                                    <div class="w-1.5 h-1.5 bg-indigo-500 rounded-full typing-dot"></div>
                                    <div class="w-1.5 h-1.5 bg-indigo-500 rounded-full typing-dot"></div>
                                </div>
                                <span id="loading-text" class="text-xs">ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>
                            </div>
                            <div id="response-timer" class="text-[10px] text-gray-500 font-mono">â± 0.0ì´ˆ</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì…ë ¥ì°½ (ê³ ì •) -->
            <div class="p-4 bg-rpg-900 border-t border-rpg-700">
                <form id="game-form" class="max-w-4xl mx-auto flex gap-2">
                    <input type="text" name="action" autofocus autocomplete="off"
                           class="flex-1 bg-rpg-800 border border-rpg-700 text-white rounded-lg px-4 py-3 focus:outline-none focus:border-rpg-accent focus:ring-1 focus:ring-rpg-accent placeholder-gray-500"
                           placeholder="ì–´ë–¤ í–‰ë™ì„ í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì˜ˆ: ë¬¸ì„ ì—°ë‹¤, ì£¼ë³€ì„ ì‚´í´ë³¸ë‹¤...)">
                    <button type="submit" class="bg-rpg-accent hover:bg-rpg-hover text-black px-6 py-3 rounded-lg font-bold transition-colors">
                        <i data-lucide="send"></i>
                    </button>
                </form>
            </div>
        </div>

        <!-- ìŠ¤íƒ¯ ì‚¬ì´ë“œë°” (ë…ë¦½ ìŠ¤í¬ë¡¤) -->
        <div class="w-80 bg-rpg-800 border-l border-rpg-700 overflow-hidden hidden lg:flex flex-col">
            <!-- í—¤ë” (ê³ ì •) -->
            <div class="p-4 border-b border-rpg-700 shrink-0">
                <div class="flex items-center justify-between">
                    <h3 class="text-gray-400 font-bold flex items-center gap-2">
                        <i data-lucide="user" class="w-4 h-4"></i>
                        PLAYER STATUS
                    </h3>
                    <button type="button" onclick="toggleDebugInfo()" class="cursor-pointer group hover:bg-rpg-900 rounded p-1 transition-colors" title="ë””ë²„ê·¸ ëª¨ë“œ">
                        <i id="debug-icon" data-lucide="bug" class="w-4 h-4 text-gray-500 group-hover:text-rpg-accent transition-colors"></i>
                    </button>
                </div>
            </div>

            <!-- ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ì½˜í…ì¸  ì˜ì—­ -->
            <div class="flex-1 overflow-y-auto p-4">
                <div id="player-stats-area">
                    {% if vars %}
                        <!-- ì„œë²„ ì‚¬ì´ë“œ ë Œë”ë§ ìœ ì§€ -->
                        <div class="bg-rpg-900 rounded-lg p-4 border border-rpg-700 shadow-sm mb-4">
                            <!-- ... stats content ... -->
                        </div>
                    {% else %}
                        <div class="text-gray-500 text-sm text-center py-4 bg-rpg-800/50 rounded-lg border border-rpg-700 border-dashed">
                            <i data-lucide="ghost" class="w-6 h-6 mx-auto mb-2 opacity-50"></i>
                            ë°ì´í„° ì—†ìŒ<br>
                            <span class="text-xs">ìƒë‹¨ [ì‹œë‚˜ë¦¬ì˜¤ ë¶ˆëŸ¬ì˜¤ê¸°]ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</span>
                        </div>
                    {% endif %}
                </div>

                <!-- ë””ë²„ê·¸ ì •ë³´ ì˜ì—­ -->
                <div id="debug-info-area" class="hidden mt-4 space-y-4">
                    <!-- ì „ì²´ ì”¬ ë³´ê¸° ë²„íŠ¼ -->
                    <div class="border-t border-rpg-700 pt-4">
                        <button onclick="openDebugScenesView()"
                                class="w-full bg-gradient-to-r from-pink-900/80 to-purple-900/80 hover:from-pink-800 hover:to-purple-800 text-white py-3 rounded-lg border border-pink-700/50 flex items-center justify-center gap-2 text-sm font-bold transition-all shadow-lg hover:shadow-pink-500/20">
                            <i data-lucide="git-merge" class="w-4 h-4"></i>
                            <span>ì „ì²´ ì”¬ ë³´ê¸°</span>
                        </button>
                    </div>

                    <!-- ì„¸ì…˜ ID í‘œì‹œ -->
                    <div class="bg-rpg-900/50 rounded p-2 border border-rpg-700/50">
                        <div class="text-gray-500 text-[10px] mb-1 flex items-center gap-1">
                            <i data-lucide="key" class="w-2.5 h-2.5"></i>
                            Session ID
                        </div>
                        <div id="session-id-display" class="text-gray-300 text-xs font-mono break-all">
                            ì„¸ì…˜ ì—†ìŒ
                        </div>
                    </div>

                    <!-- NPC ìƒíƒœ -->
                    <div class="border-t border-rpg-700 pt-4">
                        <h4 class="text-gray-400 font-bold text-sm mb-3 flex items-center gap-2">
                            <i data-lucide="users" class="w-3.5 h-3.5"></i>
                            NPC STATUS
                        </h4>
                        <div id="npc-status-area" class="space-y-2">
                            <div class="text-gray-500 text-xs text-center py-2 bg-rpg-800/50 rounded border border-rpg-700 border-dashed">
                                NPC ë°ì´í„° ì—†ìŒ
                            </div>
                        </div>
                    </div>

                    <!-- World State Manager -->
                    <div class="border-t border-rpg-700 pt-4 mb-10">
                        <h4 class="text-gray-400 font-bold text-sm mb-3 flex items-center gap-2">
                            <i data-lucide="globe" class="w-3.5 h-3.5"></i>
                            WORLD STATE
                        </h4>
                        <div id="world-state-area" class="text-xs">
                            <div class="text-gray-500 text-xs text-center py-2 bg-rpg-800/50 rounded border border-rpg-700 border-dashed">
                                World State ë°ì´í„° ì—†ìŒ
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', path='/js/player/constants.js') }}"></script>
<script src="{{ url_for('static', path='/js/player/api_service.js') }}"></script>
<script src="{{ url_for('static', path='/js/player/ui_manager.js') }}"></script>
<script src="{{ url_for('static', path='/js/player/debug_module.js') }}"></script>
<script src="{{ url_for('static', path='/js/player/main.js') }}"></script>

<!-- ë²„ì „ í‘œì‹œ -->
<div class="version-badge">v{{ version }}</div>

</body>
</html>
