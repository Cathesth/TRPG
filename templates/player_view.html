<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRPG Player Mode</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Pretendard', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }

        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .streaming-cursor { animation: blink 1s step-end infinite; color: #818cf8; }
        @keyframes blink { 50% { opacity: 0; } }

        .serif-font { font-family: 'Noto Sans KR', 'Pretendard', sans-serif; }

        /* íŒíŠ¸ í‚¤ì›Œë“œ í•˜ì´ë¼ì´íŠ¸ ìŠ¤íƒ€ì¼ (Game Engine ì—°ë™) */
        mark {
            background: linear-gradient(120deg, rgba(251, 191, 36, 0.15) 0%, rgba(251, 191, 36, 0.2) 100%);
            color: #fbbf24;
            padding: 0.1em 0.3em;
            border-radius: 3px;
            font-weight: 500;
        }

        /* NPC ëŒ€í™”ì™€ ë‚˜ë ˆì´í„° êµ¬ë¶„ ìŠ¤íƒ€ì¼ */
        .npc-dialogue {
            background: linear-gradient(135deg, rgba(234, 179, 8, 0.15) 0%, rgba(202, 138, 4, 0.1) 100%);
            border-left: 4px solid #eab308;
        }

        .narrator-text {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(79, 70, 229, 0.05) 100%);
            border-left: 3px solid #6366f1;
        }

        .brand-gradient {
            background: linear-gradient(135deg, #6E47E6 0%, #818cf8 100%);
        }

        /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
        .sidebar { width: 72px; transition: width 0.3s ease; }
        .sidebar:hover, .sidebar.expanded { width: 260px; }
        .sidebar .nav-text, .sidebar .logo-text, .sidebar .section-title, .sidebar .user-info, .sidebar .user-chevron {
            opacity: 0; white-space: nowrap; transition: opacity 0.2s ease;
        }
        .sidebar:hover .nav-text, .sidebar.expanded .nav-text,
        .sidebar:hover .logo-text, .sidebar.expanded .logo-text,
        .sidebar:hover .section-title, .sidebar.expanded .section-title,
        .sidebar:hover .user-info, .sidebar.expanded .user-info,
        .sidebar:hover .user-chevron, .sidebar.expanded .user-chevron { opacity: 1; }

        /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
        input:disabled, button:disabled { cursor: not-allowed !important; opacity: 0.5; }
        input:disabled { background-color: #1f2937 !important; border-color: #374151 !important; color: #6b7280 !important; }
        button:disabled { background-color: #374151 !important; border-color: #4b5563 !important; }
        input:read-only:not(:disabled) { background-color: #1f2937; border-color: #fbbf24; cursor: wait; opacity: 0.7; }
        input:not(:disabled):not(:read-only):focus { border-color: #6366f1; box-shadow: 0 0 0 1px #6366f1; }

        .version-badge {
            position: fixed; bottom: 16px; right: 16px; font-size: 10px; color: #6b7280;
            font-family: 'Courier New', monospace; z-index: 1000; pointer-events: none; user-select: none;
        }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: { 900: '#111111', 800: '#1c1c1c', 700: '#2c2c2c', 600: '#3f3f46' },
                        brand: { purple: '#6E47E6', light: '#9F7AEA' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-dark-900 text-gray-200 h-screen flex overflow-hidden">

<!-- ì‚¬ì´ë“œë°” -->
<div class="sidebar bg-dark-800 border-r border-white/5 flex flex-col hidden md:flex shrink-0 z-20 overflow-hidden">
    <div class="p-4 h-16 flex items-center">
        <div class="flex items-center gap-2 cursor-pointer" onclick="location.href='/'">
            <div class="w-10 h-10 brand-gradient rounded-lg flex items-center justify-center text-white shadow-lg shadow-brand-purple/20 shrink-0">
                <i data-lucide="dice-5" class="w-5 h-5 fill-current"></i>
            </div>
            <span class="logo-text text-xl font-bold text-white tracking-tight">TRPG Studio</span>
        </div>
    </div>

    <nav class="flex-1 px-3 space-y-1 mt-2">
        <div class="section-title text-[10px] font-semibold text-gray-500 px-3 py-2 uppercase tracking-wider">Workspace</div>
        <a href="/" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-400 hover:bg-white/5 hover:text-white group cursor-pointer text-sm font-medium transition-colors">
            <i data-lucide="layout-grid" class="w-5 h-5 text-gray-500 group-hover:text-gray-300 shrink-0"></i>
            <span class="nav-text">ëŒ€ì‹œë³´ë“œ</span>
        </a>
        <a href="/views/builder" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-400 hover:bg-white/5 hover:text-white group cursor-pointer text-sm font-medium transition-colors">
            <i data-lucide="pen-tool" class="w-5 h-5 text-gray-500 group-hover:text-gray-300 shrink-0"></i>
            <span class="nav-text">ì‹œë‚˜ë¦¬ì˜¤ ë¹Œë”</span>
        </a>
        <a href="/views/player" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg bg-white/5 text-white group cursor-pointer text-sm font-medium">
            <i data-lucide="gamepad-2" class="w-5 h-5 text-brand-light shrink-0"></i>
            <span class="nav-text">í”Œë ˆì´ì–´ ëª¨ë“œ</span>
        </a>
        <a href="/views/scenes" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-400 hover:bg-white/5 hover:text-white group cursor-pointer text-sm font-medium transition-colors">
            <i data-lucide="git-merge" class="w-5 h-5 text-gray-500 group-hover:text-gray-300 shrink-0"></i>
            <span class="nav-text">ì „ì²´ ì”¬ ë³´ê¸°</span>
        </a>
    </nav>
    <div class="p-3 border-t border-white/5">
        <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 cursor-pointer transition-colors">
            <img src="https://api.dicebear.com/7.x/notionists/svg?seed=Felix" alt="User" class="w-8 h-8 rounded-full bg-gray-700 shrink-0">
            <div class="user-info flex-1 min-w-0">
                <p class="text-sm font-medium text-white truncate">Game Master</p>
                <p class="text-[11px] text-gray-500 truncate">Free Plan</p>
            </div>
            <i data-lucide="chevron-right" class="user-chevron w-4 h-4 text-gray-500"></i>
        </div>
    </div>
</div>

<!-- ë©”ì¸ ë·° -->
<div class="flex-1 flex flex-col h-full relative z-10 bg-dark-900 overflow-hidden">

    <!-- ìƒë‹¨ í—¤ë” -->
    <header class="h-16 border-b border-white/5 flex items-center justify-between px-6 bg-dark-900/80 backdrop-blur-md sticky top-0 z-20">
        <div class="flex items-center gap-4">
            <div class="text-indigo-400 font-bold flex items-center gap-2">
                <i data-lucide="gamepad-2" class="w-5 h-5"></i>
                í”Œë ˆì´ì–´ ëª¨ë“œ
            </div>
            <div class="flex items-center gap-2 ml-4">
                <label class="text-xs text-gray-400 font-medium">AI ì œê³µì‚¬:</label>
                <select id="provider-select" onchange="updateModelVersions()"
                    class="bg-gray-800 border border-gray-700 text-gray-200 text-xs rounded px-3 py-1.5 focus:outline-none focus:ring-1 focus:ring-indigo-500 hover:bg-gray-750 transition-colors">
                    <option value="google">ğŸ”· Google</option>
                    <option value="anthropic">ğŸŸ£ Anthropic</option>
                    <option value="openai">ğŸŸ¢ OpenAI</option>
                    <option value="deepseek" selected>ğŸ”´ DeepSeek</option>
                    <option value="meta">ğŸ”µ Meta</option>
                    <option value="xai">âš« xAI</option>
                    <option value="mistral">ğŸŸ  Mistral</option>
                    <option value="xiaomi">ğŸŸ¡ Xiaomi</option>
                </select>

                <label class="text-xs text-gray-400 font-medium">ëª¨ë¸ ë²„ì „:</label>
                <select id="model-version-select"
                    class="bg-gray-800 border border-gray-700 text-gray-200 text-xs rounded px-3 py-1.5 focus:outline-none focus:ring-1 focus:ring-indigo-500 hover:bg-gray-750 transition-colors min-w-[200px]">
                    <!-- JavaScriptë¡œ ë™ì  ìƒì„± -->
                </select>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button id="scenes-btn" onclick="openScenesView()" disabled
               class="bg-pink-900/80 hover:bg-pink-800 text-pink-200 px-4 py-2 rounded-lg border border-pink-700/50 flex items-center gap-2 text-sm font-bold transition-all hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100">
                <i data-lucide="git-merge" class="w-4 h-4"></i>
                <span class="hidden sm:inline">ì „ì²´ ì”¬ ë³´ê¸°</span>
            </button>
            <button id="load-btn" onclick="openLoadModal()"
                    class="bg-indigo-900/80 hover:bg-indigo-800 text-indigo-200 px-4 py-2 rounded-lg border border-indigo-700/50 flex items-center gap-2 text-sm font-bold transition-all hover:scale-105">
                <i data-lucide="folder-open" class="w-4 h-4"></i>
                <span class="hidden sm:inline">ì‹œë‚˜ë¦¬ì˜¤ ë¶ˆëŸ¬ì˜¤ê¸°</span>
            </button>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <!-- ì±„íŒ… ì˜ì—­ -->
        <div class="flex-1 flex flex-col relative bg-dark-900">

            <!-- ì‹œë‚˜ë¦¬ì˜¤ ë¡œë“œ ëª¨ë‹¬ -->
            <div id="load-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-gray-950/90 backdrop-blur-sm">
                <div class="bg-gray-900 border border-gray-700 rounded-xl w-full max-w-4xl h-[80vh] flex flex-col shadow-2xl overflow-hidden m-4">
                    <div class="p-4 border-b border-gray-800 flex justify-between items-center bg-gray-800">
                        <h3 class="text-xl font-bold text-white flex items-center gap-2">
                            <i data-lucide="folder-open" class="text-yellow-500"></i> ì €ì¥ëœ ì‹œë‚˜ë¦¬ì˜¤ ëª©ë¡
                        </h3>
                        <div class="flex items-center gap-3">
                            <select id="scenario-sort" onchange="reloadScenarioList()"
                                    class="bg-gray-700 border border-gray-600 text-gray-200 text-sm rounded px-3 py-1.5 focus:outline-none focus:ring-1 focus:ring-indigo-500">
                                <option value="newest">ìµœì‹ ìˆœ</option>
                                <option value="oldest">ì˜¤ë˜ëœìˆœ</option>
                                <option value="name_asc">ì´ë¦„ ì˜¤ë¦„ì°¨ìˆœ</option>
                            </select>
                            <button onclick="closeLoadModal()" class="text-gray-400 hover:text-white p-2"><i data-lucide="x" class="w-6 h-6"></i></button>
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-6 bg-gray-900">
                        <div id="scenario-list-container"
                             hx-get="/api/scenarios?sort=newest&filter=all"
                             hx-trigger="revealed"
                             class="grid gap-4 grid-cols-1 md:grid-cols-2">
                            <div class="col-span-1 md:col-span-2 text-center text-gray-500 py-12">
                                <i data-lucide="loader" class="w-8 h-8 mx-auto mb-2 animate-spin text-indigo-500"></i>
                                <p>ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="chat-log" class="flex-1 overflow-y-auto p-6 space-y-6 pb-24 scroll-smooth">
                <!-- ì•Œë¦¼ ë©”ì‹œì§€ ì˜ì—­ -->
                <div id="init-result" class="mb-4"></div>

                <!-- ì´ˆê¸° ì•ˆë‚´ -->
                <div id="intro-message" class="flex gap-4 fade-in mb-4">
                    <div class="w-8 h-8 rounded-lg bg-indigo-900 flex items-center justify-center shrink-0">
                        <i data-lucide="bot" class="text-white w-4 h-4"></i>
                    </div>
                    <div class="flex-1">
                        <div class="text-indigo-400 text-xs font-bold mb-1">GM</div>
                        <div class="bg-[#1a1a1e] border-gray-700 p-3 rounded-lg border text-gray-300 text-sm leading-relaxed">
                            ì‹œìŠ¤í…œì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤. ìš°ì¸¡ ìƒë‹¨ì˜ <span class="text-indigo-400 font-bold">[ì‹œë‚˜ë¦¬ì˜¤ ë¶ˆëŸ¬ì˜¤ê¸°]</span> ë²„íŠ¼ì„ ëˆŒëŸ¬ ê²Œì„ì„ ë¡œë“œí•˜ì„¸ìš”.
                        </div>
                    </div>
                </div>

                <!-- AI ë¡œë”© ì¸ë””ì¼€ì´í„° -->
                <div id="ai-loading" class="hidden flex gap-4 fade-in">
                    <div class="w-8 h-8 rounded-lg bg-indigo-900 flex items-center justify-center shrink-0">
                        <i data-lucide="bot" class="text-white w-4 h-4"></i>
                    </div>
                    <div class="flex-1">
                        <div class="text-indigo-400 text-xs font-bold mb-1">GM</div>
                        <div id="loading-message" class="bg-[#1a1a1e]/50 border border-gray-700/50 p-3 rounded-lg text-gray-400 text-sm flex flex-col gap-1">
                            <div class="flex items-center gap-2">
                                <div class="flex gap-1">
                                    <div class="w-1.5 h-1.5 bg-indigo-500 rounded-full typing-dot"></div>
                                    <div class="w-1.5 h-1.5 bg-indigo-500 rounded-full typing-dot"></div>
                                    <div class="w-1.5 h-1.5 bg-indigo-500 rounded-full typing-dot"></div>
                                </div>
                                <span id="loading-text" class="text-xs">ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>
                            </div>
                            <div id="response-timer" class="text-[10px] text-gray-500 font-mono">â± 0.0ì´ˆ</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ì…ë ¥ì°½ (ìì—°ì–´ ì…ë ¥ ì¤‘ì‹¬) -->
            <div class="p-4 bg-gray-900 border-t border-gray-800 absolute bottom-0 w-full z-20">
                <form id="game-form" class="max-w-4xl mx-auto flex gap-2">
                    <input type="text" name="action" autofocus autocomplete="off"
                           class="flex-1 bg-gray-800 border border-gray-700 text-white rounded-lg px-4 py-3 focus:outline-none focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 placeholder-gray-500"
                           placeholder="ì–´ë–¤ í–‰ë™ì„ í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì˜ˆ: ë¬¸ì„ ì—°ë‹¤, ì£¼ë³€ì„ ì‚´í´ë³¸ë‹¤...)">
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-bold transition-colors">
                        <i data-lucide="send"></i>
                    </button>
                </form>
            </div>
        </div>

        <!-- ìŠ¤íƒ¯ ì‚¬ì´ë“œë°” -->
        <div class="w-80 bg-gray-900 border-l border-gray-800 p-4 overflow-y-auto hidden lg:block">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-gray-400 font-bold flex items-center gap-2">
                    <i data-lucide="user" class="w-4 h-4"></i>
                    PLAYER STATUS
                </h3>
                <label class="flex items-center gap-1.5 cursor-pointer group" title="ë””ë²„ê·¸ ëª¨ë“œ">
                    <input type="checkbox" id="debug-toggle" class="w-3.5 h-3.5 rounded border-gray-600 bg-gray-800 text-indigo-600 focus:ring-1 focus:ring-indigo-500 focus:ring-offset-0 cursor-pointer" onchange="toggleDebugInfo()">
                    <i data-lucide="bug" class="w-3.5 h-3.5 text-gray-500 group-hover:text-indigo-400 transition-colors"></i>
                </label>
            </div>
            <div id="player-stats-area">
                {% if vars %}
                    <!-- ì„œë²„ ì‚¬ì´ë“œ ë Œë”ë§ ìœ ì§€ -->
                    <div class="bg-[#1a1e2e] rounded-lg p-4 border border-[#2d2d35] shadow-sm mb-4">
                        <!-- ... stats content ... -->
                    </div>
                {% else %}
                    <div class="text-gray-500 text-sm text-center py-4 bg-gray-800/50 rounded-lg border border-gray-700 border-dashed">
                        <i data-lucide="ghost" class="w-6 h-6 mx-auto mb-2 opacity-50"></i>
                        ë°ì´í„° ì—†ìŒ<br>
                        <span class="text-xs">ìƒë‹¨ [ì‹œë‚˜ë¦¬ì˜¤ ë¶ˆëŸ¬ì˜¤ê¸°]ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</span>
                    </div>
                {% endif %}
            </div>

            <!-- ë””ë²„ê·¸ ì •ë³´ ì˜ì—­ (ì²´í¬ë°•ìŠ¤ í™œì„±í™” ì‹œ í‘œì‹œ) -->
            <div id="debug-info-area" class="hidden mt-4 space-y-4">
                <!-- NPC ìƒíƒœ -->
                <div class="border-t border-gray-800 pt-4">
                    <h4 class="text-gray-400 font-bold text-sm mb-3 flex items-center gap-2">
                        <i data-lucide="users" class="w-3.5 h-3.5"></i>
                        NPC STATUS
                    </h4>
                    <div id="npc-status-area" class="space-y-2">
                        <div class="text-gray-500 text-xs text-center py-2 bg-gray-800/50 rounded border border-gray-700 border-dashed">
                            NPC ë°ì´í„° ì—†ìŒ
                        </div>
                    </div>
                </div>

                <!-- World State Manager -->
                <div class="border-t border-gray-800 pt-4">
                    <h4 class="text-gray-400 font-bold text-sm mb-3 flex items-center gap-2">
                        <i data-lucide="globe" class="w-3.5 h-3.5"></i>
                        WORLD STATE
                    </h4>
                    <div id="world-state-area" class="text-xs">
                        <div class="text-gray-500 text-xs text-center py-2 bg-gray-800/50 rounded border border-gray-700 border-dashed">
                            World State ë°ì´í„° ì—†ìŒ
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ì„œë²„ ìƒíƒœëŠ” ë¬´ì‹œí•˜ê³  í•­ìƒ ì´ˆê¸°í™”ëœ ìƒíƒœë¡œ ì‹œì‘
    const serverHasState = false;  // í•­ìƒ falseë¡œ ì„¤ì •í•˜ì—¬ ì„œë²„ ìƒíƒœ ë¬´ì‹œ

    let isGameEnded = false;
    let isScenarioLoaded = false;
    let isInternalNavigation = false;  // ë‚´ë¶€ ë„¤ë¹„ê²Œì´ì…˜ í”Œë˜ê·¸
    let hasGameStarted = false;  // ê²Œì„ì´ ì‹œì‘ë˜ì—ˆëŠ”ì§€ (ì±„íŒ… ë‚´ì—­ì´ ìˆëŠ”ì§€)
    let isStreaming = false;  // ìŠ¤íŠ¸ë¦¬ë° ì¤‘ ì—¬ë¶€ ì¶”ê°€
    let responseTimerInterval = null;  // ì‘ë‹µ ì‹œê°„ íƒ€ì´ë¨¸
    let responseStartTime = null;  // ì‘ë‹µ ì‹œì‘ ì‹œê°„
    let currentSessionKey = '';  // í˜„ì¬ ì„¸ì…˜ í‚¤ ì €ì¥

    // ìƒìˆ˜ ì •ì˜
    const CHAT_LOG_KEY = 'trpg_chat_log';
    const SCENARIO_LOADED_KEY = 'trpg_scenario_loaded';
    const CURRENT_SCENARIO_KEY = 'trpg_current_scenario';
    const STATS_KEY = 'trpg_player_stats';
    const MODEL_PROVIDER_KEY = 'trpg_model_provider';
    const MODEL_VERSION_KEY = 'trpg_model_version';
    const DEBUG_MODE_KEY = 'trpg_debug_mode';
    const GAME_ENDED_KEY = 'trpg_game_ended';
    const NAVIGATION_FLAG_KEY = 'trpg_navigation_flag';

    // ìƒˆë¡œê³ ì¹¨ ê°ì§€ ë° ê²½ê³ 
    window.addEventListener('beforeunload', function(e) {
        // ìŠ¤íŠ¸ë¦¬ë° ì¤‘ì´ë©´ ë¬´ì¡°ê±´ ê²½ê³ 
        if (isStreaming) {
            e.preventDefault();
            e.returnValue = 'AIê°€ ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ë²—ì–´ë‚˜ì‹œê² ìŠµë‹ˆê¹Œ?';
            return e.returnValue;
        }

        // ë‚´ë¶€ ë„¤ë¹„ê²Œì´ì…˜ì´ë©´ ê²½ê³  ì•ˆ í•¨
        if (isInternalNavigation) {
            // ë‚´ë¶€ ë„¤ë¹„ê²Œì´ì…˜ í”Œë˜ê·¸ ì„¤ì • (ë‹¤ìŒ í˜ì´ì§€ ë¡œë“œ ì‹œ ë³µì›ìš©)
            sessionStorage.setItem(NAVIGATION_FLAG_KEY, 'true');
            return;
        }

        // ê²Œì„ì´ ì§„í–‰ ì¤‘ì´ë©´ ê²½ê³  (ì±„íŒ… ë¡œê·¸ê°€ ìˆê³  ê²Œì„ì´ ì‹œì‘ë¨)
        if (hasGameStarted && isScenarioLoaded) {
            e.preventDefault();
            e.returnValue = 'í˜ì´ì§€ë¥¼ ë²—ì–´ë‚˜ë©´ í˜„ì¬ ì§„í–‰ ë‚´ì—­ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?';
            return e.returnValue;
        }
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ìƒíƒœ ë³µì› ë˜ëŠ” ì´ˆê¸°í™”
    (function() {
        // ë‚´ë¶€ ë„¤ë¹„ê²Œì´ì…˜ìœ¼ë¡œ ëŒì•„ì˜¨ ê²½ìš° (ì „ì²´ ì”¬ ë³´ê¸° -> í”Œë ˆì´ì–´ ëª¨ë“œ)
        const isReturningFromNavigation = sessionStorage.getItem(NAVIGATION_FLAG_KEY) === 'true';
        sessionStorage.removeItem(NAVIGATION_FLAG_KEY);  // í”Œë˜ê·¸ ì œê±°

        // ì €ì¥ëœ ê²Œì„ ìƒíƒœê°€ ìˆëŠ”ì§€ í™•ì¸
        const hasSavedGame = sessionStorage.getItem(CHAT_LOG_KEY) || sessionStorage.getItem(SCENARIO_LOADED_KEY);

        // ë‚´ë¶€ ë„¤ë¹„ê²Œì´ì…˜ìœ¼ë¡œ ëŒì•„ì™”ê±°ë‚˜ ì €ì¥ëœ ê²Œì„ì´ ìˆìœ¼ë©´ ë³µì›
        if (isReturningFromNavigation || hasSavedGame) {
            console.log('ğŸ”„ ê²Œì„ ìƒíƒœ ë³µì› ì¤‘...');
            // ë³µì›ì€ DOMContentLoadedì—ì„œ restoreChatLog()ê°€ ì²˜ë¦¬
            return;
        }

        // ì™„ì „íˆ ìƒˆë¡œìš´ ì‹œì‘ (ì²« ë°©ë¬¸ ë˜ëŠ” ìˆ˜ë™ ìƒˆë¡œê³ ì¹¨)
        console.log('ğŸ†• ìƒˆë¡œìš´ ê²Œì„ ì„¸ì…˜ ì‹œì‘');
        clearAllGameState();

        // UI ì´ˆê¸°í™”
        const chatLog = document.getElementById('chat-log');
        const initResult = document.getElementById('init-result');
        const aiLoading = document.getElementById('ai-loading');

        if (chatLog && initResult && aiLoading) {
            // ì´ˆê¸° ë©”ì‹œì§€ë§Œ ë‚¨ê¸°ê³  ëª¨ë‘ ì œê±°
            chatLog.innerHTML = '';
            chatLog.appendChild(initResult);

            // ì´ˆê¸° ì•ˆë‚´ ë©”ì‹œì§€ ë³µì›
            const introHtml = `
                <div id="intro-message" class="flex gap-4 fade-in mb-4">
                    <div class="w-8 h-8 rounded-lg bg-indigo-900 flex items-center justify-center shrink-0">
                        <i data-lucide="bot" class="text-white w-4 h-4"></i>
                    </div>
                    <div class="flex-1">
                        <div class="text-indigo-400 text-xs font-bold mb-1">GM</div>
                        <div class="bg-[#1a1a1e] border-gray-700 p-3 rounded-lg border text-gray-300 text-sm leading-relaxed">
                            ì‹œìŠ¤í…œì— ì ‘ì†í–ˆìŠµë‹ˆë‹¤. ìš°ì¸¡ ìƒë‹¨ì˜ <span class="text-indigo-400 font-bold">[ì‹œë‚˜ë¦¬ì˜¤ ë¶ˆëŸ¬ì˜¤ê¸°]</span> ë²„íŠ¼ì„ ëˆŒëŸ¬ ê²Œì„ì„ ë¡œë“œí•˜ì„¸ìš”.
                        </div>
                    </div>
                </div>
            `;
            initResult.insertAdjacentHTML('afterend', introHtml);
            chatLog.appendChild(aiLoading);

            // ìŠ¤íƒ¯ ì˜ì—­ ì´ˆê¸°í™”
            const statsArea = document.getElementById('player-stats-area');
            if (statsArea) {
                statsArea.innerHTML = `
                    <div class="text-gray-500 text-sm text-center py-4 bg-gray-800/50 rounded-lg border border-gray-700 border-dashed">
                        <i data-lucide="ghost" class="w-6 h-6 mx-auto mb-2 opacity-50"></i>
                        ë°ì´í„° ì—†ìŒ<br>
                        <span class="text-xs">ìƒë‹¨ [ì‹œë‚˜ë¦¬ì˜¤ ë¶ˆëŸ¬ì˜¤ê¸°]ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.</span>
                    </div>
                `;
            }

            // UI ë¹„í™œì„±í™”
            disableGameUI();
        }
    })();

    // ëª¨ë“  ê²Œì„ ìƒíƒœ ì´ˆê¸°í™” í•¨ìˆ˜
    function clearAllGameState() {
        sessionStorage.removeItem(CHAT_LOG_KEY);
        sessionStorage.removeItem(STATS_KEY);
        sessionStorage.removeItem(GAME_ENDED_KEY);
        sessionStorage.removeItem(SCENARIO_LOADED_KEY);
        sessionStorage.removeItem(CURRENT_SCENARIO_KEY);
        isGameEnded = false;
        isScenarioLoaded = false;
        hasGameStarted = false;
        isStreaming = false;
    }

    function openScenesView() {
        if (isScenarioLoaded) {
            isInternalNavigation = true;
            window.location.href = '/views/scenes';
        }
    }

    function enableGameUI() {
        isScenarioLoaded = true;
        sessionStorage.setItem(SCENARIO_LOADED_KEY, 'true');
        const form = document.getElementById('game-form');
        const input = form.querySelector('input[name="action"]');
        const submitBtn = form.querySelector('button[type="submit"]');

        if (input) {
            input.disabled = false;
            // ìˆ«ì ì…ë ¥ ì˜ˆì‹œ ì œê±°, í–‰ë™ ì¤‘ì‹¬ ì•ˆë‚´
            input.placeholder = "ì–´ë–¤ í–‰ë™ì„ í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì˜ˆ: ë¬¸ì„ ì—°ë‹¤, ì‚´í´ë³¸ë‹¤...)";
            input.classList.remove('opacity-50', 'cursor-not-allowed');
        }
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
        const scenesBtn = document.getElementById('scenes-btn');
        if (scenesBtn) scenesBtn.disabled = false;
    }

    function disableGameUI() {
        isScenarioLoaded = false;
        const form = document.getElementById('game-form');
        const input = form.querySelector('input[name="action"]');
        const submitBtn = form.querySelector('button[type="submit"]');

        if (input) {
            input.disabled = true;
            input.placeholder = "ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë¨¼ì € ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”...";
            input.classList.add('opacity-50', 'cursor-not-allowed');
        }
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
        const scenesBtn = document.getElementById('scenes-btn');
        if (scenesBtn) scenesBtn.disabled = true;
    }

    function restoreChatLog() {
        const savedLog = sessionStorage.getItem(CHAT_LOG_KEY);
        const savedStats = sessionStorage.getItem(STATS_KEY);
        const savedGameEnded = sessionStorage.getItem(GAME_ENDED_KEY);
        const savedScenarioLoaded = sessionStorage.getItem(SCENARIO_LOADED_KEY);

        if (savedLog) {
            const chatLog = document.getElementById('chat-log');
            const initResult = document.getElementById('init-result');
            const aiLoading = document.getElementById('ai-loading');

            chatLog.innerHTML = '';
            chatLog.appendChild(initResult);
            initResult.insertAdjacentHTML('afterend', savedLog);
            chatLog.appendChild(aiLoading);

            const intro = document.getElementById('intro-message');
            if (intro) intro.remove();

            lucide.createIcons();
            chatLog.scrollTo({ top: chatLog.scrollHeight, behavior: 'auto' });
        } else if (savedScenarioLoaded === 'true') {
            const intro = document.getElementById('intro-message');
            if (intro) intro.remove();
            const initResult = document.getElementById('init-result');
            initResult.innerHTML = `
            <div class="bg-green-900/30 border border-green-800 text-green-400 p-4 rounded-lg flex items-center gap-3 fade-in mt-4">
                <i data-lucide="check-circle" class="w-6 h-6"></i>
                <div>
                    <div class="font-bold">ë¡œë“œ ì™„ë£Œ!</div>
                    <div class="text-sm opacity-80">ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ê±°ë‚˜ ì±„íŒ…ì°½ì— "ì‹œì‘"ì„ ì…ë ¥í•˜ì„¸ìš”.</div>
                </div>
            </div>
            <button onclick="submitGameAction('ì‹œì‘')"
                    class="mt-3 w-full bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 transition-all hover:scale-[1.02] shadow-lg">
                <i data-lucide="play" class="w-5 h-5"></i>
                ê²Œì„ ì‹œì‘í•˜ê¸°
            </button>
            `;
            lucide.createIcons();
        }

        if (savedStats) {
            try { updateStats(JSON.parse(savedStats)); } catch (e) {}
        }

        if (savedGameEnded === 'true') {
            isGameEnded = true;
            disableInput();
        }

        if (savedScenarioLoaded === 'true') enableGameUI();
        else disableGameUI();
    }

    function saveChatLog() {
        const chatLog = document.getElementById('chat-log');
        let content = '';
        for (const child of chatLog.children) {
            if (child.id !== 'init-result' && child.id !== 'ai-loading') {
                content += child.outerHTML;
            }
        }
        sessionStorage.setItem(CHAT_LOG_KEY, content);
        sessionStorage.setItem(GAME_ENDED_KEY, isGameEnded.toString());
    }

    function clearChatLog() {
        sessionStorage.removeItem(CHAT_LOG_KEY);
        sessionStorage.removeItem(STATS_KEY);
        sessionStorage.removeItem(GAME_ENDED_KEY);
    }

    function submitGameAction(actionText) {
        if (isGameEnded) return;
        submitWithStreaming(actionText);
    }

    function disableInput() {
        isGameEnded = true;
        const form = document.getElementById('game-form');
        const input = form.querySelector('input[name="action"]');
        const submitBtn = form.querySelector('button[type="submit"]');

        input.disabled = true;
        input.placeholder = "ğŸ® ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";
        input.classList.add('opacity-50', 'cursor-not-allowed');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }

    async function submitWithStreaming(actionText) {
        if (isGameEnded) return;

        // ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŒì„ í‘œì‹œ (ìƒˆë¡œê³ ì¹¨ ê²½ê³ ìš©)
        hasGameStarted = true;
        // ìŠ¤íŠ¸ë¦¬ë° ì‹œì‘
        isStreaming = true;

        const form = document.getElementById('game-form');
        const chatLog = document.getElementById('chat-log');
        const loadingIndicator = document.getElementById('ai-loading');
        const input = form.querySelector('input[name="action"]');
        const scenesBtn = document.getElementById('scenes-btn');
        const providerSelect = document.getElementById('provider-select');
        const modelVersionSelect = document.getElementById('model-version-select');

        const introMsg = document.getElementById('intro-message');
        if (introMsg) introMsg.remove();

        form.classList.add('streaming');
        input.readOnly = true;
        chatLog.classList.add('processing');

        // ìŠ¤íŠ¸ë¦¬ë° ì¤‘ ì „ì²´ ì”¬ ë³´ê¸° ë²„íŠ¼ ë¹„í™œì„±í™”
        if (scenesBtn) {
            scenesBtn.disabled = true;
            scenesBtn.title = "ë‹µë³€ ìƒì„± ì¤‘ì—ëŠ” ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤";
        }

        // í”Œë ˆì´ì–´ ë©”ì‹œì§€ ì¶”ê°€
        const playerMsgHtml = `
        <div class="flex gap-4 fade-in mb-4 justify-end">
            <div class="flex-1 text-right">
                <div class="text-gray-400 text-xs font-bold mb-1">Player</div>
                <div class="bg-[#2a2a30] border-gray-600 p-3 rounded-lg border text-white text-sm inline-block text-left">
                    ${actionText}
                </div>
            </div>
            <div class="w-8 h-8 rounded-lg bg-gray-700 flex items-center justify-center shrink-0">
                <i data-lucide="user" class="text-white w-4 h-4"></i>
            </div>
        </div>`;
        loadingIndicator.insertAdjacentHTML('beforebegin', playerMsgHtml);
        input.value = '';

        // GM ì‘ë‹µ ì»¨í…Œì´ë„ˆ
        const gmContainer = document.createElement('div');
        gmContainer.className = 'flex gap-4 fade-in mb-4';
        gmContainer.innerHTML = `
            <div class="w-8 h-8 rounded-lg bg-indigo-900 flex items-center justify-center shrink-0">
                <i data-lucide="bot" class="text-white w-4 h-4"></i>
            </div>
            <div class="flex-1">
                <div class="text-indigo-400 text-xs font-bold mb-1">GM</div>
                <div id="gm-streaming-content" class="bg-[#1a1a1e] border-gray-700 p-3 rounded-lg border text-gray-300 text-sm leading-relaxed serif-font">
                    <span class="streaming-cursor">â–Œ</span>
                </div>
            </div>`;
        loadingIndicator.insertAdjacentHTML('beforebegin', gmContainer.outerHTML);

        const contentDiv = document.getElementById('gm-streaming-content');
        loadingIndicator.classList.remove('hidden');
        loadingIndicator.classList.add('flex');
        lucide.createIcons();
        scrollToBottom();

        try {
            const formData = new FormData();
            formData.append('action', actionText);
            // ì„ íƒí•œ ëª¨ë¸ ì¶”ê°€
            if (providerSelect && modelVersionSelect) {
                formData.append('model', modelVersionSelect.value);
                formData.append('provider', providerSelect.value);
            }

            const response = await fetch('/game/act_stream', { method: 'POST', body: formData });

            // [ì¶”ê°€] ì„œë²„ ì—ëŸ¬(500, 400 ë“±) ë¨¼ì € ì²´í¬
            if (!response.ok) {
                let errorMsg = 'ì„œë²„ ì˜¤ë¥˜';
                try {
                    // JSON ì—ëŸ¬ ë©”ì‹œì§€ ì‹œë„
                    const errData = await response.json();
                    errorMsg = errData.error || errData.detail || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
                } catch (e) {
                    // í…ìŠ¤íŠ¸ ì—ëŸ¬ ë©”ì‹œì§€ ì‹œë„
                    errorMsg = await response.text();
                }
                throw new Error(errorMsg);
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let narratorText = '';
            let buffer = '';
            let currentContent = '';

            // ì‘ë‹µ ì‹œê°„ ì¸¡ì •ì„ ìœ„í•œ íƒ€ì´ë¨¸ ì‹œì‘
            responseStartTime = Date.now();
            responseTimerInterval = setInterval(() => {
                const elapsedTime = Date.now() - responseStartTime;
                const seconds = Math.floor(elapsedTime / 1000);
                const milliseconds = Math.floor((elapsedTime % 1000) / 100);
                const timerText = `â± ${seconds}.${milliseconds}ì´ˆ`;
                document.getElementById('response-timer').textContent = timerText;
            }, 100);

            while (true) {
                const { done, value } = await reader.read();
                if (done) break;

                buffer += decoder.decode(value, { stream: true });
                const lines = buffer.split('\n');
                buffer = lines.pop();

                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        try {
                            const data = JSON.parse(line.slice(6));
                            // Game Engineì˜ ìŠ¤íŠ¸ë¦¬ë° íƒ€ì… ì²˜ë¦¬
                            switch (data.type) {
                                case 'prefix': // íŒíŠ¸ ëª¨ë“œë‚˜ ì§§ì€ ë¬¸ì¥ì¼ ë•Œ ì£¼ë¡œ ì‚¬ìš©ë¨
                                    currentContent += data.content;
                                    contentDiv.innerHTML = currentContent + '<span id="narrator-stream"></span><span class="streaming-cursor">â–Œ</span>';
                                    break;
                                case 'token': // ìŠ¤íŠ¸ë¦¬ë° í…ìŠ¤íŠ¸ ëˆ„ì 
                                    narratorText += data.content;
                                    const narratorSpan = document.getElementById('narrator-stream');
                                    if (narratorSpan) narratorSpan.innerHTML = narratorText;
                                    else {
                                        currentContent += data.content;
                                        contentDiv.innerHTML = currentContent + '<span class="streaming-cursor">â–Œ</span>';
                                    }
                                    scrollToBottom(true);
                                    break;
                                case 'section_end':
                                    currentContent += narratorText + data.content;
                                    narratorText = '';
                                    contentDiv.innerHTML = currentContent + '<span id="narrator-stream"></span><span class="streaming-cursor">â–Œ</span>';
                                    break;

                                case 'ending_start':
                                    currentContent = data.content;
                                    contentDiv.innerHTML = currentContent + '<span class="streaming-cursor">â–Œ</span>';
                                    narratorText = '';
                                    break;

                                case 'retry':
                                    // ì¬ìƒì„± ì¤‘ - ë¡œë”© ë©”ì‹œì§€ ë³€ê²½
                                    const loadingText = document.getElementById('loading-text');
                                    if (loadingText) {
                                        loadingText.textContent = `ë‹µë³€ì„ ì¬ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤... (${data.attempt}/${data.max})`;
                                        loadingText.classList.add('text-yellow-400');
                                    }
                                    // ê¸°ì¡´ ì½˜í…ì¸  ì´ˆê¸°í™” (ì¬ìƒì„± ì‹œì‘)
                                    currentContent = '';
                                    narratorText = '';
                                    contentDiv.innerHTML = '<span class="text-yellow-400 text-xs">ğŸ”„ ë‹µë³€ ì¬ìƒì„± ì¤‘...</span><span class="streaming-cursor">â–Œ</span>';
                                    break;

                                case 'fallback':
                                    // í´ë°± ë©”ì‹œì§€ í‘œì‹œ
                                    currentContent = data.content;
                                    contentDiv.innerHTML = currentContent;
                                    break;

                                case 'game_ended':
                                    disableInput();
                                    break;
                                case 'stats':
                                    updateStats(data.content);
                                    break;
                                case 'world_state':
                                    // WorldState ì •ë³´ ì—…ë°ì´íŠ¸
                                    updateWorldState(data.content);
                                    break;
                                case 'npc_status':
                                    // NPC ìƒíƒœ ì •ë³´ ì—…ë°ì´íŠ¸
                                    updateNPCStatus(data.content);
                                    break;
                                case 'session_key':
                                    // ì„¸ì…˜ í‚¤ ì €ì¥
                                    currentSessionKey = data.content;
                                    break;
                                case 'done':
                                    contentDiv.innerHTML = contentDiv.innerHTML.replace('<span class="streaming-cursor">â–Œ</span>', '');

                                    // ìµœì¢… ìƒì„± ì‹œê°„ ê³„ì‚° ë° í‘œì‹œ
                                    const finalElapsedTime = Date.now() - responseStartTime;
                                    const finalSeconds = (finalElapsedTime / 1000).toFixed(1);
                                    const timeStamp = `<div class="text-[10px] text-gray-500 mt-2 font-mono">â± ìƒì„± ì‹œê°„: ${finalSeconds}ì´ˆ</div>`;
                                    contentDiv.innerHTML += timeStamp;

                                    // ë¡œë”© ë©”ì‹œì§€ ì´ˆê¸°í™”
                                    const loadingTextReset = document.getElementById('loading-text');
                                    if (loadingTextReset) {
                                        loadingTextReset.textContent = 'ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
                                        loadingTextReset.classList.remove('text-yellow-400');
                                    }
                                    break;
                                case 'error':
                                    contentDiv.innerHTML = `<div class="text-red-500">Error: ${data.content}</div>`;
                                    break;
                            }
                        } catch (e) { console.error('Parse error:', e); }
                    }
                }
            }
        } catch (error) {
            contentDiv.innerHTML = `<div class="text-red-500">í†µì‹  ì˜¤ë¥˜: ${error.message}</div>`;
        } finally {
            // ìŠ¤íŠ¸ë¦¬ë° ì¢…ë£Œ
            isStreaming = false;
            clearInterval(responseTimerInterval);  // íƒ€ì´ë¨¸ ì¤‘ì§€

            loadingIndicator.classList.add('hidden');
            loadingIndicator.classList.remove('flex');
            form.classList.remove('streaming');
            if (!isGameEnded) { input.readOnly = false; input.focus(); }
            chatLog.classList.remove('processing');

            // ìŠ¤íŠ¸ë¦¬ë° ì™„ë£Œ í›„ ì „ì²´ ì”¬ ë³´ê¸° ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
            if (scenesBtn && isScenarioLoaded) {
                scenesBtn.disabled = false;
                scenesBtn.title = "";
            }

            lucide.createIcons();
            const oldContent = document.getElementById('gm-streaming-content');
            if (oldContent) oldContent.removeAttribute('id');
            const oldNarrator = document.getElementById('narrator-stream');
            if (oldNarrator) oldNarrator.removeAttribute('id');
            scrollToBottom();
            saveChatLog();
        }
    }

    function scrollToBottom(smooth = true) {
        const chatLog = document.getElementById('chat-log');
        if (chatLog) chatLog.scrollTo({ top: chatLog.scrollHeight, behavior: smooth ? 'smooth' : 'auto' });
    }

    function updateStats(statsData) {
        const statsArea = document.getElementById('player-stats-area');
        if (!statsArea) return;

        // ìŠ¤íƒ¯ í‘œì‹œ ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
        const statConfig = {
            'hp': { icon: 'heart', color: 'red', isBar: true, max: 'max_hp' },
            'mp': { icon: 'zap', color: 'blue', isBar: true, max: 'max_mp' },
            'sanity': { icon: 'brain', color: 'purple', isBar: true, max: 100 },
            'gold': { icon: 'coins', color: 'yellow' }
        };

        let html = `
        <div class="bg-[#1a1e2e] rounded-lg p-4 border border-[#2d2d35] shadow-sm mb-4 fade-in">
            <div class="flex justify-between items-center mb-3">
                <span class="text-xs font-bold text-gray-400 uppercase">Status</span>
                <i data-lucide="activity" class="w-3 h-3 text-red-500"></i>
            </div>
            <div class="space-y-2">`;

        for (const [k, v] of Object.entries(statsData)) {
            // [FIX] ë‚´ë¶€ í”Œë˜ê·¸ í•„í„°ë§ (npc_appeared_, _internal ë“±)
            if (k !== 'inventory' && !k.startsWith('max_') && !k.startsWith('npc_appeared_') && !k.startsWith('_')) {
                const config = statConfig[k.toLowerCase()] || { icon: 'circle', color: 'gray' };
                const colorClass = `text-${config.color}-400`;
                const bgColorClass = `bg-${config.color}-500`;

                if (config.isBar) {
                    let maxVal = typeof config.max === 'string' ? (statsData[config.max] || 100) : 100;
                    let percentage = Math.min(100, Math.max(0, (v / maxVal) * 100));
                    html += `
                    <div class="mb-2">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-gray-400 flex items-center gap-1"><i data-lucide="${config.icon}" class="w-3 h-3 ${colorClass}"></i>${k.toUpperCase()}</span>
                            <span class="text-xs font-bold text-white">${v}/${maxVal}</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2 overflow-hidden">
                            <div class="${bgColorClass} h-full transition-all duration-300 rounded-full" style="width: ${percentage}%"></div>
                        </div>
                    </div>`;
                } else {
                    html += `
                    <div class="flex justify-between items-center border-b border-gray-800 py-1.5">
                        <span class="text-xs text-gray-400 flex items-center gap-1"><i data-lucide="${config.icon}" class="w-3 h-3 ${colorClass}"></i>${k.toUpperCase()}</span>
                        <span class="text-white font-bold text-sm">${v}</span>
                    </div>`;
                }
            }
        }
        html += '</div>';

        if (statsData.inventory && statsData.inventory.length > 0) {
            html += `
            <div class="border-t border-gray-700 pt-3 mt-3">
                <div class="text-[10px] text-gray-500 mb-2 flex items-center gap-1"><i data-lucide="backpack" class="w-3 h-3"></i>INVENTORY</div>
                <div class="flex flex-wrap gap-1">`;
            for (const item of statsData.inventory) {
                html += `<span class="bg-gray-800 px-2 py-1 rounded text-[10px] text-indigo-300 border border-gray-700 flex items-center gap-1"><i data-lucide="box" class="w-2.5 h-2.5"></i>${item}</span>`;
            }
            html += '</div></div>';
        }
        html += '</div>';

        statsArea.innerHTML = html;
        lucide.createIcons();
        sessionStorage.setItem(STATS_KEY, JSON.stringify(statsData));

        // ë””ë²„ê·¸ ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ë””ë²„ê·¸ ì •ë³´ë„ ì—…ë°ì´íŠ¸
        const debugToggle = document.getElementById('debug-toggle');
        if (debugToggle && debugToggle.checked) {
            updateDebugInfo(statsData);
        }
    }

    // ë””ë²„ê·¸ ì •ë³´ í† ê¸€ í•¨ìˆ˜
    function toggleDebugInfo() {
        const debugToggle = document.getElementById('debug-toggle');
        const debugInfoArea = document.getElementById('debug-info-area');

        if (debugToggle.checked) {
            debugInfoArea.classList.remove('hidden');
            // ë””ë²„ê·¸ ëª¨ë“œ ìƒíƒœ ì €ì¥
            sessionStorage.setItem(DEBUG_MODE_KEY, 'true');
            // í˜„ì¬ ì €ì¥ëœ ìŠ¤íƒ¯ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë””ë²„ê·¸ ì •ë³´ ì—…ë°ì´íŠ¸
            const savedStats = sessionStorage.getItem(STATS_KEY);
            if (savedStats) {
                try {
                    updateDebugInfo(JSON.parse(savedStats));
                } catch (e) {
                    console.error('Failed to parse stats:', e);
                }
            }
        } else {
            debugInfoArea.classList.add('hidden');
            // ë””ë²„ê·¸ ëª¨ë“œ ìƒíƒœ ì €ì¥
            sessionStorage.setItem(DEBUG_MODE_KEY, 'false');
        }

        lucide.createIcons();
    }

    // ë””ë²„ê·¸ ì •ë³´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateDebugInfo(statsData) {
        updateNPCStatus(statsData);
        updateWorldState(statsData);
    }

    // NPC ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateNPCStatus(npcData) {
        const npcStatusArea = document.getElementById('npc-status-area');
        if (!npcStatusArea) return;

        // npcDataê°€ ì§ì ‘ NPC ë”•ì…”ë„ˆë¦¬ì¸ ê²½ìš°ì™€ statsDataì—ì„œ ì¶”ì¶œí•œ ê²½ìš° ëª¨ë‘ ì²˜ë¦¬
        let npcs = {};

        if (npcData.world_state && npcData.world_state.npcs) {
            // statsDataì—ì„œ ì¶”ì¶œí•œ ê²½ìš°
            npcs = npcData.world_state.npcs;
        } else if (npcData.npcs) {
            // world_stateì—ì„œ ì¶”ì¶œí•œ ê²½ìš°
            npcs = npcData.npcs;
        } else {
            // ì§ì ‘ NPC ë”•ì…”ë„ˆë¦¬ì¸ ê²½ìš°
            npcs = npcData;
        }

        if (!npcs || Object.keys(npcs).length === 0) {
            npcStatusArea.innerHTML = `
                <div class="text-gray-500 text-xs text-center py-2 bg-gray-800/50 rounded border border-gray-700 border-dashed">
                    NPC ë°ì´í„° ì—†ìŒ
                </div>
            `;
            return;
        }

        let html = '';
        for (const [npcName, npcData] of Object.entries(npcs)) {
            const status = npcData.status || 'alive';
            const hp = npcData.hp !== undefined ? npcData.hp : '?';
            const maxHp = npcData.max_hp || 100;
            const relationship = npcData.relationship !== undefined ? npcData.relationship : 50;
            const emotion = npcData.emotion || 'neutral';
            const location = npcData.location || '?';
            const isHostile = npcData.is_hostile || false;

            // ìƒíƒœì— ë”°ë¥¸ ìƒ‰ìƒ
            const statusColor = status === 'alive' ? 'text-green-400' :
                              status === 'dead' ? 'text-red-400' : 'text-yellow-400';

            // ê´€ê³„ë„ì— ë”°ë¥¸ ìƒ‰ìƒ
            const relationColor = relationship >= 70 ? 'text-green-400' :
                                relationship >= 40 ? 'text-blue-400' :
                                relationship >= 20 ? 'text-yellow-400' : 'text-red-400';

            html += `
                <div class="bg-gray-800/50 rounded p-2 border border-gray-700 text-xs">
                    <div class="flex items-center justify-between mb-1">
                        <span class="font-bold text-white flex items-center gap-1">
                            <i data-lucide="${isHostile ? 'skull' : 'user'}" class="w-3 h-3 ${isHostile ? 'text-red-500' : 'text-blue-400'}"></i>
                            ${npcName}
                        </span>
                        <span class="${statusColor} text-[10px] font-bold">${status.toUpperCase()}</span>
                    </div>
                    <div class="space-y-0.5 text-[10px] text-gray-400">
                        <div class="flex justify-between">
                            <span>HP:</span>
                            <span class="text-white">${hp}/${maxHp}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>ê´€ê³„ë„:</span>
                            <span class="${relationColor}">${relationship}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>ê°ì •:</span>
                            <span class="text-white">${emotion}</span>
                        </div>
                        <div class="flex justify-between">
                            <span>ìœ„ì¹˜:</span>
                            <span class="text-white">${location}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        npcStatusArea.innerHTML = html;
        lucide.createIcons();
    }

    // World State ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateWorldState(worldStateData) {
        const worldStateArea = document.getElementById('world-state-area');
        if (!worldStateArea) return;

        // worldStateDataê°€ ì§ì ‘ world_stateì¸ ê²½ìš°ì™€ statsDataì—ì„œ ì¶”ì¶œí•œ ê²½ìš° ëª¨ë‘ ì²˜ë¦¬
        let worldState = {};

        if (worldStateData.world_state) {
            // statsDataì—ì„œ ì¶”ì¶œí•œ ê²½ìš°
            worldState = worldStateData.world_state;
        } else {
            // ì§ì ‘ world_stateì¸ ê²½ìš°
            worldState = worldStateData;
        }

        if (!worldState || Object.keys(worldState).length === 0) {
            worldStateArea.innerHTML = `
                <div class="text-gray-500 text-xs text-center py-2 bg-gray-800/50 rounded border border-gray-700 border-dashed">
                    World State ë°ì´í„° ì—†ìŒ
                </div>
            `;
            return;
        }

        const time = worldState.time || {};
        const day = time.day || 1;
        const phase = time.phase || 'morning';
        const location = worldState.location || '?';
        const turnCount = worldState.turn_count || 0;
        const globalFlags = worldState.global_flags || {};

        // ì‹œê°„ëŒ€ì— ë”°ë¥¸ ì•„ì´ì½˜
        const phaseIcon = phase === 'morning' ? 'sunrise' :
                         phase === 'afternoon' ? 'sun' : 'moon';

        let html = `
            <div class="bg-gray-800/50 rounded p-2 border border-gray-700 space-y-1.5">
                <div class="flex justify-between items-center">
                    <span class="text-gray-400">ì‹œê°„:</span>
                    <span class="text-white flex items-center gap-1">
                        <i data-lucide="${phaseIcon}" class="w-3 h-3 text-yellow-400"></i>
                        Day ${day}, ${phase}
                    </span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-400">ìœ„ì¹˜:</span>
                    <span class="text-white">${location}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-400">í„´ ìˆ˜:</span>
                    <span class="text-white">${turnCount}</span>
                </div>
        `;

        // ì „ì—­ í”Œë˜ê·¸ê°€ ìˆìœ¼ë©´ í‘œì‹œ
        if (Object.keys(globalFlags).length > 0) {
            html += `
                <div class="border-t border-gray-700 pt-1.5 mt-1.5">
                    <div class="text-gray-500 text-[10px] mb-1">ì „ì—­ í”Œë˜ê·¸:</div>
                    <div class="space-y-0.5">
            `;
            for (const [flag, value] of Object.entries(globalFlags)) {
                const icon = value ? 'check-circle' : 'x-circle';
                const color = value ? 'text-green-400' : 'text-gray-500';
                html += `
                    <div class="flex items-center gap-1 text-[10px]">
                        <i data-lucide="${icon}" class="w-2.5 h-2.5 ${color}"></i>
                        <span class="text-gray-400">${flag}:</span>
                        <span class="${color}">${value}</span>
                    </div>
                `;
            }
            html += `
                    </div>
                </div>
            `;
        }

        html += `</div>`;

        worldStateArea.innerHTML = html;
        lucide.createIcons();
    }

    document.addEventListener('DOMContentLoaded', function() {
        // ì•„ì´ì½˜ ì´ˆê¸°í™”
        lucide.createIcons();

        // ëª¨ë¸ ë²„ì „ ì´ˆê¸°í™” (ê°€ì¥ ë¨¼ì € ì‹¤í–‰)
        const providerSelect = document.getElementById('provider-select');
        const modelVersionSelect = document.getElementById('model-version-select');

        if (providerSelect && modelVersionSelect) {
            // ì´ì „ì— ì €ì¥ëœ ì œê³µì‚¬ ë³µì›
            const savedProvider = sessionStorage.getItem(MODEL_PROVIDER_KEY);
            if (savedProvider) {
                providerSelect.value = savedProvider;
            }

            // ëª¨ë¸ ë²„ì „ ì˜µì…˜ ì´ˆê¸°í™”
            updateModelVersions();

            // ì œê³µì‚¬ ë³€ê²½ ì‹œ ì²˜ë¦¬
            providerSelect.addEventListener('change', function() {
                updateModelVersions();
                console.log('ğŸ¤– ì œê³µì‚¬ ë³€ê²½ë¨:', this.value);
            });

            // ëª¨ë¸ ë²„ì „ ë³€ê²½ ì‹œ ì €ì¥
            modelVersionSelect.addEventListener('change', function() {
                sessionStorage.setItem(MODEL_VERSION_KEY, this.value);
                console.log('ğŸ¤– ëª¨ë¸ ì €ì¥ë¨:', this.value);
            });
        } else {
            console.error('âŒ ëª¨ë¸ ì„ íƒ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', { providerSelect, modelVersionSelect });
        }

        // ì±„íŒ… ë¡œê·¸ ë³µì›
        restoreChatLog();

        // ë””ë²„ê·¸ ëª¨ë“œ ìƒíƒœ ë³µì›
        const savedDebugMode = sessionStorage.getItem(DEBUG_MODE_KEY);
        const debugToggle = document.getElementById('debug-toggle');
        if (savedDebugMode === 'true' && debugToggle) {
            debugToggle.checked = true;
            const debugInfoArea = document.getElementById('debug-info-area');
            if (debugInfoArea) {
                debugInfoArea.classList.remove('hidden');
                // ì €ì¥ëœ ìŠ¤íƒ¯ì´ ìˆìœ¼ë©´ ë””ë²„ê·¸ ì •ë³´ ì—…ë°ì´íŠ¸
                const savedStats = sessionStorage.getItem(STATS_KEY);
                if (savedStats) {
                    try {
                        updateDebugInfo(JSON.parse(savedStats));
                    } catch (e) {
                        console.error('Failed to parse stats:', e);
                    }
                }
            }
            lucide.createIcons();
        }

        const form = document.getElementById('game-form');
        if (form) {
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                if (isGameEnded) return;
                const input = form.querySelector('input[name="action"]');
                if (input.value.trim()) submitWithStreaming(input.value.trim());
            });
        }

        // ì•„ì´ì½˜ ì¬ìƒì„± (ëª¨ë“  ì´ˆê¸°í™” í›„)
        setTimeout(() => {
            lucide.createIcons();
        }, 100);
    });

    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === 'init-result') {
            closeLoadModal();
            clearChatLog();
            isGameEnded = false;
            enableGameUI();
            const chatLog = document.getElementById('chat-log');
            Array.from(chatLog.children).forEach(child => {
                if (child.id !== 'init-result' && child.id !== 'ai-loading') child.remove();
            });
        }
    });

    lucide.createIcons();

    // ì‚¬ì´ë“œë°” ë¡œì§
    (function() {
        const sidebar = document.querySelector('.sidebar');
        const SIDEBAR_STATE_KEY = 'sidebar_expanded';
        let isRestoredState = false;

        if (sessionStorage.getItem(SIDEBAR_STATE_KEY) === 'true') {
            sidebar.style.transition = 'none';
            sidebar.classList.add('expanded');
            isRestoredState = true;
            sessionStorage.removeItem(SIDEBAR_STATE_KEY);
            requestAnimationFrame(() => requestAnimationFrame(() => sidebar.style.transition = ''));
        }

        if (isRestoredState) {
            setTimeout(() => {
                const checkMousePosition = (e) => {
                    const rect = sidebar.getBoundingClientRect();
                    const isInsideSidebar = e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom;
                    if (!isInsideSidebar) sidebar.classList.remove('expanded');
                    document.removeEventListener('mousemove', checkMousePosition);
                };
                document.addEventListener('mousemove', checkMousePosition, { once: true });
            }, 100);
        }

        sidebar.querySelectorAll('a[href], button').forEach(link => {
            link.addEventListener('click', function(e) {
                if (this.tagName === 'A' && this.href) {
                    sessionStorage.setItem(SIDEBAR_STATE_KEY, 'true');
                    sidebar.classList.add('expanded');
                }
            });
        });
        sidebar.addEventListener('mouseleave', () => sidebar.classList.remove('expanded'));
    })();

    function openLoadModal() {
        const modal = document.getElementById('load-modal');
        if (modal) {
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
            const sortSelect = document.getElementById('scenario-sort');
            const sortValue = sortSelect ? sortSelect.value : 'newest';
            htmx.ajax('GET', `/api/scenarios?sort=${sortValue}&filter=all`, {target: '#scenario-list-container', swap: 'innerHTML'});
        }
    }

    function closeLoadModal() {
        const modal = document.getElementById('load-modal');
        if (modal) {
            modal.classList.add('hidden');
            modal.style.display = 'none';
        }
    }

    function reloadScenarioList() {
        const sortSelect = document.getElementById('scenario-sort');
        const sortValue = sortSelect ? sortSelect.value : 'newest';
        htmx.ajax('GET', `/api/scenarios?sort=${sortValue}&filter=all`, {target: '#scenario-list-container', swap: 'innerHTML'});
    }

    // ì‹œë‚˜ë¦¬ì˜¤ í”Œë ˆì´ í•¨ìˆ˜
    async function playScenario(filename, btn) {
        // ì´ë¯¸ ê²Œì„ì´ ì§„í–‰ ì¤‘ì´ë¼ë©´ ê²½ê³ 
        const savedLog = sessionStorage.getItem(CHAT_LOG_KEY);
        if (savedLog && savedLog.length > 0) {
            if (!confirm('í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì‹œë‚˜ë¦¬ì˜¤ê°€ ìˆìŠµë‹ˆë‹¤.\nìƒˆ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë¶ˆëŸ¬ì˜¤ë©´ ì§„í–‰ ë‚´ì—­ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
        }

        const originalText = btn.innerHTML;
        btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> ë¡œë”©...';
        btn.disabled = true;
        lucide.createIcons();

        try {
            const formData = new FormData();
            formData.append('filename', filename);

            const res = await fetch('/api/load_scenario', {
                method: 'POST',
                body: formData
            });

            if (res.ok) {
                // ì´ì „ ê²Œì„ ìƒíƒœ ì™„ì „íˆ ì´ˆê¸°í™”
                clearAllGameState();

                // ìƒˆ ì‹œë‚˜ë¦¬ì˜¤ ë¡œë“œ ìƒíƒœ ì„¤ì •
                sessionStorage.setItem(SCENARIO_LOADED_KEY, 'true');
                sessionStorage.setItem(CURRENT_SCENARIO_KEY, filename);

                // ë‚´ë¶€ ë„¤ë¹„ê²Œì´ì…˜ìœ¼ë¡œ ì„¤ì • (beforeunload ê²½ê³  ë°©ì§€)
                isInternalNavigation = true;

                closeLoadModal();

                // UI ì´ˆê¸°í™” í›„ ìƒˆë¡œê³ ì¹¨ ëŒ€ì‹  ì§ì ‘ ì´ˆê¸°í™”
                resetGameUI();
                showToast('ì‹œë‚˜ë¦¬ì˜¤ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } else {
                const text = await res.text();
                showToast('ë¡œë“œ ì‹¤íŒ¨: ' + text, 'error');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        } catch (e) {
            console.error(e);
            showToast('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // ê²Œì„ UI ì´ˆê¸°í™” í•¨ìˆ˜ (ìƒˆë¡œê³ ì¹¨ ì—†ì´)
    function resetGameUI() {
        const chatLog = document.getElementById('chat-log');
        const initResult = document.getElementById('init-result');
        const aiLoading = document.getElementById('ai-loading');
        const statsArea = document.getElementById('player-stats-area');

        // ì±„íŒ… ë¡œê·¸ ì´ˆê¸°í™”
        chatLog.innerHTML = '';
        chatLog.appendChild(initResult);

        // ë¡œë“œ ì™„ë£Œ ë©”ì‹œì§€ í‘œì‹œ
        initResult.innerHTML = `
        <div class="bg-green-900/30 border border-green-800 text-green-400 p-4 rounded-lg flex items-center gap-3 fade-in mt-4">
            <i data-lucide="check-circle" class="w-6 h-6"></i>
            <div>
                <div class="font-bold">ë¡œë“œ ì™„ë£Œ!</div>
                <div class="text-sm opacity-80">ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ê±°ë‚˜ ì±„íŒ…ì°½ì— "ì‹œì‘"ì„ ì…ë ¥í•˜ì„¸ìš”.</div>
            </div>
        </div>
        <button onclick="submitGameAction('ì‹œì‘')"
                class="mt-3 w-full bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 transition-all hover:scale-[1.02] shadow-lg">
            <i data-lucide="play" class="w-5 h-5"></i>
            ê²Œì„ ì‹œì‘í•˜ê¸°
        </button>
        `;

        chatLog.appendChild(aiLoading);

        // ìŠ¤íƒ¯ ì˜ì—­ ì´ˆê¸°í™”
        if (statsArea) {
            statsArea.innerHTML = `
            <div class="text-gray-500 text-sm text-center py-4 bg-gray-800/50 rounded-lg border border-gray-700 border-dashed">
                <i data-lucide="ghost" class="w-6 h-6 mx-auto mb-2 opacity-50"></i>
                ë°ì´í„° ì—†ìŒ<br>
                <span class="text-xs">ê²Œì„ì„ ì‹œì‘í•˜ë©´ í‘œì‹œë©ë‹ˆë‹¤.</span>
            </div>
            `;
        }

        // ìƒíƒœ ì´ˆê¸°í™”
        isGameEnded = false;
        hasGameStarted = false;

        // UI í™œì„±í™”
        enableGameUI();

        lucide.createIcons();
    }

    // ì‹œë‚˜ë¦¬ì˜¤ ì‚­ì œ í•¨ìˆ˜
    async function deleteScenario(filename, title, btnElement) {
        if (!confirm(`"${title}" ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
            return;
        }

        try {
            const response = await fetch('/api/delete_scenario', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: filename })
            });

            const result = await response.json();

            if (result.success) {
                const card = btnElement.closest('.bg-gray-800, .bg-rpg-800');
                if (card) {
                    card.style.transition = 'opacity 0.3s, transform 0.3s';
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.9)';
                    setTimeout(() => {
                        card.remove();
                        const container = document.getElementById('scenario-list-container');
                        if (container && container.children.length === 0) {
                            container.innerHTML = '<div class="col-span-1 md:col-span-2 text-center text-gray-500 py-8">ì €ì¥ëœ ì‹œë‚˜ë¦¬ì˜¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                        }
                    }, 300);
                }
                showToast('ì‹œë‚˜ë¦¬ì˜¤ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } else {
                showToast('ì‚­ì œ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
            }
        } catch (error) {
            console.error('Delete error:', error);
            showToast('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ì‹œë‚˜ë¦¬ì˜¤ ê³µê°œ/ë¹„ê³µê°œ í† ê¸€ í•¨ìˆ˜
    async function publishScenario(filename, btnElement) {
        const card = btnElement.closest('.bg-gray-800');
        const statusBadge = card.querySelector('span[class*="bg-green-900"], span[class*="bg-gray-700"]');
        const currentStatus = statusBadge.textContent.trim();
        const isCurrentlyPublic = currentStatus === 'PUBLIC';

        try {
            const response = await fetch('/api/publish_scenario', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filename: filename })
            });

            const result = await response.json();

            if (result.success) {
                // UI ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                if (isCurrentlyPublic) {
                    // PUBLIC -> PRIVATE
                    statusBadge.className = 'ml-2 text-[10px] bg-gray-700 text-gray-300 px-1 rounded';
                    statusBadge.textContent = 'PRIVATE';
                } else {
                    // PRIVATE -> PUBLIC
                    statusBadge.className = 'ml-2 text-[10px] bg-green-900 text-green-300 px-1 rounded';
                    statusBadge.textContent = 'PUBLIC';
                }

                // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                showToast(result.message || 'ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } else {
                showToast('ë³€ê²½ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'), 'error');
            }
        } catch (error) {
            console.error('Publish error:', error);
            showToast('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
    function showToast(message, type = 'info') {
        const bgColor = type === 'success' ? 'bg-green-900/90 border-green-500/30 text-green-100' :
                       type === 'error' ? 'bg-red-900/90 border-red-500/30 text-red-100' :
                       'bg-blue-900/90 border-blue-500/30 text-blue-100';

        const icon = type === 'success' ? 'check-circle' :
                    type === 'error' ? 'alert-circle' : 'info';

        const toast = document.createElement('div');
        toast.className = `fixed bottom-4 right-4 z-[100] ${bgColor} border px-6 py-4 rounded-xl shadow-2xl backdrop-blur-md flex items-center gap-3`;
        toast.innerHTML = `
            <i data-lucide="${icon}" class="w-5 h-5"></i>
            <span class="font-medium">${message}</span>
        `;

        document.body.appendChild(toast);
        lucide.createIcons();

        setTimeout(() => {
            toast.style.transition = 'opacity 0.3s, transform 0.3s';
            toast.style.opacity = '0';
            toast.style.transform = 'translateY(10px)';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // ì‹œë‚˜ë¦¬ì˜¤ í¸ì§‘ í•¨ìˆ˜ (ë¹„ì£¼ì–¼ ì—ë””í„°ë¡œ ì´ë™)
    function editScenario(filename) {
        // ëª¨ë‹¬ ë‹«ê¸°
        closeLoadModal();
        // ë¹„ì£¼ì–¼ ì—ë””í„°ë¡œ ì´ë™
        isInternalNavigation = true;
        window.location.href = `/views/scenes/edit/${filename}`;
    }

    // ëª¨ë¸ ë²„ì „ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateModelVersions() {
        const providerSelect = document.getElementById('provider-select');
        const modelVersionSelect = document.getElementById('model-version-select');

        const provider = providerSelect.value;

        // ê¸°ë³¸ ì˜µì…˜ ì§€ìš°ê¸°
        modelVersionSelect.innerHTML = '';

        // ì œê³µì‚¬ì— ë”°ë¥¸ ëª¨ë¸ ë²„ì „ ì¶”ê°€
        let options = [];
        switch (provider) {
            case 'google':
                options = [
                    { value: 'openai/google/gemini-2.0-flash-001', label: 'Gemini 2.0 Flash (1M)' },
                    { value: 'openai/google/gemini-2.5-flash-lite', label: 'Gemini 2.5 Flash Lite (1M)' },
                    { value: 'openai/google/gemini-2.5-flash', label: 'Gemini 2.5 Flash (1M)' },
                    { value: 'openai/google/gemini-3-flash-preview', label: 'Gemini 3 Flash Preview (1M)' },
                    { value: 'openai/google/gemini-3-pro-preview', label: 'Gemini 3 Pro Preview (1M)' }
                ];
                break;
            case 'anthropic':
                options = [
                    { value: 'openai/anthropic/claude-3.5-haiku', label: 'Claude 3.5 Haiku (200K)' },
                    { value: 'openai/anthropic/claude-3.5-sonnet', label: 'Claude 3.5 Sonnet (200K)' },
                    { value: 'openai/anthropic/claude-sonnet-4', label: 'Claude Sonnet 4 (200K)' },
                    { value: 'openai/anthropic/claude-haiku-4.5', label: 'Claude Haiku 4.5 (200K)' },
                    { value: 'openai/anthropic/claude-sonnet-4.5', label: 'Claude Sonnet 4.5 (200K)' },
                    { value: 'openai/anthropic/claude-opus-4.5', label: 'Claude Opus 4.5 (200K)' }
                ];
                break;
            case 'openai':
                options = [
                    { value: 'openai/openai/gpt-4o-mini', label: 'GPT-4o Mini (128K)' },
                    { value: 'openai/openai/gpt-4o', label: 'GPT-4o (128K)' },
                    { value: 'openai/openai/gpt-5-mini', label: 'GPT-5 Mini (1M)' },
                    { value: 'openai/openai/gpt-5.2', label: 'GPT-5.2 (1M)' }
                ];
                break;
            case 'deepseek':
                options = [
                    { value: 'openai/tngtech/deepseek-r1t2-chimera:free', label: 'R1 Chimera (Free) â­' },
                    { value: 'openai/deepseek/deepseek-chat-v3-0324', label: 'DeepSeek Chat V3 (128K)' },
                    { value: 'openai/deepseek/deepseek-v3.2', label: 'DeepSeek V3.2 (128K)' }
                ];
                break;
            case 'meta':
                options = [
                    { value: 'openai/meta-llama/llama-3.1-8b-instruct', label: 'Llama 3.1 8B (128K)' },
                    { value: 'openai/meta-llama/llama-3.1-405b-instruct:free', label: 'Llama 3.1 405B (Free) â­' },
                    { value: 'openai/meta-llama/llama-3.1-405b-instruct', label: 'Llama 3.1 405B (128K)' },
                    { value: 'openai/meta-llama/llama-3.3-70b-instruct:free', label: 'Llama 3.3 70B (Free) â­' },
                    { value: 'openai/meta-llama/llama-3.3-70b-instruct', label: 'Llama 3.3 70B (128K)' }
                ];
                break;
            case 'xai':
                options = [
                    { value: 'openai/x-ai/grok-code-fast-1', label: 'Grok Code Fast 1 (128K)' },
                    { value: 'openai/x-ai/grok-4-fast', label: 'Grok 4 Fast (128K)' },
                    { value: 'openai/x-ai/grok-vision-1', label: 'Grok Vision 1 (128K)' }
                ];
                break;
            case 'mistral':
                options = [
                    { value: 'openai/mistralai/mistral-7b-instruct', label: 'Mistral 7B Instruct (32K)' },
                    { value: 'openai/mistralai/mixtral-8x7b-instruct', label: 'Mixtral 8x7B Instruct (32K)' }
                ];
                break;
            case 'xiaomi':
                options = [
                    { value: 'openai/xiaomi/minicpm-v-2.6-instruct', label: 'MiniCPM V 2.6 Instruct (32K)' }
                ];
                break;
            default:
                options = [{ value: 'openai/tngtech/deepseek-r1t2-chimera:free', label: 'R1 Chimera (Free) â­' }];
        }

        // ì˜µì…˜ ì¶”ê°€
        options.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt.value;
            option.textContent = opt.label;
            modelVersionSelect.appendChild(option);
        });

        // ì´ì „ì— ì €ì¥ëœ ëª¨ë¸ ë²„ì „ ë³µì› (ê°™ì€ ì œê³µì‚¬ì¸ ê²½ìš°)
        const savedModelVersion = sessionStorage.getItem(MODEL_VERSION_KEY);
        if (savedModelVersion && Array.from(modelVersionSelect.options).some(opt => opt.value === savedModelVersion)) {
            modelVersionSelect.value = savedModelVersion;
        }

        // ì œê³µì‚¬ ì„ íƒ ì €ì¥ (ì˜µì…˜ ì¶”ê°€ í›„ì— ì €ì¥)
        sessionStorage.setItem(MODEL_PROVIDER_KEY, provider);
    }
</script>
</body>
</html>
