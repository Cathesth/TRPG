<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scenario Builder</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM (CDNJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin></script>

    <!-- Babel (Standalone) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
        body { background-color: #111; color: #fff; margin: 0; overflow: hidden; font-family: sans-serif; }

        .bg-dots-pattern {
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .no-select { user-select: none; -webkit-user-select: none; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .progress-shine {
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transform: translateX(-100%);
            animation: shine 2s infinite;
        }
        @keyframes shine { 100% { transform: translateX(100%); } }

        /* Î°úÎî© Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ Î∞úÍ¥ë Ìö®Í≥º Í∞ïÌôî */
        .glow-effect {
            box-shadow: 0 0 15px 4px rgba(59, 130, 246, 0.8);
            border-color: rgba(147, 197, 253, 0.8);
            background-color: #3b82f6;
        }
        .glow-effect-success {
            box-shadow: 0 0 15px 4px rgba(34, 197, 94, 0.8);
            background-color: #22c55e;
        }
        .dot {
            width: 10px;
            height: 10px;
            border-radius: 9999px;
            background-color: #374151; /* Í∏∞Î≥∏ ÌöåÏÉâ */
            transition: all 0.25s ease;
        }

        .dot.active {
            background-color: #3b82f6 !important;
            box-shadow: 0 0 8px 2px rgba(59, 130, 246, 0.8);
        }

        .dot.success {
            background-color: #22c55e !important;
            box-shadow: 0 0 8px 2px rgba(34, 197, 94, 0.8);
        }

        /* Î™®Îã¨ ÎÇ¥ Ïä§ÌÅ¨Î°§Î∞î Ïä§ÌÉÄÏùº */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 2px; }

        #global-error {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(50, 0, 0, 0.9);
            color: #ffcccc;
            z-index: 9999;
            padding: 20px;
            overflow: auto;
            white-space: pre-wrap;
            font-family: monospace;
        }

        .connection-line {
            stroke: #6b7280;
            stroke-width: 3;
            fill: none;
            filter: drop-shadow(0 0 4px rgba(107, 114, 128, 0.5));
        }
        .connection-line:hover {
            stroke: #9ca3af;
            stroke-width: 4;
        }
        .connecting-line {
            stroke: #6366f1;
            stroke-width: 3;
            stroke-dasharray: 8,4;
            fill: none;
            filter: drop-shadow(0 0 6px rgba(99, 102, 241, 0.6));
            animation: dash 0.5s linear infinite;
        }
        @keyframes dash {
            to { stroke-dashoffset: -12; }
        }

        .version-badge {
            position: fixed;
            bottom: 16px;
            right: 16px;
            font-size: 10px;
            color: #9ca3af;
            font-family: 'Courier New', monospace;
            z-index: 1000;
            pointer-events: none;
            user-select: none;
        }
    </style>

    <script>
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            const errorBox = document.getElementById('global-error');
            if (errorBox) {
                errorBox.style.display = 'block';
                errorBox.innerHTML += `[Error] ${msg}\nLocation: ${url}:${lineNo}:${columnNo}\n\n`;
            }
            return false;
        };
    </script>
</head>
<body class="bg-black text-white h-screen w-screen">

    <div id="global-error"></div>

    <div id="root" class="w-full h-full">
        <div class="flex items-center justify-center h-full flex-col text-gray-500 gap-4">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white"></div>
            <p class="text-lg">Ï¥àÍ∏∞Ìôî Ï§ë...</p>
        </div>
    </div>

    {% raw %}
    <script type="text/babel">
        try {
            const { useState, useRef, useEffect } = React;

            const ICONS = {
                'settings': <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />,
                'users': <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2 M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8 M22 21v-2a4 4 0 0 0-3-3.87 M16 3.13a4 4 0 0 1 0 7.75" />,
                'play': <polygon points="5 3 19 12 5 21 5 3" />,
                'link': <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71 M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />,
                'x': <path d="M18 6 6 18 M6 6l12 12" />,
                'log-out': <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4 M16 17l5-12-5 7 M21 12H9" />,
                'loader-2': <path d="M21 12a9 9 0 1 1-6.219-8.56" />,
                'check-circle': <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14 M22 4L12 14.01l-3-3" />,
                'alert-triangle': <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z M12 9v4 M12 17h.01" />,
                'undo': <path d="M3 7v6h6 M21 17a9 9 0 0 0-9-9 9 9 0 0 0-9 9" />,
                'redo': <path d="M21 7v6h-6 M3 17a9 9 0 0 1 9-9 9 9 0 0 1 9 9" />
            };

            const Icon = ({ name, size = 20, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {ICONS[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );

            const Modal = ({ isOpen, title, children, onClose, type = 'info' }) => {
                if (!isOpen) return null;
                const colors = type === 'error' ? 'red' : type === 'success' ? 'green' : 'gray';
                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-in">
                        <div className={`bg-gray-900 border border-${colors}-500/50 w-full max-w-lg rounded-xl shadow-2xl overflow-hidden`}>
                            <div className="p-4 border-b border-white/10 flex justify-between items-center bg-white/5">
                                <h3 className={`text-lg font-bold text-${colors === 'gray' ? 'white' : colors + '-400'} flex items-center gap-2`}>
                                    {type === 'success' && <Icon name="check-circle" />}
                                    {type === 'error' && <Icon name="alert-triangle" />}
                                    {title}
                                </h3>
                                {onClose && <button onClick={onClose}><Icon name="x" size={20} className="text-gray-500 hover:text-white" /></button>}
                            </div>
                            <div className="p-6 text-gray-300 text-sm leading-relaxed">{children}</div>
                        </div>
                    </div>
                );
            };

            const LoadingOverlay = ({ isOpen, progress, buildStatus }) => {
                if (!isOpen) return null;

                const phaseOrder = ['initializing', 'parsing', 'worldbuilding', 'scene_generation', 'validation', 'finalizing', 'done'];
                const currentPhase = buildStatus.current_phase || 'initializing';
                const isError = buildStatus.status === 'error';

                return (
                    <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-md p-4 animate-fade-in cursor-wait">
                        <div className="w-full max-w-xl text-center p-8 rounded-2xl bg-gray-900/50 border border-white/10 shadow-2xl relative overflow-hidden">
                            <div className={`absolute top-0 left-1/2 -translate-x-1/2 w-64 h-64 ${isError ? 'bg-red-600/20' : 'bg-blue-600/20'} blur-[100px] rounded-full pointer-events-none`}></div>
                            <div className="relative z-10">
                                <div className={`mb-6 inline-block p-4 rounded-full ${isError ? 'bg-red-500/10 border-red-500/20' : 'bg-blue-500/10 border-blue-500/20'} border`}>
                                    <Icon name={isError ? 'alert-triangle' : 'loader-2'} size={48} className={`${isError ? 'text-red-400' : 'animate-spin text-blue-400'}`} />
                                </div>

                                <h3 className="text-2xl font-bold text-white mb-2">
                                    {isError ? 'ÏÉùÏÑ± Ïò§Î•ò Î∞úÏÉù' : 'ÏãúÎÇòÎ¶¨Ïò§ ÏÉùÏÑ± Ï§ë...'}
                                </h3>

                                <p className={`text-sm mb-6 ${isError ? 'text-red-300' : 'text-gray-400'}`}>
                                    {buildStatus.detail || 'AI ÏûëÍ∞ÄÍ∞Ä ÏÑ∏Í≥ÑÍ¥ÄÏùÑ Ï∞ΩÏ°∞ÌïòÍ≥† ÏûàÏäµÎãàÎã§...'}
                                </p>

                                {/* Ïî¨ ÏÉùÏÑ± ÏßÑÌñâÎ•† */}
                                {buildStatus.current_phase === 'scene_generation' && buildStatus.total_scenes > 0 && (
                                    <div className="mb-4 p-3 bg-gray-800/50 rounded-lg border border-gray-700">
                                        <div className="flex justify-between text-xs text-gray-400 mb-2">
                                            <span>Ïî¨ ÏÉùÏÑ± ÏßÑÌñâÎ•†</span>
                                            <span className="text-indigo-400 font-bold">{buildStatus.completed_scenes} / {buildStatus.total_scenes}</span>
                                        </div>
                                        <div className="w-full bg-gray-700 rounded-full h-2 overflow-hidden">
                                            <div
                                                className="bg-indigo-500 h-full transition-all duration-300"
                                                style={{ width: `${(buildStatus.completed_scenes / buildStatus.total_scenes) * 100}%` }}
                                            ></div>
                                        </div>
                                    </div>
                                )}

                                <div className="w-full bg-gray-800 rounded-full h-4 mb-3 overflow-hidden border border-white/5 relative">
                                    <div
                                        className={`h-full transition-all duration-500 ease-out relative ${isError ? 'bg-red-600' : 'bg-gradient-to-r from-blue-600 via-indigo-500 to-purple-500'}`}
                                        style={{ width: `${progress}%` }}
                                    >
                                        {!isError && <div className="progress-shine"></div>}
                                    </div>
                                </div>

                                <div className="flex justify-between text-xs font-mono text-gray-500 px-1">
                                    <span className={`font-bold ${isError ? 'text-red-400' : 'text-blue-400'}`}>
                                        {Math.round(progress)}% {isError ? 'Ïã§Ìå®' : 'ÏôÑÎ£å'}
                                    </span>
                                </div>

                                {/* Ïù∏ÎîîÏºÄÏù¥ÌÑ∞: ÌÖçÏä§Ìä∏ ÏóÜÏù¥ ÏãúÍ∞Å Ìö®Í≥ºÎßå */}
                                <div className="mt-8 flex justify-center items-center gap-6">
                                    {['parsing', 'worldbuilding', 'scene_generation', 'validation', 'finalizing'].map((phase) => {
                                        const currentIdx = phaseOrder.indexOf(currentPhase);
                                        const thisIdx = phaseOrder.indexOf(phase);

                                        const isCompleted = currentIdx > thisIdx;
                                        const isActive = currentPhase === phase;

                                        return (
                                            <div key={phase} className="flex flex-col items-center">
                                                <div className={`w-4 h-4 rounded-full transition-all duration-500 ${
                                                        isActive
                                                            ? 'bg-blue-500 glow-effect animate-pulse scale-125'
                                                            : isCompleted
                                                                ? 'bg-green-500 glow-effect-success scale-100'
                                                                : 'bg-gray-700'
                                                    }`}
                                                /></div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            function ScenarioBuilder() {
                const [nodes, setNodes] = useState([
                    { id: 'start', type: 'start', x: 50, y: 50, data: { label: 'ÏãúÎÇòÎ¶¨Ïò§ ÏÑ§Ï†ï', prologue: '', gm_notes: '' } },
                    { id: 'scene-1', type: 'scene', x: 400, y: 150, data: { title: 'Ï≤´ Î≤àÏß∏ Ïû•Î©¥', description: '', npcs: [] } },
                ]);
                const [connections, setConnections] = useState([ { id: 'c1', source: 'start', target: 'scene-1' } ]);
                const [selectedNodeId, setSelectedNodeId] = useState(null);
                const [globalNpcs, setGlobalNpcs] = useState([]);

                const [history, setHistory] = useState([]);
                const [historyIndex, setHistoryIndex] = useState(-1);
                const [isLoadingPreset, setIsLoadingPreset] = useState(false);

                const saveToHistory = () => {
                    const newState = {
                        nodes: JSON.parse(JSON.stringify(nodes)),
                        connections: JSON.parse(JSON.stringify(connections)),
                        globalNpcs: JSON.parse(JSON.stringify(globalNpcs))
                    };
                    const newHistory = history.slice(0, historyIndex + 1);
                    newHistory.push(newState);
                    if (newHistory.length > 50) {
                        newHistory.shift();
                    } else {
                        setHistoryIndex(historyIndex + 1);
                    }
                    setHistory(newHistory);
                };

                const handleUndo = () => {
                    if (historyIndex > 0) {
                        const newIndex = historyIndex - 1;
                        const prevState = history[newIndex];
                        setNodes(JSON.parse(JSON.stringify(prevState.nodes)));
                        setConnections(JSON.parse(JSON.stringify(prevState.connections)));
                        setGlobalNpcs(JSON.parse(JSON.stringify(prevState.globalNpcs)));
                        setHistoryIndex(newIndex);
                    }
                };

                const handleRedo = () => {
                    if (historyIndex < history.length - 1) {
                        const newIndex = historyIndex + 1;
                        const nextState = history[newIndex];
                        setNodes(JSON.parse(JSON.stringify(nextState.nodes)));
                        setConnections(JSON.parse(JSON.stringify(nextState.connections)));
                        setGlobalNpcs(JSON.parse(JSON.stringify(nextState.globalNpcs)));
                        setHistoryIndex(newIndex);
                    }
                };

                useEffect(() => {
                    const handleKeyDown = (e) => {
                        if (e.ctrlKey && e.key === 'z') {
                            e.preventDefault();
                            handleUndo();
                        } else if (e.ctrlKey && e.key === 'y') {
                            e.preventDefault();
                            handleRedo();
                        }
                    };
                    window.addEventListener('keydown', handleKeyDown);
                    return () => window.removeEventListener('keydown', handleKeyDown);
                }, [historyIndex, history]);

                useEffect(() => {
                    if (history.length === 0) {
                        saveToHistory();
                    }
                }, []);

                useEffect(() => {
                    if (isLoadingPreset) {
                        saveToHistory();
                        setIsLoadingPreset(false);
                    }
                }, [nodes, connections, globalNpcs, isLoadingPreset]);

                const [presetModalOpen, setPresetModalOpen] = useState(false);
                const [presetSaveModalOpen, setPresetSaveModalOpen] = useState(false);
                const [presets, setPresets] = useState([]);
                const [presetName, setPresetName] = useState('');
                const [presetDescription, setPresetDescription] = useState('');
                const [loadingPresets, setLoadingPresets] = useState(false);

                const MODEL_PROVIDERS = {
                    'google': {
                        name: 'Google',
                        icon: 'üîµ',
                        models: [
                            { id: 'openai/google/gemini-2.0-flash-001', name: 'Gemini 2.0 Flash', context: '1M', input: '$0.10/M', output: '$0.40/M' },
                            { id: 'openai/google/gemini-2.5-flash-lite', name: 'Gemini 2.5 Flash Lite', context: '1M', input: '$0.075/M', output: '$0.30/M' },
                            { id: 'openai/google/gemini-2.5-flash', name: 'Gemini 2.5 Flash', context: '1M', input: '$0.15/M', output: '$0.60/M' },
                            { id: 'openai/google/gemini-3-flash-preview', name: 'Gemini 3 Flash (Preview)', context: '1M', input: '$0.15/M', output: '$0.60/M' },
                            { id: 'openai/google/gemini-3-pro-preview', name: 'Gemini 3 Pro (Preview)', context: '1M', input: '$1.25/M', output: '$10/M' },
                        ]
                    },
                    'anthropic': {
                        name: 'Anthropic',
                        icon: 'üü†',
                        models: [
                            { id: 'openai/anthropic/claude-3.5-haiku', name: 'Claude 3.5 Haiku', context: '200K', input: '$0.80/M', output: '$4/M' },
                            { id: 'openai/anthropic/claude-3.5-sonnet', name: 'Claude 3.5 Sonnet', context: '200K', input: '$3/M', output: '$15/M' },
                            { id: 'openai/anthropic/claude-sonnet-4', name: 'Claude Sonnet 4', context: '200K', input: '$3/M', output: '$15/M' },
                            { id: 'openai/anthropic/claude-haiku-4.5', name: 'Claude Haiku 4.5', context: '200K', input: '$0.80/M', output: '$4/M' },
                            { id: 'openai/anthropic/claude-sonnet-4.5', name: 'Claude Sonnet 4.5', context: '200K', input: '$3/M', output: '$15/M' },
                            { id: 'openai/anthropic/claude-opus-4.5', name: 'Claude Opus 4.5', context: '200K', input: '$15/M', output: '$75/M' },
                        ]
                    },
                    'openai': {
                        name: 'OpenAI',
                        icon: 'üü¢',
                        models: [
                            { id: 'openai/openai/gpt-4o-mini', name: 'GPT-4o Mini', context: '128K', input: '$0.15/M', output: '$0.60/M' },
                            { id: 'openai/openai/gpt-4o', name: 'GPT-4o', context: '128K', input: '$2.50/M', output: '$10/M' },
                            { id: 'openai/openai/gpt-5-mini', name: 'GPT-5 Mini', context: '1M', input: '$1.10/M', output: '$4.40/M' },
                            { id: 'openai/openai/gpt-5.2', name: 'GPT-5.2', context: '1M', input: '$2/M', output: '$8/M' },
                        ]
                    },
                    'deepseek': {
                        name: 'DeepSeek',
                        icon: 'üîÆ',
                        models: [
                            { id: 'openai/tngtech/deepseek-r1t2-chimera:free', name: 'R1 Chimera (Free)', context: '164K', input: 'Free', output: 'Free', free: true },
                            { id: 'openai/deepseek/deepseek-chat-v3-0324', name: 'DeepSeek Chat V3', context: '128K', input: '$0.14/M', output: '$0.28/M' },
                            { id: 'openai/deepseek/deepseek-v3.2', name: 'DeepSeek V3.2', context: '128K', input: '$0.14/M', output: '$0.28/M' },
                        ]
                    },
                    'meta': {
                        name: 'Meta Llama',
                        icon: 'ü¶ô',
                        models: [
                            { id: 'openai/meta-llama/llama-3.1-8b-instruct', name: 'Llama 3.1 8B', context: '128K', input: '$0.02/M', output: '$0.05/M' },
                            { id: 'openai/meta-llama/llama-3.1-405b-instruct:free', name: 'Llama 3.1 405B (Free)', context: '128K', input: 'Free', output: 'Free', free: true },
                            { id: 'openai/meta-llama/llama-3.1-405b-instruct', name: 'Llama 3.1 405B', context: '128K', input: '$0.80/M', output: '$0.80/M' },
                            { id: 'openai/meta-llama/llama-3.3-70b-instruct:free', name: 'Llama 3.3 70B (Free)', context: '128K', input: 'Free', output: 'Free', free: true },
                            { id: 'openai/meta-llama/llama-3.3-70b-instruct', name: 'Llama 3.3 70B', context: '128K', input: '$0.10/M', output: '$0.25/M' },
                        ]
                    },
                    'xai': {
                        name: 'xAI (Grok)',
                        icon: '‚ö°',
                        models: [
                            { id: 'openai/x-ai/grok-code-fast-1', name: 'Grok Code Fast 1', context: '128K', input: '$0.15/M', output: '$0.60/M' },
                            { id: 'openai/x-ai/grok-4-fast', name: 'Grok 4 Fast', context: '256K', input: '$2/M', output: '$10/M' },
                            { id: 'openai/x-ai/grok-4.1-fast', name: 'Grok 4.1 Fast', context: '1M', input: '$3/M', output: '$15/M' },
                        ]
                    },
                    'mistral': {
                        name: 'Mistral AI',
                        icon: 'üåÄ',
                        models: [
                            { id: 'openai/mistralai/devstral-2512:free', name: 'Devstral 2512 (Free)', context: '128K', input: 'Free', output: 'Free', free: true },
                        ]
                    },
                    'xiaomi': {
                        name: 'Xiaomi',
                        icon: 'üì±',
                        models: [
                            { id: 'openai/xiaomi/mimo-v2-flash:free', name: 'MiMo V2 Flash (Free)', context: '128K', input: 'Free', output: 'Free', free: true },
                        ]
                    },
                };

                const [selectedProvider, setSelectedProvider] = useState('deepseek');
                const [selectedModel, setSelectedModel] = useState('openai/tngtech/deepseek-r1t2-chimera:free');

                const handleProviderChange = (provider) => {
                    setSelectedProvider(provider);
                    const models = MODEL_PROVIDERS[provider]?.models;
                    if (models && models.length > 0) {
                        setSelectedModel(models[0].id);
                    }
                };

                const getSelectedModelInfo = () => {
                    const provider = MODEL_PROVIDERS[selectedProvider];
                    if (!provider) return null;
                    return provider.models.find(m => m.id === selectedModel);
                };

                const [resultModal, setResultModal] = useState({ open: false, type: 'info', title: '', message: '', showPlayButton: false });
                const [isLoading, setIsLoading] = useState(false);
                const [progress, setProgress] = useState(0);
                const [buildStatus, setBuildStatus] = useState({
                    status: 'idle',
                    step: '0/5',
                    detail: '',
                    progress: 0,
                    total_scenes: 0,
                    completed_scenes: 0,
                    current_phase: 'initializing'
                });

                const [useAutoTitle, setUseAutoTitle] = useState(true);
                const [generatedTitle, setGeneratedTitle] = useState('');

                const [draggingNodeId, setDraggingNodeId] = useState(null);
                const [connectingSourceId, setConnectingSourceId] = useState(null);
                const [mousePos, setMousePos] = useState({ x: 0, y: 0 });
                const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });

                const [zoom, setZoom] = useState(1);
                const [panOffset, setPanOffset] = useState({ x: 0, y: 0 });
                const [isPanning, setIsPanning] = useState(false);
                const [panStart, setPanStart] = useState({ x: 0, y: 0 });

                const canvasRef = useRef(null);

                const openExternalNpcGenerator = () => {
                    const width = 500;
                    const height = 700;
                    const left = (window.screen.width - width) / 2;
                    const top = (window.screen.height - height) / 2;
                    window.open('/builder/npc-generator', 'NPCGenerator', `width=${width},height=${height},top=${top},left=${left},resizable=yes`);
                };

                useEffect(() => {
                    const handleMessage = (event) => {
                        if (event.data.type === 'GENERATOR_READY') {
                            const startNode = nodes.find(n => n.id === 'start');
                            if (event.source) {
                                event.source.postMessage({
                                    type: 'SCENARIO_INFO',
                                    payload: {
                                        title: startNode?.data?.label || "Ï†úÎ™© ÎØ∏Ï†ï",
                                        summary: startNode?.data?.prologue || "" // ÏàòÏ†ï: prologue Ï†ÑÎã¨
                                    }
                                }, '*');
                            }
                        } else if (event.data.type === 'ADD_NPC') {
                            const newNpc = event.data.payload;
                            setGlobalNpcs(prev => {
                                if (prev.some(n => n.name === newNpc.name)) return prev;

                                const updated = [...prev, {
                                    name: newNpc.name,
                                    role: newNpc.role,
                                    trait: newNpc.description,
                                    ...newNpc
                                }];

                                return updated;
                            });

                            setTimeout(() => {
                            }, 100);
                        }
                    };

                    window.addEventListener('message', handleMessage);
                    return () => window.removeEventListener('message', handleMessage);
                }, [nodes]);

                const MIN_ZOOM = 0.25;
                const MAX_ZOOM = 2;

                const handleWheel = (e) => {
                    e.preventDefault();
                    const delta = e.deltaY * -0.001;
                    const newZoom = Math.min(Math.max(zoom + delta, MIN_ZOOM), MAX_ZOOM);
                    setZoom(newZoom);
                };

                const handleZoomIn = () => {
                    setZoom(prev => Math.min(prev + 0.1, MAX_ZOOM));
                };

                const handleZoomOut = () => {
                    setZoom(prev => Math.max(prev - 0.1, MIN_ZOOM));
                };

                const handleZoomReset = () => {
                    setZoom(1);
                    setPanOffset({ x: 0, y: 0 });
                };

                const handleCanvasMouseDown = (e) => {
                    if (e.button === 1 || (e.button === 0 && e.shiftKey)) {
                        e.preventDefault();
                        setIsPanning(true);
                        setPanStart({ x: e.clientX - panOffset.x, y: e.clientY - panOffset.y });
                    }
                };

                const addNode = (type) => {
                    const id = `${type}-${Date.now()}`;
                    setNodes(p => [...p, { id, type, x: Math.random() * 200 + 100, y: Math.random() * 200 + 100, data: { title: type === 'scene' ? 'ÏÉàÎ°úÏö¥ Ïû•Î©¥' : 'ÏÉàÎ°úÏö¥ ÏóîÎî©', description: '', npcs: [] } }]);
                    setTimeout(saveToHistory, 100);
                };

                const deleteNode = (id) => {
                    if (id === 'start') return;
                    setNodes(p => p.filter(n => n.id !== id));
                    setConnections(p => p.filter(c => c.source !== id && c.target !== id));
                    if (selectedNodeId === id) setSelectedNodeId(null);
                    setTimeout(saveToHistory, 100);
                };

                const updateNodeData = (key, value) => {
                    if (!selectedNodeId) return;
                    setNodes(p => p.map(n => n.id === selectedNodeId ? { ...n, data: { ...n.data, [key]: value } } : n));
                };

                const handleGenerate = async () => {
                    if (nodes.length < 2) {
                        setResultModal({ open: true, type: 'error', title: 'ÏÉùÏÑ± Î∂àÍ∞Ä', message: 'ÏµúÏÜåÌïú ÌïòÎÇòÏùò Ïû•Î©¥ ÎÖ∏ÎìúÍ∞Ä Ï∂îÍ∞ÄÎêòÏñ¥Ïïº Ìï©ÎãàÎã§.' });
                        return;
                    }

                    setProgress(0);
                    setIsLoading(true);
                    setBuildStatus({
                        status: 'building',
                        step: '0/5',
                        detail: 'ÎπåÎìú Ï§ÄÎπÑ Ï§ë...',
                        progress: 0,
                        total_scenes: 0,
                        completed_scenes: 0,
                        current_phase: 'initializing'
                    });

                    const eventSource = new EventSource('/api/build_progress');

                    eventSource.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            setBuildStatus(data);
                            setProgress(data.progress || 0);

                            if (data.status === 'completed' || data.status === 'error') {
                                eventSource.close();
                            }
                        } catch (e) {
                            console.error('SSE parse error:', e);
                        }
                    };

                    eventSource.onerror = (error) => {
                        console.error('SSE error:', error);
                        eventSource.close();
                    };

                    try {
                        const response = await fetch('/api/init_game', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ nodes, edges: connections, npcs: globalNpcs, model: selectedModel })
                        });

                        eventSource.close();

                        setProgress(100);
                        await new Promise(r => setTimeout(r, 300));

                        if (!response.ok) {
                            const errData = await response.json();
                            throw new Error(errData.error || 'ÏÑúÎ≤Ñ Ïò§Î•ò');
                        }

                        const data = await response.json();
                        console.log("Server Response (Agent Data):", data);

                        let scenarioTitle = '';
                        const startNode = nodes.find(n => n.id === 'start');

                        if (data.title) {
                            scenarioTitle = data.title;
                        } else if (startNode?.data?.label && startNode.data.label !== 'ÏãúÎÇòÎ¶¨Ïò§ ÏÑ§Ï†ï & ÌîÑÎ°§Î°úÍ∑∏') {
                            scenarioTitle = startNode.data.label;
                        } else if (data.filename) {
                            scenarioTitle = data.filename.replace('.json', '').replace(/_/g, ' ');
                        } else {
                            scenarioTitle = 'ÏÉà ÏãúÎÇòÎ¶¨Ïò§';
                        }

                        setGeneratedTitle(scenarioTitle);

                        if (useAutoTitle && scenarioTitle) {
                            setNodes(prev => prev.map(n =>
                                n.id === 'start'
                                    ? { ...n, data: { ...n.data, label: scenarioTitle } }
                                    : n
                            ));
                        }

                        setResultModal({
                            open: true, type: 'success', title: 'ÏÉùÏÑ± ÏôÑÎ£å!',
                            message: `"${scenarioTitle}" ÏãúÎÇòÎ¶¨Ïò§Í∞Ä ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.\nÏù¥Ï†ú ÌîåÎ†àÏù¥Ïñ¥ Î™®ÎìúÏóêÏÑú Í≤åÏûÑÏùÑ Ï¶êÍ≤®Î≥¥ÏÑ∏Ïöî.`,
                            data: data,
                            showPlayButton: true
                        });

                    } catch (error) {
                        eventSource.close();
                        console.error(error);
                        setBuildStatus(prev => ({ ...prev, status: 'error', detail: error.message }));
                        setResultModal({ open: true, type: 'error', title: 'ÏÉùÏÑ± Ïã§Ìå®', message: error.message });
                    } finally {
                        setIsLoading(false);
                    }
                };

                const handleBackgroundClick = (e) => {
                    if (e.target === canvasRef.current || e.target.id === 'svg-layer') {
                        setSelectedNodeId(null);
                        setConnectingSourceId(null);
                    }
                };

                const handleMouseDownNode = (e, id) => {
                    e.stopPropagation();
                    if (connectingSourceId) {
                        if (connectingSourceId !== id && !connections.some(c => c.source === connectingSourceId && c.target === id)) {
                            setConnections(p => [...p, { id: `c-${Date.now()}`, source: connectingSourceId, target: id }]);
                            setTimeout(saveToHistory, 100);
                        }
                        setConnectingSourceId(null);
                        return;
                    }
                    const node = nodes.find(n => n.id === id);
                    if (node) {
                        const rect = canvasRef.current.getBoundingClientRect();
                        const x = (e.clientX - rect.left - panOffset.x) / zoom;
                        const y = (e.clientY - rect.top - panOffset.y) / zoom;
                        setDragOffset({ x: x - node.x, y: y - node.y });
                        setSelectedNodeId(id);
                        setDraggingNodeId(id);
                    }
                };

                const handleCanvasMouseMove = (e) => {
                    if (!canvasRef.current) return;
                    const rect = canvasRef.current.getBoundingClientRect();
                    const x = (e.clientX - rect.left - panOffset.x) / zoom;
                    const y = (e.clientY - rect.top - panOffset.y) / zoom;
                    setMousePos({ x, y });

                    if (isPanning) {
                        setPanOffset({
                            x: e.clientX - panStart.x,
                            y: e.clientY - panStart.y
                        });
                    } else if (draggingNodeId) {
                        setNodes(p => p.map(n => n.id === draggingNodeId ? { ...n, x: x - dragOffset.x, y: y - dragOffset.y } : n));
                    }
                };

                const handleCanvasMouseUp = () => {
                    if (draggingNodeId) {
                        setTimeout(saveToHistory, 100);
                    }
                    setDraggingNodeId(null);
                    setIsPanning(false);
                };

                const NODE_WIDTH = 200;
                const NODE_HEIGHT = 80;

                const getConnectionPoints = (sourceNode, targetNode) => {
                    const sCenterX = sourceNode.x + NODE_WIDTH / 2;
                    const sCenterY = sourceNode.y + NODE_HEIGHT / 2;
                    const tCenterX = targetNode.x + NODE_WIDTH / 2;
                    const tCenterY = targetNode.y + NODE_HEIGHT / 2;

                    const dx = tCenterX - sCenterX;
                    const dy = tCenterY - sCenterY;

                    let sx, sy, tx, ty;

                    if (Math.abs(dx) > Math.abs(dy)) {
                        if (dx > 0) {
                            sx = sourceNode.x + NODE_WIDTH;
                            sy = sourceNode.y + NODE_HEIGHT / 2;
                            tx = targetNode.x;
                            ty = targetNode.y + NODE_HEIGHT / 2;
                        } else {
                            sx = sourceNode.x;
                            sy = sourceNode.y + NODE_HEIGHT / 2;
                            tx = targetNode.x + NODE_WIDTH;
                            ty = targetNode.y + NODE_HEIGHT / 2;
                        }
                    } else {
                        if (dy > 0) {
                            sx = sourceNode.x + NODE_WIDTH / 2;
                            sy = sourceNode.y + NODE_HEIGHT;
                            tx = targetNode.x + NODE_WIDTH / 2;
                            ty = targetNode.y;
                        } else {
                            sx = sourceNode.x + NODE_WIDTH / 2;
                            sy = sourceNode.y;
                            tx = targetNode.x + NODE_WIDTH / 2;
                            ty = targetNode.y + NODE_HEIGHT;
                        }
                    }

                    return { sx, sy, tx, ty };
                };

                const createPath = (sx, sy, tx, ty) => {
                    const dx = tx - sx;
                    const dy = ty - sy;

                    if (Math.abs(dx) > Math.abs(dy)) {
                        const cpOffset = Math.abs(dx) * 0.4;
                        const cp1x = sx + (dx > 0 ? cpOffset : -cpOffset);
                        const cp2x = tx + (dx > 0 ? -cpOffset : cpOffset);
                        return `M ${sx} ${sy} C ${cp1x} ${sy}, ${cp2x} ${ty}, ${tx} ${ty}`;
                    } else {
                        const cpOffset = Math.abs(dy) * 0.4;
                        const cp1y = sy + (dy > 0 ? cpOffset : -cpOffset);
                        const cp2y = ty + (dy > 0 ? -cpOffset : cpOffset);
                        return `M ${sx} ${sy} C ${sx} ${cp1y}, ${tx} ${cp2y}, ${tx} ${ty}`;
                    }
                };

                const fetchPresets = async () => {
                    setLoadingPresets(true);
                    try {
                        const response = await fetch('/api/presets');
                        if (!response.ok) throw new Error('ÌîÑÎ¶¨ÏÖã Î™©Î°ù Ï°∞Ìöå Ïã§Ìå®');
                        const data = await response.json();
                        setPresets(data || []);
                    } catch (error) {
                        console.error('ÌîÑÎ¶¨ÏÖã Î°úÎìú Ïã§Ìå®:', error);
                    } finally {
                        setLoadingPresets(false);
                    }
                };

                const handleSavePreset = async () => {
                    if (!presetName.trim()) {
                        setResultModal({ open: true, type: 'error', title: 'Ï†ÄÏû• Ïã§Ìå®', message: 'ÌîÑÎ¶¨ÏÖã Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.' });
                        return;
                    }

                    try {
                        const response = await fetch('/api/presets/save', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                name: presetName,
                                description: presetDescription,
                                nodes: nodes,
                                connections: connections,
                                globalNpcs: globalNpcs,
                                selectedProvider: selectedProvider,
                                selectedModel: selectedModel,
                                useAutoTitle: useAutoTitle
                            })
                        });

                        const data = await response.json();
                        if (!data.success) throw new Error(data.error || 'Ï†ÄÏû• Ïã§Ìå®');

                        setResultModal({ open: true, type: 'success', title: 'Ï†ÄÏû• ÏôÑÎ£å', message: data.message });
                        setPresetName('');
                        setPresetDescription('');
                        setPresetSaveModalOpen(false);
                        fetchPresets();
                    } catch (error) {
                        setResultModal({ open: true, type: 'error', title: 'Ï†ÄÏû• Ïã§Ìå®', message: error.message });
                    }
                };

                const handleLoadPreset = async (preset) => {
                    try {
                        const response = await fetch('/api/presets/load', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filename: preset.filename })
                        });

                        const data = await response.json();
                        if (!data.success) throw new Error(data.error || 'Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®');

                        const presetData = data.data;

                        setIsLoadingPreset(true);

                        setNodes(presetData.nodes || []);
                        setConnections(presetData.connections || []);
                        setGlobalNpcs(presetData.globalNpcs || []);
                        setSelectedProvider(presetData.selectedProvider || 'deepseek');
                        setSelectedModel(presetData.selectedModel || 'openai/tngtech/deepseek-r1t2-chimera:free');
                        setUseAutoTitle(presetData.useAutoTitle !== false);


                        setPresetModalOpen(false);
                        setResultModal({ open: true, type: 'success', title: 'Î∂àÎü¨Ïò§Í∏∞ ÏôÑÎ£å', message: `'${presetData.name}' ÌîÑÎ¶¨ÏÖãÏùÑ Î∂àÎü¨ÏôîÏäµÎãàÎã§.` });
                    } catch (error) {
                        setResultModal({ open: true, type: 'error', title: 'Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®', message: error.message });
                    }
                };

                const handleDeletePreset = async (filename) => {
                    if (!confirm('Ï†ïÎßê Ïù¥ ÌîÑÎ¶¨ÏÖãÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;

                    try {
                        const response = await fetch('/api/presets/delete', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ filename })
                        });

                        const data = await response.json();
                        if (!data.success) throw new Error(data.error || 'ÏÇ≠Ï†ú Ïã§Ìå®');

                        fetchPresets();
                    } catch (error) {
                        setResultModal({ open: true, type: 'error', title: 'ÏÇ≠Ï†ú Ïã§Ìå®', message: error.message });
                    }
                };

                useEffect(() => {
                    fetchPresets();
                }, []);

                return (
                    <div className="flex h-screen bg-black text-white font-sans overflow-hidden no-select">
                        <LoadingOverlay isOpen={isLoading} progress={progress} buildStatus={buildStatus} />

                        <div className="w-64 bg-gray-900 border-r border-gray-800 flex flex-col z-20 shadow-xl">
                            <div className="p-4 border-b border-gray-800 flex justify-between items-center">
                                <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">Builder</h1>
                                <a href="/" className="text-gray-500 hover:text-white p-2 rounded hover:bg-gray-800"><Icon name="log-out" size={18} /></a>
                            </div>
                            <div className="p-4 space-y-3">

                                <button onClick={() => addNode('scene')} className="w-full py-2.5 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-lg text-sm text-indigo-300 flex items-center justify-center gap-2"><div className="w-2 h-2 bg-indigo-500 rounded-full"></div> Ïî¨ Ï∂îÍ∞Ä</button>
                                <button onClick={() => addNode('ending')} className="w-full py-2.5 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-lg text-sm text-red-300 flex items-center justify-center gap-2"><div className="w-2 h-2 bg-red-500 rounded-full"></div> ÏóîÎî© Ï∂îÍ∞Ä</button>
                                <button onClick={openExternalNpcGenerator} className="w-full py-2.5 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-lg text-sm text-green-300 flex items-center justify-center gap-2"><Icon name="users" size={16} /> NPC Í¥ÄÎ¶¨</button>

                                <button onClick={() => { setPresetModalOpen(true); fetchPresets(); }} className="w-full py-2.5 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-lg text-sm text-yellow-300 flex items-center justify-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                                        <polyline points="17 21 17 13 7 13 7 21"/>
                                        <polyline points="7 3 7 8 15 8"/>
                                    </svg>
                                    ÌîÑÎ¶¨ÏÖã Í¥ÄÎ¶¨
                                </button>

                                <div className="pt-3 border-t border-gray-800">
                                    <label className="text-xs text-gray-400 block mb-2">ü§ñ AI Î™®Îç∏ ÏÑ†ÌÉù</label>
                                    <div className="flex flex-col gap-2">
                                        <select
                                            value={selectedProvider}
                                            onChange={(e) => handleProviderChange(e.target.value)}
                                            className="w-full bg-gray-800 border border-gray-700 rounded-lg p-2.5 text-sm text-white cursor-pointer hover:border-gray-600 focus:border-blue-500 focus:outline-none"
                                        >
                                            {Object.entries(MODEL_PROVIDERS).map(([key, provider]) => (
                                                <option key={key} value={key}>{provider.name}</option>
                                            ))}
                                        </select>
                                        <select
                                            value={selectedModel}
                                            onChange={(e) => setSelectedModel(e.target.value)}
                                            className="w-full bg-gray-800 border border-gray-700 rounded-lg p-2.5 text-sm text-white cursor-pointer hover:border-gray-600 focus:border-blue-500 focus:outline-none"
                                        >
                                            {MODEL_PROVIDERS[selectedProvider]?.models.map(m => (
                                                <option key={m.id} value={m.id}>{m.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <p className="text-xs text-gray-500 mt-1.5">
                                        {getSelectedModelInfo()?.context} | ÏûÖÎ†•: {getSelectedModelInfo()?.input} | Ï∂úÎ†•: {getSelectedModelInfo()?.output}
                                    </p>
                                </div>
                            </div>
                            <div className="mt-auto p-4 border-t border-gray-800">
                                <button onClick={handleGenerate} className="w-full py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold rounded-lg shadow-lg flex items-center justify-center gap-2">
                                    <Icon name="play" size={18} /> ÏãúÎÇòÎ¶¨Ïò§ ÏÉùÏÑ±
                                </button>
                            </div>
                        </div>

                        <div ref={canvasRef} className="flex-1 relative bg-gray-950 overflow-hidden cursor-crosshair bg-dots-pattern"
                            onMouseMove={handleCanvasMouseMove} onMouseUp={handleCanvasMouseUp} onClick={handleBackgroundClick}
                            onWheel={handleWheel} onMouseDown={handleCanvasMouseDown}>

                            <div className="absolute top-4 right-4 z-30 flex flex-col gap-2 bg-gray-900/90 backdrop-blur-sm rounded-lg p-2 border border-gray-700 shadow-xl">
                                <button
                                    onClick={handleZoomIn}
                                    className="w-10 h-10 bg-gray-800 hover:bg-gray-700 rounded-lg flex items-center justify-center text-white transition-colors border border-gray-600 hover:border-gray-500"
                                    title="ÌôïÎåÄ (Zoom In)"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <circle cx="11" cy="11" r="8"></circle>
                                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                        <line x1="11" y1="8" x2="11" y2="14"></line>
                                        <line x1="8" y1="11" x2="14" y2="11"></line>
                                    </svg>
                                </button>
                                <button
                                    onClick={handleZoomReset}
                                    className="w-10 h-10 bg-gray-800 hover:bg-gray-700 rounded-lg flex items-center justify-center text-white transition-colors border border-gray-600 hover:border-gray-500 text-xs font-bold"
                                    title="Ï¥àÍ∏∞Ìôî (Reset)"
                                >
                                    {Math.round(zoom * 100)}%
                                </button>
                                <button
                                    onClick={handleZoomOut}
                                    className="w-10 h-10 bg-gray-800 hover:bg-gray-700 rounded-lg flex items-center justify-center text-white transition-colors border border-gray-600 hover:border-gray-500"
                                    title="Ï∂ïÏÜå (Zoom Out)"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <circle cx="11" cy="11" r="8"></circle>
                                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                        <line x1="8" y1="11" x2="14" y2="11"></line>
                                    </svg>
                                </button>
                                <div className="h-px bg-gray-700 my-1"></div>
                                <button onClick={handleUndo} className="w-10 h-10 bg-gray-800 hover:bg-gray-700 rounded-lg flex items-center justify-center text-white transition-colors border border-gray-600 hover:border-gray-500" title="Ïã§Ìñâ Ï∑®ÏÜå (Ctrl+Z)">
                                    <Icon name="undo" size={18} />
                                </button>
                                <button onClick={handleRedo} className="w-10 h-10 bg-gray-800 hover:bg-gray-700 rounded-lg flex items-center justify-center text-white transition-colors border border-gray-600 hover:border-gray-500" title="Îã§Ïãú Ïã§Ìñâ (Ctrl+Y)">
                                    <Icon name="redo" size={18} />
                                </button>
                            </div>

                            <div className="absolute bottom-4 left-4 z-30 bg-gray-900/80 backdrop-blur-sm rounded-lg px-3 py-2 border border-gray-700 text-xs text-gray-400">
                                <div className="flex items-center gap-2">
                                    <span className="text-white font-bold">Ï°∞ÏûëÎ≤ï:</span>
                                    <span>ÎßàÏö∞Ïä§ Ìú† = Ï§å</span>
                                    <span className="text-gray-600">|</span>
                                    <span>Shift + ÎìúÎûòÍ∑∏ = Ïù¥Îèô</span>
                                    <span className="text-gray-600">|</span>
                                    <span>Ctrl+Z = Ïã§ÌñâÏ∑®ÏÜå</span>
                                    <span className="text-gray-600">|</span>
                                    <span>Ctrl+Y = Îã§ÏãúÏã§Ìñâ</span>
                                </div>
                            </div>

                            <div style={{
                                transform: `translate(${panOffset.x}px, ${panOffset.y}px) scale(${zoom})`,
                                transformOrigin: '0 0',
                                width: '100%',
                                height: '100%',
                                position: 'absolute'
                            }}>
                                <svg className="absolute inset-0 w-full h-full pointer-events-none z-10" style={{ overflow: 'visible' }}>
                                    {connections.map(c => {
                                        const s = nodes.find(n => n.id === c.source), t = nodes.find(n => n.id === c.target);
                                        if (!s || !t) return null;
                                        const { sx, sy, tx, ty } = getConnectionPoints(s, t);
                                        return <path key={c.id} d={createPath(sx, sy, tx, ty)} className="connection-line" />;
                                    })}
                                    {connectingSourceId && (() => {
                                        const s = nodes.find(n => n.id === connectingSourceId);
                                        if (!s) return null;
                                        const sx = s.x + NODE_WIDTH / 2;
                                        const sy = s.y + NODE_HEIGHT / 2;
                                        return <path d={createPath(sx, sy, mousePos.x, mousePos.y)} className="connecting-line" />;
                                    })()}
                                </svg>
                                {nodes.map(node => (
                                    <div key={node.id} style={{ left: node.x, top: node.y }} onMouseDown={(e) => handleMouseDownNode(e, node.id)}
                                        className={`absolute w-[200px] rounded-lg shadow-xl border-2 group select-none transition-shadow ${selectedNodeId === node.id ? 'border-white z-20 ring-2 ring-blue-500/50' : node.type === 'start' ? 'border-blue-600 bg-gray-900 z-10' : node.type === 'ending' ? 'border-red-600 bg-gray-900 z-10' : 'border-indigo-600 bg-gray-900 z-10'} ${connectingSourceId && connectingSourceId !== node.id ? 'hover:scale-105 cursor-pointer' : 'cursor-grab active:cursor-grabbing'}`}>

                                        <div className={`p-2 rounded-t-md text-sm font-bold flex justify-between items-center ${node.type === 'start' ? 'bg-blue-900/50 text-blue-200' : node.type === 'ending' ? 'bg-red-900/50 text-red-200' : 'bg-indigo-900/50 text-indigo-200'}`}>
                                            <span className="truncate pl-2">{node.type === 'start' ? 'ÏÑ§Ï†ï' : node.type === 'scene' ? 'Scene' : 'Ending'}</span>

                                            <button
                                                onClick={(e) => { e.stopPropagation(); setConnectingSourceId(node.id); setSelectedNodeId(node.id); }}
                                                className={`p-1 rounded hover:bg-white/20 transition-colors ${connectingSourceId === node.id ? 'bg-white/30 text-white animate-pulse' : 'text-white/70 hover:text-white'}`}
                                                title="Ïù¥ ÎÖ∏ÎìúÏóêÏÑú Ïó∞Í≤∞ ÏãúÏûë"
                                            >
                                                <Icon name="link" size={14} />
                                            </button>
                                        </div>

                                        <div className="p-3 text-xs text-gray-300 min-h-[60px] relative">
                                            <div className="font-bold mb-1 truncate">{node.data.title || node.data.label || 'Ï†úÎ™© ÏóÜÏùå'}</div>
                                            <div className="text-gray-500 line-clamp-2">
                                                {node.type === 'start'
                                                    ? (node.data.prologue ? node.data.prologue.substring(0, 50) + '...' : 'ÌîÑÎ°§Î°úÍ∑∏ ÏóÜÏùå')
                                                    : (node.data.description || 'ÎÇ¥Ïö© ÏóÜÏùå')}
                                            </div>

                                            {node.id !== 'start' && selectedNodeId === node.id && (
                                                <button
                                                    onClick={(e) => { e.stopPropagation(); deleteNode(node.id); }}
                                                    className="absolute -top-10 -left-3 bg-red-500 text-white rounded-full p-1.5 shadow-lg hover:bg-red-600 transition-transform hover:scale-110 z-50 flex items-center justify-center border-2 border-gray-900"
                                                    title="ÎÖ∏Îìú ÏÇ≠Ï†ú"
                                                >
                                                    <Icon name="x" size={14} />
                                                </button>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="w-80 bg-gray-900 border-l border-gray-800 overflow-y-auto z-20 shadow-xl">
                            {selectedNodeId ? (() => {
                                const node = nodes.find(n => n.id === selectedNodeId);
                                if (!node) return null;
                                return (
                                    <div className="p-6 space-y-6">
                                        <h2 className="text-lg font-bold border-b border-gray-700 pb-2">ÏÜçÏÑ± Ìé∏Ïßë <span className="text-xs bg-gray-800 px-2 py-0.5 rounded text-gray-400">{node.type}</span></h2>
                                        <div className="space-y-3">
                                            {/* ÏãúÏûë ÎÖ∏ÎìúÏùº Í≤ΩÏö∞: Ï†úÎ™© / ÌîÑÎ°§Î°úÍ∑∏ / GM ÏÑ§Ï†ï Î∂ÑÎ¶¨ */}
                                            {node.type === 'start' ? (
                                                <>
                                                    <div className="bg-blue-900/20 border border-blue-800/50 rounded-lg p-3 space-y-2 mb-2">
                                                        <label className="flex items-center gap-2 cursor-pointer">
                                                            <input
                                                                type="checkbox"
                                                                className="rounded bg-gray-700 border-gray-600 text-blue-500 w-4 h-4"
                                                                checked={useAutoTitle}
                                                                onChange={(e) => {
                                                                    setUseAutoTitle(e.target.checked);
                                                                    if (e.target.checked && generatedTitle) {
                                                                        setNodes(prev => prev.map(n =>
                                                                            n.id === 'start'
                                                                                ? { ...n, data: { ...n.data, label: generatedTitle } }
                                                                                : n
                                                                        ));
                                                                    }
                                                                }}
                                                            />
                                                            <span className="text-sm text-blue-300 font-medium">AI ÏÉùÏÑ± Ï†úÎ™© ÏÇ¨Ïö©</span>
                                                        </label>
                                                    </div>

                                                    <div>
                                                        <label className="text-xs text-gray-400 block mb-1">ÏãúÎÇòÎ¶¨Ïò§ Ï†úÎ™©</label>
                                                        <input
                                                            className={`w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm text-white ${useAutoTitle ? 'opacity-50 cursor-not-allowed' : ''}`}
                                                            value={node.data.label || ''}
                                                            onChange={e => updateNodeData('label', e.target.value)}
                                                            disabled={useAutoTitle}
                                                            placeholder={useAutoTitle ? 'ÏãúÎÇòÎ¶¨Ïò§ ÏÉùÏÑ± Ïãú ÏûêÎèô ÏûÖÎ†•' : 'Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî'}
                                                        />
                                                    </div>

                                                    <div>
                                                        <label className="text-xs text-blue-400 block mb-1 font-bold">üìú Í≥µÍ∞ú ÌîÑÎ°§Î°úÍ∑∏ (ÌîåÎ†àÏù¥Ïñ¥ÏóêÍ≤å Î≥¥ÏûÑ)</label>
                                                        <textarea
                                                            rows={6}
                                                            className="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm text-white resize-none focus:border-blue-500 transition-colors"
                                                            value={node.data.prologue || ''}
                                                            onChange={e => updateNodeData('prologue', e.target.value)}
                                                            placeholder="Í≤åÏûÑ ÏãúÏûë Ïãú ÌîåÎ†àÏù¥Ïñ¥Í∞Ä ÏùΩÍ≤å Îê† ÎèÑÏûÖÎ∂Ä Ïù¥ÏïºÍ∏∞Î•º ÏûëÏÑ±ÌïòÏÑ∏Ïöî."
                                                        />
                                                    </div>

                                                    <div>
                                                        <label className="text-xs text-red-400 block mb-1 font-bold">üîí ÏãúÏä§ÌÖú ÎÇ¥Î∂Ä ÏÑ§Ï†ï (ÎπÑÍ≥µÍ∞ú)</label>
                                                        <textarea
                                                            rows={6}
                                                            className="w-full bg-gray-900 border border-red-900/50 rounded p-2 text-sm text-gray-300 resize-none focus:border-red-500 transition-colors"
                                                            value={node.data.gm_notes || ''}
                                                            onChange={e => updateNodeData('gm_notes', e.target.value)}
                                                            placeholder="ÌîåÎ†àÏù¥Ïñ¥ÏóêÍ≤å Ïà®Í≤®ÏßÑ ÏßÑÏã§, Ìä∏Î¶≠, ÏãúÏä§ÌÖú Î°úÏßÅ Îì±ÏùÑ ÏûëÏÑ±ÌïòÏÑ∏Ïöî."
                                                        />
                                                    </div>
                                                </>
                                            ) : (
                                                /* ÏùºÎ∞ò ÎÖ∏Îìú (Ïî¨/ÏóîÎî©) */
                                                <>
                                                    <div>
                                                        <label className="text-xs text-gray-400 block mb-1">Ï†úÎ™©</label>
                                                        <input
                                                            className="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm text-white"
                                                            value={node.data.title || ''}
                                                            onChange={e => updateNodeData('title', e.target.value)}
                                                            placeholder="Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="text-xs text-gray-400 block mb-1">ÎÇ¥Ïö©</label>
                                                        <textarea
                                                            rows={5}
                                                            className="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm text-white resize-none"
                                                            value={node.data.description || ''}
                                                            onChange={e => updateNodeData('description', e.target.value)}
                                                            placeholder="Ïû•Î©¥ ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                                                        />
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                        {node.type === 'scene' && (
                                            <div className="space-y-2 pt-4 border-t border-gray-800">
                                                <h3 className="text-sm font-bold text-green-400 flex justify-between">NPC Îì±Ïû• <span className="cursor-pointer hover:text-white" onClick={openExternalNpcGenerator}>+Ï∂îÍ∞Ä</span></h3>
                                                <div className="space-y-1 max-h-40 overflow-y-auto pr-1">{globalNpcs.map((n, i) => (
                                                    <label key={i} className="flex items-center space-x-2 text-sm p-1.5 hover:bg-gray-800 rounded cursor-pointer">
                                                        <input type="checkbox" className="rounded bg-gray-700 border-gray-600 text-green-500" checked={(node.data.npcs || []).includes(n.name)}
                                                            onChange={e => updateNodeData('npcs', e.target.checked ? [...(node.data.npcs || []), n.name] : (node.data.npcs || []).filter(x => x !== n.name))} />
                                                        <span>{n.name}</span>
                                                    </label>
                                                ))}</div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })() : <div className="flex flex-col items-center justify-center h-full text-gray-600"><Icon name="settings" size={48} className="mb-4 opacity-50" /><p className="text-sm">ÎÖ∏ÎìúÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî</p></div>}
                        </div>

                        <Modal isOpen={presetModalOpen} title="ÌîÑÎ¶¨ÏÖã Í¥ÄÎ¶¨" onClose={() => setPresetModalOpen(false)}>
                            <div className="space-y-4">
                                <div className="flex justify-between items-center">
                                    <h3 className="text-base font-bold text-gray-200">Ï†ÄÏû•Îêú ÌîÑÎ¶¨ÏÖã</h3>
                                    <span className="text-xs text-gray-500">{presets.length}Í∞ú</span>
                                </div>
                                {loadingPresets ? (
                                    <div className="flex items-center justify-center py-10">
                                        <Icon name="loader-2" size={32} className="animate-spin text-blue-400" />
                                    </div>
                                ) : (
                                    <div className="space-y-2 max-h-60 overflow-y-auto">
                                        {presets.length === 0 && <p className="text-gray-500 text-sm text-center py-4">Ï†ÄÏû•Îêú ÌîÑÎ¶¨ÏÖãÏù¥ ÏóÜÏäµÎãàÎã§.</p>}
                                        {presets.map(preset => (
                                            <div key={preset.filename} className="p-3 bg-gray-800 rounded-lg border border-gray-700 hover:border-gray-600 transition-colors">
                                                <div className="flex justify-between items-start">
                                                    <div className="flex-1 min-w-0">
                                                        {/* Ï†úÎ™©Ïù¥ nameÏù¥ ÏïÑÎãå titleÎ°ú Îì§Ïñ¥Ïò§Îäî Í≤ΩÏö∞ ÎåÄÏùë */}
                                                        <div className="text-sm font-bold text-gray-200 truncate">{preset.title || preset.name}</div>
                                                        <div className="text-xs text-gray-500 truncate">{preset.description || 'ÏÑ§Î™Ö ÏóÜÏùå'}</div>
                                                        <div className="text-[10px] text-gray-600 mt-1">
                                                            ÎÖ∏Îìú {preset.nodeCount}Í∞ú ¬∑ NPC {preset.npcCount}Í∞ú
                                                        </div>
                                                    </div>
                                                    <div className="flex gap-1.5 ml-2">
                                                        <button onClick={() => handleLoadPreset(preset)} className="px-2.5 py-1 text-xs bg-blue-600 hover:bg-blue-500 rounded font-medium">Î∂àÎü¨Ïò§Í∏∞</button>
                                                        <button onClick={() => handleDeletePreset(preset.filename)} className="p-1 text-xs bg-red-600/80 hover:bg-red-500 rounded" title="ÏÇ≠Ï†ú">
                                                            <Icon name="x" size={14} className="text-white" />
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                                <div className="pt-3 border-t border-gray-800">
                                    <button onClick={() => { setPresetModalOpen(false); setPresetSaveModalOpen(true); }} className="w-full py-2.5 bg-green-600 hover:bg-green-500 rounded-lg font-bold transition-colors flex items-center justify-center gap-2">
                                        <Icon name="check-circle" size={18} /> ÌòÑÏû¨ ÏÑ§Ï†ïÏùÑ ÌîÑÎ¶¨ÏÖãÏúºÎ°ú Ï†ÄÏû•
                                    </button>
                                </div>
                            </div>
                        </Modal>

                        <Modal isOpen={presetSaveModalOpen} title="ÌîÑÎ¶¨ÏÖã Ï†ÄÏû•" onClose={() => setPresetSaveModalOpen(false)}>
                            <div className="p-4">
                                <h3 className="text-lg font-bold text-gray-200 mb-4">ÌîÑÎ¶¨ÏÖã Ïù¥Î¶Ñ Î∞è ÏÑ§Î™Ö</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-xs text-gray-400 block mb-1">ÌîÑÎ¶¨ÏÖã Ïù¥Î¶Ñ</label>
                                        <input
                                            value={presetName}
                                            onChange={e => setPresetName(e.target.value)}
                                            className="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm text-white"
                                            placeholder="ÌîÑÎ¶¨ÏÖã Ïù¥Î¶ÑÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"
                                        />
                                    </div>
                                    <div>
                                        <label className="text-xs text-gray-400 block mb-1">ÌîÑÎ¶¨ÏÖã ÏÑ§Î™Ö</label>
                                        <textarea
                                            value={presetDescription}
                                            onChange={e => setPresetDescription(e.target.value)}
                                            className="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm text-white resize-none"
                                            rows={3}
                                            placeholder="ÌîÑÎ¶¨ÏÖã ÏÑ§Î™ÖÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (ÏÑ†ÌÉù ÏÇ¨Ìï≠)"
                                        />
                                    </div>
                                </div>
                                <div className="mt-4">
                                    <button onClick={handleSavePreset} className="w-full py-2 bg-green-600 hover:bg-green-500 rounded-lg font-bold transition-colors flex items-center justify-center gap-2">
                                        <Icon name="check-circle" size={18} /> Ï†ÄÏû•
                                    </button>
                                </div>
                            </div>
                        </Modal>

                        <Modal isOpen={resultModal.open} type={resultModal.type} title={resultModal.title} onClose={() => setResultModal({ ...resultModal, open: false })}>
                            <div className="whitespace-pre-wrap text-base font-medium text-white mb-4">{resultModal.message}</div>

                            {resultModal.data && (
                                <div className="space-y-3">
                                    {(resultModal.data.prologue || resultModal.data.desc) && (
                                        <div className="bg-gray-800 border border-indigo-500/30 rounded-lg p-3">
                                            <h4 className="text-sm font-bold text-indigo-300 mb-2 flex items-center gap-2">
                                                <Icon name="play" size={14} /> Í≥µÍ∞ú ÌîÑÎ°§Î°úÍ∑∏
                                            </h4>
                                            <div className="text-xs text-gray-300 whitespace-pre-wrap leading-relaxed max-h-40 overflow-y-auto custom-scrollbar">
                                                {resultModal.data.prologue || resultModal.data.desc}
                                            </div>
                                        </div>
                                    )}

                                    {(resultModal.data.player_status || resultModal.data.world_settings) && (
                                        <div className="bg-gray-900 border border-red-500/30 rounded-lg p-3">
                                            <h4 className="text-sm font-bold text-red-400 mb-2 flex items-center gap-2">
                                                <Icon name="settings" size={14} /> Ï†ÑÏ≤¥ ÏÑ§Ï†ï (Player Status / ÎπÑÍ≥µÍ∞ú)
                                            </h4>
                                            <div className="text-xs text-gray-400 whitespace-pre-wrap leading-relaxed italic max-h-40 overflow-y-auto custom-scrollbar">
                                                {resultModal.data.player_status || resultModal.data.world_settings}
                                            </div>
                                        </div>
                                    )}

                                    <div className="grid grid-cols-2 gap-2 mt-2">
                                        {resultModal.data.worlds && resultModal.data.worlds.length > 0 && (
                                            <div className="bg-gray-800/50 p-2 rounded border border-gray-700">
                                                <h5 className="text-xs font-bold text-gray-400 mb-1">üåé ÏÑ∏Í≥ÑÍ¥Ä ({resultModal.data.worlds.length})</h5>
                                                <ul className="list-disc pl-3 text-[10px] text-gray-500">
                                                    {resultModal.data.worlds.slice(0, 3).map((w, i) => <li key={i} className="truncate">{w.name}</li>)}
                                                </ul>
                                            </div>
                                        )}
                                        {resultModal.data.scenes && resultModal.data.scenes.length > 0 && (
                                            <div className="bg-gray-800/50 p-2 rounded border border-gray-700">
                                                <h5 className="text-xs font-bold text-gray-400 mb-1">üé¨ Ïû•Î©¥ ({resultModal.data.scenes.length})</h5>
                                                <ul className="list-disc pl-3 text-[10px] text-gray-500">
                                                    {resultModal.data.scenes.slice(0, 3).map((s, i) => <li key={i} className="truncate">{s.name || s.title}</li>)}
                                                </ul>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            <div className="mt-6 flex justify-end gap-2">
                                {resultModal.type === 'success' && resultModal.showPlayButton && (
                                        <a
                                            href="/views/player"
                                            onClick={() => sessionStorage.setItem('trpg_scenario_loaded', 'true')}
                                            className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded font-bold"
                                        >
                                            ÌîåÎ†àÏù¥ÌïòÎü¨ Í∞ÄÍ∏∞
                                        </a>
                                    )}
                                <button onClick={() => setResultModal({ ...resultModal, open: false })} className="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded text-white">ÌôïÏù∏</button>
                            </div>
                        </Modal>
                    </div>
                );
            }

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<ScenarioBuilder />);

        } catch (error) {
            document.getElementById('global-error').style.display = 'block';
            document.getElementById('global-error').innerText = "[React Init Error] " + error.message;
        }
    </script>
    {% endraw %}

<div class="version-badge">
    v{{ version }}
</div>

</body>
</html>