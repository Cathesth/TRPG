<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scenario Builder</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React & ReactDOM (CDNJS) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js" crossorigin></script>

    <!-- Babel (Standalone) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

    <style>
        body { background-color: #111; color: #fff; margin: 0; overflow: hidden; font-family: sans-serif; }

        .bg-dots-pattern {
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .no-select { user-select: none; -webkit-user-select: none; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .progress-shine {
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transform: translateX(-100%);
            animation: shine 2s infinite;
        }
        @keyframes shine { 100% { transform: translateX(100%); } }

        #global-error {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(50, 0, 0, 0.9);
            color: #ffcccc;
            z-index: 9999;
            padding: 20px;
            overflow: auto;
            white-space: pre-wrap;
            font-family: monospace;
        }
    </style>

    <script>
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            const errorBox = document.getElementById('global-error');
            if (errorBox) {
                errorBox.style.display = 'block';
                errorBox.innerHTML += `[Error] ${msg}\nLocation: ${url}:${lineNo}:${columnNo}\n\n`;
            }
            return false;
        };
    </script>
</head>
<body class="bg-black text-white h-screen w-screen">

    <div id="global-error"></div>

    <div id="root" class="w-full h-full">
        <div class="flex items-center justify-center h-full flex-col text-gray-500 gap-4">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white"></div>
            <p class="text-lg">ì´ˆê¸°í™” ì¤‘...</p>
        </div>
    </div>

    {% raw %}
    <script type="text/babel">
        try {
            const { useState, useRef, useEffect } = React;

            const ICONS = {
                'settings': <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />,
                'users': <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2 M9 7a4 4 0 1 0 0-8 4 4 0 0 0 0 8 M22 21v-2a4 4 0 0 0-3-3.87 M16 3.13a4 4 0 0 1 0 7.75" />,
                'play': <polygon points="5 3 19 12 5 21 5 3" />,
                'link': <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71 M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" />,
                'x': <path d="M18 6 6 18 M6 6l12 12" />,
                'log-out': <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4 M16 17l5-12-5 7 M21 12H9" />,
                'loader-2': <path d="M21 12a9 9 0 1 1-6.219-8.56" />,
                'check-circle': <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14 M22 4L12 14.01l-3-3" />,
                'alert-triangle': <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z M12 9v4 M12 17h.01" />
            };

            const Icon = ({ name, size = 20, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {ICONS[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );

            const Modal = ({ isOpen, title, children, onClose, type = 'info' }) => {
                if (!isOpen) return null;
                const colors = type === 'error' ? 'red' : type === 'success' ? 'green' : 'gray';
                return (
                    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-fade-in">
                        <div className={`bg-gray-900 border border-${colors}-500/50 w-full max-w-md rounded-xl shadow-2xl overflow-hidden`}>
                            <div className="p-4 border-b border-white/10 flex justify-between items-center bg-white/5">
                                <h3 className={`text-lg font-bold text-${colors === 'gray' ? 'white' : colors + '-400'} flex items-center gap-2`}>
                                    {type === 'success' && <Icon name="check-circle" />}
                                    {type === 'error' && <Icon name="alert-triangle" />}
                                    {title}
                                </h3>
                                {onClose && <button onClick={onClose}><Icon name="x" size={20} className="text-gray-500 hover:text-white" /></button>}
                            </div>
                            <div className="p-6 text-gray-300 text-sm leading-relaxed">{children}</div>
                        </div>
                    </div>
                );
            };

            const LoadingOverlay = ({ isOpen, progress, remainingTime }) => {
                if (!isOpen) return null;
                return (
                    <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-md p-4 animate-fade-in cursor-wait">
                        <div className="w-full max-w-lg text-center p-8 rounded-2xl bg-gray-900/50 border border-white/10 shadow-2xl relative overflow-hidden">
                            <div className="absolute top-0 left-1/2 -translate-x-1/2 w-64 h-64 bg-blue-600/20 blur-[100px] rounded-full pointer-events-none"></div>
                            <div className="relative z-10">
                                <div className="mb-6 inline-block p-4 rounded-full bg-blue-500/10 border border-blue-500/20">
                                    <Icon name="loader-2" size={48} className="animate-spin text-blue-400" />
                                </div>
                                <h3 className="text-2xl font-bold text-white mb-2">ì‹œë‚˜ë¦¬ì˜¤ ìƒì„± ì¤‘...</h3>
                                <p className="text-gray-400 text-sm mb-8">AI ì‘ê°€ê°€ ì„¸ê³„ê´€ì„ ì°½ì¡°í•˜ê³  ìˆìŠµë‹ˆë‹¤.<br/>ë…¸ë“œê°€ ë§ì„ìˆ˜ë¡ ì‹œê°„ì´ ë” ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                                <div className="w-full bg-gray-800 rounded-full h-3 mb-3 overflow-hidden border border-white/5 relative">
                                    <div className="bg-gradient-to-r from-blue-600 to-indigo-500 h-full transition-all duration-300 ease-out relative" style={{ width: `${progress}%` }}>
                                        <div className="progress-shine"></div>
                                    </div>
                                </div>
                                <div className="flex justify-between text-xs font-mono text-gray-500 px-1">
                                    <span className="text-blue-400 font-bold">{Math.round(progress)}% ì™„ë£Œ</span>
                                    <span>ì˜ˆìƒ ì†Œìš” ì‹œê°„: ì•½ <span className="text-white font-bold">{Math.max(0, remainingTime)}</span>ì´ˆ</span>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            function ScenarioBuilder() {
                const [nodes, setNodes] = useState([
                    { id: 'start', type: 'start', x: 50, y: 50, data: { label: 'ì‹œë‚˜ë¦¬ì˜¤ ì„¤ì • & í”„ë¡¤ë¡œê·¸', description: '' } },
                    { id: 'scene-1', type: 'scene', x: 400, y: 150, data: { title: 'ì²« ë²ˆì§¸ ì¥ë©´', description: '', npcs: [] } },
                ]);
                const [connections, setConnections] = useState([ { id: 'c1', source: 'start', target: 'scene-1' } ]);
                const [selectedNodeId, setSelectedNodeId] = useState(null);
                const [globalNpcs, setGlobalNpcs] = useState([]);

                // ëª¨ë¸ ì œê³µì‚¬ ë° ë²„ì „ ì •ë³´
                const MODEL_PROVIDERS = {
                    'google': {
                        name: 'Google',
                        icon: 'ğŸ”µ',
                        models: [
                            { id: 'openai/google/gemini-2.0-flash-001', name: 'Gemini 2.0 Flash', context: '1M', input: '$0.10/M', output: '$0.40/M' },
                            { id: 'openai/google/gemini-2.5-flash-lite', name: 'Gemini 2.5 Flash Lite', context: '1M', input: '$0.075/M', output: '$0.30/M' },
                            { id: 'openai/google/gemini-2.5-flash', name: 'Gemini 2.5 Flash', context: '1M', input: '$0.15/M', output: '$0.60/M' },
                            { id: 'openai/google/gemini-3-flash-preview', name: 'Gemini 3 Flash (Preview)', context: '1M', input: '$0.15/M', output: '$0.60/M' },
                            { id: 'openai/google/gemini-3-pro-preview', name: 'Gemini 3 Pro (Preview)', context: '1M', input: '$1.25/M', output: '$10/M' },
                        ]
                    },
                    'anthropic': {
                        name: 'Anthropic',
                        icon: 'ğŸŸ ',
                        models: [
                            { id: 'openai/anthropic/claude-3.5-haiku', name: 'Claude 3.5 Haiku', context: '200K', input: '$0.80/M', output: '$4/M' },
                            { id: 'openai/anthropic/claude-3.5-sonnet', name: 'Claude 3.5 Sonnet', context: '200K', input: '$3/M', output: '$15/M' },
                            { id: 'openai/anthropic/claude-sonnet-4', name: 'Claude Sonnet 4', context: '200K', input: '$3/M', output: '$15/M' },
                            { id: 'openai/anthropic/claude-haiku-4.5', name: 'Claude Haiku 4.5', context: '200K', input: '$0.80/M', output: '$4/M' },
                            { id: 'openai/anthropic/claude-sonnet-4.5', name: 'Claude Sonnet 4.5', context: '200K', input: '$3/M', output: '$15/M' },
                            { id: 'openai/anthropic/claude-opus-4.5', name: 'Claude Opus 4.5', context: '200K', input: '$15/M', output: '$75/M' },
                        ]
                    },
                    'openai': {
                        name: 'OpenAI',
                        icon: 'ğŸŸ¢',
                        models: [
                            { id: 'openai/openai/gpt-4o-mini', name: 'GPT-4o Mini', context: '128K', input: '$0.15/M', output: '$0.60/M' },
                            { id: 'openai/openai/gpt-4o', name: 'GPT-4o', context: '128K', input: '$2.50/M', output: '$10/M' },
                            { id: 'openai/openai/gpt-5-mini', name: 'GPT-5 Mini', context: '1M', input: '$1.10/M', output: '$4.40/M' },
                            { id: 'openai/openai/gpt-5.2', name: 'GPT-5.2', context: '1M', input: '$2/M', output: '$8/M' },
                        ]
                    },
                    'deepseek': {
                        name: 'DeepSeek',
                        icon: 'ğŸ”®',
                        models: [
                            { id: 'openai/tngtech/deepseek-r1t2-chimera:free', name: 'R1 Chimera (Free)', context: '164K', input: 'Free', output: 'Free', free: true },
                            { id: 'openai/deepseek/deepseek-chat-v3-0324', name: 'DeepSeek Chat V3', context: '128K', input: '$0.14/M', output: '$0.28/M' },
                            { id: 'openai/deepseek/deepseek-v3.2', name: 'DeepSeek V3.2', context: '128K', input: '$0.14/M', output: '$0.28/M' },
                        ]
                    },
                    'meta': {
                        name: 'Meta Llama',
                        icon: 'ğŸ¦™',
                        models: [
                            { id: 'openai/meta-llama/llama-3.1-8b-instruct', name: 'Llama 3.1 8B', context: '128K', input: '$0.02/M', output: '$0.05/M' },
                            { id: 'openai/meta-llama/llama-3.1-405b-instruct:free', name: 'Llama 3.1 405B (Free)', context: '128K', input: 'Free', output: 'Free', free: true },
                            { id: 'openai/meta-llama/llama-3.1-405b-instruct', name: 'Llama 3.1 405B', context: '128K', input: '$0.80/M', output: '$0.80/M' },
                            { id: 'openai/meta-llama/llama-3.3-70b-instruct:free', name: 'Llama 3.3 70B (Free)', context: '128K', input: 'Free', output: 'Free', free: true },
                            { id: 'openai/meta-llama/llama-3.3-70b-instruct', name: 'Llama 3.3 70B', context: '128K', input: '$0.10/M', output: '$0.25/M' },
                        ]
                    },
                    'xai': {
                        name: 'xAI (Grok)',
                        icon: 'âš¡',
                        models: [
                            { id: 'openai/x-ai/grok-code-fast-1', name: 'Grok Code Fast 1', context: '128K', input: '$0.15/M', output: '$0.60/M' },
                            { id: 'openai/x-ai/grok-4-fast', name: 'Grok 4 Fast', context: '256K', input: '$2/M', output: '$10/M' },
                            { id: 'openai/x-ai/grok-4.1-fast', name: 'Grok 4.1 Fast', context: '1M', input: '$3/M', output: '$15/M' },
                        ]
                    },
                    'mistral': {
                        name: 'Mistral AI',
                        icon: 'ğŸŒ€',
                        models: [
                            { id: 'openai/mistralai/devstral-2512:free', name: 'Devstral 2512 (Free)', context: '128K', input: 'Free', output: 'Free', free: true },
                        ]
                    },
                    'xiaomi': {
                        name: 'Xiaomi',
                        icon: 'ğŸ“±',
                        models: [
                            { id: 'openai/xiaomi/mimo-v2-flash:free', name: 'MiMo V2 Flash (Free)', context: '128K', input: 'Free', output: 'Free', free: true },
                        ]
                    },
                };

                const [selectedProvider, setSelectedProvider] = useState('deepseek');
                const [selectedModel, setSelectedModel] = useState('openai/tngtech/deepseek-r1t2-chimera:free');

                // ì œê³µì‚¬ ë³€ê²½ ì‹œ ì²« ë²ˆì§¸ ëª¨ë¸ë¡œ ìë™ ì„ íƒ
                const handleProviderChange = (provider) => {
                    setSelectedProvider(provider);
                    const models = MODEL_PROVIDERS[provider]?.models;
                    if (models && models.length > 0) {
                        setSelectedModel(models[0].id);
                    }
                };

                // í˜„ì¬ ì„ íƒëœ ëª¨ë¸ ì •ë³´
                const getSelectedModelInfo = () => {
                    const provider = MODEL_PROVIDERS[selectedProvider];
                    if (!provider) return null;
                    return provider.models.find(m => m.id === selectedModel);
                };

                const [npcModalOpen, setNpcModalOpen] = useState(false);
                const [resultModal, setResultModal] = useState({ open: false, type: 'info', title: '', message: '' });
                const [isLoading, setIsLoading] = useState(false);
                const [progress, setProgress] = useState(0);
                const [remainingTime, setRemainingTime] = useState(0);

                // ìë™ ì œëª© ê¸°ëŠ¥
                const [useAutoTitle, setUseAutoTitle] = useState(true);
                const [generatedTitle, setGeneratedTitle] = useState('');

                const [draggingNodeId, setDraggingNodeId] = useState(null);
                const [connectingSourceId, setConnectingSourceId] = useState(null);
                const [mousePos, setMousePos] = useState({ x: 0, y: 0 });
                const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });

                // ì¤Œ ê¸°ëŠ¥ state ì¶”ê°€
                const [zoom, setZoom] = useState(1);
                const [panOffset, setPanOffset] = useState({ x: 0, y: 0 });
                const [isPanning, setIsPanning] = useState(false);
                const [panStart, setPanStart] = useState({ x: 0, y: 0 });

                const canvasRef = useRef(null);
                const timerRef = useRef(null);

                // ì¤Œ ì œí•œ
                const MIN_ZOOM = 0.25;
                const MAX_ZOOM = 2;

                // ë§ˆìš°ìŠ¤ íœ  ì¤Œ í•¸ë“¤ëŸ¬
                const handleWheel = (e) => {
                    e.preventDefault();
                    const delta = e.deltaY * -0.001;
                    const newZoom = Math.min(Math.max(zoom + delta, MIN_ZOOM), MAX_ZOOM);
                    setZoom(newZoom);
                };

                // ì¤Œ ë²„íŠ¼ í•¸ë“¤ëŸ¬
                const handleZoomIn = () => {
                    setZoom(prev => Math.min(prev + 0.1, MAX_ZOOM));
                };

                const handleZoomOut = () => {
                    setZoom(prev => Math.max(prev - 0.1, MIN_ZOOM));
                };

                const handleZoomReset = () => {
                    setZoom(1);
                    setPanOffset({ x: 0, y: 0 });
                };

                // ìº”ë²„ìŠ¤ ë§ˆìš°ìŠ¤ ë‹¤ìš´ (íŒ¨ë‹ ì‹œì‘)
                const handleCanvasMouseDown = (e) => {
                    // ìŠ¤í˜ì´ìŠ¤ë°”ë¥¼ ëˆ„ë¥´ê±°ë‚˜ ì¤‘ê°„ ë§ˆìš°ìŠ¤ ë²„íŠ¼ìœ¼ë¡œ íŒ¨ë‹
                    if (e.button === 1 || (e.button === 0 && e.shiftKey)) {
                        e.preventDefault();
                        setIsPanning(true);
                        setPanStart({ x: e.clientX - panOffset.x, y: e.clientY - panOffset.y });
                    }
                };

                const addNode = (type) => {
                    const id = `${type}-${Date.now()}`;
                    setNodes(p => [...p, { id, type, x: Math.random() * 200 + 100, y: Math.random() * 200 + 100, data: { title: type === 'scene' ? 'ìƒˆë¡œìš´ ì¥ë©´' : 'ìƒˆë¡œìš´ ì—”ë”©', description: '', npcs: [] } }]);
                };

                const deleteNode = (id) => {
                    if (id === 'start') return;
                    setNodes(p => p.filter(n => n.id !== id));
                    setConnections(p => p.filter(c => c.source !== id && c.target !== id));
                    if (selectedNodeId === id) setSelectedNodeId(null);
                };

                const updateNodeData = (key, value) => {
                    if (!selectedNodeId) return;
                    setNodes(p => p.map(n => n.id === selectedNodeId ? { ...n, data: { ...n.data, [key]: value } } : n));
                };

                const addGlobalNpc = (e) => {
                    e.preventDefault();
                    const form = e.target;
                    const name = form.elements.namedItem('npcName').value;
                    const role = form.elements.namedItem('npcRole').value;
                    const trait = form.elements.namedItem('npcTrait').value;
                    if(name) { setGlobalNpcs(p => [...p, { name, role, trait }]); form.reset(); }
                };

                const handleGenerate = async () => {
                    if (nodes.length < 2) {
                        setResultModal({ open: true, type: 'error', title: 'ìƒì„± ë¶ˆê°€', message: 'ìµœì†Œí•œ í•˜ë‚˜ì˜ ì¥ë©´ ë…¸ë“œê°€ ì¶”ê°€ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.' });
                        return;
                    }

                    const estimatedSecs = 10 + (nodes.length * 5);
                    setRemainingTime(estimatedSecs);
                    setProgress(0);
                    setIsLoading(true);

                    const startTime = Date.now();
                    timerRef.current = setInterval(() => {
                        const elapsed = (Date.now() - startTime) / 1000;
                        const newProgress = Math.min(90, (elapsed / estimatedSecs) * 100);
                        const timeLeft = Math.max(0, Math.ceil(estimatedSecs - elapsed));
                        setProgress(newProgress);
                        setRemainingTime(timeLeft);
                    }, 100);

                    try {
                        const response = await fetch('/api/init_game', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            // [ìˆ˜ì •] edgesë¡œ ë³€í™˜í•˜ì—¬ ì „ì†¡
                            body: JSON.stringify({ nodes, edges: connections, npcs: globalNpcs, model: selectedModel })
                        });

                        clearInterval(timerRef.current);
                        setProgress(100);
                        setRemainingTime(0);
                        await new Promise(r => setTimeout(r, 500));

                        if (!response.ok) {
                            const errData = await response.json();
                            throw new Error(errData.error || 'ì„œë²„ ì˜¤ë¥˜');
                        }

                        const data = await response.json();

                        // ìƒì„±ëœ ì œëª© ì¶”ì¶œ (filenameì—ì„œ .json ì œê±°)
                        if (data.filename) {
                            const titleFromFilename = data.filename.replace('.json', '').replace(/_/g, ' ');
                            setGeneratedTitle(titleFromFilename);

                            // ìë™ ì œëª© ì‚¬ìš© ì‹œ start ë…¸ë“œì˜ label ì—…ë°ì´íŠ¸
                            if (useAutoTitle) {
                                setNodes(prev => prev.map(n =>
                                    n.id === 'start'
                                        ? { ...n, data: { ...n.data, label: titleFromFilename } }
                                        : n
                                ));
                            }
                        }

                        setResultModal({
                            open: true, type: 'success', title: 'ìƒì„± ì™„ë£Œ!',
                            message: `${data.message}\nì´ì œ í”Œë ˆì´ì–´ ëª¨ë“œì—ì„œ ê²Œì„ì„ ì¦ê²¨ë³´ì„¸ìš”.`
                        });

                    } catch (error) {
                        clearInterval(timerRef.current);
                        console.error(error);
                        setResultModal({ open: true, type: 'error', title: 'ìƒì„± ì‹¤íŒ¨', message: error.message });
                    } finally {
                        setIsLoading(false);
                    }
                };

                // [ìˆ˜ì •ë¨] ëˆ„ë½ë˜ì—ˆë˜ ë°°ê²½ í´ë¦­ í•¸ë“¤ëŸ¬ ì¶”ê°€
                const handleBackgroundClick = (e) => {
                    if (e.target === canvasRef.current || e.target.id === 'svg-layer') {
                        setSelectedNodeId(null);
                        setConnectingSourceId(null);
                    }
                };

                const handleMouseDownNode = (e, id) => {
                    e.stopPropagation();
                    if (connectingSourceId) {
                        if (connectingSourceId !== id && !connections.some(c => c.source === connectingSourceId && c.target === id)) {
                            setConnections(p => [...p, { id: `c-${Date.now()}`, source: connectingSourceId, target: id }]);
                        }
                        setConnectingSourceId(null);
                        return;
                    }
                    const node = nodes.find(n => n.id === id);
                    if (node) {
                        const rect = canvasRef.current.getBoundingClientRect();
                        const x = (e.clientX - rect.left - panOffset.x) / zoom;
                        const y = (e.clientY - rect.top - panOffset.y) / zoom;
                        setDragOffset({ x: x - node.x, y: y - node.y });
                        setSelectedNodeId(id);
                        setDraggingNodeId(id);
                    }
                };

                const handleCanvasMouseMove = (e) => {
                    if (!canvasRef.current) return;
                    const rect = canvasRef.current.getBoundingClientRect();
                    const x = (e.clientX - rect.left - panOffset.x) / zoom;
                    const y = (e.clientY - rect.top - panOffset.y) / zoom;
                    setMousePos({ x, y });

                    if (isPanning) {
                        setPanOffset({
                            x: e.clientX - panStart.x,
                            y: e.clientY - panStart.y
                        });
                    } else if (draggingNodeId) {
                        setNodes(p => p.map(n => n.id === draggingNodeId ? { ...n, x: x - dragOffset.x, y: y - dragOffset.y } : n));
                    }
                };

                const handleCanvasMouseUp = () => {
                    setDraggingNodeId(null);
                    setIsPanning(false);
                };

                // ë…¸ë“œ í¬ê¸° ìƒìˆ˜
                const NODE_WIDTH = 200;
                const NODE_HEIGHT = 80;

                // ë‘ ë…¸ë“œ ê°„ ìµœì ì˜ ì—°ê²°ì  ê³„ì‚°
                const getConnectionPoints = (sourceNode, targetNode) => {
                    const sCenterX = sourceNode.x + NODE_WIDTH / 2;
                    const sCenterY = sourceNode.y + NODE_HEIGHT / 2;
                    const tCenterX = targetNode.x + NODE_WIDTH / 2;
                    const tCenterY = targetNode.y + NODE_HEIGHT / 2;

                    const dx = tCenterX - sCenterX;
                    const dy = tCenterY - sCenterY;

                    let sx, sy, tx, ty;

                    // ìˆ˜í‰ ê±°ë¦¬ê°€ ìˆ˜ì§ ê±°ë¦¬ë³´ë‹¤ í¬ë©´ ì¢Œìš° ì—°ê²°
                    if (Math.abs(dx) > Math.abs(dy)) {
                        if (dx > 0) {
                            // íƒ€ê²Ÿì´ ì˜¤ë¥¸ìª½ì— ìˆìŒ: ì†ŒìŠ¤ ì˜¤ë¥¸ìª½ â†’ íƒ€ê²Ÿ ì™¼ìª½
                            sx = sourceNode.x + NODE_WIDTH;
                            sy = sourceNode.y + NODE_HEIGHT / 2;
                            tx = targetNode.x;
                            ty = targetNode.y + NODE_HEIGHT / 2;
                        } else {
                            // íƒ€ê²Ÿì´ ì™¼ìª½ì— ìˆìŒ: ì†ŒìŠ¤ ì™¼ìª½ â†’ íƒ€ê²Ÿ ì˜¤ë¥¸ìª½
                            sx = sourceNode.x;
                            sy = sourceNode.y + NODE_HEIGHT / 2;
                            tx = targetNode.x + NODE_WIDTH;
                            ty = targetNode.y + NODE_HEIGHT / 2;
                        }
                    } else {
                        // ìˆ˜ì§ ê±°ë¦¬ê°€ ë” í¬ë©´ ìƒí•˜ ì—°ê²°
                        if (dy > 0) {
                            // íƒ€ê²Ÿì´ ì•„ë˜ì— ìˆìŒ: ì†ŒìŠ¤ í•˜ë‹¨ â†’ íƒ€ê²Ÿ ìƒë‹¨
                            sx = sourceNode.x + NODE_WIDTH / 2;
                            sy = sourceNode.y + NODE_HEIGHT;
                            tx = targetNode.x + NODE_WIDTH / 2;
                            ty = targetNode.y;
                        } else {
                            // íƒ€ê²Ÿì´ ìœ„ì— ìˆìŒ: ì†ŒìŠ¤ ìƒë‹¨ â†’ íƒ€ê²Ÿ í•˜ë‹¨
                            sx = sourceNode.x + NODE_WIDTH / 2;
                            sy = sourceNode.y;
                            tx = targetNode.x + NODE_WIDTH / 2;
                            ty = targetNode.y + NODE_HEIGHT;
                        }
                    }

                    return { sx, sy, tx, ty };
                };

                // ë² ì§€ì–´ ì»¤ë¸Œ ê²½ë¡œ ìƒì„± (ì—°ê²° ë°©í–¥ì— ë”°ë¼ ì œì–´ì  ì¡°ì •)
                const createPath = (sx, sy, tx, ty) => {
                    const dx = tx - sx;
                    const dy = ty - sy;

                    // ìˆ˜í‰ ì—°ê²°ì¸ ê²½ìš°
                    if (Math.abs(dx) > Math.abs(dy)) {
                        const cpOffset = Math.abs(dx) * 0.4;
                        const cp1x = sx + (dx > 0 ? cpOffset : -cpOffset);
                        const cp2x = tx + (dx > 0 ? -cpOffset : cpOffset);
                        return `M ${sx} ${sy} C ${cp1x} ${sy}, ${cp2x} ${ty}, ${tx} ${ty}`;
                    } else {
                        // ìˆ˜ì§ ì—°ê²°ì¸ ê²½ìš°
                        const cpOffset = Math.abs(dy) * 0.4;
                        const cp1y = sy + (dy > 0 ? cpOffset : -cpOffset);
                        const cp2y = ty + (dy > 0 ? -cpOffset : cpOffset);
                        return `M ${sx} ${sy} C ${sx} ${cp1y}, ${tx} ${cp2y}, ${tx} ${ty}`;
                    }
                };

                return (
                    <div className="flex h-screen bg-black text-white font-sans overflow-hidden no-select">
                        <LoadingOverlay isOpen={isLoading} progress={progress} remainingTime={remainingTime} />

                        <div className="w-64 bg-gray-900 border-r border-gray-800 flex flex-col z-20 shadow-xl">
                            <div className="p-4 border-b border-gray-800 flex justify-between items-center">
                                <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">Builder</h1>
                                <a href="/" className="text-gray-500 hover:text-white p-2 rounded hover:bg-gray-800"><Icon name="log-out" size={18} /></a>
                            </div>
                            <div className="p-4 space-y-3">
                                <button onClick={() => addNode('scene')} className="w-full py-2.5 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-lg text-sm text-indigo-300 flex items-center justify-center gap-2"><div className="w-2 h-2 bg-indigo-500 rounded-full"></div> ì”¬ ì¶”ê°€</button>
                                <button onClick={() => addNode('ending')} className="w-full py-2.5 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-lg text-sm text-red-300 flex items-center justify-center gap-2"><div className="w-2 h-2 bg-red-500 rounded-full"></div> ì—”ë”© ì¶”ê°€</button>
                                <button onClick={() => setNpcModalOpen(true)} className="w-full py-2.5 bg-gray-800 hover:bg-gray-700 border border-gray-700 rounded-lg text-sm text-green-300 flex items-center justify-center gap-2"><Icon name="users" size={16} /> NPC ê´€ë¦¬</button>

                                <div className="pt-3 border-t border-gray-800">
                                    <label className="text-xs text-gray-400 block mb-2">ğŸ¤– AI ëª¨ë¸ ì„ íƒ</label>
                                    <div className="flex flex-col gap-2">
                                        <select
                                            value={selectedProvider}
                                            onChange={(e) => handleProviderChange(e.target.value)}
                                            className="w-full bg-gray-800 border border-gray-700 rounded-lg p-2.5 text-sm text-white cursor-pointer hover:border-gray-600 focus:border-blue-500 focus:outline-none"
                                        >
                                            {Object.entries(MODEL_PROVIDERS).map(([key, provider]) => (
                                                <option key={key} value={key}>{provider.name}</option>
                                            ))}
                                        </select>
                                        <select
                                            value={selectedModel}
                                            onChange={(e) => setSelectedModel(e.target.value)}
                                            className="w-full bg-gray-800 border border-gray-700 rounded-lg p-2.5 text-sm text-white cursor-pointer hover:border-gray-600 focus:border-blue-500 focus:outline-none"
                                        >
                                            {MODEL_PROVIDERS[selectedProvider]?.models.map(m => (
                                                <option key={m.id} value={m.id}>{m.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <p className="text-xs text-gray-500 mt-1.5">
                                        {getSelectedModelInfo()?.context} | ì…ë ¥: {getSelectedModelInfo()?.input} | ì¶œë ¥: {getSelectedModelInfo()?.output}
                                    </p>
                                </div>
                            </div>
                            <div className="mt-auto p-4 border-t border-gray-800">
                                <button onClick={handleGenerate} className="w-full py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold rounded-lg shadow-lg flex items-center justify-center gap-2">
                                    <Icon name="play" size={18} /> ì‹œë‚˜ë¦¬ì˜¤ ìƒì„±
                                </button>
                            </div>
                        </div>

                        <div ref={canvasRef} className="flex-1 relative bg-gray-950 overflow-hidden cursor-crosshair bg-dots-pattern"
                            onMouseMove={handleCanvasMouseMove} onMouseUp={handleCanvasMouseUp} onClick={handleBackgroundClick}
                            onWheel={handleWheel} onMouseDown={handleCanvasMouseDown}>

                            {/* ì¤Œ ì»¨íŠ¸ë¡¤ UI */}
                            <div className="absolute top-4 right-4 z-30 flex flex-col gap-2 bg-gray-900/90 backdrop-blur-sm rounded-lg p-2 border border-gray-700 shadow-xl">
                                <button
                                    onClick={handleZoomIn}
                                    className="w-10 h-10 bg-gray-800 hover:bg-gray-700 rounded-lg flex items-center justify-center text-white transition-colors border border-gray-600 hover:border-gray-500"
                                    title="í™•ëŒ€ (Zoom In)"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <circle cx="11" cy="11" r="8"></circle>
                                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                        <line x1="11" y1="8" x2="11" y2="14"></line>
                                        <line x1="8" y1="11" x2="14" y2="11"></line>
                                    </svg>
                                </button>
                                <button
                                    onClick={handleZoomReset}
                                    className="w-10 h-10 bg-gray-800 hover:bg-gray-700 rounded-lg flex items-center justify-center text-white transition-colors border border-gray-600 hover:border-gray-500 text-xs font-bold"
                                    title="ì´ˆê¸°í™” (Reset)"
                                >
                                    {Math.round(zoom * 100)}%
                                </button>
                                <button
                                    onClick={handleZoomOut}
                                    className="w-10 h-10 bg-gray-800 hover:bg-gray-700 rounded-lg flex items-center justify-center text-white transition-colors border border-gray-600 hover:border-gray-500"
                                    title="ì¶•ì†Œ (Zoom Out)"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                        <circle cx="11" cy="11" r="8"></circle>
                                        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                                        <line x1="8" y1="11" x2="14" y2="11"></line>
                                    </svg>
                                </button>
                            </div>

                            {/* ì¡°ì‘ ê°€ì´ë“œ */}
                            <div className="absolute bottom-4 left-4 z-30 bg-gray-900/80 backdrop-blur-sm rounded-lg px-3 py-2 border border-gray-700 text-xs text-gray-400">
                                <div className="flex items-center gap-2">
                                    <span className="text-white font-bold">ì¡°ì‘ë²•:</span>
                                    <span>ë§ˆìš°ìŠ¤ íœ  = ì¤Œ</span>
                                    <span className="text-gray-600">|</span>
                                    <span>Shift + ë“œë˜ê·¸ = ì´ë™</span>
                                </div>
                            </div>

                            {/* transform ì ìš©ëœ ì»¨í…Œì´ë„ˆ */}
                            <div style={{
                                transform: `translate(${panOffset.x}px, ${panOffset.y}px) scale(${zoom})`,
                                transformOrigin: '0 0',
                                width: '100%',
                                height: '100%',
                                position: 'absolute'
                            }}>
                                <svg className="absolute inset-0 w-full h-full pointer-events-none z-0">
                                    {connections.map(c => {
                                        const s = nodes.find(n => n.id === c.source), t = nodes.find(n => n.id === c.target);
                                        if (!s || !t) return null;
                                        const { sx, sy, tx, ty } = getConnectionPoints(s, t);
                                        return <path key={c.id} d={createPath(sx, sy, tx, ty)} stroke="#4b5563" strokeWidth="2" fill="none" />;
                                    })}
                                    {connectingSourceId && (() => {
                                        const s = nodes.find(n => n.id === connectingSourceId);
                                        if (!s) return null;
                                        // ì—°ê²° ì¤‘ì¸ ì„ : ì†ŒìŠ¤ ë…¸ë“œ ì¤‘ì‹¬ì—ì„œ ë§ˆìš°ìŠ¤ ìœ„ì¹˜ê¹Œì§€
                                        const sx = s.x + NODE_WIDTH / 2;
                                        const sy = s.y + NODE_HEIGHT / 2;
                                        return <path d={createPath(sx, sy, mousePos.x, mousePos.y)} stroke="#6366f1" strokeWidth="2" strokeDasharray="5,5" fill="none" />;
                                    })()}
                                </svg>
                                {nodes.map(node => (
                                    <div key={node.id} style={{ left: node.x, top: node.y }} onMouseDown={(e) => handleMouseDownNode(e, node.id)}
                                        className={`absolute w-[200px] rounded-lg shadow-xl border-2 group select-none transition-shadow ${selectedNodeId === node.id ? 'border-white z-20 ring-2 ring-blue-500/50' : node.type === 'start' ? 'border-blue-600 bg-gray-900 z-10' : node.type === 'ending' ? 'border-red-600 bg-gray-900 z-10' : 'border-indigo-600 bg-gray-900 z-10'} ${connectingSourceId && connectingSourceId !== node.id ? 'hover:scale-105 cursor-pointer' : 'cursor-grab active:cursor-grabbing'}`}>
                                        <div className={`p-2 rounded-t-md text-sm font-bold flex justify-between ${node.type === 'start' ? 'bg-blue-900/50 text-blue-200' : node.type === 'ending' ? 'bg-red-900/50 text-red-200' : 'bg-indigo-900/50 text-indigo-200'}`}>
                                            <span className="truncate">{node.type === 'start' ? 'ì„¤ì •' : node.type === 'scene' ? 'Scene' : 'Ending'}</span>
                                            <button onClick={(e) => { e.stopPropagation(); setConnectingSourceId(node.id); setSelectedNodeId(node.id); }} className="hover:text-white p-0.5"><Icon name="link" size={14} /></button>
                                        </div>
                                        <div className="p-3 text-xs text-gray-300 min-h-[60px] relative">
                                            <div className="font-bold mb-1 truncate">{node.data.title || 'ì œëª© ì—†ìŒ'}</div>
                                            <div className="text-gray-500 line-clamp-2">{node.data.description || 'ë‚´ìš© ì—†ìŒ'}</div>
                                            {node.id !== 'start' && selectedNodeId === node.id && (
                                                <button onClick={(e) => { e.stopPropagation(); deleteNode(node.id); }} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-1 shadow-md hover:bg-red-600 w-5 h-5 flex items-center justify-center"><Icon name="x" size={12} /></button>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>

                        <div className="w-80 bg-gray-900 border-l border-gray-800 overflow-y-auto z-20 shadow-xl">
                            {selectedNodeId ? (() => {
                                const node = nodes.find(n => n.id === selectedNodeId);
                                if (!node) return null;
                                return (
                                    <div className="p-6 space-y-6">
                                        <h2 className="text-lg font-bold border-b border-gray-700 pb-2">ì†ì„± í¸ì§‘ <span className="text-xs bg-gray-800 px-2 py-0.5 rounded text-gray-400">{node.type}</span></h2>
                                        <div className="space-y-3">
                                            {/* start ë…¸ë“œì¼ ê²½ìš° ìë™ ì œëª© ì²´í¬ë°•ìŠ¤ í‘œì‹œ */}
                                            {node.type === 'start' && (
                                                <div className="bg-blue-900/20 border border-blue-800/50 rounded-lg p-3 space-y-2">
                                                    <label className="flex items-center gap-2 cursor-pointer">
                                                        <input
                                                            type="checkbox"
                                                            className="rounded bg-gray-700 border-gray-600 text-blue-500 w-4 h-4"
                                                            checked={useAutoTitle}
                                                            onChange={(e) => {
                                                                setUseAutoTitle(e.target.checked);
                                                                // ìë™ ì œëª© í™œì„±í™” ì‹œ ìƒì„±ëœ ì œëª©ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                                                                if (e.target.checked && generatedTitle) {
                                                                    setNodes(prev => prev.map(n =>
                                                                        n.id === 'start'
                                                                            ? { ...n, data: { ...n.data, label: generatedTitle } }
                                                                            : n
                                                                    ));
                                                                }
                                                            }}
                                                        />
                                                        <span className="text-sm text-blue-300 font-medium">AI ìƒì„± ì œëª© ì‚¬ìš©</span>
                                                    </label>
                                                    {generatedTitle && (
                                                        <p className="text-xs text-gray-400 pl-6">ìƒì„±ëœ ì œëª©: <span className="text-blue-400">{generatedTitle}</span></p>
                                                    )}
                                                    {!generatedTitle && (
                                                        <p className="text-xs text-gray-500 pl-6">ì‹œë‚˜ë¦¬ì˜¤ ìƒì„± í›„ ìë™ìœ¼ë¡œ ì œëª©ì´ ì…ë ¥ë©ë‹ˆë‹¤</p>
                                                    )}
                                                </div>
                                            )}
                                            <div>
                                                <label className="text-xs text-gray-400 block mb-1">ì œëª©</label>
                                                <input
                                                    className={`w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm text-white ${node.type === 'start' && useAutoTitle ? 'opacity-50 cursor-not-allowed' : ''}`}
                                                    value={node.type === 'start' ? (node.data.label || '') : (node.data.title || '')}
                                                    onChange={e => updateNodeData(node.type === 'start' ? 'label' : 'title', e.target.value)}
                                                    disabled={node.type === 'start' && useAutoTitle}
                                                    placeholder={node.type === 'start' && useAutoTitle ? 'ì‹œë‚˜ë¦¬ì˜¤ ìƒì„± ì‹œ ìë™ ì…ë ¥' : 'ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”'}
                                                />
                                            </div>
                                            <div><label className="text-xs text-gray-400 block mb-1">ë‚´ìš©</label><textarea rows={5} className="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm text-white resize-none" value={node.data.description || ''} onChange={e => updateNodeData('description', e.target.value)} /></div>
                                        </div>
                                        {node.type === 'scene' && (
                                            <div className="space-y-2 pt-4 border-t border-gray-800">
                                                <h3 className="text-sm font-bold text-green-400 flex justify-between">NPC ë“±ì¥ <span className="cursor-pointer hover:text-white" onClick={() => setNpcModalOpen(true)}>+ì¶”ê°€</span></h3>
                                                <div className="space-y-1 max-h-40 overflow-y-auto pr-1">{globalNpcs.map((n, i) => (
                                                    <label key={i} className="flex items-center space-x-2 text-sm p-1.5 hover:bg-gray-800 rounded cursor-pointer">
                                                        <input type="checkbox" className="rounded bg-gray-700 border-gray-600 text-green-500" checked={(node.data.npcs || []).includes(n.name)}
                                                            onChange={e => updateNodeData('npcs', e.target.checked ? [...(node.data.npcs || []), n.name] : (node.data.npcs || []).filter(x => x !== n.name))} />
                                                        <span>{n.name}</span>
                                                    </label>
                                                ))}</div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })() : <div className="flex flex-col items-center justify-center h-full text-gray-600"><Icon name="settings" size={48} className="mb-4 opacity-50" /><p className="text-sm">ë…¸ë“œë¥¼ ì„ íƒí•˜ì„¸ìš”</p></div>}
                        </div>

                        <Modal isOpen={npcModalOpen} title="NPC ìƒì„±" onClose={() => setNpcModalOpen(false)}>
                            <form onSubmit={addGlobalNpc} className="space-y-4">
                                <input name="npcName" required className="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white" placeholder="ì´ë¦„" />
                                <input name="npcRole" required className="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white" placeholder="ì—­í• " />
                                <textarea name="npcTrait" required className="w-full bg-gray-800 border border-gray-700 rounded p-2 text-white resize-none" placeholder="íŠ¹ì§•" />
                                <div className="flex gap-2 mt-6">
                                    <button type="button" onClick={() => setNpcModalOpen(false)} className="flex-1 py-2 bg-gray-800 rounded">ë‹«ê¸°</button>
                                    <button type="submit" className="flex-1 py-2 bg-green-600 rounded font-bold">ì¶”ê°€</button>
                                </div>
                            </form>
                        </Modal>

                        <Modal isOpen={resultModal.open} type={resultModal.type} title={resultModal.title} onClose={() => setResultModal({ ...resultModal, open: false })}>
                            <div className="whitespace-pre-wrap">{resultModal.message}</div>
                            <div className="mt-6 flex justify-end gap-2">
                                {resultModal.type === 'success' && <a href="/views/player" className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded font-bold">í”Œë ˆì´í•˜ëŸ¬ ê°€ê¸°</a>}
                                <button onClick={() => setResultModal({ ...resultModal, open: false })} className="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded text-white">í™•ì¸</button>
                            </div>
                        </Modal>
                    </div>
                );
            }

            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<ScenarioBuilder />);

        } catch (error) {
            document.getElementById('global-error').style.display = 'block';
            document.getElementById('global-error').innerText = "[React Init Error] " + error.message;
        }
    </script>
    {% endraw %}
</body>
</html>
