<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRPG Studio - {{ version }}</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Pretendard', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }

        .htmx-indicator { display: none; pointer-events: none; }
        .htmx-request .htmx-indicator { display: flex; pointer-events: auto; }
        .htmx-request.htmx-indicator { display: flex; pointer-events: auto; }

         /* ë¸Œëœë“œ ê·¸ë¼ë°ì´ì…˜ */

        .brand-gradient {
            background: linear-gradient(135deg, #6E47E6 0%, #818cf8 100%);
        }
        /* ë¡œê·¸ì¸/íšŒì›ê°€ì…ìš© ê·¸ë¼ë°ì´ì…˜ (ê¸°ì¡´ html íŒŒì¼ ë””ìì¸) */
        .auth-gradient {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);

        }

        /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
        .sidebar {
            width: 72px;
            transition: width 0.3s ease;
        }
        .sidebar:hover,
        .sidebar.expanded {
            width: 260px;
        }
        .sidebar .nav-text, .sidebar .logo-text, .sidebar .section-title, .sidebar .user-info, .sidebar .user-chevron {
            opacity: 0;
            white-space: nowrap;
            transition: opacity 0.2s ease;
        }
        .sidebar:hover .nav-text, .sidebar.expanded .nav-text,
        .sidebar:hover .logo-text, .sidebar.expanded .logo-text,
        .sidebar:hover .section-title, .sidebar.expanded .section-title,
        .sidebar:hover .user-info, .sidebar.expanded .user-info,
        .sidebar:hover .user-chevron, .sidebar.expanded .user-chevron {
            opacity: 1;
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: hidden !important; }

        /* ë²„ì „ ì •ë³´ ìŠ¤íƒ€ì¼ */
        .version-badge {
            position: fixed;
            bottom: 16px;
            right: 16px;
            background: rgba(28, 28, 28, 0.8);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 11px;
            color: #9ca3af;
            font-family: 'Courier New', monospace;
            z-index: 1000;
            transition: all 0.2s ease;
        }

    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: { 900: '#111111', 800: '#1c1c1c', 700: '#2c2c2c', 600: '#3f3f46' },
                        brand: { purple: '#6E47E6', light: '#9F7AEA' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-dark-900 text-gray-200 h-screen flex overflow-hidden selection:bg-brand-purple selection:text-white">

    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar bg-dark-800 border-r border-white/5 flex flex-col hidden md:flex shrink-0 z-20 overflow-hidden">
        <div class="p-4 h-16 flex items-center">
            <div class="flex items-center gap-2 cursor-pointer" onclick="location.href='/'">
                <div class="w-10 h-10 brand-gradient rounded-lg flex items-center justify-center text-white shadow-lg shadow-brand-purple/20 shrink-0">
                    <i data-lucide="dice-5" class="w-5 h-5 fill-current"></i>
                </div>
                <span class="logo-text text-xl font-bold text-white tracking-tight">TRPG Studio</span>
            </div>
        </div>

        <nav class="flex-1 px-3 space-y-1 mt-2">
            <div class="section-title text-[10px] font-semibold text-gray-500 px-3 py-2 uppercase tracking-wider">Workspace</div>
            <a href="/" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg bg-white/5 text-white group cursor-pointer text-sm font-medium">
                <i data-lucide="layout-grid" class="w-5 h-5 text-brand-light shrink-0"></i>
                <span class="nav-text">ëŒ€ì‹œë³´ë“œ</span>
            </a>
            <a href="/views/builder" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-400 hover:bg-white/5 hover:text-white group cursor-pointer text-sm font-medium transition-colors">
                <i data-lucide="pen-tool" class="w-5 h-5 text-gray-500 group-hover:text-gray-300 shrink-0"></i>
                <span class="nav-text">ì‹œë‚˜ë¦¬ì˜¤ ë¹Œë”</span>
            </a>
            <a href="/views/player" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-400 hover:bg-white/5 hover:text-white group cursor-pointer text-sm font-medium transition-colors">
                <i data-lucide="gamepad-2" class="w-5 h-5 text-gray-500 group-hover:text-gray-300 shrink-0"></i>
                <span class="nav-text">í”Œë ˆì´ì–´ ëª¨ë“œ</span>
            </a>
            <a href="/views/scenes" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-400 hover:bg-white/5 hover:text-white group cursor-pointer text-sm font-medium transition-colors">
                <i data-lucide="git-merge" class="w-5 h-5 text-gray-500 group-hover:text-gray-300 shrink-0"></i>
                <span class="nav-text">ì „ì²´ ì”¬ ë³´ê¸°</span>
            </a>
        </nav>

        <!-- ìœ ì € í”„ë¡œí•„ -->
        <div class="p-3 border-t border-white/5">
            {% if user.is_authenticated %}
            <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 cursor-pointer transition-colors" onclick="logout()">
                <img src="{{ user.profile_img }}" alt="Profile" class="w-8 h-8 rounded-full border border-gray-600 bg-gray-700">
                <div class="user-info flex-1 min-w-0">
                    <p class="text-sm font-medium text-white truncate">{{ user.id }}</p>
                    <p class="text-[11px] text-brand-light truncate">ë¡œê·¸ì•„ì›ƒ</p>
                </div>
                <i data-lucide="log-out" class="user-chevron w-4 h-4 text-gray-500"></i>
            </div>
            {% else %}
            <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 cursor-pointer transition-colors" onclick="openModal('login-modal')">
                <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center shrink-0">
                    <i data-lucide="user" class="w-4 h-4 text-gray-400"></i>
                </div>
                <div class="user-info flex-1 min-w-0">
                    <p class="text-sm font-medium text-white truncate">ë¡œê·¸ì¸</p>
                    <p class="text-[11px] text-gray-500 truncate">ê³„ì • ì ‘ì†</p>
                </div>
            </div>
            <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 cursor-pointer transition-colors mt-1" onclick="openModal('register-modal')">
                <div class="w-8 h-8 rounded-full bg-brand-purple/20 flex items-center justify-center shrink-0">
                    <i data-lucide="user-plus" class="w-4 h-4 text-brand-light"></i>
                </div>
                <div class="user-info flex-1 min-w-0">
                    <p class="text-sm font-medium text-white truncate">íšŒì›ê°€ì…</p>
                    <p class="text-[11px] text-gray-500 truncate">ê³„ì • ìƒì„±</p>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ë©”ì¸ ë·° -->
    <div id="main-view" class="flex-1 flex flex-col h-full relative z-10 bg-dark-900 overflow-hidden">
        <!-- í—¤ë” -->
        <header class="h-16 border-b border-white/5 flex items-center justify-between px-8 bg-dark-900/80 backdrop-blur-md sticky top-0 z-20">
            <div class="flex items-center gap-4 w-full max-w-xl">
                <div class="relative w-full group">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500 group-focus-within:text-brand-light transition-colors"></i>
                    <input type="text" placeholder="ì‹œë‚˜ë¦¬ì˜¤ ê²€ìƒ‰..." class="w-full bg-dark-800 border border-white/5 rounded-full pl-10 pr-4 py-2 text-sm text-gray-300 focus:outline-none focus:ring-1 focus:ring-brand-purple/50 focus:bg-dark-700 transition-all placeholder-gray-600">
                </div>
            </div>
            <div class="flex items-center gap-4 ml-4">
                {% if user.is_authenticated %}
                    <span class="text-sm text-gray-400 hidden sm:inline"><span class="text-brand-light font-bold">{{ user.id }}</span>ë‹˜</span>
                    <button onclick="logout()" class="text-xs bg-dark-800 hover:bg-dark-700 text-gray-300 px-3 py-1.5 rounded border border-white/10 transition-colors">ë¡œê·¸ì•„ì›ƒ</button>
                {% else %}
                    <button onclick="openModal('login-modal')" class="text-sm text-gray-300 hover:text-white transition-colors">ë¡œê·¸ì¸</button>
                    <button onclick="openModal('register-modal')" class="text-sm bg-brand-purple hover:bg-brand-purple/90 text-white px-4 py-1.5 rounded-full shadow-lg shadow-brand-purple/20 transition-all">íšŒì›ê°€ì…</button>
                {% endif %}
            </div>
        </header>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <main class="flex-1 overflow-y-auto p-8 custom-scrollbar">
            <!-- ì›°ì»´ ë©”ì‹œì§€ -->
            <div class="mb-10">
                <h2 class="text-2xl font-bold text-white mb-2">{% if user.is_authenticated %}ë°˜ê°€ì›Œìš”, {{ user.id }}ë‹˜! ğŸ‘‹{% else %}TRPG Studioì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤! ğŸ‘‹{% endif %}</h2>
                <p class="text-gray-400">ì˜¤ëŠ˜ë„ ìƒˆë¡œìš´ ì„¸ê³„ë¥¼ ì°½ì¡°í•´ë³¼ê¹Œìš”?</p>
            </div>

            <!-- ë‚´ ì‘í’ˆ ëª©ë¡ (ë¡œê·¸ì¸ ì‹œ í‘œì‹œ) -->
            {% if user.is_authenticated %}
            <div class="mb-12">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2"><i data-lucide="folder-open" class="w-5 h-5 text-gray-500"></i> ë‚´ ì‘í’ˆ</h3>
                    <button class="text-xs text-gray-500 hover:text-brand-light flex items-center gap-1" onclick="document.getElementById('my-tab-btn').click(); location.href='#scenarios-list'">ì „ì²´ë³´ê¸° <i data-lucide="chevron-right" class="w-3 h-3"></i></button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" hx-get="/api/scenarios?filter=my&limit=3" hx-trigger="load">
                     <div class="col-span-full py-8 text-center text-gray-500"><i data-lucide="loader-2" class="w-6 h-6 animate-spin mx-auto mb-2 text-brand-purple"></i>ë‚´ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>
            {% endif %}

            <!-- ì‹œë‚˜ë¦¬ì˜¤ ëª©ë¡ (íƒ­) -->
            <div class="mb-12" id="scenarios-list">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2"><i data-lucide="library" class="w-5 h-5 text-gray-500"></i> ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤</h3>
                    <div class="bg-dark-800 p-1 rounded-lg inline-flex border border-white/5">
                        <button id="public-tab-btn" class="px-4 py-1.5 rounded-md text-xs font-medium bg-brand-purple text-white shadow transition-all" hx-get="/api/scenarios?filter=public" hx-target="#scenario-grid" onclick="setActiveTab(this)">ê³µê°œ</button>
                        {% if user.is_authenticated %}
                        <button id="my-tab-btn" class="px-4 py-1.5 rounded-md text-xs font-medium text-gray-400 hover:text-white transition-all" hx-get="/api/scenarios?filter=my" hx-target="#scenario-grid" onclick="setActiveTab(this)">ë‚´ ì‘í’ˆ</button>
                        {% endif %}
                    </div>
                </div>
                <div id="scenario-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" hx-get="/api/scenarios?filter=public" hx-trigger="load">
                    <div class="col-span-full py-12 flex flex-col items-center justify-center text-gray-500"><i data-lucide="loader-2" class="w-8 h-8 animate-spin mb-3 text-brand-purple"></i><p>ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p></div>
                </div>
            </div>

            <!-- í•˜ë‹¨ ë°”ë¡œê°€ê¸° -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-12">
                <a href="/views/builder" class="group bg-dark-800 p-6 rounded-xl border border-white/5 hover:border-brand-purple/50 transition-all hover:bg-dark-800/80 cursor-pointer flex flex-col items-center justify-center text-center h-40">
                    <div class="w-12 h-12 rounded-full bg-brand-purple/10 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform"><i data-lucide="plus" class="w-6 h-6 text-brand-purple"></i></div>
                    <h5 class="font-bold text-white group-hover:text-brand-light transition-colors">ìƒˆ í”„ë¡œì íŠ¸</h5>
                    <p class="text-[11px] text-gray-500 mt-1">ì²˜ìŒë¶€í„° ì§ì ‘ ë§Œë“¤ê¸°</p>
                </a>
            </div>
        </main>
    </div>

    <!-- ëª¨ë‹¬ë“¤ -->
    <div id="login-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-black/70 backdrop-blur-sm" onclick="closeModal('login-modal')"></div>
        <div class="modal-container bg-gray-800/90 w-11/12 md:max-w-md mx-auto rounded-2xl shadow-2xl z-50 overflow-hidden border border-white/10 transform transition-all scale-95 opacity-0 duration-300 relative">

            <div class="absolute top-[-50px] left-[-50px] w-40 h-40 bg-purple-600/20 rounded-full blur-3xl pointer-events-none"></div>

            <div class="absolute bottom-[-50px] right-[-50px] w-40 h-40 bg-indigo-600/20 rounded-full blur-3xl pointer-events-none"></div>


            <div class="p-8 relative z-10">


                <button onclick="closeModal('login-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>

                <div class="flex flex-col items-center mb-8">
                    <div class="w-12 h-12 auth-gradient rounded-xl flex items-center justify-center text-white shadow-lg shadow-purple-500/20 mb-4">

                        <i data-lucide="dice-5" class="w-6 h-6 fill-current"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-white tracking-tight">TRPG Studio</h1>
                    <p class="text-gray-400 text-sm mt-1">ëª¨í—˜ì„ ì‹œì‘í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”</p>
                </div>

                <form onsubmit="handleLogin(event)" class="space-y-5">
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1.5">ì•„ì´ë””</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="user" class="h-5 w-5 text-gray-500"></i></div>
                            <input type="text" name="username" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required class="w-full pl-10 pr-4 py-3 bg-gray-900/50 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
                        </div>
                    </div>
                    <div>
                        <div class="flex items-center justify-between mb-1.5">
                            <label class="block text-sm font-medium text-gray-400">ë¹„ë°€ë²ˆí˜¸</label>
                            <a href="#" class="text-xs text-purple-400 hover:text-purple-300 transition-colors">ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠìœ¼ì…¨ë‚˜ìš”?</a>
                        </div>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="lock" class="h-5 w-5 text-gray-500"></i></div>
                            <input type="password" name="password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required class="w-full pl-10 pr-4 py-3 bg-gray-900/50 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">

                        </div>
                    </div>
                    <div id="login-error" class="text-red-400 text-xs bg-red-500/10 p-2 rounded border border-red-500/20 hidden"></div>
                    <button type="submit" class="w-full py-3.5 px-4 auth-gradient hover:opacity-90 rounded-lg text-white font-semibold shadow-lg shadow-purple-500/25 transition-all transform hover:-translate-y-0.5">ë¡œê·¸ì¸</button>
                </form>

                <div class="mt-8 text-center border-t border-white/10 pt-6">
                    <p class="text-gray-400 text-sm">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <button onclick="closeModal('login-modal'); openModal('register-modal')" class="text-purple-400 hover:text-purple-300 font-medium ml-1 transition-colors">íšŒì›ê°€ì…í•˜ê¸°</button></p>
                </div>
            </div>
        </div>
    </div>



    <div id="register-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-black/70 backdrop-blur-sm" onclick="closeModal('register-modal')"></div>
        <div class="modal-container bg-gray-800/90 w-11/12 md:max-w-md mx-auto rounded-2xl shadow-2xl z-50 overflow-hidden border border-white/10 transform transition-all scale-95 opacity-0 duration-300 relative">

            <div class="absolute top-[-50px] left-[-50px] w-40 h-40 bg-purple-600/20 rounded-full blur-3xl pointer-events-none"></div>

            <div class="absolute bottom-[-50px] right-[-50px] w-40 h-40 bg-indigo-600/20 rounded-full blur-3xl pointer-events-none"></div>

            <div class="p-8 relative z-10">
                <button onclick="closeModal('register-modal')" class="absolute top-4 right-4 text-gray-400 hover:text-white transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>

                <div class="flex flex-col items-center mb-8">
                    <div class="w-12 h-12 auth-gradient rounded-xl flex items-center justify-center text-white shadow-lg shadow-purple-500/20 mb-4">

                        <i data-lucide="dice-5" class="w-6 h-6 fill-current"></i>
                    </div>
                    <h1 class="text-2xl font-bold text-white tracking-tight">íšŒì›ê°€ì…</h1>
                    <p class="text-gray-400 text-sm mt-1">TRPG Studioì˜ ë©¤ë²„ê°€ ë˜ì–´ë³´ì„¸ìš”</p>

                </div>

                <form onsubmit="handleRegister(event)" class="space-y-4">
                    <div>

                        <label class="block text-sm font-medium text-gray-400 mb-1.5">ì•„ì´ë””</label>

                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="user" class="h-5 w-5 text-gray-500"></i></div>
                            <input type="text" name="username" placeholder="ì‚¬ìš©í•  ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required class="w-full pl-10 pr-4 py-3 bg-gray-900/50 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
                        </div>

                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1.5">ì´ë©”ì¼</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="mail" class="h-5 w-5 text-gray-500"></i></div>
                            <input type="email" name="email" placeholder="example@email.com" required class="w-full pl-10 pr-4 py-3 bg-gray-900/50 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1.5">ë¹„ë°€ë²ˆí˜¸</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="lock" class="h-5 w-5 text-gray-500"></i></div>
                            <input type="password" name="password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required class="w-full pl-10 pr-4 py-3 bg-gray-900/50 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1.5">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><i data-lucide="check-circle" class="h-5 w-5 text-gray-500"></i></div>
                            <input type="password" name="confirm_password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”" required class="w-full pl-10 pr-4 py-3 bg-gray-900/50 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
                        </div>
                    </div>
                    <div id="register-error" class="text-red-400 text-xs bg-red-500/10 p-2 rounded border border-red-500/20 hidden"></div>
                    <button type="submit" class="w-full py-3.5 px-4 auth-gradient hover:opacity-90 rounded-lg text-white font-semibold shadow-lg shadow-purple-500/25 transition-all transform hover:-translate-y-0.5 mt-2">ê³„ì • ìƒì„±í•˜ê¸°</button>

                </form>

                <div class="mt-8 text-center border-t border-white/10 pt-6">
                    <p class="text-gray-400 text-sm">ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <button onclick="closeModal('register-modal'); openModal('login-modal')" class="text-purple-400 hover:text-purple-300 font-medium ml-1 transition-colors">ë¡œê·¸ì¸í•˜ê¸°</button></p>
                </div>
            </div>
        </div>
    </div>

    <!-- ë²„ì „ ì •ë³´ ë°°ì§€ -->
    <div class="version-badge">
        v{{ version }}
    </div>

    <script>
        lucide.createIcons();
        document.body.addEventListener('htmx:afterSwap', function(evt) { lucide.createIcons(); });

        function setActiveTab(btn) {
            const container = btn.parentElement;
            container.querySelectorAll('button').forEach(b => { b.classList.remove('bg-brand-purple', 'text-white', 'shadow'); b.classList.add('text-gray-400'); });
            btn.classList.remove('text-gray-400'); btn.classList.add('bg-brand-purple', 'text-white', 'shadow');
        }

        // [í•µì‹¬] ì‹œë‚˜ë¦¬ì˜¤ í”Œë ˆì´ í•¨ìˆ˜ (JS fetch ë°©ì‹)
        async function playScenario(filename, btn) {
            // ë²„íŠ¼ ë¡œë”© ìƒíƒœ
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> ë¡œë”©...';
            btn.disabled = true;
            lucide.createIcons();

            try {
                const formData = new FormData();
                formData.append('filename', filename);

                const res = await fetch('/api/load_scenario', {
                    method: 'POST',
                    body: formData
                });

                // ì„±ê³µí•˜ë©´ í”Œë ˆì´ì–´ í˜ì´ì§€ë¡œ ì´ë™
                if (res.ok) {
                    // [ì¶”ê°€ë¨] ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ë¡œë“œ ìƒíƒœ ë°•ì•„ì¤˜ì•¼ í•¨
                    sessionStorage.setItem('trpg_scenario_loaded', 'true');
                    window.location.href = '/views/player';
                } else {
                    const text = await res.text();
                    alert('ë¡œë“œ ì‹¤íŒ¨: ' + text);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            } catch (e) {
                console.error(e);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // ì‹œë‚˜ë¦¬ì˜¤ ì‚­ì œ í•¨ìˆ˜
        async function deleteScenario(filename, title, btnElement) {
            if (!confirm(`"${title}" ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                return;
            }

            try {
                const response = await fetch('/api/delete_scenario', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: filename })
                });

                const result = await response.json();

                if (result.success) {
                    // ì‚­ì œëœ ì¹´ë“œ ì• ë‹ˆë©”ì´ì…˜ í›„ ì œê±°
                    const card = btnElement.closest('.bg-dark-800');
                    if (card) {
                        card.style.transition = 'opacity 0.3s, transform 0.3s';
                        card.style.opacity = '0';
                        card.style.transform = 'scale(0.9)';
                        setTimeout(() => {
                            card.remove();
                            // ë‚¨ì€ ì‹œë‚˜ë¦¬ì˜¤ê°€ ì—†ìœ¼ë©´ ë©”ì‹œì§€ í‘œì‹œ
                            const container = document.getElementById('scenario-grid');
                            if (container && container.children.length === 0) {
                                container.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">ì €ì¥ëœ ì‹œë‚˜ë¦¬ì˜¤ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                            }
                        }, 300);
                    }
                } else {
                    alert('ì‚­ì œ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì‹œë‚˜ë¦¬ì˜¤ ê³µê°œ/ë¹„ê³µê°œ í† ê¸€ í•¨ìˆ˜
        async function publishScenario(filename, btnElement) {
            try {
                const response = await fetch('/api/publish_scenario', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ filename: filename })
                });

                const result = await response.json();

                if (result.success) {
                    // ì„±ê³µ ì‹œ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    alert(result.message || 'ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    // htmxë¡œ ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ
                    const currentFilter = document.querySelector('.bg-brand-purple')?.textContent?.includes('ê³µê°œ') ? 'public' : 'my';
                    htmx.ajax('GET', `/api/scenarios?filter=${currentFilter}`, {target: '#scenario-grid', swap: 'innerHTML'});
                } else {
                    alert('ë³€ê²½ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (error) {
                console.error('Publish error:', error);
                alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ë¡œê·¸ì¸/íšŒì›ê°€ì…/ë¡œê·¸ì•„ì›ƒ ë“± ê¸°ì¡´ í•¨ìˆ˜ë“¤
        function openModal(id) {
            const modal = document.getElementById(id);
            const container = modal.querySelector('.modal-container');

            const form = modal.querySelector('form');
            if (form) form.reset();

            const errorMsg = modal.querySelector('[id$="-error"]');
            if (errorMsg) {
                errorMsg.innerText = '';
                errorMsg.classList.add('hidden');
            }

            modal.classList.remove('opacity-0', 'pointer-events-none');
            document.body.classList.add('modal-active');

            setTimeout(() => {
                container.classList.remove('scale-95', 'opacity-0');
                container.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeModal(id) {
            const modal = document.getElementById(id);
            const container = modal.querySelector('.modal-container');

            container.classList.remove('scale-100', 'opacity-100');
            container.classList.add('scale-95', 'opacity-0');

            setTimeout(() => {
                modal.classList.add('opacity-0', 'pointer-events-none');
                document.body.classList.remove('modal-active');
            }, 300);
        }

        async function handleLogin(e) {
            e.preventDefault();
            const form = e.target;
            const errorMsg = document.getElementById('login-error');
            try {
                const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: form.username.value, password: form.password.value})
                });
                const data = await res.json();
                if (data.success) window.location.reload();
                else {
                    errorMsg.innerText = data.error;
                    errorMsg.classList.remove('hidden');
                }
            } catch(e) {
                errorMsg.innerText = 'ì„œë²„ í†µì‹  ì˜¤ë¥˜';
                errorMsg.classList.remove('hidden');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const form = e.target;
            const errorMsg = document.getElementById('register-error');

            if (form.password.value !== form.confirm_password.value) {
                errorMsg.innerText = "ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
                errorMsg.classList.remove('hidden');
                form.confirm_password.focus();
                return;
            }

            if (form.password.value.length < 4) {
                errorMsg.innerText = "ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 4ìë¦¬ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.";
                errorMsg.classList.remove('hidden');
                form.password.focus();
                return;
            }

            errorMsg.classList.add('hidden');

            try {
                const res = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        username: form.username.value,
                        password: form.password.value,
                        email: form.email.value
                    })
                });

                const data = await res.json();

                if (data.success) {
                    alert('ê°€ì… ì„±ê³µ!');
                    closeModal('register-modal');
                    openModal('login-modal');
                } else {
                    errorMsg.innerText = data.error;
                    errorMsg.classList.remove('hidden');
                }
            } catch(e) {
                console.error(e);
                errorMsg.innerText = "ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                errorMsg.classList.remove('hidden');
            }
        }

        async function logout() {
            if(confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                await fetch('/api/auth/logout', {method:'POST'});
                window.location.reload();
            }
        }

        // ì‚¬ì´ë“œë°” ìƒíƒœ ê´€ë¦¬
        (function() {
            const sidebar = document.querySelector('.sidebar');
            const SIDEBAR_STATE_KEY = 'sidebar_expanded';
            let isRestoredState = false;

            if (sessionStorage.getItem(SIDEBAR_STATE_KEY) === 'true') {
                sidebar.style.transition = 'none';
                sidebar.classList.add('expanded');
                isRestoredState = true;
                sessionStorage.removeItem(SIDEBAR_STATE_KEY);
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        sidebar.style.transition = '';
                    });
                });
            }

            if (isRestoredState) {
                setTimeout(() => {
                    const checkMousePosition = (e) => {
                        const rect = sidebar.getBoundingClientRect();
                        const isInsideSidebar = e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom;
                        if (!isInsideSidebar) sidebar.classList.remove('expanded');
                        document.removeEventListener('mousemove', checkMousePosition);
                    };
                    document.addEventListener('mousemove', checkMousePosition, { once: true });
                }, 100);
            }

            sidebar.querySelectorAll('a[href], button').forEach(link => {
                link.addEventListener('click', function(e) {
                    if (this.tagName === 'A' && this.href) {
                        sessionStorage.setItem(SIDEBAR_STATE_KEY, 'true');
                        sidebar.classList.add('expanded');
                    }
                });
            });

            sidebar.addEventListener('mouseleave', () => {
                sidebar.classList.remove('expanded');
            });
        })();
    </script>
</body>
</html>
