<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRPG Studio - The Core</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        rpg: {
                            900: '#020617', // Main Background (Deep Dark)
                            800: '#0f172a', // Card Background
                            700: '#1e293b', // Border
                            accent: '#38bdf8', // Cyan (Point Color)
                            hover: '#0ea5e9', // Blue
                            danger: '#ef4444', // Red
                        }
                    },
                    fontFamily: {
                        title: ['Cinzel', 'serif'],
                        body: ['Inter', 'sans-serif']
                    },
                    animation: {
                        'slide-infinite': 'slide 40s linear infinite', // 부드러운 슬라이드
                    },
                    keyframes: {
                        slide: {
                            '0%': { transform: 'translateX(0)' },
                            '100%': { transform: 'translateX(-50%)' } // 이미지 개수에 맞춰 조정
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { @apply font-body bg-rpg-900 text-gray-200; }

        /* 스크롤바 숨김 */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow: hidden; }

        /* [중요] API에서 반환된 카드 스타일 강제 적용 (다크모드 보장) */
        /* api.py에서 'scenario-card' 클래스를 사용하므로 해당 클래스 타겟팅 */
        .horizontal-scroll-container .scenario-card {
            background-color: #0f172a !important; /* bg-rpg-800 */
            border: 1px solid #1e293b !important; /* border-rpg-700 */
            border-radius: 0.75rem !important; /* rounded-xl */
            overflow: hidden !important;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1) !important;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;

            /* 슬라이드 레이아웃 필수 속성 */
            display: flex !important;
            flex-direction: column !important;
            min-width: 280px !important;
            max-width: 280px !important;
            margin-right: 1.5rem !important;
            flex-shrink: 0 !important; /* 크기 축소 방지 */
        }

        /* 카드 호버 효과 */
        .horizontal-scroll-container .scenario-card:hover {
            border-color: #38bdf8 !important; /* border-rpg-accent */
            box-shadow: 0 0 20px rgba(56, 189, 248, 0.2) !important;
            transform: translateY(-4px);
        }

        /* 이미지 영역 스타일 강제 */
        .card-image-wrapper {
            position: relative !important;
            height: 160px !important;
            overflow: hidden !important;
            background-color: #000 !important;
        }

        .card-image {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
            transition: transform 0.5s ease !important;
            opacity: 0.8 !important;
        }

        .scenario-card:hover .card-image {
            transform: scale(1.1) !important;
            opacity: 1 !important;
        }

        /* 텍스트 컨텐츠 영역 스타일 강제 */
        .card-content {
            padding: 1.25rem !important; /* p-5 */
            display: flex !important;
            flex-direction: column !important;
            gap: 0.75rem !important;
            flex: 1 !important;
            background-color: #0f172a !important; /* bg-rpg-800 재확인 */
            color: #e2e8f0 !important; /* 텍스트 색상 */
        }

        .card-title {
            font-size: 1.125rem !important; /* text-lg */
            font-weight: 700 !important;
            font-family: 'Cinzel', serif !important;
            color: #ffffff !important; /* text-white */
            letter-spacing: 0.025em !important;
            margin-bottom: 0.25rem !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }

        .card-desc {
            font-size: 0.875rem !important; /* text-sm */
            color: #9ca3af !important; /* text-gray-400 */
            display: -webkit-box !important;
            -webkit-line-clamp: 2 !important;
            -webkit-box-orient: vertical !important;
            overflow: hidden !important;
            min-height: 2.5rem !important;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col selection:bg-rpg-accent selection:text-black">

    <header class="fixed top-0 left-0 w-full h-20 bg-rpg-900/90 backdrop-blur-md border-b border-rpg-700 z-50 px-8 flex items-center justify-between">
        <div class="flex items-center gap-3 cursor-pointer" onclick="location.href='/'">
            <div class="w-10 h-10 bg-rpg-accent rounded flex items-center justify-center shadow-[0_0_15px_#38bdf8]">
                <i data-lucide="sword" class="text-black w-6 h-6 fill-current"></i>
            </div>
            <span class="font-title text-2xl font-black text-white tracking-widest hover:text-rpg-accent transition-colors">TRPG.OS</span>
        </div>

        <div>
            {% if user.is_authenticated %}
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-3 cursor-pointer group" onclick="location.href='/views/mypage'">
                    <div class="text-right hidden sm:block">
                        <p class="text-sm font-bold text-white group-hover:text-rpg-accent transition-colors">{{ user.id }}</p>
                        <p class="text-[10px] text-gray-400">OPERATOR</p>
                    </div>
                    <img src="{{ user.profile_img }}" class="w-10 h-10 rounded border border-rpg-700 group-hover:border-rpg-accent transition-all object-cover bg-rpg-800">
                </div>
            </div>
            {% else %}
            <button onclick="openModal('login-modal')" class="flex items-center gap-2 px-5 py-2.5 bg-rpg-accent hover:bg-white text-black font-bold rounded shadow-lg shadow-rpg-accent/20 transition-all">
                <i data-lucide="log-in" class="w-4 h-4"></i> LOGIN
            </button>
            {% endif %}
        </div>
    </header>

    <main class="flex-1 mt-20 pb-20">

        <!-- Hero Section -->
        <div class="relative w-full h-[35vh] min-h-[350px] overflow-hidden group border-b border-rpg-700 bg-black">
            <div class="absolute inset-0 bg-gradient-to-t from-rpg-900 via-rpg-900/40 to-transparent z-20 pointer-events-none"></div>

            <div class="flex w-[200%] h-full animate-slide-infinite">
                <div class="w-1/5 h-full relative flex-shrink-0">
                    <img src="https://images.unsplash.com/photo-1555680202-c86f0e12f086?q=80&w=1600" class="w-full h-full object-cover">
                </div>
                <div class="w-1/5 h-full relative flex-shrink-0">
                    <img src="https://images.unsplash.com/photo-1511512578047-dfb367046420?q=80&w=1600" class="w-full h-full object-cover">
                </div>
                <div class="w-1/5 h-full relative flex-shrink-0">
                    <img src="https://images.unsplash.com/photo-1533230500755-667923232c95?q=80&w=1600" class="w-full h-full object-cover">
                </div>
                <div class="w-1/5 h-full relative flex-shrink-0">
                    <img src="https://images.unsplash.com/photo-1519074069444-1ba4fff66d16?q=80&w=1600" class="w-full h-full object-cover">
                </div>
                <div class="w-1/5 h-full relative flex-shrink-0">
                    <img src="https://images.unsplash.com/photo-1550745165-9bc0b252726f?q=80&w=1600" class="w-full h-full object-cover">
                </div>

                <!-- Duplicate for loop -->
                <div class="w-1/5 h-full relative flex-shrink-0"><img src="https://images.unsplash.com/photo-1555680202-c86f0e12f086?q=80&w=1600" class="w-full h-full object-cover"></div>
                <div class="w-1/5 h-full relative flex-shrink-0"><img src="https://images.unsplash.com/photo-1511512578047-dfb367046420?q=80&w=1600" class="w-full h-full object-cover"></div>
                <div class="w-1/5 h-full relative flex-shrink-0"><img src="https://images.unsplash.com/photo-1533230500755-667923232c95?q=80&w=1600" class="w-full h-full object-cover"></div>
                <div class="w-1/5 h-full relative flex-shrink-0"><img src="https://images.unsplash.com/photo-1519074069444-1ba4fff66d16?q=80&w=1600" class="w-full h-full object-cover"></div>
                <div class="w-1/5 h-full relative flex-shrink-0"><img src="https://images.unsplash.com/photo-1550745165-9bc0b252726f?q=80&w=1600" class="w-full h-full object-cover"></div>
            </div>

            <div class="absolute bottom-0 left-0 w-full p-12 z-30 container mx-auto">
                <h1 class="text-5xl md:text-6xl font-title font-black text-white mb-4 drop-shadow-2xl tracking-tighter">
                    Dive into the <span class="text-rpg-accent">Abyss</span>
                </h1>
                <p class="text-lg md:text-xl text-gray-300 max-w-2xl font-medium drop-shadow-lg bg-black/30 backdrop-blur-sm p-4 rounded-lg border-l-4 border-rpg-accent">
                    상상을 초월하는 모험이 당신을 기다립니다.<br>지금 바로 시작하세요.
                </p>
            </div>
        </div>

        <!-- Create New Button -->
        <div class="container mx-auto px-8 mt-8">
            <a href="/views/builder" class="block w-full bg-rpg-800 hover:bg-rpg-700 border border-rpg-700 hover:border-rpg-accent rounded-xl p-6 text-center group transition-all shadow-lg hover:shadow-[0_0_20px_rgba(56,189,248,0.15)]">
                <div class="flex flex-col items-center justify-center gap-3">
                    <div class="p-3 bg-rpg-accent/10 rounded-full group-hover:scale-110 transition-transform ring-1 ring-rpg-accent/30">
                        <i data-lucide="plus" class="w-8 h-8 text-rpg-accent"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white group-hover:text-rpg-accent transition-colors tracking-widest">CREATE NEW SCENARIO</h3>
                    <p class="text-sm text-gray-500 group-hover:text-gray-400">당신만의 세계를 직접 창조해보세요</p>
                </div>
            </a>
        </div>

        <!-- Genre Filter -->
        <div class="container mx-auto px-8 mt-12">
            <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <i data-lucide="filter" class="w-5 h-5 text-rpg-accent"></i> GENRE
            </h2>
            <div class="flex flex-wrap gap-3">
                <button onclick="filterGenre('all')" class="px-4 py-2 rounded-full bg-rpg-accent text-black font-bold text-sm hover:opacity-80 transition-all shadow-[0_0_10px_rgba(56,189,248,0.3)]">전체</button>
                <button onclick="filterGenre('fantasy')" class="px-4 py-2 rounded-full bg-rpg-800 border border-rpg-700 hover:border-rpg-accent text-gray-300 hover:text-white text-sm transition-all hover:bg-rpg-700">SF/판타지</button>
                <button onclick="filterGenre('thriller')" class="px-4 py-2 rounded-full bg-rpg-800 border border-rpg-700 hover:border-rpg-accent text-gray-300 hover:text-white text-sm transition-all hover:bg-rpg-700">스릴러</button>
                <button onclick="filterGenre('mystery')" class="px-4 py-2 rounded-full bg-rpg-800 border border-rpg-700 hover:border-rpg-accent text-gray-300 hover:text-white text-sm transition-all hover:bg-rpg-700">추리</button>
                <button onclick="filterGenre('romance')" class="px-4 py-2 rounded-full bg-rpg-800 border border-rpg-700 hover:border-rpg-accent text-gray-300 hover:text-white text-sm transition-all hover:bg-rpg-700">로맨스</button>
                <button onclick="filterGenre('etc')" class="px-4 py-2 rounded-full bg-rpg-800 border border-rpg-700 hover:border-rpg-accent text-gray-300 hover:text-white text-sm transition-all hover:bg-rpg-700">기타</button>
            </div>
        </div>

        <!-- Scenario Lists (Horizontal Scroll) -->
        <div class="space-y-16 mt-12 pb-20">

            <section class="container mx-auto pl-8">
                <div class="flex items-center justify-between pr-8 mb-4">
                    <h2 class="text-2xl font-title font-bold text-white flex items-center gap-2">
                        <span class="w-1 h-6 bg-rpg-accent rounded-full shadow-[0_0_10px_#38bdf8]"></span> 실시간 (Newest)
                    </h2>
                    <span class="text-xs text-gray-500">Drag to scroll <i data-lucide="arrow-right" class="inline w-3 h-3"></i></span>
                </div>
                <!-- API Loading Container -->
                <div id="realtime-grid"
                     class="horizontal-scroll-container flex overflow-x-auto gap-4 pb-8 no-scrollbar cursor-grab active:cursor-grabbing"
                     hx-get="/api/scenarios?sort=newest&limit=10"
                     hx-trigger="load">
                     <!-- Skeleton Loaders -->
                     <div class="bg-rpg-800 border border-rpg-700 rounded-xl min-w-[280px] h-[320px] animate-pulse flex-shrink-0"></div>
                     <div class="bg-rpg-800 border border-rpg-700 rounded-xl min-w-[280px] h-[320px] animate-pulse flex-shrink-0"></div>
                     <div class="bg-rpg-800 border border-rpg-700 rounded-xl min-w-[280px] h-[320px] animate-pulse flex-shrink-0"></div>
                     <div class="bg-rpg-800 border border-rpg-700 rounded-xl min-w-[280px] h-[320px] animate-pulse flex-shrink-0"></div>
                </div>
            </section>

            <section class="container mx-auto pl-8">
                <div class="flex items-center justify-between pr-8 mb-4">
                    <h2 class="text-2xl font-title font-bold text-white flex items-center gap-2">
                        <span class="w-1 h-6 bg-yellow-500 rounded-full shadow-[0_0_10px_#eab308]"></span> 인기 (Popular)
                    </h2>
                </div>
                <div id="popular-grid"
                     class="horizontal-scroll-container flex overflow-x-auto gap-4 pb-8 no-scrollbar cursor-grab active:cursor-grabbing"
                     hx-get="/api/scenarios?sort=newest&limit=10"
                     hx-trigger="load">
                     <div class="bg-rpg-800 border border-rpg-700 rounded-xl min-w-[280px] h-[320px] animate-pulse flex-shrink-0"></div>
                     <div class="bg-rpg-800 border border-rpg-700 rounded-xl min-w-[280px] h-[320px] animate-pulse flex-shrink-0"></div>
                </div>
            </section>

            <section class="container mx-auto pl-8">
                <div class="flex items-center justify-between pr-8 mb-4">
                    <h2 class="text-2xl font-title font-bold text-white flex items-center gap-2">
                        <span class="w-1 h-6 bg-green-500 rounded-full shadow-[0_0_10px_#22c55e]"></span> 스테디셀러
                    </h2>
                </div>
                <div id="steady-grid"
                     class="horizontal-scroll-container flex overflow-x-auto gap-4 pb-8 no-scrollbar cursor-grab active:cursor-grabbing"
                     hx-get="/api/scenarios?sort=newest&limit=10"
                     hx-trigger="load">
                     <div class="bg-rpg-800 border border-rpg-700 rounded-xl min-w-[280px] h-[320px] animate-pulse flex-shrink-0"></div>
                     <div class="bg-rpg-800 border border-rpg-700 rounded-xl min-w-[280px] h-[320px] animate-pulse flex-shrink-0"></div>
                </div>
            </section>

        </div>
    </main>

    <!-- Login Modal -->
    <div id="login-modal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[100] flex items-center justify-center">
        <div class="modal-overlay absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeModal('login-modal')"></div>
        <div class="modal-container bg-rpg-800 w-full max-w-md mx-4 rounded-2xl border border-rpg-700 shadow-2xl transform scale-95 opacity-0 transition-all duration-300 relative z-10">
            <div class="p-8">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-2xl font-title font-bold text-white">LOGIN</h3>
                    <button onclick="closeModal('login-modal')" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                <form onsubmit="handleLogin(event)" class="space-y-6">
                    <div>
                        <label class="block text-gray-400 text-xs font-bold mb-2">USERNAME</label>
                        <input type="text" name="username" required class="w-full bg-rpg-900 border border-rpg-700 rounded-lg p-3 text-white focus:border-rpg-accent focus:outline-none transition-colors">
                    </div>
                    <div>
                        <label class="block text-gray-400 text-xs font-bold mb-2">PASSWORD</label>
                        <input type="password" name="password" required class="w-full bg-rpg-900 border border-rpg-700 rounded-lg p-3 text-white focus:border-rpg-accent focus:outline-none transition-colors">
                    </div>
                    <div id="login-error" class="text-red-400 text-xs hidden"></div>
                    <button type="submit" class="w-full bg-rpg-accent hover:bg-white text-black font-bold py-4 rounded-lg shadow-lg transition-all">ACCESS SYSTEM</button>
                </form>
                <div class="mt-6 text-center text-sm text-gray-500">
                    계정이 없으신가요? <button onclick="closeModal('login-modal'); openModal('register-modal')" class="text-rpg-accent hover:underline font-bold ml-1">회원가입 하기</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="register-modal" class="modal opacity-0 pointer-events-none fixed inset-0 z-[100] flex items-center justify-center">
        <div class="modal-overlay absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="closeModal('register-modal')"></div>
        <div class="modal-container bg-rpg-800 w-full max-w-md mx-4 rounded-2xl border border-rpg-700 shadow-2xl transform scale-95 opacity-0 transition-all duration-300 relative z-10">
            <div class="p-8">
                <div class="flex justify-between items-center mb-8">
                    <h3 class="text-2xl font-title font-bold text-white">REGISTER</h3>
                    <button onclick="closeModal('register-modal')" class="text-gray-400 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
                </div>
                <form onsubmit="handleRegister(event)" class="space-y-4">
                    <div>
                        <label class="block text-gray-400 text-xs font-bold mb-1">USERNAME</label>
                        <input type="text" name="username" required class="w-full bg-rpg-900 border border-rpg-700 rounded-lg p-3 text-white focus:border-rpg-accent focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-gray-400 text-xs font-bold mb-1">EMAIL</label>
                        <input type="email" name="email" required class="w-full bg-rpg-900 border border-rpg-700 rounded-lg p-3 text-white focus:border-rpg-accent focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-gray-400 text-xs font-bold mb-1">PASSWORD</label>
                        <input type="password" name="password" required class="w-full bg-rpg-900 border border-rpg-700 rounded-lg p-3 text-white focus:border-rpg-accent focus:outline-none">
                    </div>
                    <div>
                        <label class="block text-gray-400 text-xs font-bold mb-1">CONFIRM PASSWORD</label>
                        <input type="password" name="confirm_password" required class="w-full bg-rpg-900 border border-rpg-700 rounded-lg p-3 text-white focus:border-rpg-accent focus:outline-none">
                    </div>
                    <div id="register-error" class="text-red-400 text-xs hidden"></div>
                    <button type="submit" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-4 rounded-lg shadow-lg mt-2 transition-all">CREATE ACCOUNT</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // HTMX 로드 후 기능 재적용 (아이콘 리로드 & 스크롤 드래그 활성화)
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            lucide.createIcons();
            enableHorizontalScroll();
        });

        // 드래그 스크롤 기능
        function enableHorizontalScroll() {
            const containers = document.querySelectorAll('.horizontal-scroll-container');
            containers.forEach(slider => {
                let isDown = false;
                let startX;
                let scrollLeft;

                // 드래그 시작
                slider.addEventListener('mousedown', (e) => {
                    isDown = true;
                    slider.classList.add('active');
                    slider.style.cursor = 'grabbing';
                    startX = e.pageX - slider.offsetLeft;
                    scrollLeft = slider.scrollLeft;
                });

                // 영역 벗어남/드래그 종료
                slider.addEventListener('mouseleave', () => {
                    isDown = false;
                    slider.classList.remove('active');
                    slider.style.cursor = 'grab';
                });

                slider.addEventListener('mouseup', () => {
                    isDown = false;
                    slider.classList.remove('active');
                    slider.style.cursor = 'grab';
                });

                // 마우스 이동
                slider.addEventListener('mousemove', (e) => {
                    if(!isDown) return;
                    e.preventDefault(); // 스크롤 중 텍스트 선택 방지
                    const x = e.pageX - slider.offsetLeft;
                    const walk = (x - startX) * 1.5; // 스크롤 속도 배율
                    slider.scrollLeft = scrollLeft - walk;
                });
            });
        }

        // 페이지 로드 시에도 스크롤 기능 활성화
        document.addEventListener('DOMContentLoaded', enableHorizontalScroll);

        // 전역 함수들
        window.playScenario = async function(filename, btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Loading...';
            btn.disabled = true;
            lucide.createIcons();

            try {
                const formData = new FormData();
                formData.append('filename', filename);
                const res = await fetch('/api/load_scenario', { method: 'POST', body: formData });

                if (res.ok) {
                    sessionStorage.setItem('trpg_scenario_loaded', 'true');
                    window.location.href = '/views/player';
                } else {
                    alert('로드 실패: ' + await res.text());
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            } catch (e) {
                console.error(e);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        window.deleteScenario = async function(filename, btn) {
            if(!confirm('정말 삭제하시겠습니까? (복구 불가)')) return;
            try {
                const res = await fetch('/api/delete_scenario', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({filename: filename})
                });

                const data = await res.json();
                if(data.success) {
                    const card = btn.closest('.scenario-card'); // 정확한 클래스 타겟팅
                    if(card) {
                        card.style.transition = 'all 0.3s ease';
                        card.style.opacity = '0';
                        card.style.transform = 'scale(0.9)';
                        setTimeout(() => card.remove(), 300);
                    } else {
                        window.location.reload();
                    }
                } else {
                    alert('삭제 실패: ' + data.error);
                }
            } catch(e) {
                console.error(e);
                alert('서버 통신 오류');
            }
        };

        window.editScenario = function(filename) {
            window.location.href = `/views/builder?scenario=${encodeURIComponent(filename)}`;
        };

        window.openModal = function(id) {
            const modal = document.getElementById(id);
            const container = modal.querySelector('.modal-container');
            if(modal.querySelector('form')) modal.querySelector('form').reset();

            modal.classList.remove('opacity-0', 'pointer-events-none');
            document.body.classList.add('modal-active');
            setTimeout(() => {
                container.classList.remove('scale-95', 'opacity-0');
                container.classList.add('scale-100', 'opacity-100');
            }, 10);
        };

        window.closeModal = function(id) {
            const modal = document.getElementById(id);
            const container = modal.querySelector('.modal-container');
            container.classList.remove('scale-100', 'opacity-100');
            container.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('opacity-0', 'pointer-events-none');
                document.body.classList.remove('modal-active');
            }, 300);
        };

        window.handleLogin = async function(e) {
            e.preventDefault(); const form = e.target;
            try {
                const res = await fetch('/api/auth/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username: form.username.value, password: form.password.value}) });
                const data = await res.json();
                if (data.success) window.location.reload();
                else alert(data.error);
            } catch(e) { alert("통신 오류"); }
        };

        window.handleRegister = async function(e) {
            e.preventDefault(); const form = e.target;
            if(form.password.value !== form.confirm_password.value) return alert("비밀번호 불일치");
            try {
                const res = await fetch('/api/auth/register', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username: form.username.value, password: form.password.value, email: form.email.value}) });
                const data = await res.json();
                if (data.success) { alert("가입 성공!"); closeModal('register-modal'); openModal('login-modal'); }
                else alert(data.error);
            } catch(e) { alert("통신 오류"); }
        };

        function filterGenre(genre) {
            const btns = document.querySelectorAll('.container button');
            btns.forEach(b => {
                b.classList.remove('bg-rpg-accent', 'text-black');
                b.classList.add('bg-rpg-800', 'text-gray-300');
            });
            event.target.classList.remove('bg-rpg-800', 'text-gray-300');
            event.target.classList.add('bg-rpg-accent', 'text-black');

            const grids = ['#realtime-grid', '#popular-grid', '#steady-grid'];
            grids.forEach(id => {
                const el = document.querySelector(id);
                if(el) {
                    htmx.trigger(el, 'load');
                }
            });
        }
    </script>
</body>
</html>