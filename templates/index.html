<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRPG Studio - {{ version }}</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Pretendard', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }

        .htmx-indicator { display: none; pointer-events: none; }
        .htmx-request .htmx-indicator { display: flex; pointer-events: auto; }
        .htmx-request.htmx-indicator { display: flex; pointer-events: auto; }

        .glass-panel {
            background: rgba(28, 28, 28, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* ë¤¼íŠ¼ ìŠ¤íƒ€ì¼ ê·¸ë¼ë°ì´ì…˜ */
        .brand-gradient {
            background: linear-gradient(135deg, #6E47E6 0%, #818cf8 100%);
        }
        .text-gradient {
            background: linear-gradient(135deg, #c084fc 0%, #818cf8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* ì ‘ì´ì‹ ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
        .sidebar {
            width: 72px;
            transition: width 0.3s ease;
        }
        .sidebar:hover,
        .sidebar.expanded {
            width: 260px;
        }
        .sidebar .nav-text {
            opacity: 0;
            white-space: nowrap;
            transition: opacity 0.2s ease;
        }
        .sidebar:hover .nav-text,
        .sidebar.expanded .nav-text {
            opacity: 1;
        }
        .sidebar .logo-text {
            opacity: 0;
            white-space: nowrap;
            transition: opacity 0.2s ease;
        }
        .sidebar:hover .logo-text,
        .sidebar.expanded .logo-text {
            opacity: 1;
        }
        .sidebar .section-title {
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .sidebar:hover .section-title,
        .sidebar.expanded .section-title {
            opacity: 1;
        }
        .sidebar .user-info {
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .sidebar:hover .user-info,
        .sidebar.expanded .user-info {
            opacity: 1;
        }
        .sidebar .user-chevron {
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .sidebar:hover .user-chevron,
        .sidebar.expanded .user-chevron {
            opacity: 1;
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: hidden !important; }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: {
                            900: '#111111',
                            800: '#1c1c1c',
                            700: '#2c2c2c',
                            600: '#3f3f46',
                        },
                        brand: {
                            purple: '#6E47E6',
                            light: '#9F7AEA'
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-dark-900 text-gray-200 h-screen flex overflow-hidden selection:bg-brand-purple selection:text-white">

    <!-- ì‚¬ì´ë“œë°” (ì ‘ì´ì‹) -->
    <div class="sidebar bg-dark-800 border-r border-white/5 flex flex-col hidden md:flex shrink-0 z-20 overflow-hidden">
        <div class="p-4 h-16 flex items-center">
            <div class="flex items-center gap-2 cursor-pointer" onclick="location.href='/'">
                <div class="w-10 h-10 brand-gradient rounded-lg flex items-center justify-center text-white shadow-lg shadow-brand-purple/20 shrink-0">
                    <i data-lucide="dice-5" class="w-5 h-5 fill-current"></i>
                </div>
                <span class="logo-text text-xl font-bold text-white tracking-tight">TRPG Studio</span>
            </div>
        </div>

        <nav class="flex-1 px-3 space-y-1 mt-2">
            <div class="section-title text-[10px] font-semibold text-gray-500 px-3 py-2 uppercase tracking-wider">Workspace</div>

            <a href="/" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg bg-white/5 text-white group cursor-pointer text-sm font-medium">
                <i data-lucide="layout-grid" class="w-5 h-5 text-brand-light shrink-0"></i>
                <span class="nav-text">ëŒ€ì‹œë³´ë“œ</span>
            </a>

            <a href="/views/builder"
               class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-400 hover:bg-white/5 hover:text-white group cursor-pointer text-sm font-medium transition-colors">
                <i data-lucide="pen-tool" class="w-5 h-5 text-gray-500 group-hover:text-gray-300 shrink-0"></i>
                <span class="nav-text">ì‹œë‚˜ë¦¬ì˜¤ ë¹Œë”</span>
            </a>

            <a href="/views/player"
               class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-400 hover:bg-white/5 hover:text-white group cursor-pointer text-sm font-medium transition-colors">
                <i data-lucide="gamepad-2" class="w-5 h-5 text-gray-500 group-hover:text-gray-300 shrink-0"></i>
                <span class="nav-text">í”Œë ˆì´ì–´ ëª¨ë“œ</span>
            </a>

            <a href="/views/scenes"
               class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-400 hover:bg-white/5 hover:text-white group cursor-pointer text-sm font-medium transition-colors">
                <i data-lucide="git-merge" class="w-5 h-5 text-gray-500 group-hover:text-gray-300 shrink-0"></i>
                <span class="nav-text">ì „ì²´ ì”¬ ë³´ê¸°</span>
            </a>

            <div class="section-title text-[10px] font-semibold text-gray-500 px-3 py-2 uppercase tracking-wider mt-6">Library</div>

            <button class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-400 hover:bg-white/5 hover:text-white group cursor-pointer text-sm font-medium transition-colors"
                    onclick="document.getElementById('public-tab-btn').click()">
                <i data-lucide="book-open" class="w-5 h-5 text-gray-500 group-hover:text-gray-300 shrink-0"></i>
                <span class="nav-text">ê³µê°œ ì‹œë‚˜ë¦¬ì˜¤</span>
            </button>
        </nav>

        <!-- ìœ ì € í”„ë¡œí•„ (ì‚¬ì´ë“œë°” í•˜ë‹¨) -->
        <div class="p-3 border-t border-white/5">
            {% if user.is_authenticated %}
            <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 cursor-pointer transition-colors" onclick="logout()">
                <div class="w-8 h-8 rounded-full bg-brand-purple flex items-center justify-center text-white text-xs font-bold shrink-0">
                    {{ user.id[:2].upper() }}
                </div>
                <div class="user-info flex-1 min-w-0">
                    <p class="text-sm font-medium text-white truncate">{{ user.id }}</p>
                    <p class="text-[11px] text-brand-light truncate">ë¡œê·¸ì•„ì›ƒ</p>
                </div>
                <i data-lucide="log-out" class="user-chevron w-4 h-4 text-gray-500"></i>
            </div>
            {% else %}
            <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 cursor-pointer transition-colors" onclick="openModal('login-modal')">
                <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center shrink-0">
                    <i data-lucide="user" class="w-4 h-4 text-gray-400"></i>
                </div>
                <div class="user-info flex-1 min-w-0">
                    <p class="text-sm font-medium text-white truncate">ê²ŒìŠ¤íŠ¸</p>
                    <p class="text-[11px] text-gray-500 truncate">ë¡œê·¸ì¸ í•„ìš”</p>
                </div>
                <i data-lucide="log-in" class="user-chevron w-4 h-4 text-gray-500"></i>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ë©”ì¸ ë·° -->
    <div id="main-view" class="flex-1 flex flex-col h-full relative z-10 bg-dark-900 overflow-hidden">

        <!-- ìƒë‹¨ í—¤ë” -->
        <header class="h-16 border-b border-white/5 flex items-center justify-between px-8 bg-dark-900/80 backdrop-blur-md sticky top-0 z-20">
            <div class="flex items-center gap-4 w-full max-w-xl">
                <div class="relative w-full group">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500 group-focus-within:text-brand-light transition-colors"></i>
                    <input type="text" placeholder="ì‹œë‚˜ë¦¬ì˜¤, NPC, ë£° ê²€ìƒ‰..."
                           class="w-full bg-dark-800 border border-white/5 rounded-full pl-10 pr-4 py-2 text-sm text-gray-300 focus:outline-none focus:ring-1 focus:ring-brand-purple/50 focus:bg-dark-700 transition-all placeholder-gray-600">
                </div>
            </div>

            <div class="flex items-center gap-4 ml-4">
                {% if user.is_authenticated %}
                    <span class="text-sm text-gray-400 hidden sm:inline">
                        <span class="text-brand-light font-bold">{{ user.id }}</span>ë‹˜
                    </span>
                    <button onclick="logout()" class="text-xs bg-dark-800 hover:bg-dark-700 text-gray-300 px-3 py-1.5 rounded border border-white/10 transition-colors">
                        ë¡œê·¸ì•„ì›ƒ
                    </button>
                {% else %}
                    <button onclick="openModal('login-modal')" class="text-sm text-gray-300 hover:text-white transition-colors">ë¡œê·¸ì¸</button>
                    <button onclick="openModal('register-modal')" class="text-sm bg-brand-purple hover:bg-brand-purple/90 text-white px-4 py-1.5 rounded-full shadow-lg shadow-brand-purple/20 transition-all">
                        íšŒì›ê°€ì…
                    </button>
                {% endif %}

                <div class="w-px h-4 bg-white/10 mx-1"></div>

                <button class="p-2 text-gray-400 hover:text-white hover:bg-white/5 rounded-full transition-colors relative">
                    <i data-lucide="bell" class="w-5 h-5"></i>
                    <span class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full border-2 border-dark-900"></span>
                </button>
            </div>
        </header>

        <!-- ë©”ì¸ ì»¨í…ì¸  (ìŠ¤í¬ë¡¤ ì˜ì—­) -->
        <main class="flex-1 overflow-y-auto p-8 custom-scrollbar">

            <!-- ì›°ì»´ ì„¹ì…˜ -->
            <div class="mb-10">
                <h2 class="text-2xl font-bold text-white mb-2">
                    {% if user.is_authenticated %}
                        ë°˜ê°€ì›Œìš”, {{ user.id }}ë‹˜! ğŸ‘‹
                    {% else %}
                        TRPG Studioì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤! ğŸ‘‹
                    {% endif %}
                </h2>
                <p class="text-gray-400">ì˜¤ëŠ˜ë„ ìƒˆë¡œìš´ ì„¸ê³„ë¥¼ ì°½ì¡°í•´ë³¼ê¹Œìš”?</p>
            </div>

            <!-- ì‹œë‚˜ë¦¬ì˜¤ ëª©ë¡ ì„¹ì…˜ -->
            <div class="mb-12">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2">
                        <i data-lucide="folder-open" class="w-5 h-5 text-gray-500"></i> ì‹œë‚˜ë¦¬ì˜¤
                    </h3>

                    <!-- íƒ­ ë²„íŠ¼ -->
                    <div class="bg-dark-800 p-1 rounded-lg inline-flex border border-white/5">
                        <button id="public-tab-btn"
                                class="px-4 py-1.5 rounded-md text-xs font-medium bg-brand-purple text-white shadow transition-all"
                                hx-get="/api/scenarios?filter=public" hx-target="#scenario-grid"
                                onclick="setActiveTab(this)">
                            ê³µê°œ
                        </button>
                        {% if user.is_authenticated %}
                        <button class="px-4 py-1.5 rounded-md text-xs font-medium text-gray-400 hover:text-white transition-all"
                                hx-get="/api/scenarios?filter=my" hx-target="#scenario-grid"
                                onclick="setActiveTab(this)">
                            ë‚´ ì‘í’ˆ
                        </button>
                        {% endif %}
                    </div>
                </div>

                <!-- ì‹œë‚˜ë¦¬ì˜¤ ê·¸ë¦¬ë“œ (HTMX ë¡œë“œ) -->
                <div id="scenario-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"
                     hx-get="/api/scenarios?filter=public" hx-trigger="load">

                    <!-- ë¡œë”© ìŠ¤ì¼ˆë ˆí†¤ (ë°ì´í„° ë¡œë“œ ì „ í‘œì‹œë¨) -->
                    <div class="col-span-full py-12 flex flex-col items-center justify-center text-gray-500">
                        <i data-lucide="loader-2" class="w-8 h-8 animate-spin mb-3 text-brand-purple"></i>
                        <p>ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
                    </div>

                </div>
            </div>

            <!-- í•˜ë‹¨ ë°”ë¡œê°€ê¸° (ë¹ˆ í”„ë¡œì íŠ¸ ìƒì„± ë“±) -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-12">
                <a href="/views/builder" class="group bg-dark-800 p-6 rounded-xl border border-white/5 hover:border-brand-purple/50 transition-all hover:bg-dark-800/80 cursor-pointer flex flex-col items-center justify-center text-center h-40">
                    <div class="w-12 h-12 rounded-full bg-brand-purple/10 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                        <i data-lucide="plus" class="w-6 h-6 text-brand-purple"></i>
                    </div>
                    <h5 class="font-bold text-white group-hover:text-brand-light transition-colors">ìƒˆ í”„ë¡œì íŠ¸</h5>
                    <p class="text-[11px] text-gray-500 mt-1">ì²˜ìŒë¶€í„° ì§ì ‘ ë§Œë“¤ê¸°</p>
                </a>
                <!-- ì¶”ê°€ì ì¸ ë°”ë¡œê°€ê¸° ì¹´ë“œë“¤... -->
            </div>

            <!-- Footer -->
            <footer class="mt-auto border-t border-white/5 pt-8 pb-4 text-center text-xs text-gray-600">
                <p>&copy; 2026 TRPG Studio. All rights reserved.</p>
                <p class="mt-1 text-gray-700">Version {{ version }}</p>
            </footer>
        </main>
    </div>

    <!-- ê²Œì„ ë¡œë“œ ê²°ê³¼ ì˜ì—­ -->
    <div id="init-result" class="fixed bottom-4 right-4 z-50"></div>

    <!-- ë¡œë”© ì¸ë””ì¼€ì´í„° (ì „ì²´í™”ë©´) -->
    <div id="full-loading" class="htmx-indicator fixed inset-0 bg-dark-900/90 z-[100] flex flex-col items-center justify-center backdrop-blur-md">
        <div class="relative w-24 h-24 mb-6">
            <div class="absolute inset-0 border-t-4 border-brand-purple border-solid rounded-full animate-spin"></div>
            <div class="absolute inset-2 border-b-4 border-indigo-500 border-solid rounded-full animate-spin reverse-spin" style="animation-direction: reverse;"></div>
            <i data-lucide="dices" class="absolute inset-0 m-auto text-white w-8 h-8 animate-bounce"></i>
        </div>
        <h3 class="text-2xl font-bold text-white mb-2">ë¡œë”© ì¤‘...</h3>
    </div>

    <!-- ================= [MODALS] ================= -->

    <!-- 1. ë¡œê·¸ì¸ ëª¨ë‹¬ -->
    <div id="login-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-black/70 backdrop-blur-sm" onclick="closeModal('login-modal')"></div>
        <div class="modal-container bg-dark-800 w-11/12 md:max-w-sm mx-auto rounded-2xl shadow-2xl z-50 overflow-hidden border border-white/10 transform transition-all scale-95 opacity-0 duration-300" id="login-modal-content">

            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-white">ë¡œê·¸ì¸</h3>
                    <button onclick="closeModal('login-modal')" class="text-gray-400 hover:text-white transition-colors">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>

                <form id="login-form" onsubmit="handleLogin(event)" class="space-y-4">
                    <div>
                        <label class="block text-gray-400 text-xs font-bold mb-1 ml-1">ì•„ì´ë””</label>
                        <input type="text" name="username" required
                               class="w-full bg-dark-900 text-white border border-white/10 rounded-lg py-2.5 px-4 focus:outline-none focus:border-brand-purple focus:ring-1 focus:ring-brand-purple transition-all placeholder-gray-600">
                    </div>
                    <div>
                        <label class="block text-gray-400 text-xs font-bold mb-1 ml-1">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" name="password" required
                               class="w-full bg-dark-900 text-white border border-white/10 rounded-lg py-2.5 px-4 focus:outline-none focus:border-brand-purple focus:ring-1 focus:ring-brand-purple transition-all placeholder-gray-600">
                    </div>

                    <div id="login-error" class="text-red-400 text-xs bg-red-500/10 p-2 rounded border border-red-500/20 hidden"></div>

                    <button type="submit" class="w-full bg-brand-gradient hover:opacity-90 text-white font-bold py-3 px-4 rounded-lg shadow-lg shadow-brand-purple/20 transition-all transform active:scale-95 mt-2">
                        ì‹œì‘í•˜ê¸°
                    </button>
                </form>

                <div class="mt-6 text-center text-xs text-gray-500">
                    ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”?
                    <button onclick="closeModal('login-modal'); openModal('register-modal')" class="text-brand-light hover:underline font-medium ml-1">íšŒì›ê°€ì…</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. íšŒì›ê°€ì… ëª¨ë‹¬ -->
    <div id="register-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-black/70 backdrop-blur-sm" onclick="closeModal('register-modal')"></div>
        <div class="modal-container bg-dark-800 w-11/12 md:max-w-sm mx-auto rounded-2xl shadow-2xl z-50 overflow-hidden border border-white/10 transform transition-all scale-95 opacity-0 duration-300" id="register-modal-content">

            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold text-white">íšŒì›ê°€ì…</h3>
                    <button onclick="closeModal('register-modal')" class="text-gray-400 hover:text-white transition-colors">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>

                <form id="register-form" onsubmit="handleRegister(event)" class="space-y-4">
                    <div>
                        <label class="block text-gray-400 text-xs font-bold mb-1 ml-1">ì•„ì´ë””</label>
                        <input type="text" name="username" required
                               class="w-full bg-dark-900 text-white border border-white/10 rounded-lg py-2.5 px-4 focus:outline-none focus:border-brand-purple focus:ring-1 focus:ring-brand-purple transition-all placeholder-gray-600">
                    </div>
                    <div>
                        <label class="block text-gray-400 text-xs font-bold mb-1 ml-1">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" name="password" required
                               class="w-full bg-dark-900 text-white border border-white/10 rounded-lg py-2.5 px-4 focus:outline-none focus:border-brand-purple focus:ring-1 focus:ring-brand-purple transition-all placeholder-gray-600">
                    </div>

                    <div id="register-error" class="text-red-400 text-xs bg-red-500/10 p-2 rounded border border-red-500/20 hidden"></div>

                    <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg shadow-emerald-900/20 transition-all transform active:scale-95 mt-2">
                        ê°€ì… ì™„ë£Œ
                    </button>
                </form>

                <div class="mt-6 text-center text-xs text-gray-500">
                    ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”?
                    <button onclick="closeModal('register-modal'); openModal('login-modal')" class="text-brand-light hover:underline font-medium ml-1">ë¡œê·¸ì¸</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            lucide.createIcons();
        });

        // íƒ­ ìŠ¤íƒ€ì¼ ì „í™˜ í•¨ìˆ˜
        function setActiveTab(btn) {
            const container = btn.parentElement;
            container.querySelectorAll('button').forEach(b => {
                b.classList.remove('bg-brand-purple', 'text-white', 'shadow');
                b.classList.add('text-gray-400');
                b.classList.remove('font-bold');
            });
            btn.classList.remove('text-gray-400');
            btn.classList.add('bg-brand-purple', 'text-white', 'shadow');
        }

        // --- ëª¨ë‹¬ ë¡œì§ ---
        function openModal(modalID) {
            const modal = document.getElementById(modalID);
            const content = modal.querySelector('.modal-container');

            modal.classList.remove('opacity-0', 'pointer-events-none');
            document.body.classList.add('modal-active');

            // ì• ë‹ˆë©”ì´ì…˜
            setTimeout(() => {
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeModal(modalID) {
            const modal = document.getElementById(modalID);
            const content = modal.querySelector('.modal-container');

            // ì• ë‹ˆë©”ì´ì…˜
            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');

            setTimeout(() => {
                modal.classList.add('opacity-0', 'pointer-events-none');
                document.body.classList.remove('modal-active');
            }, 300);
        }

        // --- ì¸ì¦ API í˜¸ì¶œ ---
        async function handleLogin(e) {
            e.preventDefault();
            const form = e.target;
            const errorDiv = document.getElementById('login-error');
            const btn = form.querySelector('button');

            // ë¡œë”© ìƒíƒœ
            const originalBtnText = btn.innerText;
            btn.innerText = "ë¡œê·¸ì¸ ì¤‘...";
            btn.disabled = true;
            btn.classList.add('opacity-70', 'cursor-not-allowed');

            try {
                const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        username: form.username.value,
                        password: form.password.value
                    })
                });
                const data = await res.json();

                if (data.success) {
                    window.location.reload();
                } else {
                    errorDiv.innerText = data.error;
                    errorDiv.classList.remove('hidden');
                    // ì—ëŸ¬ ì‹œ í”ë“¤ë¦¼ ì• ë‹ˆë©”ì´ì…˜ ë“± ì¶”ê°€ ê°€ëŠ¥
                }
            } catch (err) {
                errorDiv.innerText = "ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                errorDiv.classList.remove('hidden');
            } finally {
                btn.innerText = originalBtnText;
                btn.disabled = false;
                btn.classList.remove('opacity-70', 'cursor-not-allowed');
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const form = e.target;
            const errorDiv = document.getElementById('register-error');
            const btn = form.querySelector('button');

            const originalBtnText = btn.innerText;
            btn.innerText = "ì²˜ë¦¬ ì¤‘...";
            btn.disabled = true;

            try {
                const res = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        username: form.username.value,
                        password: form.password.value
                    })
                });
                const data = await res.json();

                if (data.success) {
                    alert('íšŒì›ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                    closeModal('register-modal');
                    openModal('login-modal');
                } else {
                    errorDiv.innerText = data.error;
                    errorDiv.classList.remove('hidden');
                }
            } catch (err) {
                errorDiv.innerText = "ì„œë²„ ì—°ê²° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                errorDiv.classList.remove('hidden');
            } finally {
                btn.innerText = originalBtnText;
                btn.disabled = false;
            }
        }

        async function logout() {
            if(!confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            await fetch('/api/auth/logout', { method: 'POST' });
            window.location.href = '/';
        }

        // ì‹œë‚˜ë¦¬ì˜¤ ê´€ë ¨ ì•¡ì…˜
        async function deleteScenario(filename, btn) {
            if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) return;

            try {
                const res = await fetch('/api/delete_scenario', {
                    method: 'POST',
                    body: JSON.stringify({filename: filename})
                });
                const data = await res.json();
                if(data.success) {
                    // ì¹´ë“œê°€ ì‚¬ë¼ì§€ëŠ” ì• ë‹ˆë©”ì´ì…˜
                    const card = btn.closest('.group');
                    card.style.transition = 'all 0.5s';
                    card.style.opacity = '0';
                    card.style.transform = 'scale(0.9)';
                    setTimeout(() => card.remove(), 500);
                } else {
                    alert(data.error);
                }
            } catch(e) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
        }

        async function publishScenario(filename, btn) {
            if(!confirm("ê³µê°œ ìƒíƒœë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            try {
                const res = await fetch('/api/publish_scenario', {
                    method: 'POST',
                    body: JSON.stringify({filename: filename})
                });
                const data = await res.json();
                if(data.success) {
                    alert(data.message);
                    htmx.trigger('#scenario-grid', 'load');
                } else {
                    alert(data.error);
                }
            } catch(e) { alert("ì˜¤ë¥˜ ë°œìƒ"); }
        }

        // ì‚¬ì´ë“œë°” ìƒíƒœ ê´€ë¦¬ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        (function() {
            const sidebar = document.querySelector('.sidebar');
            const SIDEBAR_STATE_KEY = 'sidebar_expanded';
            let isRestoredState = false;

            if (sessionStorage.getItem(SIDEBAR_STATE_KEY) === 'true') {
                sidebar.style.transition = 'none';
                sidebar.classList.add('expanded');
                isRestoredState = true;
                sessionStorage.removeItem(SIDEBAR_STATE_KEY);
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        sidebar.style.transition = '';
                    });
                });
            }

            if (isRestoredState) {
                setTimeout(() => {
                    const checkMousePosition = (e) => {
                        const rect = sidebar.getBoundingClientRect();
                        const isInsideSidebar = e.clientX >= rect.left && e.clientX <= rect.right &&
                                               e.clientY >= rect.top && e.clientY <= rect.bottom;
                        if (!isInsideSidebar) {
                            sidebar.classList.remove('expanded');
                        }
                        document.removeEventListener('mousemove', checkMousePosition);
                    };
                    document.addEventListener('mousemove', checkMousePosition, { once: true });
                }, 100);
            }

            sidebar.querySelectorAll('a[href], button').forEach(link => {
                link.addEventListener('click', function(e) {
                    if (this.tagName === 'A' && this.href) {
                        sessionStorage.setItem(SIDEBAR_STATE_KEY, 'true');
                        sidebar.classList.add('expanded');
                    }
                });
            });

            const logoArea = sidebar.querySelector('.p-4.h-16 .flex.items-center.gap-2');
            if (logoArea) {
                logoArea.addEventListener('click', function(e) {
                    sessionStorage.setItem(SIDEBAR_STATE_KEY, 'true');
                    sidebar.classList.add('expanded');
                });
            }

            sidebar.addEventListener('mouseleave', function() {
                sidebar.classList.remove('expanded');
            });
        })();
    </script>
</body>
</html>