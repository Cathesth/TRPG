<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRPG Studio - {{ version }}</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Pretendard', sans-serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }

        .htmx-indicator { display: none; pointer-events: none; }
        .htmx-request .htmx-indicator { display: flex; pointer-events: auto; }
        .htmx-request.htmx-indicator { display: flex; pointer-events: auto; }

        .glass-panel {
            background: rgba(28, 28, 28, 0.6);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .brand-gradient {
            background: linear-gradient(135deg, #6E47E6 0%, #818cf8 100%);
        }
        .text-gradient {
            background: linear-gradient(135deg, #c084fc 0%, #818cf8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
        .sidebar {
            width: 72px;
            transition: width 0.3s ease;
        }
        .sidebar:hover,
        .sidebar.expanded {
            width: 260px;
        }
        .sidebar .nav-text, .sidebar .logo-text, .sidebar .section-title, .sidebar .user-info, .sidebar .user-chevron {
            opacity: 0;
            white-space: nowrap;
            transition: opacity 0.2s ease;
        }
        .sidebar:hover .nav-text, .sidebar.expanded .nav-text,
        .sidebar:hover .logo-text, .sidebar.expanded .logo-text,
        .sidebar:hover .section-title, .sidebar.expanded .section-title,
        .sidebar:hover .user-info, .sidebar.expanded .user-info,
        .sidebar:hover .user-chevron, .sidebar.expanded .user-chevron {
            opacity: 1;
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: hidden !important; }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: { 900: '#111111', 800: '#1c1c1c', 700: '#2c2c2c', 600: '#3f3f46' },
                        brand: { purple: '#6E47E6', light: '#9F7AEA' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-dark-900 text-gray-200 h-screen flex overflow-hidden selection:bg-brand-purple selection:text-white">

    <!-- ì‚¬ì´ë“œë°” -->
    <div class="sidebar bg-dark-800 border-r border-white/5 flex flex-col hidden md:flex shrink-0 z-20 overflow-hidden">
        <div class="p-4 h-16 flex items-center">
            <div class="flex items-center gap-2 cursor-pointer" onclick="location.href='/'">
                <div class="w-10 h-10 brand-gradient rounded-lg flex items-center justify-center text-white shadow-lg shadow-brand-purple/20 shrink-0">
                    <i data-lucide="dice-5" class="w-5 h-5 fill-current"></i>
                </div>
                <span class="logo-text text-xl font-bold text-white tracking-tight">TRPG Studio</span>
            </div>
        </div>

        <nav class="flex-1 px-3 space-y-1 mt-2">
            <div class="section-title text-[10px] font-semibold text-gray-500 px-3 py-2 uppercase tracking-wider">Workspace</div>
            <a href="/" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg bg-white/5 text-white group cursor-pointer text-sm font-medium">
                <i data-lucide="layout-grid" class="w-5 h-5 text-brand-light shrink-0"></i>
                <span class="nav-text">ëŒ€ì‹œë³´ë“œ</span>
            </a>
            <a href="/views/builder" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-400 hover:bg-white/5 hover:text-white group cursor-pointer text-sm font-medium transition-colors">
                <i data-lucide="pen-tool" class="w-5 h-5 text-gray-500 group-hover:text-gray-300 shrink-0"></i>
                <span class="nav-text">ì‹œë‚˜ë¦¬ì˜¤ ë¹Œë”</span>
            </a>
            <a href="/views/player" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-400 hover:bg-white/5 hover:text-white group cursor-pointer text-sm font-medium transition-colors">
                <i data-lucide="gamepad-2" class="w-5 h-5 text-gray-500 group-hover:text-gray-300 shrink-0"></i>
                <span class="nav-text">í”Œë ˆì´ì–´ ëª¨ë“œ</span>
            </a>
            <a href="/views/scenes" class="w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-gray-400 hover:bg-white/5 hover:text-white group cursor-pointer text-sm font-medium transition-colors">
                <i data-lucide="git-merge" class="w-5 h-5 text-gray-500 group-hover:text-gray-300 shrink-0"></i>
                <span class="nav-text">ì „ì²´ ì”¬ ë³´ê¸°</span>
            </a>
        </nav>

        <!-- ìœ ì € í”„ë¡œí•„ -->
        <div class="p-3 border-t border-white/5">
            {% if user.is_authenticated %}
            <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 cursor-pointer transition-colors" onclick="logout()">
                <div class="w-8 h-8 rounded-full bg-brand-purple flex items-center justify-center text-white text-xs font-bold shrink-0">
                    {{ user.id[:2].upper() }}
                </div>
                <div class="user-info flex-1 min-w-0">
                    <p class="text-sm font-medium text-white truncate">{{ user.id }}</p>
                    <p class="text-[11px] text-brand-light truncate">ë¡œê·¸ì•„ì›ƒ</p>
                </div>
                <i data-lucide="log-out" class="user-chevron w-4 h-4 text-gray-500"></i>
            </div>
            {% else %}
            <div class="flex items-center gap-3 p-2 rounded-lg hover:bg-white/5 cursor-pointer transition-colors" onclick="openModal('login-modal')">
                <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center shrink-0">
                    <i data-lucide="user" class="w-4 h-4 text-gray-400"></i>
                </div>
                <div class="user-info flex-1 min-w-0">
                    <p class="text-sm font-medium text-white truncate">ê²ŒìŠ¤íŠ¸</p>
                    <p class="text-[11px] text-gray-500 truncate">ë¡œê·¸ì¸ í•„ìš”</p>
                </div>
                <i data-lucide="log-in" class="user-chevron w-4 h-4 text-gray-500"></i>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- ë©”ì¸ ë·° -->
    <div id="main-view" class="flex-1 flex flex-col h-full relative z-10 bg-dark-900 overflow-hidden">
        <!-- í—¤ë” -->
        <header class="h-16 border-b border-white/5 flex items-center justify-between px-8 bg-dark-900/80 backdrop-blur-md sticky top-0 z-20">
            <div class="flex items-center gap-4 w-full max-w-xl">
                <div class="relative w-full group">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-500 group-focus-within:text-brand-light transition-colors"></i>
                    <input type="text" placeholder="ì‹œë‚˜ë¦¬ì˜¤ ê²€ìƒ‰..." class="w-full bg-dark-800 border border-white/5 rounded-full pl-10 pr-4 py-2 text-sm text-gray-300 focus:outline-none focus:ring-1 focus:ring-brand-purple/50 focus:bg-dark-700 transition-all placeholder-gray-600">
                </div>
            </div>
            <div class="flex items-center gap-4 ml-4">
                {% if user.is_authenticated %}
                    <span class="text-sm text-gray-400 hidden sm:inline"><span class="text-brand-light font-bold">{{ user.id }}</span>ë‹˜</span>
                    <button onclick="logout()" class="text-xs bg-dark-800 hover:bg-dark-700 text-gray-300 px-3 py-1.5 rounded border border-white/10 transition-colors">ë¡œê·¸ì•„ì›ƒ</button>
                {% else %}
                    <button onclick="openModal('login-modal')" class="text-sm text-gray-300 hover:text-white transition-colors">ë¡œê·¸ì¸</button>
                    <button onclick="openModal('register-modal')" class="text-sm bg-brand-purple hover:bg-brand-purple/90 text-white px-4 py-1.5 rounded-full shadow-lg shadow-brand-purple/20 transition-all">íšŒì›ê°€ì…</button>
                {% endif %}
            </div>
        </header>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <main class="flex-1 overflow-y-auto p-8 custom-scrollbar">
            <!-- ì›°ì»´ ë©”ì‹œì§€ -->
            <div class="mb-10">
                <h2 class="text-2xl font-bold text-white mb-2">{% if user.is_authenticated %}ë°˜ê°€ì›Œìš”, {{ user.id }}ë‹˜! ğŸ‘‹{% else %}TRPG Studioì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤! ğŸ‘‹{% endif %}</h2>
                <p class="text-gray-400">ì˜¤ëŠ˜ë„ ìƒˆë¡œìš´ ì„¸ê³„ë¥¼ ì°½ì¡°í•´ë³¼ê¹Œìš”?</p>
            </div>

            <!-- ë‚´ ì‘í’ˆ ëª©ë¡ (ë¡œê·¸ì¸ ì‹œ í‘œì‹œ) -->
            {% if user.is_authenticated %}
            <div class="mb-12">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2"><i data-lucide="folder-open" class="w-5 h-5 text-gray-500"></i> ë‚´ ì‘í’ˆ</h3>
                    <button class="text-xs text-gray-500 hover:text-brand-light flex items-center gap-1" onclick="document.getElementById('my-tab-btn').click(); location.href='#scenarios-list'">ì „ì²´ë³´ê¸° <i data-lucide="chevron-right" class="w-3 h-3"></i></button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" hx-get="/api/scenarios?filter=my&limit=3" hx-trigger="load">
                     <div class="col-span-full py-8 text-center text-gray-500"><i data-lucide="loader-2" class="w-6 h-6 animate-spin mx-auto mb-2 text-brand-purple"></i>ë‚´ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>
            {% endif %}

            <!-- ì‹œë‚˜ë¦¬ì˜¤ ëª©ë¡ (íƒ­) -->
            <div class="mb-12" id="scenarios-list">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2"><i data-lucide="library" class="w-5 h-5 text-gray-500"></i> ëª¨ë“  ì‹œë‚˜ë¦¬ì˜¤</h3>
                    <div class="bg-dark-800 p-1 rounded-lg inline-flex border border-white/5">
                        <button id="public-tab-btn" class="px-4 py-1.5 rounded-md text-xs font-medium bg-brand-purple text-white shadow transition-all" hx-get="/api/scenarios?filter=public" hx-target="#scenario-grid" onclick="setActiveTab(this)">ê³µê°œ</button>
                        {% if user.is_authenticated %}
                        <button id="my-tab-btn" class="px-4 py-1.5 rounded-md text-xs font-medium text-gray-400 hover:text-white transition-all" hx-get="/api/scenarios?filter=my" hx-target="#scenario-grid" onclick="setActiveTab(this)">ë‚´ ì‘í’ˆ</button>
                        {% endif %}
                    </div>
                </div>
                <div id="scenario-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" hx-get="/api/scenarios?filter=public" hx-trigger="load">
                    <div class="col-span-full py-12 flex flex-col items-center justify-center text-gray-500"><i data-lucide="loader-2" class="w-8 h-8 animate-spin mb-3 text-brand-purple"></i><p>ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p></div>
                </div>
            </div>

            <!-- í•˜ë‹¨ ë°”ë¡œê°€ê¸° -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-12">
                <a href="/views/builder" class="group bg-dark-800 p-6 rounded-xl border border-white/5 hover:border-brand-purple/50 transition-all hover:bg-dark-800/80 cursor-pointer flex flex-col items-center justify-center text-center h-40">
                    <div class="w-12 h-12 rounded-full bg-brand-purple/10 flex items-center justify-center mb-3 group-hover:scale-110 transition-transform"><i data-lucide="plus" class="w-6 h-6 text-brand-purple"></i></div>
                    <h5 class="font-bold text-white group-hover:text-brand-light transition-colors">ìƒˆ í”„ë¡œì íŠ¸</h5>
                    <p class="text-[11px] text-gray-500 mt-1">ì²˜ìŒë¶€í„° ì§ì ‘ ë§Œë“¤ê¸°</p>
                </a>
            </div>
        </main>
    </div>

    <!-- ëª¨ë‹¬ë“¤ -->
    <div id="login-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-black/70 backdrop-blur-sm" onclick="closeModal('login-modal')"></div>
        <div class="modal-container bg-dark-800 w-11/12 md:max-w-sm mx-auto rounded-2xl shadow-2xl z-50 overflow-hidden border border-white/10 transform transition-all scale-95 opacity-0 duration-300">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-white">ë¡œê·¸ì¸</h3><button onclick="closeModal('login-modal')" class="text-gray-400 hover:text-white transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button></div>
                <form onsubmit="handleLogin(event)" class="space-y-4">
                    <div><label class="block text-gray-400 text-xs font-bold mb-1 ml-1">ì•„ì´ë””</label><input type="text" name="username" required class="w-full bg-dark-900 text-white border border-white/10 rounded-lg py-2.5 px-4 focus:outline-none focus:border-brand-purple transition-all"></div>
                    <div><label class="block text-gray-400 text-xs font-bold mb-1 ml-1">ë¹„ë°€ë²ˆí˜¸</label><input type="password" name="password" required class="w-full bg-dark-900 text-white border border-white/10 rounded-lg py-2.5 px-4 focus:outline-none focus:border-brand-purple transition-all"></div>
                    <div id="login-error" class="text-red-400 text-xs bg-red-500/10 p-2 rounded border border-red-500/20 hidden"></div>
                    <button type="submit" class="w-full bg-brand-gradient hover:opacity-90 text-white font-bold py-3 px-4 rounded-lg shadow-lg mt-2">ì‹œì‘í•˜ê¸°</button>
                </form>
            </div>
        </div>
    </div>

    <div id="register-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-black/70 backdrop-blur-sm" onclick="closeModal('register-modal')"></div>
        <div class="modal-container bg-dark-800 w-11/12 md:max-w-sm mx-auto rounded-2xl shadow-2xl z-50 overflow-hidden border border-white/10 transform transition-all scale-95 opacity-0 duration-300">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-white">íšŒì›ê°€ì…</h3><button onclick="closeModal('register-modal')" class="text-gray-400 hover:text-white transition-colors"><i data-lucide="x" class="w-5 h-5"></i></button></div>
                <form onsubmit="handleRegister(event)" class="space-y-4">
                    <div><label class="block text-gray-400 text-xs font-bold mb-1 ml-1">ì•„ì´ë””</label><input type="text" name="username" required class="w-full bg-dark-900 text-white border border-white/10 rounded-lg py-2.5 px-4 focus:outline-none focus:border-brand-purple transition-all"></div>
                    <div><label class="block text-gray-400 text-xs font-bold mb-1 ml-1">ë¹„ë°€ë²ˆí˜¸</label><input type="password" name="password" required class="w-full bg-dark-900 text-white border border-white/10 rounded-lg py-2.5 px-4 focus:outline-none focus:border-brand-purple transition-all"></div>
                    <div id="register-error" class="text-red-400 text-xs bg-red-500/10 p-2 rounded border border-red-500/20 hidden"></div>
                    <button type="submit" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg mt-2">ê°€ì… ì™„ë£Œ</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        document.body.addEventListener('htmx:afterSwap', function(evt) { lucide.createIcons(); });

        function setActiveTab(btn) {
            const container = btn.parentElement;
            container.querySelectorAll('button').forEach(b => { b.classList.remove('bg-brand-purple', 'text-white', 'shadow'); b.classList.add('text-gray-400'); });
            btn.classList.remove('text-gray-400'); btn.classList.add('bg-brand-purple', 'text-white', 'shadow');
        }

        // [í•µì‹¬] ì‹œë‚˜ë¦¬ì˜¤ í”Œë ˆì´ í•¨ìˆ˜ (JS fetch ë°©ì‹)
        async function playScenario(filename, btn) {
            // ë²„íŠ¼ ë¡œë”© ìƒíƒœ
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> ë¡œë”©...';
            btn.disabled = true;
            lucide.createIcons();

            try {
                const formData = new FormData();
                formData.append('filename', filename);

                const res = await fetch('/api/load_scenario', {
                    method: 'POST',
                    body: formData
                });

                // ì„±ê³µí•˜ë©´ í”Œë ˆì´ì–´ í˜ì´ì§€ë¡œ ì´ë™
                if (res.ok) {
                    // [ì¶”ê°€ë¨] ì„¸ì…˜ ìŠ¤í† ë¦¬ì§€ì— ë¡œë“œ ìƒíƒœ ë°•ì•„ì¤˜ì•¼ í•¨
                    sessionStorage.setItem('trpg_scenario_loaded', 'true');
                    window.location.href = '/views/player';
                } else {
                    const text = await res.text();
                    alert('ë¡œë“œ ì‹¤íŒ¨: ' + text);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            } catch (e) {
                console.error(e);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // ë¡œê·¸ì¸/íšŒì›ê°€ì…/ë¡œê·¸ì•„ì›ƒ ë“± ê¸°ì¡´ í•¨ìˆ˜ë“¤ (ë™ì¼í•˜ê²Œ ìœ ì§€)
        function openModal(id) { document.getElementById(id).classList.remove('opacity-0', 'pointer-events-none'); document.body.classList.add('modal-active'); }
        function closeModal(id) { document.getElementById(id).classList.add('opacity-0', 'pointer-events-none'); document.body.classList.remove('modal-active'); }

        async function handleLogin(e) {
            e.preventDefault(); const form = e.target;
            try {
                const res = await fetch('/api/auth/login', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username: form.username.value, password: form.password.value}) });
                const data = await res.json();
                if (data.success) window.location.reload();
                else { document.getElementById('login-error').innerText = data.error; document.getElementById('login-error').classList.remove('hidden'); }
            } catch(e) {}
        }

        async function handleRegister(e) {
            e.preventDefault(); const form = e.target;
            try {
                const res = await fetch('/api/auth/register', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({username: form.username.value, password: form.password.value}) });
                const data = await res.json();
                if (data.success) { alert('ê°€ì… ì„±ê³µ!'); closeModal('register-modal'); openModal('login-modal'); }
                else { document.getElementById('register-error').innerText = data.error; document.getElementById('register-error').classList.remove('hidden'); }
            } catch(e) {}
        }

        async function logout() { if(confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) { await fetch('/api/auth/logout', {method:'POST'}); window.location.reload(); } }

        async function deleteScenario(fname, btn) {
            if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            await fetch('/api/delete_scenario', { method: 'POST', body: JSON.stringify({filename: fname}) });
            btn.closest('.group').remove();
        }

        async function publishScenario(fname, btn) {
            if(!confirm('ê³µê°œ ìƒíƒœ ë³€ê²½?')) return;
            await fetch('/api/publish_scenario', { method: 'POST', body: JSON.stringify({filename: fname}) });
            htmx.trigger('#scenario-grid', 'load');
        }
    </script>
</body>
</html>