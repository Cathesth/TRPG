<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>NPC/Enemy Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #6366f1; /* indigo-500 */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    </style>
</head>
<body class="bg-gray-900 text-white p-6">

<div class="max-w-xl mx-auto">
    <div id="scenario-info" class="mb-4 text-xs text-gray-500 text-right">
        ì‹œë‚˜ë¦¬ì˜¤ ì •ë³´ ëŒ€ê¸° ì¤‘...
    </div>

    <!-- íƒ­ ë©”ë‰´ -->
    <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-6">
        <div class="flex gap-4">
            <button onclick="switchTab('npc')" id="tab-npc" class="text-green-400 font-bold border-b-2 border-green-400 pb-1 transition-colors">NPC ìƒì„±</button>
            <button onclick="switchTab('enemy')" id="tab-enemy" class="text-gray-500 hover:text-red-400 font-bold pb-1 transition-colors">ì (Enemy) ìƒì„±</button>
        </div>

        <button onclick="openAiPrompt()" class="text-xs bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded flex items-center gap-2 shadow-lg transition-transform active:scale-95">
            <i class="fas fa-magic"></i> AI ìë™ ìƒì„±
        </button>
    </div>

    <!-- AI í”„ë¡¬í”„íŠ¸ ì…ë ¥ì°½ -->
    <div id="ai-prompt-box" class="hidden mb-6 bg-gray-800 p-4 rounded-lg border border-indigo-500/50 shadow-xl animate-fade-in-down">
        <label class="block text-xs text-indigo-300 mb-2 font-bold"><i class="fas fa-robot mr-1"></i>AIì—ê²Œ ìš”ì²­í•  ë‚´ìš©</label>
        <div class="flex gap-2">
            <input type="text" id="ai-request-text" class="flex-1 bg-gray-900 border border-gray-700 rounded p-2 text-sm focus:border-indigo-500 outline-none transition-colors" placeholder="ì˜ˆ: ëˆì„ ë°íˆëŠ” ë¹„ì—´í•œ ê³ ë¸”ë¦° ìƒì¸, ëŒ€ì‚¬ë„ ê±°ì¹ ê²Œ">
            <button onclick="generateWithAI()" id="btn-ai-gen" class="bg-indigo-600 hover:bg-indigo-500 px-4 rounded text-sm font-bold min-w-[70px] flex justify-center items-center transition-colors">
                ìƒì„±
            </button>
        </div>
        <p class="text-[10px] text-gray-500 mt-2">* ì‹œë‚˜ë¦¬ì˜¤ ë¶„ìœ„ê¸°ì— ë§ì¶° ìë™ìœ¼ë¡œ ìƒì„¸ ì„¤ì •ì„ ì±„ì›Œì¤ë‹ˆë‹¤.</p>
    </div>

    <!-- NPC ì…ë ¥ í¼ -->
    <div id="form-npc" class="space-y-4">
        <div class="grid grid-cols-2 gap-3">
            <div>
                <label class="block text-xs text-gray-400 mb-1">ì´ë¦„ <span class="text-green-500">*</span></label>
                <input type="text" id="npc-name" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm focus:border-green-500 outline-none" placeholder="NPC ì´ë¦„">
            </div>
            <div>
                <label class="block text-xs text-gray-400 mb-1">ì—­í• /ì§ì—… <span class="text-green-500">*</span></label>
                <input type="text" id="npc-role" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm focus:border-green-500 outline-none" placeholder="ì˜ˆ: ëŒ€ì¥ì¥ì´">
            </div>
        </div>

        <!-- [ì¶”ê°€] ì™¸ëª¨ ë¬˜ì‚¬ -->
        <div>
            <label class="block text-xs text-gray-400 mb-1">ì™¸ëª¨ ë¬˜ì‚¬</label>
            <input type="text" id="npc-appearance" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm focus:border-green-500 outline-none" placeholder="ì˜ˆ: ë¶‰ì€ ìˆ˜ì—¼, í•œìª½ ëˆˆ ì•ˆëŒ€, ë‚¡ì€ ê°€ì£½ ì•ì¹˜ë§ˆ">
        </div>

        <div>
            <label class="block text-xs text-gray-400 mb-1">ì„±ê²©/íŠ¹ì§• <span class="text-green-500">*</span></label>
            <input type="text" id="npc-personality" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm focus:border-green-500 outline-none" placeholder="ì˜ˆ: ë¬´ëšëší•¨, ë‹¤í˜ˆì§ˆ, ëˆì„ ë°í˜">
        </div>

        <!-- [ì¶”ê°€] ëŒ€í‘œ ëŒ€ì‚¬ -->
        <div>
            <label class="block text-xs text-indigo-300 mb-1 font-bold">ğŸ’¬ ëŒ€í‘œ ëŒ€ì‚¬ (ë§ë²„ë¦‡) <span class="text-green-500">*</span></label>
            <textarea id="npc-dialogue" rows="2" class="w-full bg-gray-800 border border-indigo-900/50 rounded p-2 text-sm focus:border-indigo-500 outline-none placeholder-gray-600" placeholder="&quot;ì´ë´, ì‚´ ê±° ì•„ë‹ˆë©´ ì© êº¼ì§€ë¼ê³ !&quot;"></textarea>
        </div>

        <!-- [ì¶”ê°€] ë¹„ë°€ -->
        <div>
            <label class="block text-xs text-yellow-500/80 mb-1">ğŸ”’ ìˆ¨ê²¨ì§„ ë¹„ë°€ (ì„ íƒ)</label>
            <input type="text" id="npc-secret" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm focus:border-yellow-500 outline-none" placeholder="ì˜ˆ: ì‚¬ì‹¤ ì™•ì‹¤ì˜ ìˆ˜ë°°ìë‹¤.">
        </div>

        <div>
            <label class="block text-xs text-gray-400 mb-1">ë°°ê²½ ì„¤ì •</label>
            <textarea id="npc-bg" rows="3" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm focus:border-green-500 outline-none" placeholder="NPCì˜ ê³¼ê±°ì‚¬ë‚˜ í˜„ì¬ ìƒí™©"></textarea>
        </div>

        <div class="grid grid-cols-2 gap-3 pt-2 border-t border-gray-800">
            <div>
                <label class="block text-xs text-gray-500">ë‚˜ì´</label>
                <select id="npc-age" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm">
                    <option value="">ì•Œ ìˆ˜ ì—†ìŒ</option>
                    <option value="child">ì–´ë¦°ì´</option>
                    <option value="teen">ì²­ì†Œë…„</option>
                    <option value="young_adult">ì²­ë…„</option>
                    <option value="middle_aged">ì¤‘ë…„</option>
                    <option value="elderly">ë…¸ë…„</option>
                </select>
            </div>
            <div>
                <label class="block text-xs text-gray-500">í˜‘ë ¥ë„</label>
                <select id="npc-coop" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm">
                    <option value="medium">ì¤‘ë¦½ì </option>
                    <option value="low">ë¹„í˜‘ì¡°ì </option>
                    <option value="high">ìš°í˜¸ì </option>
                </select>
            </div>
        </div>

        <button onclick="createNPC()" id="btn-save-npc" class="w-full bg-green-700 hover:bg-green-600 text-white font-bold py-3 rounded mt-2 transition-colors shadow-lg">
            NPC ì €ì¥ ë° ì ìš©
        </button>
    </div>

    <!-- ì (Enemy) ì…ë ¥ í¼ -->
    <div id="form-enemy" class="space-y-4 hidden">
        <div class="grid grid-cols-2 gap-3">
            <div>
                <label class="block text-xs text-gray-400 mb-1">ì´ë¦„ <span class="text-red-500">*</span></label>
                <input type="text" id="enemy-name" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm focus:border-red-500 outline-none" placeholder="ì  ì´ë¦„">
            </div>
            <div>
                <label class="block text-xs text-gray-400 mb-1">ì¢…ì¡±/ìœ í˜• <span class="text-red-500">*</span></label>
                <input type="text" id="enemy-type" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm focus:border-red-500 outline-none" placeholder="ì˜ˆ: ì–¸ë°ë“œ, ì•¼ìˆ˜">
            </div>
        </div>

        <!-- [ì¶”ê°€] ì „íˆ¬ ìŠ¤íƒ¯ -->
        <div class="bg-gray-800/50 p-3 rounded border border-gray-700">
            <label class="block text-xs text-red-400 font-bold mb-2"><i class="fas fa-skull mr-1"></i>ì „íˆ¬ ì •ë³´</label>
            <div class="grid grid-cols-3 gap-2">
                <div>
                    <label class="block text-[10px] text-gray-500">ë‚œì´ë„</label>
                    <select id="enemy-difficulty" class="w-full bg-gray-900 border border-gray-700 rounded p-1.5 text-xs text-white">
                        <option value="easy">í•˜ (Easy)</option>
                        <option value="medium" selected>ì¤‘ (Normal)</option>
                        <option value="hard">ìƒ (Hard)</option>
                        <option value="boss">ë³´ìŠ¤ (Boss)</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] text-gray-500">ì²´ë ¥ (HP)</label>
                    <input type="number" id="enemy-hp" class="w-full bg-gray-900 border border-gray-700 rounded p-1.5 text-xs text-white" placeholder="ê¸°ë³¸">
                </div>
                <div>
                    <label class="block text-[10px] text-gray-500">ê³µê²©ë ¥ (ATK)</label>
                    <input type="number" id="enemy-attack" class="w-full bg-gray-900 border border-gray-700 rounded p-1.5 text-xs text-white" placeholder="ê¸°ë³¸">
                </div>
            </div>
        </div>

        <div>
            <label class="block text-xs text-gray-400 mb-1">íŠ¹ì§•/ê³µê²© íŒ¨í„´</label>
            <textarea id="enemy-desc" rows="3" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm focus:border-red-500 outline-none" placeholder="ì™¸í˜• ë¬˜ì‚¬ ë° ì£¼ ê³µê²© íŒ¨í„´"></textarea>
        </div>

        <!-- [ì¶”ê°€] ì•½ì  ë° ë³´ìƒ -->
        <div class="grid grid-cols-2 gap-3">
            <div>
                <label class="block text-xs text-gray-500">ì•½ì  (Weakness)</label>
                <input type="text" id="enemy-weakness" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-xs" placeholder="ì˜ˆ: ë¶ˆ, ì‹ ì„± ë§ˆë²•">
            </div>
            <div>
                <label class="block text-xs text-gray-500">ë“œë ì•„ì´í…œ</label>
                <input type="text" id="enemy-drop" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-xs" placeholder="ì˜ˆ: ëŠ‘ëŒ€ ê°€ì£½, ê³¨ë“œ">
            </div>
        </div>

        <button onclick="createEnemy()" id="btn-save-enemy" class="w-full bg-red-700 hover:bg-red-600 text-white font-bold py-3 rounded mt-2 transition-colors shadow-lg">
            ì (Enemy) ì €ì¥ ë° ì ìš©
        </button>
    </div>

    <div id="message-box" class="mt-4 p-3 rounded text-sm hidden font-bold text-center animate-fade-in-up"></div>
</div>

<script>
    let currentTab = 'npc';
    let scenarioInfo = { title: '', summary: '' };

    window.addEventListener('message', (event) => {
        if (event.data.type === 'SCENARIO_INFO') {
            scenarioInfo = event.data.payload;
            document.getElementById('scenario-info').innerText = `í˜„ì¬ ì‹œë‚˜ë¦¬ì˜¤: ${scenarioInfo.title || 'ì œëª© ì—†ìŒ'}`;
        }
    });

    window.onload = () => {
        if (window.parent) window.parent.postMessage({ type: 'GENERATOR_READY' }, '*');
    };

    function switchTab(tab) {
        currentTab = tab;
        document.getElementById('form-npc').classList.toggle('hidden', tab !== 'npc');
        document.getElementById('form-enemy').classList.toggle('hidden', tab !== 'enemy');

        const npcBtn = document.getElementById('tab-npc');
        const enemyBtn = document.getElementById('tab-enemy');

        if (tab === 'npc') {
            npcBtn.className = "text-green-400 font-bold border-b-2 border-green-400 pb-1 transition-colors";
            enemyBtn.className = "text-gray-500 hover:text-red-400 font-bold pb-1 transition-colors";
        } else {
            npcBtn.className = "text-gray-500 hover:text-green-400 font-bold pb-1 transition-colors";
            enemyBtn.className = "text-red-400 font-bold border-b-2 border-red-400 pb-1 transition-colors";
        }
    }

    function showMessage(msg, type='error') {
        const box = document.getElementById('message-box');
        box.className = `mt-4 p-3 rounded text-sm font-bold text-center animate-fade-in-up ${type === 'error' ? 'bg-red-900/80 text-red-200 border border-red-700' : 'bg-green-900/80 text-green-200 border border-green-700'}`;
        box.innerText = msg;
        box.classList.remove('hidden');
        setTimeout(() => box.classList.add('hidden'), 3000);
    }

    async function saveToDB(type, data) {
        try {
            const response = await fetch('/api/npc/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type, ...data })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'ì €ì¥ ì˜¤ë¥˜');
            return true;
        } catch (e) {
            console.error("DB Save Failed:", e);
            showMessage(`ì €ì¥ ì‹¤íŒ¨: ${e.message}`, 'error');
            return false;
        }
    }

    function openAiPrompt() {
        const box = document.getElementById('ai-prompt-box');
        box.classList.toggle('hidden');
        if (!box.classList.contains('hidden')) document.getElementById('ai-request-text').focus();
    }

    async function generateWithAI() {
        const requestText = document.getElementById('ai-request-text').value;
        const btn = document.getElementById('btn-ai-gen');

        if (!requestText.trim()) {
            showMessage("AIì—ê²Œ ìš”ì²­í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        const originalText = btn.innerHTML;
        btn.innerHTML = '<div class="loader"></div>';
        btn.disabled = true;

        try {
            const response = await fetch('/api/npc/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    scenario_title: scenarioInfo.title,
                    scenario_summary: scenarioInfo.summary,
                    request: requestText,
                    type: currentTab
                })
            });

            const result = await response.json();
            if (!result.success) throw new Error(result.error);
            const data = result.data;

            // [ìë™ ì±„ìš°ê¸°]
            if (currentTab === 'npc') {
                document.getElementById('npc-name').value = data.name || '';
                document.getElementById('npc-role').value = data.role || '';
                document.getElementById('npc-personality').value = data.personality || '';
                document.getElementById('npc-bg').value = data.description || '';

                // ì¶”ê°€ í•„ë“œ (AIê°€ ë°˜í™˜í•œë‹¤ë©´)
                if (data.appearance) document.getElementById('npc-appearance').value = data.appearance;
                if (data.dialogue) document.getElementById('npc-dialogue').value = data.dialogue;
                if (data.secret) document.getElementById('npc-secret').value = data.secret;
            } else {
                document.getElementById('enemy-name').value = data.name || '';
                document.getElementById('enemy-type').value = data.role || data.type || '';
                document.getElementById('enemy-desc').value = data.description || '';

                // ì¶”ê°€ í•„ë“œ
                if (data.weakness) document.getElementById('enemy-weakness').value = data.weakness;
                if (data.hp) document.getElementById('enemy-hp').value = data.hp;
                if (data.attack) document.getElementById('enemy-attack').value = data.attack;
            }

            showMessage("AI ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ì • í›„ ì €ì¥í•˜ì„¸ìš”.", "success");

        } catch (e) {
            showMessage(`AI ìƒì„± ì‹¤íŒ¨: ${e.message}`, 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    async function createNPC() {
        const btn = document.getElementById('btn-save-npc');
        btn.disabled = true; btn.innerText = "ì €ì¥ ì¤‘...";

        // í•„ìˆ˜ í•„ë“œ
        const name = document.getElementById('npc-name').value;
        const role = document.getElementById('npc-role').value;
        const personality = document.getElementById('npc-personality').value;
        const dialogue = document.getElementById('npc-dialogue').value; // ì¶”ê°€: í•„ìˆ˜ ê¶Œì¥

        if (!name || !role || !personality) {
            showMessage("í•„ìˆ˜ í•­ëª©(ì´ë¦„, ì—­í• , ì„±ê²©)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            btn.disabled = false; btn.innerText = "NPC ì €ì¥ ë° ì ìš©";
            return;
        }

        const npcData = {
            name, role, personality,
            description: document.getElementById('npc-bg').value,
            appearance: document.getElementById('npc-appearance').value, // ì¶”ê°€
            dialogue: dialogue, // ì¶”ê°€
            secret: document.getElementById('npc-secret').value, // ì¶”ê°€
            age: document.getElementById('npc-age').value,
            cooperation: document.getElementById('npc-coop').value,
            isEnemy: false
        };

        const saved = await saveToDB('npc', npcData);
        if (saved) {
            window.parent.postMessage({ type: 'ADD_NPC', payload: npcData }, '*');
            showMessage("NPCê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!", "success");
            // í¼ ì´ˆê¸°í™” (ì „ì²´ input/textarea)
            const form = document.getElementById('form-npc');
            form.querySelectorAll('input, textarea').forEach(el => el.value = '');
            document.getElementById('npc-coop').value = 'medium';
        }
        btn.disabled = false; btn.innerText = "NPC ì €ì¥ ë° ì ìš©";
    }

    async function createEnemy() {
        const btn = document.getElementById('btn-save-enemy');
        btn.disabled = true; btn.innerText = "ì €ì¥ ì¤‘...";

        const name = document.getElementById('enemy-name').value;
        const type = document.getElementById('enemy-type').value;
        const difficulty = document.getElementById('enemy-difficulty').value;

        if (!name || !type || !difficulty) {
            showMessage("í•„ìˆ˜ í•­ëª©(ì´ë¦„, ìœ í˜•, ë‚œì´ë„)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            btn.disabled = false; btn.innerText = "ì (Enemy) ì €ì¥ ë° ì ìš©";
            return;
        }

        const enemyData = {
            name, type, difficulty,
            description: document.getElementById('enemy-desc').value,
            hp: document.getElementById('enemy-hp').value, // ì¶”ê°€
            attack: document.getElementById('enemy-attack').value, // ì¶”ê°€
            weakness: document.getElementById('enemy-weakness').value, // ì¶”ê°€
            drop_items: document.getElementById('enemy-drop').value, // ì¶”ê°€
            isEnemy: true
        };

        const saved = await saveToDB('enemy', enemyData);
        if (saved) {
            window.parent.postMessage({ type: 'ADD_NPC', payload: enemyData }, '*');
            showMessage("ì ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!", "success");
            const form = document.getElementById('form-enemy');
            form.querySelectorAll('input, textarea').forEach(el => el.value = '');
            document.getElementById('enemy-difficulty').value = 'medium';
        }
        btn.disabled = false; btn.innerText = "ì (Enemy) ì €ì¥ ë° ì ìš©";
    }
</script>
</body>
</html>