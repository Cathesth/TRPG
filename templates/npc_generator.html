<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>NPC/Enemy Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-900 text-white p-6">

<div class="max-w-xl mx-auto">
    <div class="flex gap-4 mb-6 border-b border-gray-700 pb-2">
        <button onclick="switchTab('npc')" id="tab-npc" class="text-green-400 font-bold border-b-2 border-green-400 pb-1">NPC 생성</button>
        <button onclick="switchTab('enemy')" id="tab-enemy" class="text-gray-500 hover:text-red-400 font-bold pb-1">적(Enemy) 생성</button>
    </div>

    <div id="form-npc" class="space-y-3">
        <div>
            <label class="block text-xs text-gray-400 mb-1">이름 <span class="text-red-500">*</span></label>
            <input type="text" id="npc-name" class="w-full bg-gray-800 border border-gray-700 rounded p-2" placeholder="NPC 이름">
        </div>
        <div>
            <label class="block text-xs text-gray-400 mb-1">역할 <span class="text-red-500">*</span></label>
            <input type="text" id="npc-role" class="w-full bg-gray-800 border border-gray-700 rounded p-2" placeholder="예: 대장장이, 상인">
        </div>
        <div>
            <label class="block text-xs text-gray-400 mb-1">성격 <span class="text-red-500">*</span></label>
            <input type="text" id="npc-personality" class="w-full bg-gray-800 border border-gray-700 rounded p-2" placeholder="예: 무뚝뚝함, 친절함">
        </div>
        <div>
            <label class="block text-xs text-gray-400 mb-1">배경 설정 <span class="text-red-500">*</span></label>
            <textarea id="npc-bg" rows="3" class="w-full bg-gray-800 border border-gray-700 rounded p-2" placeholder="NPC의 배경 스토리"></textarea>
        </div>

        <div class="grid grid-cols-2 gap-3 pt-2 border-t border-gray-800">
            <div>
                <label class="block text-xs text-gray-500">나이 (선택)</label>
                <select id="npc-age" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm">
                    <option value="">선택 안 함</option>
                    <option value="child">어린이</option>
                    <option value="teen">청소년</option>
                    <option value="young_adult">청년</option>
                    <option value="middle_aged">중년</option>
                    <option value="elderly">노년</option>
                </select>
            </div>
            <div>
                <label class="block text-xs text-gray-500">협력도 (선택)</label>
                <select id="npc-coop" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm">
                    <option value="">선택 안 함</option>
                    <option value="low">저 (비협조적)</option>
                    <option value="medium">중 (중립적)</option>
                    <option value="high">상 (협조적)</option>
                </select>
            </div>
            <div class="col-span-2">
                <label class="block text-xs text-gray-500">보유 아이템 (선택)</label>
                <input type="text" id="npc-items" class="w-full bg-gray-800 border border-gray-700 rounded p-2" placeholder="예: 낡은 검, 회복 물약">
            </div>
        </div>

        <button onclick="createNPC()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded mt-4">NPC 생성 및 저장</button>
    </div>

    <div id="form-enemy" class="space-y-3 hidden">
        <div>
            <label class="block text-xs text-gray-400 mb-1">이름 <span class="text-red-500">*</span></label>
            <input type="text" id="enemy-name" class="w-full bg-gray-800 border border-gray-700 rounded p-2" placeholder="적 이름">
        </div>
        <div>
            <label class="block text-xs text-gray-400 mb-1">유형 <span class="text-red-500">*</span></label>
            <input type="text" id="enemy-type" class="w-full bg-gray-800 border border-gray-700 rounded p-2" placeholder="예: 언데드, 인간, 야수">
        </div>
        <div>
            <label class="block text-xs text-gray-400 mb-1">난이도 <span class="text-red-500">*</span></label>
            <select id="enemy-difficulty" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm">
                <option value="">선택하세요</option>
                <option value="easy">약 (Easy)</option>
                <option value="medium">중 (Normal)</option>
                <option value="hard">강 (Hard)</option>
            </select>
        </div>

        <button onclick="createEnemy()" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded mt-4">적(Enemy) 생성 및 저장</button>
    </div>

    <div id="message-box" class="mt-4 p-3 rounded text-sm hidden"></div>
</div>

<script>
    let currentTab = 'npc';

    function switchTab(tab) {
        currentTab = tab;
        document.getElementById('form-npc').classList.toggle('hidden', tab !== 'npc');
        document.getElementById('form-enemy').classList.toggle('hidden', tab !== 'enemy');

        const npcBtn = document.getElementById('tab-npc');
        const enemyBtn = document.getElementById('tab-enemy');

        if (tab === 'npc') {
            npcBtn.className = "text-green-400 font-bold border-b-2 border-green-400 pb-1";
            enemyBtn.className = "text-gray-500 hover:text-red-400 font-bold pb-1";
        } else {
            npcBtn.className = "text-gray-500 hover:text-green-400 font-bold pb-1";
            enemyBtn.className = "text-red-400 font-bold border-b-2 border-red-400 pb-1";
        }
    }

    function showMessage(msg, type='error') {
        const box = document.getElementById('message-box');
        box.className = `mt-4 p-3 rounded text-sm ${type === 'error' ? 'bg-red-900/50 text-red-200' : 'bg-green-900/50 text-green-200'}`;
        box.innerText = msg;
        box.classList.remove('hidden');
        setTimeout(() => box.classList.add('hidden'), 3000);
    }

    async function saveToDB(type, data) {
        // 백엔드 API 호출 시뮬레이션 (실제 구현 시 엔드포인트 필요)
        try {
            const response = await fetch('/api/npc/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type, ...data })
            });
            return response.ok;
        } catch (e) {
            console.error("DB Save Failed (Backend not implemented?)", e);
            // 백엔드가 없어도 프론트엔드 기능은 동작하도록 true 반환 (데모용)
            return true;
        }
    }

    async function createNPC() {
        const name = document.getElementById('npc-name').value;
        const role = document.getElementById('npc-role').value;
        const personality = document.getElementById('npc-personality').value;
        const bg = document.getElementById('npc-bg').value;

        // 선택 사항
        const age = document.getElementById('npc-age').value;
        const coop = document.getElementById('npc-coop').value;
        const items = document.getElementById('npc-items').value;

        // 필수 항목 체크
        if (!name || !role || !personality || !bg) {
            showMessage("필수 항목(이름, 역할, 성격, 배경)을 모두 입력해주세요.");
            return;
        }

        const npcData = {
            name, role, personality, description: bg,
            age: age || null,
            cooperation: coop || null,
            items: items || null,
            isEnemy: false
        };

        const saved = await saveToDB('npc', npcData);
        if (saved) {
            // 부모 창으로 데이터 전송
            window.parent.postMessage({ type: 'ADD_NPC', payload: npcData }, '*');
            showMessage("NPC가 생성 및 저장되었습니다!", "success");
            // 폼 초기화
            document.querySelectorAll('#form-npc input, #form-npc textarea').forEach(el => el.value = '');
            document.querySelectorAll('#form-npc select').forEach(el => el.value = '');
        } else {
            showMessage("저장에 실패했습니다.");
        }
    }

    async function createEnemy() {
        const name = document.getElementById('enemy-name').value;
        const type = document.getElementById('enemy-type').value;
        const difficulty = document.getElementById('enemy-difficulty').value;

        if (!name || !type || !difficulty) {
            showMessage("필수 항목(이름, 유형, 난이도)을 모두 입력해주세요.");
            return;
        }

        const enemyData = {
            name, type, difficulty,
            isEnemy: true
        };

        const saved = await saveToDB('enemy', enemyData);
        if (saved) {
            window.parent.postMessage({ type: 'ADD_NPC', payload: enemyData }, '*');
            showMessage("적이 생성 및 저장되었습니다!", "success");
            document.querySelectorAll('#form-enemy input').forEach(el => el.value = '');
            document.getElementById('enemy-difficulty').value = '';
        } else {
            showMessage("저장에 실패했습니다.");
        }
    }
</script>
</body>
</html>