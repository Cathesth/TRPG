<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>NPC/Enemy Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=DotGothic16&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        rpg: {
                            900: '#0B0B19',
                            800: '#1A0B2E',
                            700: '#2D1B4E',
                            accent: '#00FFFF',
                            hover: '#00DDDD',
                            danger: '#FF007F',
                            success: '#10b981',
                            item: '#FFD700',
                        }
                    },
                    fontFamily: {
                        pixel: ['Press Start 2P', 'monospace'],
                        dot: ['DotGothic16', 'sans-serif'],
                        title: ['Press Start 2P', 'monospace'],
                        body: ['DotGothic16', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style>
        /* 8-bit Pixel Art Base */
        body {
            background: linear-gradient(180deg, #0B0B19 0%, #1A0B2E 50%, #0B0B19 100%) !important;
            color: #e2e8f0 !important;
            font-family: 'DotGothic16', sans-serif;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        /* CRT Effect */
        body::before {
            content: '';
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: repeating-linear-gradient(0deg, rgba(0, 0, 0, 0.15), rgba(0, 0, 0, 0.15) 1px, transparent 1px, transparent 2px);
            pointer-events: none; z-index: 9999;
        }

        /* Pixel Border & Input Styles */
        .pixel-input {
            background: rgba(26, 11, 46, 0.8) !important;
            border: 2px solid #4A4A6A !important;
            color: #FFFACD !important;
            font-family: 'DotGothic16', sans-serif;
            border-radius: 0 !important;
            padding: 8px 12px !important;
        }
        .pixel-input:focus {
            border-color: #00FFFF !important;
            box-shadow: 0 0 8px rgba(0, 255, 255, 0.3) !important;
            outline: none !important;
        }

        .loader {
            border: 3px solid #4A4A6A; border-top: 3px solid #00FFFF;
            border-radius: 0 !important; width: 20px; height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 12px; }
        ::-webkit-scrollbar-track { background: #0B0B19; }
        ::-webkit-scrollbar-thumb { background: #4A4A6A; border: 2px solid #2D1B4E; border-radius: 0 !important; }
        ::-webkit-scrollbar-thumb:hover { background: #6A6A8A; }

        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="min-h-screen text-white p-6 relative">

<!-- í† í° í‘œì‹œê¸° (ìš°ì¸¡ ìƒë‹¨) -->
<div id="token-display" class="absolute top-4 right-4 flex items-center gap-2 bg-gray-900/80 px-3 py-1.5 rounded border border-yellow-500/50 text-yellow-400 text-xs shadow-lg animate-fade-in">
    <i class="fas fa-coins text-yellow-500"></i>
    <span id="token-balance">Loading...</span>
</div>

<div class="max-w-xl mx-auto">
    <div id="scenario-info" class="mb-4 text-xs text-gray-500 text-right">
        ì‹œë‚˜ë¦¬ì˜¤ ì •ë³´ ëŒ€ê¸° ì¤‘...
    </div>

    <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-6">
        <div class="flex gap-4">
            <button onclick="switchTab('npc')" id="tab-npc" class="text-green-400 font-bold border-b-2 border-green-400 pb-1 transition-colors">NPC ìƒì„±</button>
            <button onclick="switchTab('enemy')" id="tab-enemy" class="text-gray-500 hover:text-red-400 font-bold pb-1 transition-colors">ì (Enemy) ìƒì„±</button>
            <button onclick="switchTab('item')" id="tab-item" class="text-gray-500 hover:text-yellow-400 font-bold pb-1 transition-colors">ì•„ì´í…œ ìƒì„±</button>
        </div>

        <button onclick="openAiPrompt()" class="text-xs bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1.5 rounded flex items-center gap-2 shadow-lg transition-transform active:scale-95">
            <i class="fas fa-magic"></i> AI ìë™ ìƒì„±
        </button>
    </div>

    <div id="ai-prompt-box" class="hidden mb-6 bg-gray-800 p-4 rounded-lg border border-indigo-500/50 shadow-xl animate-fade-in-down">
        <label class="block text-xs text-indigo-300 mb-2 font-bold"><i class="fas fa-robot mr-1"></i>AIì—ê²Œ ìš”ì²­í•  ë‚´ìš©</label>
        <div class="flex gap-2">
            <input type="text" id="ai-request-text" class="flex-1 bg-gray-900 border border-gray-700 rounded p-2 text-sm focus:border-indigo-500 outline-none transition-colors" placeholder="ì˜ˆ: ì „ì„¤ì˜ ë…¹ìŠ¨ ê²€, ë¹„ì—´í•œ ê³ ë¸”ë¦° ìƒì¸">
            <button onclick="generateWithAI()" id="btn-ai-gen" class="bg-indigo-600 hover:bg-indigo-500 px-4 rounded text-xs font-bold min-w-[100px] flex justify-center items-center gap-1 transition-colors">
                ìƒì„± <span class="opacity-70 font-normal">(~2 CR)</span>
            </button>
        </div>
        <p class="text-[10px] text-gray-500 mt-2">* ì‹œë‚˜ë¦¬ì˜¤ ë¶„ìœ„ê¸°ì— ë§ì¶° ìë™ìœ¼ë¡œ ìƒì„¸ ì„¤ì •ì„ ì±„ì›Œì¤ë‹ˆë‹¤.</p>
    </div>

    <!-- NPC Form -->
    <div id="form-npc" class="space-y-4">
        <div class="grid grid-cols-2 gap-3">
            <div>
                <label class="block text-xs text-gray-400 mb-1">ì´ë¦„ <span class="text-green-500">*</span></label>
                <input type="text" id="npc-name" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm focus:border-green-500 outline-none" placeholder="NPC ì´ë¦„">
            </div>
            <div>
                <label class="block text-xs text-gray-400 mb-1">ì—­í• /ì§ì—… <span class="text-green-500">*</span></label>
                <input type="text" id="npc-role" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm focus:border-green-500 outline-none" placeholder="ì˜ˆ: ëŒ€ì¥ì¥ì´">
            </div>
        </div>
        <div>
            <label class="block text-xs text-gray-400 mb-1">ì™¸ëª¨ ë¬˜ì‚¬</label>
            <input type="text" id="npc-appearance" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm focus:border-green-500 outline-none" placeholder="ì˜ˆ: ë¶‰ì€ ìˆ˜ì—¼, í•œìª½ ëˆˆ ì•ˆëŒ€">
        </div>
        <div>
            <label class="block text-xs text-gray-400 mb-1">ì„±ê²©/íŠ¹ì§• <span class="text-green-500">*</span></label>
            <input type="text" id="npc-personality" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm focus:border-green-500 outline-none" placeholder="ì˜ˆ: ë¬´ëšëší•¨, ë‹¤í˜ˆì§ˆ">
        </div>
        <div>
            <label class="block text-xs text-indigo-300 mb-1 font-bold">ğŸ’¬ ëŒ€í‘œ ëŒ€ì‚¬ (ë§ë²„ë¦‡) <span class="text-green-500">*</span></label>
            <textarea id="npc-dialogue" rows="2" class="w-full bg-gray-800 border border-indigo-900/50 rounded p-2 text-sm focus:border-indigo-500 outline-none placeholder-gray-600" placeholder="&quot;ì´ë´, ì‚´ ê±° ì•„ë‹ˆë©´ ì© êº¼ì§€ë¼ê³ !&quot;"></textarea>
        </div>
        <div>
            <label class="block text-xs text-yellow-500/80 mb-1">ğŸ”’ ìˆ¨ê²¨ì§„ ë¹„ë°€ (ì„ íƒ)</label>
            <input type="text" id="npc-secret" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm focus:border-yellow-500 outline-none" placeholder="ì˜ˆ: ì‚¬ì‹¤ ì™•ì‹¤ì˜ ìˆ˜ë°°ìë‹¤.">
        </div>
        <div>
            <label class="block text-xs text-gray-400 mb-1">ë°°ê²½ ì„¤ì •</label>
            <textarea id="npc-bg" rows="3" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm focus:border-green-500 outline-none" placeholder="NPCì˜ ê³¼ê±°ì‚¬ë‚˜ í˜„ì¬ ìƒí™©"></textarea>
        </div>
        <div class="grid grid-cols-2 gap-3 pt-2 border-t border-gray-800">
            <div>
                <label class="block text-xs text-gray-500">ë‚˜ì´</label>
                <select id="npc-age" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm">
                    <option value="">ì•Œ ìˆ˜ ì—†ìŒ</option>
                    <option value="child">ì–´ë¦°ì´</option>
                    <option value="teen">ì²­ì†Œë…„</option>
                    <option value="young_adult">ì²­ë…„</option>
                    <option value="middle_aged">ì¤‘ë…„</option>
                    <option value="elderly">ë…¸ë…„</option>
                </select>
            </div>
            <div>
                <label class="block text-xs text-gray-500">í˜‘ë ¥ë„</label>
                <select id="npc-coop" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm">
                    <option value="medium">ì¤‘ë¦½ì </option>
                    <option value="low">ë¹„í˜‘ì¡°ì </option>
                    <option value="high">ìš°í˜¸ì </option>
                </select>
            </div>
        </div>
        <button onclick="createNPC()" id="btn-save-npc" class="w-full bg-green-700 hover:bg-green-600 text-white font-bold py-3 rounded mt-2 transition-colors shadow-lg">NPC ì €ì¥ ë° ì ìš©</button>
    </div>

    <!-- Enemy Form -->
    <div id="form-enemy" class="space-y-4 hidden">
        <div class="grid grid-cols-2 gap-3">
            <div>
                <label class="block text-xs text-gray-400 mb-1">ì´ë¦„ <span class="text-red-500">*</span></label>
                <input type="text" id="enemy-name" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm focus:border-red-500 outline-none" placeholder="ì  ì´ë¦„">
            </div>
            <div>
                <label class="block text-xs text-gray-400 mb-1">ì¢…ì¡±/ìœ í˜• <span class="text-red-500">*</span></label>
                <input type="text" id="enemy-type" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm focus:border-red-500 outline-none" placeholder="ì˜ˆ: ì–¸ë°ë“œ, ì•¼ìˆ˜">
            </div>
        </div>
        <div class="bg-gray-800/50 p-3 rounded border border-gray-700">
            <label class="block text-xs text-red-400 font-bold mb-2"><i class="fas fa-skull mr-1"></i>ì „íˆ¬ ì •ë³´</label>
            <div class="grid grid-cols-3 gap-2">
                <div>
                    <label class="block text-[10px] text-gray-500">ë‚œì´ë„</label>
                    <select id="enemy-difficulty" class="w-full bg-gray-900 border border-gray-700 rounded p-1.5 text-xs text-white">
                        <option value="easy">í•˜</option>
                        <option value="medium" selected>ì¤‘</option>
                        <option value="hard">ìƒ</option>
                        <option value="boss">ë³´ìŠ¤</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] text-gray-500">ì²´ë ¥ (HP)</label>
                    <input type="number" id="enemy-hp" class="w-full bg-gray-900 border border-gray-700 rounded p-1.5 text-xs text-white" placeholder="ê¸°ë³¸">
                </div>
                <div>
                    <label class="block text-[10px] text-gray-500">ê³µê²©ë ¥ (ATK)</label>
                    <input type="number" id="enemy-attack" class="w-full bg-gray-900 border border-gray-700 rounded p-1.5 text-xs text-white" placeholder="ê¸°ë³¸">
                </div>
            </div>
        </div>
        <div>
            <label class="block text-xs text-gray-400 mb-1">íŠ¹ì§•/ê³µê²© íŒ¨í„´</label>
            <textarea id="enemy-desc" rows="3" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm focus:border-red-500 outline-none" placeholder="ì™¸í˜• ë¬˜ì‚¬ ë° ì£¼ ê³µê²© íŒ¨í„´"></textarea>
        </div>
        <div class="grid grid-cols-2 gap-3">
            <div>
                <label class="block text-xs text-gray-500">ì•½ì  (Weakness)</label>
                <input type="text" id="enemy-weakness" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-xs" placeholder="ì˜ˆ: ë¶ˆ, ì‹ ì„± ë§ˆë²•">
            </div>
            <div>
                <label class="block text-xs text-gray-500">ë“œë ì•„ì´í…œ</label>
                <input type="text" id="enemy-drop" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-xs" placeholder="ì˜ˆ: ëŠ‘ëŒ€ ê°€ì£½, ê³¨ë“œ">
            </div>
        </div>
        <button onclick="createEnemy()" id="btn-save-enemy" class="w-full bg-red-700 hover:bg-red-600 text-white font-bold py-3 rounded mt-2 transition-colors shadow-lg">ì (Enemy) ì €ì¥ ë° ì ìš©</button>
    </div>

    <!-- Item Form -->
    <div id="form-item" class="space-y-4 hidden fade-in">
        <div class="grid grid-cols-2 gap-3">
            <div>
                <label class="block text-xs text-gray-400 mb-1">ì•„ì´í…œ ì´ë¦„ <span class="text-yellow-500">*</span></label>
                <input type="text" id="item-name" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm focus:border-yellow-500 outline-none" placeholder="ì•„ì´í…œ ëª…">
            </div>
            <div>
                <label class="block text-xs text-gray-400 mb-1">ìœ í˜•</label>
                <select id="item-type" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm focus:border-yellow-500 outline-none">
                    <option value="weapon">ë¬´ê¸°</option>
                    <option value="armor">ë°©ì–´êµ¬</option>
                    <option value="consumable">ì†Œëª¨í’ˆ</option>
                    <option value="key_item">ì¤‘ìš” ì•„ì´í…œ</option>
                    <option value="misc">ê¸°íƒ€</option>
                </select>
            </div>
        </div>

        <div>
            <label class="block text-xs text-gray-400 mb-1">íš¨ê³¼ / ëŠ¥ë ¥ì¹˜</label>
            <input type="text" id="item-effect" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm focus:border-yellow-500 outline-none" placeholder="ì˜ˆ: ê³µê²©ë ¥ +10, ì²´ë ¥ 50 íšŒë³µ">
        </div>

        <div>
            <label class="block text-xs text-gray-400 mb-1">ì„¤ëª… / ì™¸í˜•</label>
            <textarea id="item-desc" rows="4" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm focus:border-yellow-500 outline-none" placeholder="ì•„ì´í…œì˜ ìƒê¹€ìƒˆë‚˜ ìœ ë˜ ë“±"></textarea>
        </div>

        <button onclick="createItem()" id="btn-save-item" class="w-full bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 rounded mt-2 shadow-lg transition-colors">ì•„ì´í…œ ì €ì¥ ë° ì ìš©</button>
    </div>

    <div id="message-box" class="mt-4 p-3 rounded text-sm hidden font-bold text-center animate-fade-in-up"></div>
</div>

<script>
    let currentTab = 'npc';
    let scenarioInfo = { title: '', summary: '' };

    // [MODIFIED] í† í° ì¡°íšŒ ê²½ë¡œ í†µì¼ (/api/user/status)
    async function fetchTokenBalance() {
        try {
            const res = await fetch('/api/user/status');
            if(res.ok) {
                const data = await res.json();
                if(data.success) {
                    const balance = data.balance.toLocaleString();
                    document.getElementById('token-balance').textContent = `${balance} CR`;
                }
            } else {
                document.getElementById('token-balance').textContent = "ERROR";
            }
        } catch(e) {
            console.error("Token fetch failed", e);
            document.getElementById('token-balance').textContent = "OFFLINE";
        }
    }

    window.addEventListener('message', (event) => {
        if (event.data.type === 'SCENARIO_INFO') {
            scenarioInfo = event.data.payload;
            document.getElementById('scenario-info').innerText = `í˜„ì¬ ì‹œë‚˜ë¦¬ì˜¤: ${scenarioInfo.title || 'ì œëª© ì—†ìŒ'}`;
        }
        if (event.data.type === 'SWITCH_TAB') {
            switchTab(event.data.tab);
        }
    });

    window.onload = () => {
        if (window.parent) window.parent.postMessage({ type: 'GENERATOR_READY' }, '*');
        fetchTokenBalance();
    };

    function switchTab(tab) {
        currentTab = tab;
        ['npc', 'enemy', 'item'].forEach(t => {
            document.getElementById(`form-${t}`).classList.add('hidden');
            const btn = document.getElementById(`tab-${t}`);
            btn.className = "text-gray-500 hover:text-white font-bold pb-1 transition-colors";

            if (t === tab) {
                document.getElementById(`form-${t}`).classList.remove('hidden');
                let activeClass = "";
                if (t === 'npc') activeClass = "text-green-400 font-bold border-b-2 border-green-400 pb-1";
                else if (t === 'enemy') activeClass = "text-red-400 font-bold border-b-2 border-red-400 pb-1";
                else activeClass = "text-yellow-400 font-bold border-b-2 border-yellow-400 pb-1";

                btn.className = `${activeClass} transition-colors`;
            }
        });
    }

    function showMessage(msg, type='error') {
        const box = document.getElementById('message-box');
        box.className = `mt-4 p-3 rounded text-sm font-bold text-center animate-fade-in-up ${type === 'error' ? 'bg-red-900/80 text-red-200 border border-red-700' : 'bg-green-900/80 text-green-200 border border-green-700'}`;
        box.innerText = msg;
        box.classList.remove('hidden');
        setTimeout(() => box.classList.add('hidden'), 3000);
    }

    async function saveToDB(type, data) {
        try {
            const response = await fetch('/api/npc/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type, ...data })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || 'ì €ì¥ ì˜¤ë¥˜');
            return true;
        } catch (e) {
            console.error("DB Save Failed:", e);
            showMessage(`ì €ì¥ ì‹¤íŒ¨: ${e.message}`, 'error');
            return false;
        }
    }

    function openAiPrompt() {
        const box = document.getElementById('ai-prompt-box');
        box.classList.toggle('hidden');
        if (!box.classList.contains('hidden')) document.getElementById('ai-request-text').focus();
    }

    async function generateWithAI() {
        const requestText = document.getElementById('ai-request-text').value;
        const btn = document.getElementById('btn-ai-gen');

        if (!requestText.trim()) {
            showMessage("AIì—ê²Œ ìš”ì²­í•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.");
            return;
        }

        const originalText = btn.innerHTML;
        btn.innerHTML = '<div class="loader"></div>';
        btn.disabled = true;

        try {
            const response = await fetch('/api/npc/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    scenario_title: scenarioInfo.title,
                    scenario_summary: scenarioInfo.summary,
                    request: requestText,
                    type: currentTab
                })
            });

            const result = await response.json();
            if (!result.success) throw new Error(result.error);
            const data = result.data;

            // [ìë™ ì±„ìš°ê¸° ë¡œì§]
            if (currentTab === 'npc') {
                document.getElementById('npc-name').value = data.name || '';
                document.getElementById('npc-role').value = data.role || '';
                document.getElementById('npc-personality').value = data.personality || '';
                document.getElementById('npc-bg').value = data.description || '';
                if (data.appearance) document.getElementById('npc-appearance').value = data.appearance;
                if (data.dialogue) document.getElementById('npc-dialogue').value = data.dialogue;
                if (data.secret) document.getElementById('npc-secret').value = data.secret;
            } else if (currentTab === 'enemy') {
                document.getElementById('enemy-name').value = data.name || '';
                document.getElementById('enemy-type').value = data.role || data.type || '';
                document.getElementById('enemy-desc').value = data.description || '';
                if (data.weakness) document.getElementById('enemy-weakness').value = data.weakness;
                if (data.hp) document.getElementById('enemy-hp').value = data.hp;
                if (data.attack) document.getElementById('enemy-attack').value = data.attack;
            } else if (currentTab === 'item') {
                document.getElementById('item-name').value = data.name || '';
                document.getElementById('item-desc').value = data.description || '';
                document.getElementById('item-effect').value = data.effect || '';
                if(data.item_type) document.getElementById('item-type').value = data.item_type;
            }

            showMessage("AI ìƒì„±ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ì • í›„ ì €ì¥í•˜ì„¸ìš”.", "success");
            await fetchTokenBalance();

        } catch (e) {
            showMessage(`AI ìƒì„± ì‹¤íŒ¨: ${e.message}`, 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    async function createNPC() {
        const btn = document.getElementById('btn-save-npc');
        btn.disabled = true; btn.innerText = "ì €ì¥ ì¤‘...";

        const name = document.getElementById('npc-name').value;
        const role = document.getElementById('npc-role').value;
        const personality = document.getElementById('npc-personality').value;

        if (!name || !role || !personality) {
            showMessage("í•„ìˆ˜ í•­ëª©(ì´ë¦„, ì—­í• , ì„±ê²©)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            btn.disabled = false; btn.innerText = "NPC ì €ì¥ ë° ì ìš©";
            return;
        }

        const npcData = {
            name, role, personality,
            description: document.getElementById('npc-bg').value,
            appearance: document.getElementById('npc-appearance').value,
            dialogue: document.getElementById('npc-dialogue').value,
            secret: document.getElementById('npc-secret').value,
            age: document.getElementById('npc-age').value,
            cooperation: document.getElementById('npc-coop').value,
            isEnemy: false
        };

        const saved = await saveToDB('npc', npcData);
        if (saved) {
            window.parent.postMessage({ type: 'ADD_NPC', payload: npcData }, '*');
            showMessage("NPCê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!", "success");
            document.getElementById('form-npc').querySelectorAll('input, textarea').forEach(el => el.value = '');
            document.getElementById('npc-coop').value = 'medium';
        }
        btn.disabled = false; btn.innerText = "NPC ì €ì¥ ë° ì ìš©";
    }

    async function createEnemy() {
        const btn = document.getElementById('btn-save-enemy');
        btn.disabled = true; btn.innerText = "ì €ì¥ ì¤‘...";

        const name = document.getElementById('enemy-name').value;
        const type = document.getElementById('enemy-type').value;
        const difficulty = document.getElementById('enemy-difficulty').value;

        if (!name || !type || !difficulty) {
            showMessage("í•„ìˆ˜ í•­ëª©(ì´ë¦„, ìœ í˜•, ë‚œì´ë„)ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            btn.disabled = false; btn.innerText = "ì (Enemy) ì €ì¥ ë° ì ìš©";
            return;
        }

        const enemyData = {
            name, type, difficulty,
            description: document.getElementById('enemy-desc').value,
            hp: document.getElementById('enemy-hp').value,
            attack: document.getElementById('enemy-attack').value,
            weakness: document.getElementById('enemy-weakness').value,
            drop_items: document.getElementById('enemy-drop').value,
            isEnemy: true
        };

        const saved = await saveToDB('enemy', enemyData);
        if (saved) {
            window.parent.postMessage({ type: 'ADD_NPC', payload: enemyData }, '*');
            showMessage("ì ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!", "success");
            document.getElementById('form-enemy').querySelectorAll('input, textarea').forEach(el => el.value = '');
            document.getElementById('enemy-difficulty').value = 'medium';
        }
        btn.disabled = false; btn.innerText = "ì (Enemy) ì €ì¥ ë° ì ìš©";
    }

    async function createItem() {
        const btn = document.getElementById('btn-save-item');
        btn.disabled = true; btn.innerText = "ì €ì¥ ì¤‘...";

        const name = document.getElementById('item-name').value;
        const itemType = document.getElementById('item-type').value;

        if (!name) {
            showMessage("ì•„ì´í…œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            btn.disabled = false; btn.innerText = "ì•„ì´í…œ ì €ì¥ ë° ì ìš©";
            return;
        }

        const itemData = {
            name,
            item_type: itemType,
            effect: document.getElementById('item-effect').value,
            description: document.getElementById('item-desc').value,
            type: 'item'
        };

        const saved = await saveToDB('item', itemData);
        if (saved) {
            window.parent.postMessage({ type: 'ADD_ITEM', payload: itemData }, '*');
            showMessage("ì•„ì´í…œì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!", "success");
            document.getElementById('form-item').querySelectorAll('input, textarea').forEach(el => el.value = '');
        }
        btn.disabled = false; btn.innerText = "ì•„ì´í…œ ì €ì¥ ë° ì ìš©";
    }
</script>
</body>
</html>