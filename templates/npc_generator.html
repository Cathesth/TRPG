<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>NPC/Enemy Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* 로딩 애니메이션 */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-900 text-white p-6">

<div class="max-w-xl mx-auto">
    <div id="scenario-info" class="mb-4 text-xs text-gray-500 text-right">
        시나리오 정보 대기 중...
    </div>

    <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-6">
        <div class="flex gap-4">
            <button onclick="switchTab('npc')" id="tab-npc" class="text-green-400 font-bold border-b-2 border-green-400 pb-1">NPC 생성</button>
            <button onclick="switchTab('enemy')" id="tab-enemy" class="text-gray-500 hover:text-red-400 font-bold pb-1">적(Enemy) 생성</button>
        </div>

        <button onclick="openAiPrompt()" class="text-xs bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1 rounded flex items-center gap-2">
            <i class="fas fa-magic"></i> AI 자동 생성
        </button>
    </div>

    <div id="ai-prompt-box" class="hidden mb-6 bg-gray-800 p-3 rounded border border-indigo-500/50">
        <label class="block text-xs text-indigo-300 mb-1">AI에게 요청할 내용</label>
        <div class="flex gap-2">
            <input type="text" id="ai-request-text" class="flex-1 bg-gray-900 border border-gray-700 rounded p-2 text-sm" placeholder="예: 비열한 고블린 상인, 강력한 화염 드래곤">
            <button onclick="generateWithAI()" id="btn-ai-gen" class="bg-indigo-600 px-3 rounded text-sm font-bold min-w-[60px] flex justify-center items-center">
                생성
            </button>
        </div>
    </div>

    <div id="form-npc" class="space-y-3">
        <div>
            <label class="block text-xs text-gray-400 mb-1">이름 <span class="text-red-500">*</span></label>
            <input type="text" id="npc-name" class="w-full bg-gray-800 border border-gray-700 rounded p-2 focus:border-green-500 outline-none" placeholder="NPC 이름">
        </div>
        <div>
            <label class="block text-xs text-gray-400 mb-1">역할 <span class="text-red-500">*</span></label>
            <input type="text" id="npc-role" class="w-full bg-gray-800 border border-gray-700 rounded p-2 focus:border-green-500 outline-none" placeholder="예: 대장장이, 상인">
        </div>
        <div>
            <label class="block text-xs text-gray-400 mb-1">성격 <span class="text-red-500">*</span></label>
            <input type="text" id="npc-personality" class="w-full bg-gray-800 border border-gray-700 rounded p-2 focus:border-green-500 outline-none" placeholder="예: 무뚝뚝함, 친절함">
        </div>
        <div>
            <label class="block text-xs text-gray-400 mb-1">배경 설정 <span class="text-red-500">*</span></label>
            <textarea id="npc-bg" rows="3" class="w-full bg-gray-800 border border-gray-700 rounded p-2 focus:border-green-500 outline-none" placeholder="NPC의 배경 스토리"></textarea>
        </div>

        <div class="grid grid-cols-2 gap-3 pt-2 border-t border-gray-800">
            <div>
                <label class="block text-xs text-gray-500">나이 (선택)</label>
                <select id="npc-age" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm">
                    <option value="">선택 안 함</option>
                    <option value="child">어린이</option>
                    <option value="teen">청소년</option>
                    <option value="young_adult">청년</option>
                    <option value="middle_aged">중년</option>
                    <option value="elderly">노년</option>
                </select>
            </div>
            <div>
                <label class="block text-xs text-gray-500">협력도 (선택)</label>
                <select id="npc-coop" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm">
                    <option value="">선택 안 함</option>
                    <option value="low">저 (비협조적)</option>
                    <option value="medium">중 (중립적)</option>
                    <option value="high">상 (협조적)</option>
                </select>
            </div>
            <div class="col-span-2">
                <label class="block text-xs text-gray-500">보유 아이템 (선택)</label>
                <input type="text" id="npc-items" class="w-full bg-gray-800 border border-gray-700 rounded p-2" placeholder="예: 낡은 검, 회복 물약">
            </div>
        </div>

        <button onclick="createNPC()" id="btn-save-npc" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded mt-4 transition-colors">
            NPC 저장 및 적용
        </button>
    </div>

    <div id="form-enemy" class="space-y-3 hidden">
        <div>
            <label class="block text-xs text-gray-400 mb-1">이름 <span class="text-red-500">*</span></label>
            <input type="text" id="enemy-name" class="w-full bg-gray-800 border border-gray-700 rounded p-2 focus:border-red-500 outline-none" placeholder="적 이름">
        </div>
        <div>
            <label class="block text-xs text-gray-400 mb-1">유형 <span class="text-red-500">*</span></label>
            <input type="text" id="enemy-type" class="w-full bg-gray-800 border border-gray-700 rounded p-2 focus:border-red-500 outline-none" placeholder="예: 언데드, 인간, 야수">
        </div>
        <div>
            <label class="block text-xs text-gray-400 mb-1">난이도 <span class="text-red-500">*</span></label>
            <select id="enemy-difficulty" class="w-full bg-gray-800 border border-gray-700 rounded p-2 text-sm focus:border-red-500 outline-none">
                <option value="">선택하세요</option>
                <option value="easy">약 (Easy)</option>
                <option value="medium">중 (Normal)</option>
                <option value="hard">강 (Hard)</option>
            </select>
        </div>

        <div>
            <label class="block text-xs text-gray-400 mb-1">설명/특징 (선택)</label>
            <textarea id="enemy-desc" rows="3" class="w-full bg-gray-800 border border-gray-700 rounded p-2 focus:border-red-500 outline-none" placeholder="적의 외형이나 공격 패턴 등"></textarea>
        </div>

        <button onclick="createEnemy()" id="btn-save-enemy" class="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded mt-4 transition-colors">
            적(Enemy) 저장 및 적용
        </button>
    </div>

    <div id="message-box" class="mt-4 p-3 rounded text-sm hidden font-bold text-center"></div>
</div>

<script>
    let currentTab = 'npc';
    let scenarioInfo = { title: '', summary: '' };

    // 부모 창으로부터 시나리오 정보 수신
    window.addEventListener('message', (event) => {
        if (event.data.type === 'SCENARIO_INFO') {
            scenarioInfo = event.data.payload;
            document.getElementById('scenario-info').innerText = `현재 시나리오: ${scenarioInfo.title || '제목 없음'}`;
        }
    });

    // 로드 완료 시 부모에게 알림
    window.onload = () => {
        if (window.parent) {
            window.parent.postMessage({ type: 'GENERATOR_READY' }, '*');
        }
    };

    function switchTab(tab) {
        currentTab = tab;
        document.getElementById('form-npc').classList.toggle('hidden', tab !== 'npc');
        document.getElementById('form-enemy').classList.toggle('hidden', tab !== 'enemy');

        const npcBtn = document.getElementById('tab-npc');
        const enemyBtn = document.getElementById('tab-enemy');

        if (tab === 'npc') {
            npcBtn.className = "text-green-400 font-bold border-b-2 border-green-400 pb-1";
            enemyBtn.className = "text-gray-500 hover:text-red-400 font-bold pb-1";
        } else {
            npcBtn.className = "text-gray-500 hover:text-green-400 font-bold pb-1";
            enemyBtn.className = "text-red-400 font-bold border-b-2 border-red-400 pb-1";
        }
    }

    function showMessage(msg, type='error') {
        const box = document.getElementById('message-box');
        box.className = `mt-4 p-3 rounded text-sm font-bold text-center ${type === 'error' ? 'bg-red-900/50 text-red-200 border border-red-800' : 'bg-green-900/50 text-green-200 border border-green-800'}`;
        box.innerText = msg;
        box.classList.remove('hidden');
        setTimeout(() => box.classList.add('hidden'), 3000);
    }

    // [DB 연결] 실제 백엔드 API 호출
    async function saveToDB(type, data) {
        try {
            const response = await fetch('/api/npc/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type, ...data })
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || '저장 중 오류가 발생했습니다.');
            }

            return true;
        } catch (e) {
            console.error("DB Save Failed:", e);
            showMessage(`저장 실패: ${e.message}`, 'error');
            return false;
        }
    }

    // [Agent 연결] AI 생성 요청
    function openAiPrompt() {
        document.getElementById('ai-prompt-box').classList.toggle('hidden');
    }

    async function generateWithAI() {
        const requestText = document.getElementById('ai-request-text').value;
        const btn = document.getElementById('btn-ai-gen');

        if (!requestText.trim()) {
            showMessage("AI에게 요청할 내용을 입력하세요.");
            return;
        }

        // 로딩 상태
        const originalText = btn.innerText;
        btn.innerHTML = '<div class="loader"></div>';
        btn.disabled = true;

        try {
            const response = await fetch('/api/npc/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    scenario_title: scenarioInfo.title,
                    scenario_summary: scenarioInfo.summary,
                    request: requestText,
                    type: currentTab // npc or enemy
                })
            });

            const result = await response.json();
            if (!result.success) throw new Error(result.error);

            const data = result.data; // AI가 생성한 데이터

            // 폼 채우기
            if (currentTab === 'npc') {
                document.getElementById('npc-name').value = data.name || '';
                document.getElementById('npc-role').value = data.role || '';
                document.getElementById('npc-personality').value = data.personality || ''; // 스키마에 따라 필드명이 다를 수 있음
                document.getElementById('npc-bg').value = data.description || '';
            } else {
                // Enemy 탭
                document.getElementById('enemy-name').value = data.name || '';
                document.getElementById('enemy-type').value = data.role || ''; // Enemy의 경우 role을 type으로 매핑
                document.getElementById('enemy-desc').value = data.description || '';
            }

            showMessage("AI 생성이 완료되었습니다. 내용을 확인하고 저장하세요.", "success");

        } catch (e) {
            showMessage(`AI 생성 실패: ${e.message}`, 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    async function createNPC() {
        const btn = document.getElementById('btn-save-npc');
        btn.disabled = true;
        btn.innerText = "저장 중...";

        const name = document.getElementById('npc-name').value;
        const role = document.getElementById('npc-role').value;
        const personality = document.getElementById('npc-personality').value;
        const bg = document.getElementById('npc-bg').value;

        const age = document.getElementById('npc-age').value;
        const coop = document.getElementById('npc-coop').value;
        const items = document.getElementById('npc-items').value;

        if (!name || !role || !personality || !bg) {
            showMessage("필수 항목(이름, 역할, 성격, 배경)을 모두 입력해주세요.");
            btn.disabled = false;
            btn.innerText = "NPC 저장 및 적용";
            return;
        }

        const npcData = {
            name, role, personality, description: bg,
            age: age || null,
            cooperation: coop || null,
            items: items || null,
            isEnemy: false
        };

        const saved = await saveToDB('npc', npcData);
        if (saved) {
            window.parent.postMessage({ type: 'ADD_NPC', payload: npcData }, '*');
            showMessage("NPC가 저장되었습니다!", "success");
            // 폼 초기화
            document.querySelectorAll('#form-npc input, #form-npc textarea').forEach(el => el.value = '');
            document.querySelectorAll('#form-npc select').forEach(el => el.value = '');
        }

        btn.disabled = false;
        btn.innerText = "NPC 저장 및 적용";
    }

    async function createEnemy() {
        const btn = document.getElementById('btn-save-enemy');
        btn.disabled = true;
        btn.innerText = "저장 중...";

        const name = document.getElementById('enemy-name').value;
        const type = document.getElementById('enemy-type').value;
        const difficulty = document.getElementById('enemy-difficulty').value;
        const desc = document.getElementById('enemy-desc').value;

        if (!name || !type || !difficulty) {
            showMessage("필수 항목(이름, 유형, 난이도)을 모두 입력해주세요.");
            btn.disabled = false;
            btn.innerText = "적(Enemy) 저장 및 적용";
            return;
        }

        const enemyData = {
            name, type, difficulty,
            description: desc || '',
            isEnemy: true
        };

        const saved = await saveToDB('enemy', enemyData);
        if (saved) {
            window.parent.postMessage({ type: 'ADD_NPC', payload: enemyData }, '*');
            showMessage("적이 저장되었습니다!", "success");
            document.querySelectorAll('#form-enemy input, #form-enemy textarea').forEach(el => el.value = '');
            document.getElementById('enemy-difficulty').value = '';
        }

        btn.disabled = false;
        btn.innerText = "적(Enemy) 저장 및 적용";
    }
</script>
</body>
</html>