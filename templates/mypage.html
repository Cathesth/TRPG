<!DOCTYPE html>
<html lang="ko" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRPG Studio - My Archives</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700;900&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        /* 텍스트 글로우 애니메이션 효과 */
        @keyframes textGlow {
            0%, 100% { text-shadow: 0 0 5px rgba(56, 189, 248, 0.2); }
            50% { text-shadow: 0 0 15px rgba(56, 189, 248, 0.6); color: white; }
        }
        .animate-text-glow:hover {
            animation: textGlow 2s infinite;
        }

        /* 스크롤바 디자인 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #020617;
        }
        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
            color: #e2e8f0;
        }

        .font-title {
            font-family: 'Cinzel', serif;
        }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        rpg: {
                            900: '#020617', // Main Background
                            800: '#0f172a', // Panel Background
                            700: '#1e293b', // Border
                            accent: '#38bdf8', // Cyan
                            hover: '#0ea5e9', // Blue
                            danger: '#ef4444', // Red
                        }
                    },
                    fontFamily: {
                        title: ['Cinzel', 'serif'],
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-rpg-900 text-gray-200 overflow-x-hidden">

    <!-- 배경 효과 -->
    <div class="fixed inset-0 pointer-events-none z-0">
        <div class="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-purple-900/10 rounded-full blur-[100px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-blue-900/10 rounded-full blur-[100px]"></div>
    </div>

    <div class="relative z-10 max-w-7xl mx-auto px-6 py-12">

        <!-- 상단 헤더 -->
        <div class="flex flex-col md:flex-row items-center justify-between mb-12 gap-6">
            <div class="flex items-center gap-4">
                <button onclick="location.href='/'" class="p-3 bg-rpg-800 rounded-full hover:bg-rpg-700 text-gray-400 hover:text-white transition-all group border border-rpg-700">
                    <i data-lucide="arrow-left" class="w-6 h-6 group-hover:-translate-x-1 transition-transform"></i>
                </button>
                <div>
                    <h1 class="text-4xl font-title font-bold text-white tracking-wider animate-text-glow">MY ARCHIVES</h1>
                    <p class="text-gray-400 mt-1">당신이 기록한 모험의 서사시</p>
                </div>
            </div>

            <div class="flex items-center gap-4 bg-rpg-800/50 backdrop-blur-sm p-4 rounded-2xl border border-rpg-700/50">
                 <!-- 유저 아이콘 및 정보 (user 객체 없을 시 대비) -->
                <div class="w-12 h-12 rounded-full bg-gradient-to-br from-purple-600 to-blue-600 flex items-center justify-center text-white font-bold text-lg shadow-lg shadow-purple-500/20">
                    {{ user.id[:2].upper() if user and user.id else 'G' }}
                </div>
                <div class="text-right hidden sm:block">
                    <p class="text-white font-bold">{{ user.id if user and user.id else 'Guest' }}</p>
                    <p class="text-xs text-rpg-accent">Master Weaver</p>
                </div>
                <button onclick="logout()" class="ml-4 p-2 text-gray-400 hover:text-red-400 transition-colors" title="로그아웃">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <!-- 메인 컨텐츠 영역 -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">

            <!-- 왼쪽 사이드바 (통계 등) -->
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-rpg-800/80 backdrop-blur border border-rpg-700 rounded-2xl p-6 shadow-xl">
                    <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <i data-lucide="bar-chart-2" class="w-5 h-5 text-rpg-accent"></i> Statistics
                    </h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center p-3 bg-rpg-900/50 rounded-lg border border-rpg-700/50">
                            <span class="text-gray-400 text-sm">Created Scenarios</span>
                            <span class="text-white font-bold text-xl">--</span> <!-- 실제 데이터 연결 필요 -->
                        </div>
                        <div class="flex justify-between items-center p-3 bg-rpg-900/50 rounded-lg border border-rpg-700/50">
                            <span class="text-gray-400 text-sm">Published</span>
                            <span class="text-rpg-accent font-bold text-xl">--</span>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-rpg-800 to-rpg-900 border border-rpg-700 rounded-2xl p-6 shadow-xl text-center">
                    <div class="mb-4 flex justify-center">
                        <div class="p-3 bg-rpg-accent/10 rounded-full">
                            <i data-lucide="plus" class="w-8 h-8 text-rpg-accent"></i>
                        </div>
                    </div>
                    <h3 class="text-lg font-bold text-white mb-2">New Adventure</h3>
                    <p class="text-sm text-gray-400 mb-6">새로운 세계를 창조할 준비가 되셨나요?</p>
                    <button onclick="location.href='/views/builder'" class="w-full py-3 bg-rpg-accent hover:bg-rpg-hover text-black font-bold rounded-xl transition-all shadow-lg shadow-rpg-accent/20 flex items-center justify-center gap-2">
                        <i data-lucide="pen-tool" class="w-4 h-4"></i> Create New
                    </button>
                </div>
            </div>

            <!-- 오른쪽 시나리오 그리드 -->
            <div class="lg:col-span-3">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-white flex items-center gap-2">
                        <i data-lucide="book-open" class="w-5 h-5 text-rpg-accent"></i> My Scenarios
                    </h2>
                    <div class="flex gap-2">
                        <!-- 필터 버튼 예시 (기능 미구현) -->
                        <button class="px-3 py-1.5 bg-rpg-800 hover:bg-rpg-700 border border-rpg-700 rounded-lg text-xs text-white transition-colors">All</button>
                        <button class="px-3 py-1.5 bg-rpg-900 hover:bg-rpg-800 border border-rpg-700 rounded-lg text-xs text-gray-400 transition-colors">Public</button>
                        <button class="px-3 py-1.5 bg-rpg-900 hover:bg-rpg-800 border border-rpg-700 rounded-lg text-xs text-gray-400 transition-colors">Private</button>
                    </div>
                </div>

                <!-- HTMX Grid Container -->
                <!-- [수정] hx-get 경로에 슬래시(/) 추가하여 절대 경로로 설정 -->
                <div id="my-scenario-grid"
                     class="grid grid-cols-1 md:grid-cols-2 gap-6"
                     hx-get="/api/scenarios?filter=my"
                     hx-trigger="load"
                     hx-swap="innerHTML">

                    <!-- Loading Placeholder (Canvas 미리보기용 예시 데이터) -->
                    <div class="col-span-full py-12 flex flex-col items-center justify-center text-gray-500 animate-pulse">
                        <i data-lucide="loader-2" class="w-8 h-8 mb-4 animate-spin"></i>
                        <p>Loading your archives...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 스크립트 영역 -->
    <script>
        lucide.createIcons();

        async function logout() {
            if(confirm('로그아웃 하시겠습니까?')) {
                await fetch('/api/auth/logout', {method:'POST'});
                window.location.href = '/';
            }
        }

        // 시나리오 플레이 (FormData 사용 필수 - api.py 사양)
        window.playScenario = async function(fid, btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i>';
            btn.disabled = true;
            lucide.createIcons();

            try {
                const formData = new FormData();
                formData.append('filename', fid);

                const res = await fetch('/api/load_scenario', {
                    method: 'POST',
                    body: formData
                });

                if (res.ok) {
                    window.location.href = '/views/player';
                } else {
                    alert('시나리오를 불러오는 데 실패했습니다.');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    lucide.createIcons();
                }
            } catch (e) {
                console.error('Play Error:', e);
                btn.innerHTML = originalText;
                btn.disabled = false;
                lucide.createIcons();
            }
        };

        window.editScenario = function(fid) {
            window.location.href = `/views/builder?scenario=${encodeURIComponent(fid)}`;
        };

        window.deleteScenario = async function(fid, btn) {
            if (!confirm('정말 이 시나리오를 영구히 삭제하시겠습니까?')) return;

            try {
                const res = await fetch('/api/delete_scenario', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ filename: fid })
                });

                const data = await res.json();

                if (data.success) {
                    // HTMX 트리거를 이용해 목록 새로고침
                    htmx.trigger("#my-scenario-grid", "load");
                } else {
                    alert('삭제 중 오류가 발생했습니다: ' + (data.error || 'Unknown error'));
                }
            } catch (e) {
                console.error('Delete Error:', e);
                alert('서버 통신 오류가 발생했습니다.');
            }
        };

        // HTMX 로드 후 아이콘 재생성
        document.body.addEventListener('htmx:afterOnLoad', function(evt) {
            if (evt.detail.target.id === "my-scenario-grid") {
                lucide.createIcons();
            }
        });

        // HTMX 스왑 후에도 아이콘 재생성 (중복 안전장치)
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            lucide.createIcons();
        });

        // 에러 로깅
        document.body.addEventListener('htmx:error', function(evt) {
            console.error('HTMX Error:', evt.detail);
        });
    </script>
</body>
</html>